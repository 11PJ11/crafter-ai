# ============================================================================
# nWave COMMAND/TASK TEMPLATE
# ============================================================================
# Version: 1.1 (2026-01-20)
# Purpose: Minimal task template for optimal agent handoff (50-60 lines target)
# Source: Claude Code Subagent Activation Best Practices Research + Pattern Analysis
#
# CHANGELOG:
# - v1.1 (2026-01-20): Added Anti-Patterns section, Delegation Principle emphasis,
#                      Compliance Checklist based on analysis of 20 existing commands
# - v1.0 (2025-10-07): Initial template with 50-60 line target
#
# CRITICAL DESIGN PRINCIPLE:
# Tasks are DELEGATION files, NOT workflow duplication files.
# Workflows belong in agent specifications (nWave/agents/{agent-name}.md).
# Tasks provide: context bundling, agent invocation, handoff coordination.
# ============================================================================

---
# ============================================================================
# AGENT ACTIVATION METADATA (YAML Frontmatter)
# ============================================================================
# Declares which agent executes this task and auto-activation behavior

agent-activation:
  required: true
  agent-id: {agent-id}              # e.g., business-analyst, solution-architect
  agent-name: "{PersonaName}"       # e.g., Riley, Quinn, Crafty, Dakota
  agent-command: "*{command-name}"  # e.g., *gather-requirements, *design-architecture
  auto-activate: true               # Claude auto-invokes agent when task loaded
---

# ============================================================================
# TASK HEADER
# ============================================================================

# DW-{WAVE}: {Task Title}

**Wave**: {DISCUSS|DESIGN|DISTILL|DEVELOP|DEMO|CROSS_WAVE}
**Agent**: {PersonaName} ({agent-id})
**Command**: `*{command-name}`

## Overview

{2-3 paragraph description of:
 - What this wave/task accomplishes
 - Its role in nWave methodology (or cross-wave support)
 - Key outcomes and value delivered}

# ============================================================================
# CONTEXT FILES SECTION (CRITICAL FOR PERFORMANCE)
# ============================================================================
# Pre-discovered file paths provided to agent (40% token reduction vs agent search)

## Context Files Required

- {file-path-1} - {purpose/description}
- {file-path-2} - {purpose/description}
- {file-path-3} - {purpose/description}

# Examples:
# - docs/project-brief.md - Project context and objectives
# - docs/stakeholders.yaml - Stakeholder identification and roles
# - docs/architecture/constraints.md - Technical and business constraints

# ============================================================================
# PREVIOUS ARTIFACTS SECTION (Wave Handoff)
# ============================================================================
# Outputs from previous wave that this wave consumes

## Previous Artifacts (Wave Handoff)

- {artifact-path-from-previous-wave} - (from {PREVIOUS_WAVE} wave)
- {artifact-path-2} - (from {PREVIOUS_WAVE} wave)

# Examples:
# - docs/requirements/requirements.md - (from DISCUSS wave)
# - docs/architecture/system-design.md - (from DESIGN wave)
# - None (if this is the first wave - DISCUSS)

# ============================================================================
# AGENT INVOCATION (Explicit Context Handoff)
# ============================================================================
# Treat agent as function with explicit inputs (Agent-as-Function pattern)

## Agent Invocation

@{agent-id}

Execute *{command-name} for {feature-name}.

**Context Files:**
- {file-path-1}
- {file-path-2}
- {file-path-3}

**Previous Artifacts:**
- {artifact-from-previous-wave}

**Configuration:**
- {config-key}: {config-value}              # e.g., interactive: high
- {config-key-2}: {config-value-2}          # e.g., output_format: markdown
- {config-key-3}: {config-value-3}          # e.g., elicitation_depth: comprehensive

# ============================================================================
# SUCCESS CRITERIA (Reference to Agent's Quality Gates)
# ============================================================================
# Do NOT duplicate full quality gates here - reference agent specification

## Success Criteria

Refer to {PersonaName} agent's quality gates in nWave/agents/{agent-id}.md.

**Key Validations:**
- [ ] {critical-validation-1}               # e.g., Requirements completeness > 0.95
- [ ] {critical-validation-2}               # e.g., Stakeholder consensus achieved
- [ ] {critical-validation-3}               # e.g., Handoff accepted by next agent

# ============================================================================
# NEXT WAVE HANDOFF
# ============================================================================
# Coordination with next wave agent

## Next Wave

**Handoff To**: {next-agent-id}             # e.g., solution-architect (DESIGN wave)
**Deliverables**: See {agent-name} agent's handoff package specification

# Expected outputs (reference only - details in agent spec):
# - {deliverable-1}.md
# - {deliverable-2}.md

# ============================================================================
# TEMPLATE USAGE NOTES
# ============================================================================
#
# VARIABLE SUBSTITUTION GUIDE:
#
# Wave Variables:
#   {WAVE} â†’ DISCUSS | DESIGN | DISTILL | DEVELOP | DEMO | CROSS_WAVE
#   {PREVIOUS_WAVE} â†’ Previous wave in sequence (or "None" for DISCUSS)
#
# Agent Variables:
#   {agent-id} â†’ Kebab-case agent identifier (e.g., business-analyst)
#   {PersonaName} â†’ Friendly agent name (e.g., Riley, Quinn, Crafty)
#   {command-name} â†’ Primary agent command (e.g., gather-requirements)
#
# Context Variables:
#   {file-path-N} â†’ Absolute or relative file paths
#   {artifact-path} â†’ Output file paths from previous waves
#   {feature-name} â†’ Feature or capability being implemented
#
# Configuration Variables:
#   {config-key} â†’ Configuration parameter name
#   {config-value} â†’ Configuration parameter value
#
# BEST PRACTICES:
#
# 1. **Minimize Duplication**: Workflow instructions belong in agent files only
# 2. **Context Bundling**: Pre-discover files before agent invocation (40% token savings)
# 3. **Explicit Handoff**: Provide context files, previous artifacts, configuration
# 4. **Reference Quality Gates**: Link to agent spec, don't duplicate full checklists
# 5. **Target Size**: 50-60 lines (excluding comments and template notes)
#
# PERFORMANCE OPTIMIZATION:
#
# WITHOUT explicit context â†’ Agent spends 5-10 tool calls searching (1500 tokens)
# WITH explicit context â†’ Agent starts immediately (650 tokens, 40% reduction)
#
# MIGRATION FROM CURRENT TASKS:
#
# Current tasks: 500-2000 lines (95% workflow duplication)
# New tasks: 50-60 lines (100% delegation, 0% duplication)
# Reduction: 90-97% code elimination, workflows moved to agent files
#
# RELATED TEMPLATES:
#
# - AGENT_TEMPLATE.yaml: Complete agent specification structure
# - context-bundles.yaml: Pre-defined file sets per wave (if created)
# - wave-configs.yaml: Wave-specific configuration templates (if created)
#
# RESEARCH SOURCES:
#
# - docs/research/claude-code-subagent-activation-best-practices.md (2025-10-07)
# - data/research/command-template-analysis-2026-01-20.md (Latest analysis)
#
# ============================================================================
# ANTI-PATTERNS TO AVOID (Evidence-Based)
# ============================================================================
#
# Analysis date: 2026-01-20
# Evidence: 20 nWave command files, 8,334 total lines analyzed
# Finding: 80% of commands exceeded 60-line target (average violation: 7x target)
# Root cause: Embedded workflows that belong in agent files
#
# DO NOT INCLUDE IN COMMAND FILES:
#
# âŒ Multi-step workflow instructions ("STEP 1, STEP 2, STEP 3...")
#    Evidence: 42 occurrences across 7 files
#    â†’ Location: Agent activation_instructions section
#
# âŒ Progress tracking and state management logic
#    Evidence: 224 occurrences (highest frequency violation)
#    â†’ Location: Orchestrator agent or infrastructure layer
#
# âŒ Orchestration coordination ("YOU ARE THE COORDINATOR")
#    Evidence: 64 occurrences across 9 files
#    â†’ Location: Orchestrator agent specification
#
# âŒ Task tool invocation details and examples
#    Evidence: 33 occurrences across 7 files
#    â†’ Location: Orchestrator agent implementation guide
#
# âŒ Parameter parsing and validation procedures
#    Evidence: 13 occurrences across 7 files
#    â†’ Location: Command parser infrastructure
#
# âŒ Error handling workflows and recovery logic
#    Evidence: 27 occurrences across 7 files
#    â†’ Location: Agent error handling protocols
#
# âŒ Detailed quality gate checklists
#    Evidence: 6 validation checklist duplications
#    â†’ Location: Agent specification, reference only in commands
#
# VIOLATION EXAMPLES FROM ANALYSIS:
#
# - develop.md: 2,360 lines (39x target) - massive orchestration embedded
# - split.md: 1,532 lines (26x target) - task generation workflow embedded
# - baseline.md: 779 lines (13x target) - measurement protocol embedded
#
# REMEMBER: Commands are DELEGATION files, not IMPLEMENTATION files
# External validation: CLI best practices (clig.dev) recommend atomic commands
#
# ============================================================================
# DELEGATION PRINCIPLE (CRITICAL)
# ============================================================================
#
# Commands follow the "Agent as Function" pattern:
#
# 1. EXPLICIT INPUTS (Required):
#    - User command/request (natural language)
#    - Context files (pre-discovered file paths with descriptions)
#    - Configuration parameters (runtime settings)
#    - Previous artifacts (wave handoff from prior agents)
#
# 2. AGENT EXECUTION (Delegated to agent file):
#    - Agent reads provided context (no searching required)
#    - Agent executes workflow (defined in agent activation_instructions)
#    - Agent produces outputs (per agent contract specification)
#
# 3. HANDOFF PACKAGE (Output):
#    - Deliverables for next agent/wave
#    - Validation status
#    - Quality gate results
#
# MEASURED PERFORMANCE IMPACT:
#
# Without explicit context handoff:
#   - Agent uses ~1,500 tokens searching for files (5-10 tool calls)
#   - Execution time: increased by file discovery overhead
#
# With explicit context handoff:
#   - Agent starts immediately with ~650 tokens (40% reduction)
#   - Execution time: optimized (no discovery phase)
#
# Source: claude-code-subagent-activation-best-practices.md
#
# Command file provides INPUTS and REFERENCES workflow.
# Agent file contains WORKFLOW IMPLEMENTATION.
#
# ============================================================================
# ORCHESTRATOR BRIEFING SECTION (MANDATORY)
# ============================================================================
#
# ðŸš¨ CRITICAL ARCHITECTURAL CONSTRAINT:
# Sub-agents launched via Task tool have NO ACCESS to the Skill tool.
# They can ONLY use: Read, Write, Edit, Bash, Glob, Grep
#
# This means agents CANNOT:
# - Invoke /nw:* commands
# - Access any Skills
# - Call other agents
#
# WHY THIS MATTERS:
# If a command says "Agent should invoke /nw:review", the agent will
# receive that text but cannot execute it. The agent completes without
# performing the review because it has no mechanism to run the command.
#
# REQUIRED IN EVERY COMMAND FILE:
# Each command MUST include an "## Orchestrator Briefing" section that tells
# the orchestrator (main Claude instance) EXACTLY what to communicate to
# agents when delegating via Task tool.
#
# ORCHESTRATOR BRIEFING TEMPLATE:
#
# ## Orchestrator Briefing
#
# When delegating this command to an agent via Task tool, the orchestrator MUST:
#
# 1. **Read this command file** and extract all workflow details
# 2. **Create a complete agent prompt** that includes:
#    - All context files content (not just paths)
#    - All step/task details inline
#    - Complete workflow instructions embedded
#    - Expected outputs explicitly stated
# 3. **Do NOT reference any /nw:* commands** in the agent prompt
# 4. **Do NOT assume the agent can call other agents or skills**
#
# ### Agent Prompt Template for {command-name}
#
# ```text
# You are a {agent-name} agent executing {task-description}.
#
# CONTEXT:
# {full content of all context files, embedded inline}
#
# TASK DETAILS:
# {step file content or task specification, embedded inline}
#
# INSTRUCTIONS:
# {complete workflow instructions - do NOT reference /nw:* commands}
#
# EXPECTED OUTPUTS:
# {explicit list of deliverables}
#
# QUALITY GATES:
# {validation criteria inline - do NOT say "run /nw:review"}
# ```
#
# ANTI-PATTERNS (NEVER INCLUDE IN COMMANDS OR AGENT PROMPTS):
# âŒ "Agent should invoke /nw:review"
# âŒ "Use /nw:execute to process the step"
# âŒ "After completion, run /nw:finalize"
# âŒ Any reference to agents calling skills or commands
# âŒ Assuming agents have access to anything beyond basic tools
#
# CORRECT PATTERNS:
# âœ… "Orchestrator should read /nw:review and embed review criteria in prompt"
# âœ… "Provide agent with complete workflow instructions inline"
# âœ… "Agent prompt must contain full file content, not just paths"
# âœ… "Include all quality gate criteria directly in the prompt"
#
# ============================================================================
# TEMPLATE COMPLIANCE CHECKLIST
# ============================================================================
#
# Before committing a command file, verify ALL items:
#
# SIZE COMPLIANCE:
# - [ ] Total lines â‰¤ 60 (excluding comments and template notes)
# - [ ] If >60 lines, workflow sections moved to agent file?
#
# CONTENT COMPLIANCE (Anti-Pattern Check):
# - [ ] No "STEP 1, STEP 2" procedural workflows
# - [ ] No orchestration coordination logic
# - [ ] No progress tracking implementation
# - [ ] No Task tool invocation tutorials
# - [ ] No parameter parsing procedures
# - [ ] No error handling workflows
# - [ ] Quality gates referenced, not duplicated
#
# DELEGATION COMPLIANCE:
# - [ ] Context files explicitly listed (with descriptions)
# - [ ] Configuration parameters defined
# - [ ] Previous artifacts identified (wave handoff)
# - [ ] Agent invocation uses explicit inputs pattern
#
# ORCHESTRATOR BRIEFING COMPLIANCE (CRITICAL):
# - [ ] Contains "## Orchestrator Briefing" section
# - [ ] Includes agent prompt template with inline content placeholders
# - [ ] NO references to agents invoking /nw:* commands
# - [ ] NO assumptions that agents can call skills
# - [ ] Quality gates embedded inline (not "run /nw:review")
# - [ ] All workflow instructions inline (not "see /nw:execute")
#
# QUALITY VALIDATION:
# - [ ] Command file is pure delegation (50-60 lines)
# - [ ] All workflow details in agent file
# - [ ] No duplication between command and agent files
#
# If any checklist item fails, REFACTOR before committing.
#
# COMPLIANCE RATE TARGET: 100% (currently 20% as of 2026-01-20 analysis)
#
# ============================================================================
