name: AI-Craft CI/CD Pipeline

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main]

jobs:
  matrix-build:
    name: Matrix Build Validation
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: true

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          echo "Building on ${{ matrix.os }}"
          echo "Build platform: ${{ runner.os }}"

      - name: Validate platform-specific setup
        run: |
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            echo "‚úÖ Linux environment configured"
            lsb_release -a || echo "Linux version info unavailable"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            echo "‚úÖ macOS environment configured"
            sw_vers
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "‚úÖ Windows environment configured"
            [[ $(uname -s) == MINGW* ]] && echo "Git Bash detected" || echo "Windows shell detected"
          fi
        shell: bash

      - name: Test Installer Dry-Run (Unix Only)
        if: runner.os != 'Windows'
        run: |
          chmod +x scripts/test-installer-unix.sh
          scripts/test-installer-unix.sh
        shell: bash

  quality-gates:
    name: Quality Gates Validation
    runs-on: ubuntu-latest
    needs: matrix-build

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Validate Shell Scripts
        run: |
          echo "::group::Shell Script Validation"

          # Find and validate all shell scripts
          echo "Validating shell script syntax..."
          find scripts -name "*.sh" -type f | while read -r script; do
            echo "Checking: $script"
            bash -n "$script" || exit 1
          done

          # Linting with shellcheck if available
          if command -v shellcheck >/dev/null 2>&1; then
            echo "Running shellcheck analysis..."
            find scripts -name "*.sh" -type f | xargs shellcheck -x || true
          fi

          echo "::endgroup::"

      - name: Security Validation
        run: |
          echo "::group::Security Validation"

          echo "Security vulnerability scanning..."

          # Check for hardcoded secrets
          if grep -rE "(password|secret|token)[[:space:]]*=[[:space:]]*['\"][^'\"]+['\"]" scripts/ --include="*.sh" 2>/dev/null | grep -v "example\|test\|comment\|TODO"; then
            echo "‚ö†Ô∏è Potential hardcoded credentials detected - review required"
            exit 1
          fi

          echo "‚úÖ Security validation: No hardcoded credentials detected"
          echo "::endgroup::"

      - name: Validate Agent Definitions
        run: |
          echo "::group::Agent Validation"

          # Check that all agent markdown files exist
          agent_count=$(find nWave/agents -name "*.md" -type f | wc -l)
          echo "Found $agent_count agent definitions"

          if [[ $agent_count -lt 10 ]]; then
            echo "‚ö†Ô∏è Expected more agent definitions"
          else
            echo "‚úÖ Agent definitions found: $agent_count"
          fi

          echo "::endgroup::"

      - name: Validate Commands
        run: |
          echo "::group::Command Validation"

          # Check that command files exist
          command_count=$(find nWave/commands -name "*.md" -type f | wc -l)
          echo "Found $command_count command definitions"

          echo "‚úÖ Command definitions found: $command_count"
          echo "::endgroup::"

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check Documentation
        run: |
          echo "::group::Documentation Validation"

          # Check for essential documentation files
          documentation_files=(
            "README.md"
            "docs/installation/INSTALL.md"
          )

          for doc_file in "${documentation_files[@]}"; do
            if [[ -f "$doc_file" ]]; then
              echo "‚úÖ Found: $doc_file"
            else
              echo "‚ö†Ô∏è Missing documentation: $doc_file"
            fi
          done

          echo "::endgroup::"

  pipeline-completion:
    name: Pipeline Completion
    runs-on: ubuntu-latest
    needs: [matrix-build, quality-gates, documentation-check]
    if: always()

    steps:
      - name: Pipeline Summary
        run: |
          echo "::group::AI-Craft CI/CD Pipeline Summary"

          if [[ "${{ needs.matrix-build.result }}" == "success" &&
                "${{ needs.quality-gates.result }}" == "success" &&
                "${{ needs.documentation-check.result }}" == "success" ]]; then

            echo "üéâ AI-Craft CI/CD Pipeline: SUCCESS"
            echo "‚úÖ Matrix build validation passed (Ubuntu, macOS, Windows)"
            echo "‚úÖ All quality gates passed"
            echo "‚úÖ Documentation validated"
            echo ""
            echo "üöÄ System ready for deployment"

          else
            echo "‚ùå AI-Craft CI/CD Pipeline: FAILED"
            echo "Results:"
            echo "  - Matrix Build: ${{ needs.matrix-build.result }}"
            echo "  - Quality Gates: ${{ needs.quality-gates.result }}"
            echo "  - Documentation: ${{ needs.documentation-check.result }}"
            exit 1
          fi

          echo "::endgroup::"
