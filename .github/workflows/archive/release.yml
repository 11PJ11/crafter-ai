name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.2.70

permissions:
  contents: write  # Required to create releases

jobs:
  build-and-release:
    name: Build Framework and Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper versioning

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML

      - name: Extract Version from Tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build nWave Framework
        run: |
          echo "Building nWave IDE bundle..."
          python tools/build.py

          # Verify build output
          if [ ! -d "dist/ide/agents/nw" ] || [ ! -d "dist/ide/commands/nw" ]; then
            echo "ERROR: Build failed - output directories not found"
            exit 1
          fi

          agent_count=$(find dist/ide/agents/nw -name "*.md" | wc -l)
          command_count=$(find dist/ide/commands/nw -name "*.md" | wc -l)

          echo "Built framework with:"
          echo "  - $agent_count agents"
          echo "  - $command_count commands"

          if [ $agent_count -lt 20 ] || [ $command_count -lt 15 ]; then
            echo "ERROR: Insufficient agents or commands built"
            exit 1
          fi

      - name: Create Release Packages
        run: |
          echo "Creating distributable packages..."
          python tools/create_release_packages.py --version ${{ steps.get_version.outputs.version }}

          # Verify packages were created
          if [ ! -f "dist/releases/nwave-claude-code-${{ steps.get_version.outputs.version }}.tar.gz" ]; then
            echo "ERROR: Claude Code package not created"
            exit 1
          fi

          if [ ! -f "dist/releases/install-nwave-claude-code.py" ]; then
            echo "ERROR: Installer not found"
            exit 1
          fi

          echo "Packages created successfully:"
          ls -lh dist/releases/

      - name: Generate Changelog
        id: changelog
        run: |
          # Extract version-specific changelog from RELEASE_NOTES if it exists
          if [ -f "dist/releases/RELEASE_NOTES_${{ steps.get_version.outputs.version }}.md" ]; then
            cp "dist/releases/RELEASE_NOTES_${{ steps.get_version.outputs.version }}.md" CHANGELOG.md
          else
            # Generate basic changelog from recent commits
            echo "# nWave Framework Release ${{ steps.get_version.outputs.version }}" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "**Release Date:** $(date +%Y-%m-%d)" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "## Changes in this Release" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> CHANGELOG.md 2>/dev/null || echo "- Initial release" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "## Installation" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "Download and run the installer:" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo '```bash' >> CHANGELOG.md
            echo "curl -O https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/install-nwave-claude-code.py" >> CHANGELOG.md
            echo "python3 install-nwave-claude-code.py" >> CHANGELOG.md
            echo '```' >> CHANGELOG.md
          fi

          cat CHANGELOG.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: nWave Framework v${{ steps.get_version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            dist/releases/nwave-claude-code-${{ steps.get_version.outputs.version }}.tar.gz
            dist/releases/nwave-codex-${{ steps.get_version.outputs.version }}.tar.gz
            dist/releases/install-nwave-claude-code.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nwave-framework-${{ steps.get_version.outputs.version }}
          path: |
            dist/releases/*.tar.gz
            dist/releases/*.py
            dist/releases/*.md
          retention-days: 90

      - name: Release Summary
        run: |
          echo "::group::Release Summary"
          echo "âœ… nWave Framework v${{ steps.get_version.outputs.version }} released successfully!"
          echo ""
          echo "ðŸ“¦ Packages created:"
          echo "  - nwave-claude-code-${{ steps.get_version.outputs.version }}.tar.gz"
          echo "  - nwave-codex-${{ steps.get_version.outputs.version }}.tar.gz"
          echo "  - install-nwave-claude-code.py"
          echo ""
          echo "ðŸ”— Release URL:"
          echo "  https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.version }}"
          echo ""
          echo "ðŸ“¥ Quick Install:"
          echo "  curl -O https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/install-nwave-claude-code.py"
          echo "  python3 install-nwave-claude-code.py"
          echo "::endgroup::"
