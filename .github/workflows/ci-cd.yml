# =============================================================================
# nWave Framework CI/CD Pipeline
# =============================================================================
#
# Purpose: Comprehensive continuous integration and automated release workflow
#
# Triggers:
#   - push/PR: Run full test suite and validation
#   - version tags (v*): Additionally create GitHub release with artifacts
#
# Quality Gates:
#   1. Pre-commit hooks validation
#   2. Pytest suite (246 tests) with coverage
#   3. Agent name synchronization verification
#   4. YAML validation (framework-catalog.yaml)
#   5. Documentation version consistency
#   6. Cross-platform compatibility (Linux, Windows, macOS)
#   7. Multi-Python version testing (3.8, 3.10, 3.12)
#
# Release Artifacts:
#   - nwave-claude-code-{version}.tar.gz
#   - nwave-codex-{version}.tar.gz
#   - install-nwave-claude-code.py
#   - SHA256 checksums
#
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches:
      - master
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - master
      - develop

# Required permissions for releases
permissions:
  contents: write
  pull-requests: read

# Environment variables shared across jobs
env:
  PYTHON_DEFAULT: '3.12'
  CACHE_VERSION: v1

jobs:
  # ===========================================================================
  # JOB 1: Continuous Integration - Multi-platform, Multi-version Testing
  # ===========================================================================
  ci:
    name: CI - Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false  # Complete all matrix combinations even if one fails
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.10', '3.12']

    steps:
      # -----------------------------------------------------------------------
      # Setup Phase
      # -----------------------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version analysis

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements*.txt
            **/requirements*.txt

      # -----------------------------------------------------------------------
      # Dependency Installation
      # -----------------------------------------------------------------------
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/Library/Caches/pip
            ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-pip-

      - name: Install core dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip install pytest pytest-cov pyyaml

      - name: Install project dependencies (if requirements.txt exists)
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        shell: bash
        continue-on-error: true  # Not all projects may have requirements.txt

      - name: Install pre-commit
        run: pip install pre-commit

      # -----------------------------------------------------------------------
      # Quality Gate 1: Pre-commit Hooks Validation
      # -----------------------------------------------------------------------
      - name: Run pre-commit hooks
        run: |
          pre-commit run --all-files --show-diff-on-failure
        continue-on-error: false

      # -----------------------------------------------------------------------
      # Quality Gate 2: Agent Name Synchronization
      # -----------------------------------------------------------------------
      - name: Verify agent name synchronization
        run: |
          python3 scripts/framework/sync_agent_names.py --verify
        shell: bash

      # -----------------------------------------------------------------------
      # Quality Gate 3: YAML Validation
      # -----------------------------------------------------------------------
      - name: Validate framework-catalog.yaml
        run: |
          python3 -c "
          import yaml
          import sys

          try:
              with open('nWave/framework-catalog.yaml', 'r') as f:
                  catalog = yaml.safe_load(f)

              # Verify required fields
              required_fields = ['name', 'version', 'description', 'agents', 'commands']
              missing = [f for f in required_fields if f not in catalog]

              if missing:
                  print(f'ERROR: Missing required fields in framework-catalog.yaml: {missing}')
                  sys.exit(1)

              # Verify version format (semantic versioning)
              import re
              version = catalog['version']
              if not re.match(r'^\d+\.\d+\.\d+$', version):
                  print(f'ERROR: Invalid version format: {version} (expected: MAJOR.MINOR.PATCH)')
                  sys.exit(1)

              print(f'âœ“ framework-catalog.yaml validation passed (version: {version})')

          except yaml.YAMLError as e:
              print(f'ERROR: Invalid YAML syntax in framework-catalog.yaml: {e}')
              sys.exit(1)
          except FileNotFoundError:
              print('ERROR: framework-catalog.yaml not found')
              sys.exit(1)
          "
        shell: bash

      # -----------------------------------------------------------------------
      # Quality Gate 4: Documentation Version Consistency
      # -----------------------------------------------------------------------
      - name: Verify documentation version consistency
        run: |
          python3 -c "
          import yaml
          import re
          import sys
          from pathlib import Path

          # Read version from framework-catalog.yaml
          with open('nWave/framework-catalog.yaml', 'r') as f:
              catalog_version = yaml.safe_load(f)['version']

          print(f'Framework version: {catalog_version}')

          # Check RELEASING.md version reference (if exists)
          releasing_md = Path('docs/RELEASING.md')
          if releasing_md.exists():
              content = releasing_md.read_text()
              # Extract version from first version comment
              match = re.search(r'<!-- version: ([\d.]+) -->', content)
              if match:
                  doc_version = match.group(1)
                  if doc_version != catalog_version:
                      print(f'WARNING: RELEASING.md version ({doc_version}) differs from framework version ({catalog_version})')
                      # Not failing - just warning
              else:
                  print('INFO: No version marker found in RELEASING.md')

          print('âœ“ Version consistency check completed')
          "
        shell: bash

      # -----------------------------------------------------------------------
      # Quality Gate 5: Pytest Test Suite (246 tests)
      # -----------------------------------------------------------------------
      - name: Run pytest test suite with coverage
        run: |
          pytest tests/ \
            --verbose \
            --tb=short \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --junitxml=test-results-${{ matrix.os }}-py${{ matrix.python-version }}.xml
        shell: bash

      # -----------------------------------------------------------------------
      # Artifact Upload (Test Results and Coverage)
      # -----------------------------------------------------------------------
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: test-results-*.xml
          retention-days: 14

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            coverage.xml
            htmlcov/
          retention-days: 14

      # -----------------------------------------------------------------------
      # CI Summary
      # -----------------------------------------------------------------------
      - name: CI Summary
        if: always()
        run: |
          echo "## CI Summary - Python ${{ matrix.python-version }} on ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All quality gates passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-commit validation" >> $GITHUB_STEP_SUMMARY
          echo "- Agent name synchronization" >> $GITHUB_STEP_SUMMARY
          echo "- YAML structure validation" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation version check" >> $GITHUB_STEP_SUMMARY
          echo "- Pytest suite (246 tests)" >> $GITHUB_STEP_SUMMARY
        shell: bash

  # ===========================================================================
  # JOB 2: Build Framework (Only on Version Tags)
  # ===========================================================================
  build:
    name: Build Framework Distribution
    needs: ci
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT }}
          cache: 'pip'

      - name: Install build dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip install pyyaml

      # -----------------------------------------------------------------------
      # Extract Version from Tag
      # -----------------------------------------------------------------------
      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"
        shell: bash

      # -----------------------------------------------------------------------
      # Verify Version Matches framework-catalog.yaml
      # -----------------------------------------------------------------------
      - name: Verify version consistency
        run: |
          TAG_VERSION="${{ steps.get_version.outputs.VERSION }}"
          CATALOG_VERSION=$(python3 -c "import yaml; print(yaml.safe_load(open('nWave/framework-catalog.yaml'))['version'])")

          echo "Tag version: ${TAG_VERSION}"
          echo "Catalog version: ${CATALOG_VERSION}"

          if [ "$TAG_VERSION" != "$CATALOG_VERSION" ]; then
            echo "ERROR: Version mismatch!"
            echo "  Tag version: ${TAG_VERSION}"
            echo "  framework-catalog.yaml version: ${CATALOG_VERSION}"
            echo ""
            echo "Update nWave/framework-catalog.yaml to match tag version before releasing."
            exit 1
          fi

          echo "âœ“ Version consistency verified: ${TAG_VERSION}"

      # -----------------------------------------------------------------------
      # Build IDE Bundle
      # -----------------------------------------------------------------------
      - name: Build IDE bundle
        run: |
          python3 tools/core/build_ide_bundle.py \
            --source-dir nWave \
            --output-dir dist/ide \
            --clean \
            --verbose
        shell: bash

      # -----------------------------------------------------------------------
      # Create Release Packages
      # -----------------------------------------------------------------------
      - name: Create release packages
        run: |
          # Check if release packager exists
          if [ -f "tools/core/release_packager.py" ]; then
            python3 tools/core/release_packager.py \
              --version ${{ steps.get_version.outputs.VERSION }} \
              --output-dir dist/releases
          elif [ -f "scripts/framework/release_package.py" ]; then
            python3 scripts/framework/release_package.py \
              --version ${{ steps.get_version.outputs.VERSION }} \
              --output-dir dist/releases
          else
            echo "WARNING: No release packager found - creating basic tar.gz"
            mkdir -p dist/releases
            tar -czf dist/releases/nwave-claude-code-${{ steps.get_version.outputs.VERSION }}.tar.gz \
              -C dist/ide .
            tar -czf dist/releases/nwave-codex-${{ steps.get_version.outputs.VERSION }}.tar.gz \
              -C dist/ide .
          fi
        shell: bash

      # -----------------------------------------------------------------------
      # Generate SHA256 Checksums
      # -----------------------------------------------------------------------
      - name: Generate checksums
        run: |
          cd dist/releases
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt
        shell: bash

      # -----------------------------------------------------------------------
      # Upload Build Artifacts
      # -----------------------------------------------------------------------
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: dist/releases/*
          retention-days: 90

  # ===========================================================================
  # JOB 3: Create GitHub Release (Only on Version Tags)
  # ===========================================================================
  release:
    name: Create GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-packages
          path: dist/releases

      # -----------------------------------------------------------------------
      # Extract Version
      # -----------------------------------------------------------------------
      - name: Extract version
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      # -----------------------------------------------------------------------
      # Generate Release Notes
      # -----------------------------------------------------------------------
      - name: Generate release notes
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"

          cat > dist/releases/RELEASE_NOTES.md << 'EOF'
          # nWave Framework v${{ steps.get_version.outputs.VERSION }}

          ## Release Information

          - **Version**: ${{ steps.get_version.outputs.VERSION }}
          - **Release Date**: $(date +%Y-%m-%d)
          - **Methodology**: DISCUSS â†’ DESIGN â†’ DISTILL â†’ DEVELOP â†’ DELIVER

          ## What's Included

          This release contains the complete nWave framework with:

          - **Agents**: 15+ specialized agents for each wave
          - **Commands**: 20+ methodology commands
          - **Templates**: Interactive workflow templates
          - **Documentation**: Comprehensive guides and references

          ## Installation

          ### Claude Code

          ```bash
          # Download and install
          curl -O https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.VERSION }}/install-nwave-claude-code.py
          python install-nwave-claude-code.py
          ```

          ### Manual Installation

          ```bash
          # Download package
          wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.VERSION }}/nwave-claude-code-${{ steps.get_version.outputs.VERSION }}.tar.gz

          # Extract to Claude Code directory
          tar -xzf nwave-claude-code-${{ steps.get_version.outputs.VERSION }}.tar.gz -C ~/.claude/
          ```

          ## Verification

          ```bash
          # Verify checksums
          sha256sum -c SHA256SUMS.txt
          ```

          ## Documentation

          - [Installation Guide](https://github.com/${{ github.repository }}/blob/master/docs/installation/INSTALL.md)
          - [Quick Start](https://github.com/${{ github.repository }}/blob/master/README.md)
          - [Release Process](https://github.com/${{ github.repository }}/blob/master/docs/RELEASING.md)

          ## Quality Assurance

          This release has passed all quality gates:

          - âœ… 246 pytest tests (100% passing)
          - âœ… Pre-commit hooks validation
          - âœ… Cross-platform testing (Linux, Windows, macOS)
          - âœ… Multi-Python version (3.8, 3.10, 3.12)
          - âœ… Agent name synchronization
          - âœ… YAML structure validation
          - âœ… Documentation version consistency

          ---

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v$(python3 -c "v='${{ steps.get_version.outputs.VERSION }}'.split('.'); v[-1]=str(int(v[-1])-1); print('.'.join(v))")...v${{ steps.get_version.outputs.VERSION }}
          EOF

          cat dist/releases/RELEASE_NOTES.md
        shell: bash

      # -----------------------------------------------------------------------
      # Create GitHub Release
      # -----------------------------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: nWave Framework v${{ steps.get_version.outputs.VERSION }}
          body_path: dist/releases/RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-rc') || contains(github.ref, '-alpha') }}
          files: |
            dist/releases/*.tar.gz
            dist/releases/*.py
            dist/releases/SHA256SUMS.txt
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # Release Summary
      # -----------------------------------------------------------------------
      - name: Release Summary
        run: |
          echo "## Release Created Successfully ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- nwave-claude-code-${{ steps.get_version.outputs.VERSION }}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- nwave-codex-${{ steps.get_version.outputs.VERSION }}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- install-nwave-claude-code.py" >> $GITHUB_STEP_SUMMARY
          echo "- SHA256SUMS.txt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
