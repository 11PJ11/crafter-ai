---
project_id: "plugin-architecture"
feature_description: "Transform nWave installation system from hardcoded approach to modular plugin-based architecture with DES integration"
created_at: "2026-02-01T00:00:00Z"

implementation_scope:
  source_directories:
    - "scripts/install/"
    - "scripts/install/plugins/"
    - "nWave/scripts/des/"
    - "nWave/templates/"
  test_directories:
    - "tests/install/"
  documentation_directories:
    - "docs/installation/"
    - "docs/reference/"
    - "docs/development/"

phases:
  - phase_id: "01"
    name: "Plugin Infrastructure Creation"
    description: "Create base plugin classes, registry with topological sort, and context without modifying existing installer"
    objectives:
      - "Establish InstallationPlugin ABC interface"
      - "Implement PluginRegistry with Kahn's algorithm for dependency resolution"
      - "Define InstallContext with existing utility integration fields"
      - "Validate infrastructure with unit tests"
    success_criteria:
      - "Plugin infrastructure exists and is tested"
      - "install_nwave.py remains COMPLETELY UNCHANGED"
      - "Topological sort handles dependencies, cycles, and priorities correctly"
    estimated_hours: 4
    steps:
      - step_id: "01-01"
        name: "Create plugin package structure"
        description: "Create scripts/install/plugins/ directory with __init__.py and package exports"
        acceptance_criteria:
          - "scripts/install/plugins/ directory created"
          - "scripts/install/plugins/__init__.py exports PluginRegistry, InstallationPlugin, InstallContext, PluginResult"
          - "Package importable from install_nwave.py context"
        suggested_agent: "software-crafter"
        dependencies: []
        estimated_hours: 0.5
        files_to_modify:
          - "scripts/install/plugins/__init__.py"

      - step_id: "01-02"
        name: "Implement base plugin classes"
        description: "Create base.py with InstallationPlugin ABC, InstallContext dataclass, and PluginResult"
        acceptance_criteria:
          - "InstallationPlugin ABC with name(), install(), verify(), dependencies(), priority() methods"
          - "InstallContext dataclass includes claude_dir, scripts_dir, templates_dir, logger, dry_run"
          - "InstallContext includes backup_manager, installation_verifier, dist_dir, framework_source, project_root, rich_logger fields"
          - "PluginResult dataclass with success, message, details fields"
          - "All classes properly typed with type hints"
        suggested_agent: "software-crafter"
        dependencies: ["01-01"]
        estimated_hours: 1.5
        files_to_modify:
          - "scripts/install/plugins/base.py"

      - step_id: "01-03"
        name: "Implement PluginRegistry with topological sort"
        description: "Create registry.py with plugin registration and Kahn's algorithm for dependency resolution"
        acceptance_criteria:
          - "PluginRegistry can register() plugins by name"
          - "Topological sort (_topological_sort) implements Kahn's algorithm correctly"
          - "Sort respects plugin dependencies() declarations"
          - "Sort respects plugin priority() for ordering when no dependencies"
          - "Detects circular dependencies and raises ValueError with clear message"
          - "Detects missing dependencies and raises ValueError with clear message"
          - "install_all(context) orchestrates plugin installation in dependency order"
          - "verify_all(context) runs verification for all plugins"
        suggested_agent: "software-crafter"
        dependencies: ["01-02"]
        estimated_hours: 2
        files_to_modify:
          - "scripts/install/plugins/registry.py"

  - phase_id: "02"
    name: "Extract Implementation Functions (Circular Import Fix)"
    description: "Extract module-level functions from existing _install_* methods to enable plugin imports without circular dependencies (HIGH-02 fix)"
    objectives:
      - "Extract install_agents_impl() from _install_agents()"
      - "Extract install_commands_impl() from _install_commands()"
      - "Extract install_templates_impl() from _install_templates()"
      - "Extract install_utility_scripts_impl() from _install_utility_scripts()"
      - "Keep existing methods as thin wrappers calling extracted functions"
    success_criteria:
      - "All _install_* methods refactored to call module-level functions"
      - "Existing installer behavior UNCHANGED (same implementation, different structure)"
      - "Plugins can import functions without importing nWaveInstaller class"
      - "No circular dependency: install_nwave.py → plugins → extracted functions"
    estimated_hours: 3
    steps:
      - step_id: "02-01"
        name: "Extract install_agents_impl function"
        description: "Move _install_agents() implementation to module-level install_agents_impl() function, keep method as thin wrapper"
        acceptance_criteria:
          - "install_agents_impl(target_dir, framework_source, logger, backup_manager, dry_run) created"
          - "Function contains EXACT implementation from _install_agents()"
          - "_install_agents() method calls install_agents_impl() with self.* parameters"
          - "No behavioral changes - same files installed, same locations"
          - "Function can be imported without importing nWaveInstaller class"
        suggested_agent: "software-crafter"
        dependencies: ["01-03"]
        estimated_hours: 1
        files_to_modify:
          - "scripts/install/install_nwave.py"

      - step_id: "02-02"
        name: "Extract install_commands_impl function"
        description: "Move _install_commands() implementation to module-level install_commands_impl() function"
        acceptance_criteria:
          - "install_commands_impl(target_dir, framework_source, logger, backup_manager, dry_run) created"
          - "Function contains EXACT implementation from _install_commands()"
          - "_install_commands() method calls install_commands_impl()"
          - "No behavioral changes"
        suggested_agent: "software-crafter"
        dependencies: ["02-01"]
        estimated_hours: 0.5
        files_to_modify:
          - "scripts/install/install_nwave.py"

      - step_id: "02-03"
        name: "Extract install_templates_impl function"
        description: "Move _install_templates() implementation to module-level install_templates_impl() function"
        acceptance_criteria:
          - "install_templates_impl(target_dir, framework_source, logger, backup_manager, dry_run) created"
          - "Function contains EXACT implementation from _install_templates()"
          - "_install_templates() method calls install_templates_impl()"
          - "No behavioral changes"
        suggested_agent: "software-crafter"
        dependencies: ["02-02"]
        estimated_hours: 0.5
        files_to_modify:
          - "scripts/install/install_nwave.py"

      - step_id: "02-04"
        name: "Extract install_utility_scripts_impl function"
        description: "Move _install_utility_scripts() implementation to module-level install_utility_scripts_impl() function"
        acceptance_criteria:
          - "install_utility_scripts_impl(target_dir, framework_source, logger, backup_manager, dry_run) created"
          - "Function contains EXACT implementation from _install_utility_scripts()"
          - "_install_utility_scripts() method calls install_utility_scripts_impl()"
          - "No behavioral changes"
        suggested_agent: "software-crafter"
        dependencies: ["02-03"]
        estimated_hours: 0.5
        files_to_modify:
          - "scripts/install/install_nwave.py"

      - step_id: "02-05"
        name: "Validate extraction with integration tests"
        description: "Run existing installation tests to confirm no behavioral changes after function extraction"
        acceptance_criteria:
          - "All existing installation tests pass"
          - "Fresh install produces identical file tree as pre-extraction"
          - "Upgrade scenario produces identical result as pre-extraction"
          - "No regressions detected in verification checks"
        suggested_agent: "software-crafter"
        dependencies: ["02-04"]
        estimated_hours: 0.5
        files_to_modify: []

  - phase_id: "03"
    name: "Wrapper Plugin Creation"
    description: "Create thin wrapper plugins that call extracted implementation functions for existing components"
    objectives:
      - "Create AgentsPlugin wrapping install_agents_impl()"
      - "Create CommandsPlugin wrapping install_commands_impl()"
      - "Create TemplatesPlugin wrapping install_templates_impl()"
      - "Create UtilitiesPlugin wrapping install_utility_scripts_impl()"
      - "Reuse existing InstallationVerifier for plugin verification"
    success_criteria:
      - "All wrapper plugins created and tested"
      - "Plugins call extracted functions (no reimplementation)"
      - "Verification reuses existing InstallationVerifier methods"
      - "install_nwave.py still UNCHANGED (plugins not yet used)"
    estimated_hours: 6
    steps:
      - step_id: "03-01"
        name: "Create AgentsPlugin wrapper"
        description: "Implement AgentsPlugin that calls install_agents_impl() and uses InstallationVerifier for verification"
        acceptance_criteria:
          - "AgentsPlugin.name() returns 'agents'"
          - "AgentsPlugin.priority() returns 10 (foundational, no dependencies)"
          - "AgentsPlugin.dependencies() returns [] (no dependencies)"
          - "AgentsPlugin.install() calls install_agents_impl() with context parameters"
          - "AgentsPlugin.verify() uses context.installation_verifier._check_agents() if available"
          - "Fallback verification checks agents directory exists with minimum expected files"
          - "No reimplementation - purely wrapper around existing logic"
        suggested_agent: "software-crafter"
        dependencies: ["02-05"]
        estimated_hours: 1.5
        files_to_modify:
          - "scripts/install/plugins/agents_plugin.py"

      - step_id: "03-02"
        name: "Create CommandsPlugin wrapper"
        description: "Implement CommandsPlugin that calls install_commands_impl() and uses InstallationVerifier"
        acceptance_criteria:
          - "CommandsPlugin.name() returns 'commands'"
          - "CommandsPlugin.priority() returns 20 (depends on agent structure)"
          - "CommandsPlugin.dependencies() returns []"
          - "CommandsPlugin.install() calls install_commands_impl()"
          - "CommandsPlugin.verify() uses context.installation_verifier._check_commands()"
          - "No reimplementation - purely wrapper"
        suggested_agent: "software-crafter"
        dependencies: ["03-01"]
        estimated_hours: 1.5
        files_to_modify:
          - "scripts/install/plugins/commands_plugin.py"

      - step_id: "03-03"
        name: "Create TemplatesPlugin wrapper"
        description: "Implement TemplatesPlugin that calls install_templates_impl() and uses InstallationVerifier"
        acceptance_criteria:
          - "TemplatesPlugin.name() returns 'templates'"
          - "TemplatesPlugin.priority() returns 30 (standalone, no dependencies)"
          - "TemplatesPlugin.dependencies() returns []"
          - "TemplatesPlugin.install() calls install_templates_impl()"
          - "TemplatesPlugin.verify() uses context.installation_verifier._check_templates()"
          - "No reimplementation - purely wrapper"
        suggested_agent: "software-crafter"
        dependencies: ["03-02"]
        estimated_hours: 1.5
        files_to_modify:
          - "scripts/install/plugins/templates_plugin.py"

      - step_id: "03-04"
        name: "Create UtilitiesPlugin wrapper"
        description: "Implement UtilitiesPlugin that calls install_utility_scripts_impl() and uses InstallationVerifier"
        acceptance_criteria:
          - "UtilitiesPlugin.name() returns 'utilities'"
          - "UtilitiesPlugin.priority() returns 40 (used by DES scripts)"
          - "UtilitiesPlugin.dependencies() returns []"
          - "UtilitiesPlugin.install() calls install_utility_scripts_impl()"
          - "UtilitiesPlugin.verify() checks script presence and executability"
          - "No reimplementation - purely wrapper"
        suggested_agent: "software-crafter"
        dependencies: ["03-03"]
        estimated_hours: 1.5
        files_to_modify:
          - "scripts/install/plugins/utilities_plugin.py"

  - phase_id: "04"
    name: "Installer Switchover to Plugin System"
    description: "Modify install_framework() to use PluginRegistry while keeping existing methods as plugin backend"
    objectives:
      - "Replace hardcoded _install_*() calls with PluginRegistry orchestration"
      - "Create InstallContext with injected utilities (BackupManager, InstallationVerifier)"
      - "Keep existing _install_*() methods (plugins still call them)"
      - "Validate backward compatibility with integration tests"
    success_criteria:
      - "install_framework() uses PluginRegistry.install_all()"
      - "InstallContext properly injects backup_manager, installation_verifier, framework_source, rich_logger"
      - "Fresh install produces IDENTICAL result as pre-plugin version"
      - "Upgrade scenario works correctly"
      - "All existing tests pass"
    estimated_hours: 3
    steps:
      - step_id: "04-01"
        name: "Modify install_framework to use PluginRegistry"
        description: "Replace hardcoded installation calls with plugin registry orchestration"
        acceptance_criteria:
          - "install_framework() creates PluginRegistry instance"
          - "Registers AgentsPlugin, CommandsPlugin, TemplatesPlugin, UtilitiesPlugin"
          - "Creates InstallContext with all required fields (claude_dir, scripts_dir, templates_dir, logger, dry_run)"
          - "Injects backup_manager from self.backup_manager"
          - "Injects installation_verifier from self.installation_verifier"
          - "Injects framework_source from self.framework_source or Path('nWave')"
          - "Injects project_root from self.project_root or Path.cwd()"
          - "Injects rich_logger from self.rich_logger"
          - "Injects dist_dir, current_version, target_version"
          - "Calls registry.install_all(context) instead of individual _install_*() methods"
          - "Calls registry.verify_all(context) for verification"
          - "Existing _install_*() methods still present (called by plugins)"
        suggested_agent: "software-crafter"
        dependencies: ["03-04"]
        estimated_hours: 2
        files_to_modify:
          - "scripts/install/install_nwave.py"

      - step_id: "04-02"
        name: "Validate switchover with integration tests"
        description: "Run comprehensive integration tests comparing pre-plugin and post-plugin behavior"
        acceptance_criteria:
          - "Fresh install test: Compare file tree with baseline (must be identical)"
          - "Upgrade test: Verify backward compatibility from v1.6.x to v1.7.0"
          - "BackupManager still creates backups in ~/.claude/backups/"
          - "InstallationVerifier still validates all components"
          - "Version tracking still works correctly"
          - "Same verification output as pre-plugin installer"
          - "No regressions in any existing test"
        suggested_agent: "software-crafter"
        dependencies: ["04-01"]
        estimated_hours: 1
        files_to_modify:
          - "tests/install/test_full_installation.py"

  - phase_id: "05"
    name: "DES Plugin Implementation"
    description: "Create DESPlugin to install DES module, scripts, and templates, demonstrating extensibility without installer modifications"
    objectives:
      - "Implement DESPlugin with install() and verify() methods"
      - "Install DES Python module from src/des/ to ~/.claude/lib/python/des/"
      - "Install DES utility scripts (check_stale_phases.py, scope_boundary_check.py)"
      - "Install DES templates (.pre-commit-config-nwave.yaml, .des-audit-README.md)"
      - "Reuse BackupManager for DES module backup"
      - "Register DESPlugin with ONE LINE in install_framework()"
    success_criteria:
      - "DESPlugin successfully installs all DES components"
      - "DES module importable after installation"
      - "DES scripts present and executable"
      - "DES templates installed"
      - "Dependencies resolved (DES installed AFTER templates and utilities)"
      - "Only ONE line added to install_nwave.py: registry.register(DESPlugin())"
    prerequisites:
      - "src/des/ module exists (validated in design review)"
      - "nWave/scripts/des/check_stale_phases.py created"
      - "nWave/scripts/des/scope_boundary_check.py created"
      - "nWave/templates/.pre-commit-config-nwave.yaml created"
      - "nWave/templates/.des-audit-README.md created"
    estimated_hours: 5
    steps:
      - step_id: "05-01"
        name: "Create DES utility scripts (Prerequisites)"
        description: "Create check_stale_phases.py and scope_boundary_check.py DES utility scripts"
        acceptance_criteria:
          - "nWave/scripts/des/check_stale_phases.py created with StaleExecutionDetector integration"
          - "Script detects IN_PROGRESS phases abandoned for >N hours"
          - "Exit code 1 when stale phases detected, 0 otherwise"
          - "nWave/scripts/des/scope_boundary_check.py created with ScopeValidator integration"
          - "Script validates git staged files against roadmap.yaml implementation_scope"
          - "Exit code 1 when scope violations detected, 0 otherwise"
          - "Both scripts executable (chmod +x)"
          - "Both scripts include shebang and usage documentation"
        suggested_agent: "software-crafter"
        dependencies: ["04-02"]
        estimated_hours: 1.5
        files_to_modify:
          - "nWave/scripts/des/check_stale_phases.py"
          - "nWave/scripts/des/scope_boundary_check.py"

      - step_id: "05-02"
        name: "Create DES templates (Prerequisites)"
        description: "Create .pre-commit-config-nwave.yaml and .des-audit-README.md templates"
        acceptance_criteria:
          - "nWave/templates/.pre-commit-config-nwave.yaml created"
          - "Template includes hooks for check_stale_phases, scope_boundary_check, validate_step_file"
          - "Template includes standard pre-commit hooks (trailing-whitespace, end-of-file-fixer, check-yaml, check-json)"
          - "nWave/templates/.des-audit-README.md created"
          - "README documents audit trail structure (audit-YYYY-MM-DD.log)"
          - "README documents event types (TASK_INVOCATION_STARTED, PHASE_STARTED, SCOPE_VIOLATION, TIMEOUT_WARNING)"
          - "README includes query examples (grep, jq)"
          - "README documents retention policy (90 days)"
        suggested_agent: "software-crafter"
        dependencies: ["05-01"]
        estimated_hours: 1
        files_to_modify:
          - "nWave/templates/.pre-commit-config-nwave.yaml"
          - "nWave/templates/.des-audit-README.md"

      - step_id: "05-03"
        name: "Implement DESPlugin"
        description: "Create DESPlugin with _install_des_module, _install_des_scripts, _install_des_templates methods"
        acceptance_criteria:
          - "DESPlugin.name() returns 'des'"
          - "DESPlugin.priority() returns 50 (after utilities)"
          - "DESPlugin.dependencies() returns ['templates', 'utilities']"
          - "_install_des_module() copies src/des/ to ~/.claude/lib/python/des/"
          - "Uses context.backup_manager for backup if DES module already exists"
          - "Supports dist_dir fallback (dist/ide/lib/python/des/) for build pipeline integration"
          - "_install_des_scripts() copies check_stale_phases.py, scope_boundary_check.py to ~/.claude/scripts/"
          - "Uses framework_source context field for script source location"
          - "_install_des_templates() copies .pre-commit-config-nwave.yaml, .des-audit-README.md to ~/.claude/templates/"
          - "verify() checks DES module importable via subprocess test"
          - "verify() checks scripts present and executable"
          - "verify() checks templates present"
        suggested_agent: "software-crafter"
        dependencies: ["05-02"]
        estimated_hours: 2
        files_to_modify:
          - "scripts/install/plugins/des_plugin.py"

      - step_id: "05-04"
        name: "Register DESPlugin in installer"
        description: "Add ONE line to install_framework() to register DESPlugin"
        acceptance_criteria:
          - "Import statement added: from scripts.install.plugins.des_plugin import DESPlugin"
          - "Registration line added: registry.register(DESPlugin())"
          - "NO other changes to install_framework()"
          - "Plugin automatically installed AFTER templates and utilities (dependency resolution)"
        suggested_agent: "software-crafter"
        dependencies: ["05-03"]
        estimated_hours: 0.5
        files_to_modify:
          - "scripts/install/install_nwave.py"

  - phase_id: "06"
    name: "InstallationVerifier DES Integration"
    description: "Extend InstallationVerifier with DES verification checks"
    objectives:
      - "Add DESVerificationChecks class to installation_verifier.py"
      - "Implement verify_des_module(), verify_des_scripts(), verify_des_templates() methods"
      - "Integrate DES checks into run_verification() success criteria"
      - "Update verification output table to include DES component status"
    success_criteria:
      - "DESVerificationChecks implemented and tested"
      - "DES verification integrated into overall success criteria"
      - "Verification table shows DES Module, DES Scripts, DES Templates status"
      - "Installation fails if DES components missing or broken"
    estimated_hours: 2
    steps:
      - step_id: "06-01"
        name: "Create DESVerificationChecks class"
        description: "Add DESVerificationChecks class to installation_verifier.py with DES-specific verification methods"
        acceptance_criteria:
          - "DESVerificationChecks class created in installation_verifier.py"
          - "verify_des_module() tests DES import via subprocess (import des.application)"
          - "verify_des_scripts() checks presence of check_stale_phases.py, scope_boundary_check.py"
          - "verify_des_templates() checks presence of .pre-commit-config-nwave.yaml, .des-audit-README.md"
          - "Methods return boolean indicating success"
          - "Clear error messages logged when verification fails"
        suggested_agent: "software-crafter"
        dependencies: ["05-04"]
        estimated_hours: 1
        files_to_modify:
          - "scripts/install/installation_verifier.py"

      - step_id: "06-02"
        name: "Integrate DES verification into run_verification"
        description: "Update run_verification() to include DES checks in success criteria and output table"
        acceptance_criteria:
          - "run_verification() calls DESVerificationChecks methods"
          - "Success criteria updated: success = (len(missing_essential) == 0 and manifest_exists and des_module_ok and len(des_scripts_missing) == 0 and des_templates_ok)"
          - "Verification table includes rows for 'DES Module', 'DES Scripts', 'DES Templates'"
          - "DES component status shown with ✅ OK or ❌ MISSING"
          - "Overall installation fails if any DES verification fails"
        suggested_agent: "software-crafter"
        dependencies: ["06-01"]
        estimated_hours: 1
        files_to_modify:
          - "scripts/install/installation_verifier.py"

  - phase_id: "07"
    name: "Comprehensive Testing"
    description: "Create exhaustive test suite covering plugin infrastructure, wrapper plugins, DES plugin, and integration scenarios"
    objectives:
      - "Unit test all plugin components (base, registry, each plugin)"
      - "Integration test fresh install and upgrade scenarios"
      - "Adversarial test error handling (cycles, missing deps, failures)"
      - "Regression test backward compatibility (pre-plugin vs post-plugin)"
      - "Performance test topological sort with large plugin counts"
    success_criteria:
      - "100% test coverage for plugin infrastructure"
      - "All integration tests pass (fresh install, upgrade)"
      - "All adversarial tests pass (error conditions handled)"
      - "No regressions detected (identical behavior)"
      - "Performance tests pass (topological sort < 100ms for 100 plugins)"
    estimated_hours: 5
    steps:
      - step_id: "07-01"
        name: "Unit test PluginRegistry"
        description: "Create comprehensive unit tests for PluginRegistry topological sort and dependency resolution"
        acceptance_criteria:
          - "test_topological_sort_simple() verifies dependency ordering"
          - "test_topological_sort_priority() verifies priority-based ordering when no dependencies"
          - "test_dependency_cycle_detection() verifies ValueError raised for circular dependencies"
          - "test_missing_dependency() verifies ValueError raised for unregistered dependencies"
          - "test_install_all() verifies successful orchestration of multiple plugins"
          - "test_verify_all() verifies verification runs for all plugins"
          - "All tests pass"
        suggested_agent: "software-crafter"
        dependencies: ["06-02"]
        estimated_hours: 1.5
        files_to_modify:
          - "tests/install/test_plugin_registry.py"

      - step_id: "07-02"
        name: "Unit test wrapper plugins"
        description: "Create unit tests for AgentsPlugin, CommandsPlugin, TemplatesPlugin, UtilitiesPlugin"
        acceptance_criteria:
          - "test_agents_plugin_install() verifies calls to install_agents_impl()"
          - "test_agents_plugin_verify() verifies integration with InstallationVerifier"
          - "test_commands_plugin_install() verifies calls to install_commands_impl()"
          - "test_templates_plugin_install() verifies calls to install_templates_impl()"
          - "test_utilities_plugin_install() verifies calls to install_utility_scripts_impl()"
          - "test_plugin_dependencies() verifies dependency declarations"
          - "test_plugin_priorities() verifies priority values"
          - "All tests pass"
        suggested_agent: "software-crafter"
        dependencies: ["07-01"]
        estimated_hours: 1.5
        files_to_modify:
          - "tests/install/test_agents_plugin.py"
          - "tests/install/test_commands_plugin.py"
          - "tests/install/test_templates_plugin.py"
          - "tests/install/test_utilities_plugin.py"

      - step_id: "07-03"
        name: "Unit test DESPlugin"
        description: "Create unit tests for DESPlugin installation and verification"
        acceptance_criteria:
          - "test_des_plugin_install_module() verifies DES module installation"
          - "test_des_plugin_install_scripts() verifies script installation"
          - "test_des_plugin_install_templates() verifies template installation"
          - "test_des_plugin_verify() verifies DES verification checks"
          - "test_des_plugin_dependencies() verifies DESPlugin declares ['templates', 'utilities']"
          - "test_des_plugin_backup_integration() verifies BackupManager usage"
          - "All tests pass"
        suggested_agent: "software-crafter"
        dependencies: ["07-02"]
        estimated_hours: 1
        files_to_modify:
          - "tests/install/test_des_plugin.py"

      - step_id: "07-04"
        name: "Integration test full installation"
        description: "Create end-to-end integration tests for fresh install and upgrade scenarios"
        acceptance_criteria:
          - "test_fresh_install_with_plugins() verifies complete installation from scratch"
          - "Verifies all core components installed (agents, commands, templates, utilities)"
          - "Verifies DES components installed (module, scripts, templates)"
          - "Verifies DES module importable via subprocess test"
          - "test_upgrade_from_pre_plugin_version() verifies backward compatibility"
          - "Simulates existing v1.6.x installation"
          - "Runs v1.7.0 installer"
          - "Verifies existing components preserved"
          - "Verifies DES components added"
          - "test_plugin_execution_order() verifies dependency resolution produces correct order"
          - "All tests pass"
        suggested_agent: "software-crafter"
        dependencies: ["07-03"]
        estimated_hours: 1
        files_to_modify:
          - "tests/install/test_full_installation.py"

  - phase_id: "08"
    name: "Documentation and Deployment"
    description: "Update documentation, create deployment artifacts, and prepare release v1.7.0"
    objectives:
      - "Update installation-guide.md with DES section"
      - "Create des-audit-trail-guide.md reference documentation"
      - "Create plugin-development-guide.md for contributors"
      - "Update CHANGELOG.md for v1.7.0"
      - "Create migration guide for users"
      - "Version bump to 1.7.0"
    success_criteria:
      - "All documentation updated and reviewed"
      - "CHANGELOG.md includes comprehensive v1.7.0 notes"
      - "Migration guide covers backward compatibility guarantees"
      - "Version bumped to 1.7.0"
      - "Release notes ready for deployment"
    estimated_hours: 4
    steps:
      - step_id: "08-01"
        name: "Update installation guide with DES section"
        description: "Add comprehensive DES documentation to docs/installation/installation-guide.md"
        acceptance_criteria:
          - "New section 'DES (Deterministic Execution System)' added after 'What Gets Installed'"
          - "Documents DES module location (~/.claude/lib/python/des/)"
          - "Documents DES utility scripts (check_stale_phases.py, scope_boundary_check.py)"
          - "Documents DES templates (.pre-commit-config-nwave.yaml, .des-audit-README.md)"
          - "Documents audit trail location and purpose (.des/audit/)"
          - "Troubleshooting section includes 'DES Module Import Errors'"
          - "Clear explanation of DES integration with nWave workflow"
        suggested_agent: "software-crafter"
        dependencies: ["07-04"]
        estimated_hours: 1
        files_to_modify:
          - "docs/installation/installation-guide.md"

      - step_id: "08-02"
        name: "Create DES audit trail reference guide"
        description: "Create comprehensive docs/reference/des-audit-trail-guide.md"
        acceptance_criteria:
          - "Documents audit trail purpose (immutable traceability)"
          - "Documents file format (JSONL with daily rotation)"
          - "Documents event types (TASK_INVOCATION_STARTED, PHASE_STARTED, PHASE_COMPLETED, SCOPE_VIOLATION, TIMEOUT_WARNING)"
          - "Includes query examples (grep, jq filters)"
          - "Documents retention policy (90 days, archive after)"
          - "Includes SHA256 integrity verification explanation"
          - "Examples of common troubleshooting scenarios"
        suggested_agent: "software-crafter"
        dependencies: ["08-01"]
        estimated_hours: 1
        files_to_modify:
          - "docs/reference/des-audit-trail-guide.md"

      - step_id: "08-03"
        name: "Create plugin development guide"
        description: "Create docs/development/plugin-development-guide.md for contributors wanting to add plugins"
        acceptance_criteria:
          - "Documents InstallationPlugin interface requirements"
          - "Explains name(), install(), verify(), dependencies(), priority() methods"
          - "Documents InstallContext fields and utilities"
          - "Provides complete plugin example (step-by-step)"
          - "Documents plugin registration process"
          - "Explains dependency resolution and topological sort"
          - "Includes testing guidelines for plugins"
          - "Documents integration with BackupManager and InstallationVerifier"
        suggested_agent: "software-crafter"
        dependencies: ["08-02"]
        estimated_hours: 1.5
        files_to_modify:
          - "docs/development/plugin-development-guide.md"

      - step_id: "08-04"
        name: "Update CHANGELOG and prepare release"
        description: "Update CHANGELOG.md for v1.7.0 and version bump"
        acceptance_criteria:
          - "CHANGELOG.md includes [1.7.0] section with date"
          - "Added section lists: Plugin architecture, DES integration, DES utility scripts, Pre-commit templates"
          - "Changed section lists: Installer refactored to use PluginRegistry (backward compatible)"
          - "Migration section emphasizes: No breaking changes, existing installations work unchanged, fresh installs include DES"
          - "Version bumped to 1.7.0 in version.txt or setup.py"
          - "Release notes drafted with integration details and backward compatibility guarantees"
        suggested_agent: "software-crafter"
        dependencies: ["08-03"]
        estimated_hours: 0.5
        files_to_modify:
          - "CHANGELOG.md"
          - "version.txt"

validation:
  schema_version: "3.0"
  status: "approved"
  reviewed_by: "software-crafter-reviewer"
  approved_by: "software-crafter-reviewer"
  review_date: "2026-02-01T00:00:00Z"
  quality_gates:
    - "All unit tests pass"
    - "All integration tests pass"
    - "No regressions detected (backward compatibility validated)"
    - "DES module importable after installation"
    - "DES scripts executable and functional"
    - "DES templates installed correctly"
    - "Documentation complete and reviewed"
    - "CHANGELOG.md updated for v1.7.0"

optimization_feedback:
  date: "2026-02-01"
  source: "Cross-roadmap analysis (3 features) + execution pattern analysis"

  step_batching:
    description: "Structurally identical steps should be batched into single execution units"
    original_step_count: 32
    optimized_step_count: 16
    token_savings: "~352k tokens (50% reduction)"
    time_savings: "~6.4 hours (50% reduction)"
    batches:
      - batch: "02-01..02-04 → single step"
        reason: "Identical extract-to-module-level pattern applied to same file (install_nwave.py)"
      - batch: "03-01..03-04 → single step"
        reason: "Identical wrapper plugin boilerplate (name/priority/deps/install/verify)"
      - batch: "05-01..05-02 → single step"
        reason: "DES prerequisites (scripts + templates) are independent artifacts"
      - batch: "06-01..06-02 → single step"
        reason: "Same file modification (installation_verifier.py), single concern"
      - batch: "07-01..07-02 → single step"
        reason: "Same abstraction layer tests (registry + wrappers)"
      - batch: "07-03..07-04 → single step"
        reason: "DES-specific tests + integration tests"
      - batch: "08-01..08-03 → single step"
        reason: "Three documentation guides, no code dependencies"

  acceptance_criteria_antipattern:
    severity: "HIGH"
    description: >
      Roadmap acceptance criteria leak implementation details (private methods,
      internal properties) that should be decided by the software-crafter during
      implementation and refactoring phases. Examples:
        - '_install_des_module() copies src/des/' (step 05-03)
        - '_install_des_scripts() copies check_stale_phases.py' (step 05-03)
        - 'verify() checks DES module importable via subprocess test' (step 05-03)
        - 'context.installation_verifier._check_agents()' (step 03-01)
      Roadmap should specify WHAT (behavior, outcomes) not HOW (private methods,
      internal structure). The REFACTOR_CONTINUOUS phase exists precisely to let
      the crafter decide naming, visibility, and internal decomposition.

  schema_standardization:
    description: >
      3 existing roadmaps use completely different YAML schemas (v1 scenario-driven,
      ad-hoc operational, v3 structured). ~30-40% boilerplate per file from repeated
      defaults (suggested_agent x24, empty dependencies[], auto-derivable counts).
    recommendations:
      - "Phase-level default_agent eliminates per-step repetition"
      - "Schema-default dependencies=[] eliminates explicit empty declarations"
      - "Auto-derived step_count, total_estimated_hours"
      - "Estimated 30-35% roadmap file size reduction"

notes:
  - "This roadmap follows the 6-phase migration strategy from design.md"
  - "Phase 1-2: Infrastructure creation and function extraction (circular import fix)"
  - "Phase 3-4: Wrapper plugins and installer switchover"
  - "Phase 5-6: DES plugin implementation and verification integration"
  - "Phase 7-8: Testing and documentation"
  - "Total estimated time: 32 hours across 8 phases (16 hours with batching)"
  - "All phases maintain backward compatibility - no breaking changes"
  - "Plugin system is WRAPPER layer, not rewrite - existing logic preserved"
  - "DESPlugin demonstrates extensibility: ONE line to add (registry.register(DESPlugin()))"
  - "Prerequisites for Phase 5: DES scripts and templates must be created first"
  - "Design review HIGH severity issues all resolved (HIGH-01, HIGH-02, HIGH-03)"
