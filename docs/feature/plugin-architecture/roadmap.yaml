---
feature: plugin-architecture
version: 1.0.0
created: 2026-02-01
methodology: nWave ATDD with Outside-In TDD
complexity: intermediate

# Quality Gate Validation
quality_gates:
  ac_abstraction_level: "All AC describe WHAT the system does, never HOW (no private methods, no internal structure)"
  step_decomposition_efficiency: "Steps decomposed by implementation unit, not by test scenario"
  step_to_file_ratio: "7 steps / ~6 production files = 1.17 (target: <= 2.5)"
  identical_pattern_batching: "Wrapper plugins batched into single step (4 plugins = 1 step)"

baseline_measurement:
  problem_description: "Monolithic installer requires code changes for each new component"
  current_state: "install_nwave.py contains hardcoded methods for each component (agents, commands, templates, utilities)"
  impact: "Adding DES requires modifying install_framework() method directly"
  measurement_data:
    hardcoded_methods: 4  # _install_agents, _install_commands, _install_templates, _install_utility_scripts
    installer_lines: 830
    modification_points: 1  # install_framework() method
  target_state: "Plugin-based architecture allowing zero-modification component addition"
  success_criteria:
    - DES installable via plugin registration (1 line change)
    - Existing components wrapped as plugins
    - Dependency resolution automatic via topological sort
    - Backward compatibility preserved (same file locations, same behavior)

implementation_scope:
  directories:
    - scripts/install/plugins/  # New plugin infrastructure
    - scripts/install/  # Modified install_nwave.py
    - nWave/scripts/des/  # DES utility scripts (prerequisites)
    - nWave/templates/  # DES templates (prerequisites)
  files_created:
    - scripts/install/plugins/__init__.py
    - scripts/install/plugins/base.py
    - scripts/install/plugins/registry.py
    - scripts/install/plugins/agents_plugin.py
    - scripts/install/plugins/commands_plugin.py
    - scripts/install/plugins/templates_plugin.py
    - scripts/install/plugins/utilities_plugin.py
    - scripts/install/plugins/des_plugin.py
  files_modified:
    - scripts/install/install_nwave.py  # Switchover to PluginRegistry
  excluded:
    - tests/  # Test creation handled separately
    - docs/  # Documentation handled in final step

migration_strategy:
  approach: "6-phase incremental migration with backward compatibility"
  phases:
    1_infrastructure: "Create plugin base classes and registry (zero installer changes)"
    2_wrapping: "Wrap existing methods as plugins (call existing logic)"
    3_switchover: "Modify install_framework() to use PluginRegistry"
    4_des_plugin: "Add DESPlugin demonstrating extensibility"
    5_testing: "Comprehensive test suite and validation"
    6_deployment: "Version bump and documentation"
  backward_compatibility_guarantee: "Plugins call existing methods; same files installed at same locations"

steps:
  # PHASE 1: Infrastructure (1 step)
  - id: "01-01"
    phase: 1
    type: infrastructure
    title: "Create plugin infrastructure (base classes and registry)"
    description: "Establish plugin architecture foundation without modifying existing installer"

    acceptance_criteria:
      # WHAT the system does (behavioral, observable outcomes)
      - InstallationPlugin interface available for plugin implementations
      - PluginRegistry resolves plugin dependencies via topological sort
      - PluginRegistry detects circular dependencies and raises ValueError
      - InstallContext carries shared state between plugins (paths, logger, backup_manager, installation_verifier)
      - PluginResult communicates success/failure with structured data
      - Existing installer remains unchanged and functional

    implementation_notes:
      files_to_create:
        - scripts/install/plugins/__init__.py
        - scripts/install/plugins/base.py  # InstallationPlugin, InstallContext, PluginResult
        - scripts/install/plugins/registry.py  # PluginRegistry with Kahn's algorithm
      existing_installer: "UNCHANGED - no modifications to install_nwave.py"
      integration_strategy: "Infrastructure exists but not yet used by installer"

    test_strategy:
      unit_tests:
        - "PluginRegistry topological sort with simple dependencies"
        - "PluginRegistry priority ordering when no dependencies"
        - "PluginRegistry cycle detection raises ValueError"
        - "PluginRegistry missing dependency error with clear message"
      validation:
        - "install_nwave.py runs successfully (unaffected by new infrastructure)"

    estimated_time: "3-4 hours"

  # PHASE 2: Wrapping (1 batched step for all 4 wrapper plugins)
  - id: "02-01"
    phase: 2
    type: feature
    title: "Create wrapper plugins for existing installer methods"
    description: "Batch creation of 4 wrapper plugins (agents, commands, templates, utilities) that call existing installation logic"

    acceptance_criteria:
      # WHAT the system does (behavioral outcomes)
      - AgentsPlugin installation produces same agent files as existing installer
      - CommandsPlugin installation produces same command files as existing installer
      - TemplatesPlugin installation produces same template files as existing installer
      - UtilitiesPlugin installation produces same utility scripts as existing installer
      - All plugins verify installation using existing InstallationVerifier
      - Plugin priority ordering follows dependency requirements (agents=10, commands=20, templates=30, utilities=40)
      - Existing installer methods remain functional and unchanged

    implementation_notes:
      files_to_create:
        - scripts/install/plugins/agents_plugin.py  # Wraps _install_agents()
        - scripts/install/plugins/commands_plugin.py  # Wraps _install_commands()
        - scripts/install/plugins/templates_plugin.py  # Wraps _install_templates()
        - scripts/install/plugins/utilities_plugin.py  # Wraps _install_utility_scripts()
      wrapper_pattern: "Extract module-level functions from existing class methods to avoid circular imports"
      circular_import_fix: "import install_agents_impl (function), NOT nWaveInstaller (class)"
      reuse_strategy: "Plugins call existing logic via module-level functions; preserve all existing backup, validation, error handling"

    test_strategy:
      unit_tests:
        - "AgentsPlugin.install() calls install_agents_impl and produces expected files"
        - "CommandsPlugin.install() calls install_commands_impl and produces expected files"
        - "TemplatesPlugin.install() calls install_templates_impl and produces expected files"
        - "UtilitiesPlugin.install() calls install_utility_scripts_impl and produces expected files"
        - "Each plugin.verify() uses existing InstallationVerifier methods"
      integration_tests:
        - "Plugin installation produces identical file trees as direct method calls"
      validation:
        - "Existing installer methods still work when called directly"

    estimated_time: "6-8 hours"

  # PHASE 3: Switchover (1 step)
  - id: "03-01"
    phase: 3
    type: refactoring
    title: "Switchover install_framework() to use PluginRegistry"
    description: "Modify installer orchestration to use plugin system while preserving existing method implementations"

    acceptance_criteria:
      # WHAT the system does (behavioral outcomes)
      - Fresh installation produces identical file tree as pre-plugin installer
      - Upgrade from v1.6.x preserves existing installations and adds new components
      - BackupManager creates timestamped backups before modifications
      - InstallationVerifier validates all components using existing checks
      - Plugin execution order respects dependencies (topological sort)
      - Version tracking continues to work (upgrade detection, version comparison)
      - Installation output shows plugin execution progress

    implementation_notes:
      files_to_modify:
        - scripts/install/install_nwave.py  # Modify install_framework() to use PluginRegistry
      existing_methods_preserved: "Keep _install_agents(), _install_commands(), _install_templates(), _install_utility_scripts() for plugins to call"
      context_injection: "Create InstallContext with backup_manager, installation_verifier, rich_logger, framework_source, project_root"
      execution_change: "install_framework() calls registry.install_all() instead of direct method calls"

    test_strategy:
      integration_tests:
        - "Fresh install with plugin system vs pre-plugin baseline (identical file trees)"
        - "Upgrade scenario from v1.6.x to v1.7.0 preserves existing files"
        - "BackupManager integration: backups created in ~/.claude/backups/"
        - "InstallationVerifier integration: all existing checks pass"
      regression_tests:
        - "Compare installed file locations (must be identical)"
        - "Compare verification output (same components, same criteria)"
        - "Version tracking comparison (same upgrade detection logic)"
      validation:
        - "Zero behavioral changes in file installation"
        - "Same error handling and recovery patterns"

    estimated_time: "2-3 hours"

  # PHASE 4: DES Plugin (1 step - demonstrates extensibility)
  - id: "04-01"
    phase: 4
    type: feature
    title: "Implement DESPlugin with prerequisite scripts and templates"
    description: "Add DES component via plugin registration, demonstrating zero-modification extensibility"

    acceptance_criteria:
      # WHAT the system does (behavioral outcomes)
      - DES Python module importable from ~/.claude/lib/python/des/
      - DES utility scripts executable from ~/.claude/scripts/
      - DES templates available in ~/.claude/templates/
      - DESPlugin installs after templates and utilities (dependency resolution)
      - DES module import test succeeds (subprocess verification)
      - Pre-commit hook templates validate YAML syntax
      - Audit README template documents JSONL format and query examples
      - Installer modified with single plugin registration line

    implementation_notes:
      prerequisites:
        des_scripts:
          - nWave/scripts/des/check_stale_phases.py  # Stale phase detection
          - nWave/scripts/des/scope_boundary_check.py  # Scope boundary validation
        des_templates:
          - nWave/templates/.pre-commit-config-nwave.yaml  # Pre-commit configuration
          - nWave/templates/.des-audit-README.md  # Audit trail documentation
        prerequisite_status: "MUST be created before this step (see MED-01, MED-02 remediations in design.md)"
      files_to_create:
        - scripts/install/plugins/des_plugin.py  # New DESPlugin implementation
      files_to_modify:
        - scripts/install/install_nwave.py  # Add registry.register(DESPlugin()) - 1 line
      des_installation:
        module_source: "dist/ide/lib/python/des/ OR src/des/ (fallback)"
        module_target: "~/.claude/lib/python/des/"
        scripts_source: "nWave/scripts/des/"
        scripts_target: "~/.claude/scripts/"
        templates_source: "nWave/templates/"
        templates_target: "~/.claude/templates/"
      reuse_strategy: "Use context.backup_manager for backups, context.logger for output, existing verification patterns"

    test_strategy:
      unit_tests:
        - "DESPlugin.install() copies module to correct location"
        - "DESPlugin.install() installs scripts with executable permissions"
        - "DESPlugin.install() installs templates to correct location"
        - "DESPlugin.verify() confirms module importable via subprocess"
        - "DESPlugin.verify() confirms scripts present and executable"
        - "DESPlugin.verify() confirms templates present"
      integration_tests:
        - "Full installation includes DES after templates and utilities"
        - "DES module import succeeds: 'from des.application import DESOrchestrator'"
        - "check_stale_phases.py executes successfully"
        - "scope_boundary_check.py executes successfully"
        - "Pre-commit config valid YAML"
      dependency_tests:
        - "DESPlugin installs AFTER TemplatesPlugin (dependency resolution)"
        - "DESPlugin installs AFTER UtilitiesPlugin (dependency resolution)"
      validation:
        - "Zero modifications to core installer beyond plugin registration"
        - "DES installation reuses existing utilities (BackupManager, Logger)"

    estimated_time: "4-5 hours"

  # PHASE 5: Testing and Documentation (1 step)
  - id: "05-01"
    phase: 5
    type: validation
    title: "Comprehensive testing and documentation"
    description: "Complete test suite coverage and user/developer documentation"

    acceptance_criteria:
      # WHAT the system does (behavioral outcomes)
      - All unit tests pass (plugin infrastructure, individual plugins)
      - All integration tests pass (fresh install, upgrade scenarios)
      - All regression tests pass (file tree comparison, behavior validation)
      - All adversarial tests pass (error handling, edge cases)
      - Installation guide documents DES components and features
      - DES audit trail guide explains JSONL format and query examples
      - Plugin development guide provides contributor instructions
      - Architecture documentation includes plugin system diagram

    implementation_notes:
      test_categories:
        unit_tests:
          - "PluginRegistry topological sort and dependency resolution"
          - "Individual plugin install/verify methods"
          - "Circular dependency detection"
          - "Missing dependency error handling"
        integration_tests:
          - "Fresh install produces expected file tree"
          - "Upgrade from v1.6.x preserves existing installation"
          - "BackupManager integration functional"
          - "InstallationVerifier integration functional"
        regression_tests:
          - "File tree comparison: pre-plugin vs post-plugin (identical)"
          - "Verification output comparison (same components, same checks)"
          - "Version tracking comparison (same logic)"
        adversarial_tests:
          - "Dependency cycle detection and error reporting"
          - "Plugin install failure handling and rollback"
          - "Missing dependency clear error messaging"
      documentation_updates:
        - docs/installation/installation-guide.md  # Add DES section
        - docs/reference/des-audit-trail-guide.md  # NEW - audit trail documentation
        - docs/development/plugin-development-guide.md  # NEW - contributor guide
        - docs/architecture/plugin-system.md  # NEW - architecture diagram

    test_strategy:
      validation:
        - "Test coverage > 90% for plugin infrastructure"
        - "Zero test failures in CI pipeline"
        - "Documentation reviewed for completeness and accuracy"
        - "Migration guide tested with actual v1.6.x installation"

    estimated_time: "4-5 hours"

  # PHASE 6: Deployment (1 step)
  - id: "06-01"
    phase: 6
    type: deployment
    title: "Version bump, release notes, and gradual rollout"
    description: "Prepare v1.7.0 release with backward compatibility guarantees"

    acceptance_criteria:
      # WHAT the system does (behavioral outcomes)
      - Version bumped to 1.7.0 in all relevant files
      - CHANGELOG.md documents new features and migration guidance
      - Release notes explain plugin architecture and backward compatibility
      - Gradual rollout plan executed (alpha → beta → stable)
      - Fresh installations include DES automatically
      - Existing installations upgrade without breaking changes
      - Migration guide validates zero breaking changes

    implementation_notes:
      version_bump:
        from: "1.6.x"
        to: "1.7.0"
        semver_rationale: "Minor version (new feature, backward compatible)"
      files_to_update:
        - VERSION
        - CHANGELOG.md
        - README.md  # Mention plugin architecture and DES
      changelog_sections:
        added:
          - "Plugin architecture for modular installation system"
          - "DES (Deterministic Execution System) integration"
          - "DES utility scripts: check_stale_phases, scope_boundary_check"
          - "Pre-commit hook templates for nWave projects"
        changed:
          - "Installer refactored to use PluginRegistry (backward compatible)"
        migration:
          - "No breaking changes - existing installations work unchanged"
          - "Fresh installs include DES automatically"
      rollout_plan:
        alpha: "Internal testing with development team"
        beta: "Selected early adopters with monitoring"
        stable: "General availability after beta validation"

    test_strategy:
      validation:
        - "Alpha testing: Fresh install and upgrade scenarios"
        - "Beta testing: Real-world usage validation"
        - "Stable release: All validation criteria met"
      backward_compatibility_verification:
        - "Existing v1.6.x installations upgrade successfully"
        - "Zero file location changes"
        - "Zero behavioral changes in core components"

    estimated_time: "1-2 hours"

handoff_to_distill:
  architecture_decisions:
    - Plugin architecture uses wrapper pattern (plugins call existing methods)
    - Circular imports avoided via module-level function extraction
    - Backward compatibility guaranteed (same files, same locations, same behavior)
    - Dependency resolution via topological sort (Kahn's algorithm)
    - InstallContext carries existing utilities (BackupManager, InstallationVerifier)

  technology_stack:
    language: Python 3.x
    installer_framework: Custom (scripts/install/install_nwave.py)
    plugin_infrastructure: Custom (scripts/install/plugins/)
    dependency_algorithm: "Kahn's topological sort"
    testing_framework: pytest
    existing_utilities_reused:
      - BackupManager
      - InstallationVerifier
      - Rich library (styled output)
      - Version tracking

  acceptance_test_framework:
    approach: "Integration tests with file tree comparison"
    key_scenarios:
      - Fresh installation produces expected file tree
      - Upgrade preserves existing files and adds new components
      - Plugin execution order respects dependencies
      - DES module importable and functional
    validation_criteria:
      - File tree comparison (pre-plugin vs post-plugin)
      - Verification output comparison
      - DES module import subprocess test
      - Backward compatibility verification

  risk_mitigation:
    circular_imports: "Resolved via module-level function extraction (HIGH-02 fix)"
    des_source_structure: "Documented prerequisites and build pipeline integration (HIGH-01 fix)"
    install_context_incomplete: "Added framework_source, project_root, rich_logger fields (HIGH-03 fix)"
    backward_compatibility: "Plugins call existing methods; same file locations; comprehensive regression tests"

  next_wave_inputs:
    primary_deliverable: "Roadmap validated and approved for acceptance test creation"
    architecture_document: "docs/feature/plugin-architecture/design.md"
    quality_gates_passed:
      - ac_abstraction_level: true
      - step_decomposition_efficiency: true
      - step_to_file_ratio: true  # 1.17 (well below 2.5 threshold)
      - identical_pattern_batching: true

    acceptance_test_guidance:
      test_structure: "7 implementation steps → 7 primary acceptance test scenarios"
      infrastructure_steps: "Step 01-01 (infrastructure) may not map to user-facing scenario"
      feature_steps: "Steps 02-01 through 06-01 map to observable behavioral scenarios"
      step_mapping:
        - step: "01-01"
          scenario: "Plugin infrastructure validation (internal)"
          type: infrastructure
        - step: "02-01"
          scenario: "Wrapper plugins produce identical installation results"
          type: feature
        - step: "03-01"
          scenario: "Plugin registry orchestration preserves backward compatibility"
          type: feature
        - step: "04-01"
          scenario: "DES plugin installation and verification"
          type: feature
        - step: "05-01"
          scenario: "Comprehensive test suite and documentation validation"
          type: validation
        - step: "06-01"
          scenario: "Version release and deployment validation"
          type: deployment

metadata:
  total_steps: 7
  estimated_total_time: "20-27 hours"
  production_files_estimate: 6  # 4 wrapper plugins + des_plugin + registry
  step_to_file_ratio: 1.17  # 7 steps / 6 files = 1.17 (target: <= 2.5)
  quality_gates_validation:
    ac_abstraction: "PASS - All AC describe observable outcomes, no private method references"
    step_decomposition: "PASS - Steps decomposed by implementation unit (infrastructure, wrapper batch, switchover, DES, testing, deployment)"
    identical_pattern_batching: "PASS - 4 wrapper plugins batched into single step 02-01"
    no_op_prevention: "PASS - All steps add production code (infrastructure, plugins, switchover, DES, docs, deployment)"
