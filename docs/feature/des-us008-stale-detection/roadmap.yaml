roadmap:
  project_id: "des-us008-stale-detection"
  created_at: "2026-01-31T00:00:00Z"
  total_steps: 11
  phases: 5
  description: "Session-scoped stale execution detection for DES - detect and block execution when IN_PROGRESS phases exceed threshold"

phases:
  - id: "01"
    name: "Domain Model - Stale Detection Entities"
    description: "Create core domain entities for stale execution detection (StaleExecution value object, StaleDetectionResult)"
    steps:
      - id: "01-01"
        agent: "software-crafter"
        deps: []
        name: "Create StaleExecution value object"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_001_pre_execution_scan_detects_stale_execution"
        criteria: "StaleExecution value object with step_file, phase_name, age_minutes, started_at; Immutable dataclass; Business validation (age_minutes >= 0); No external dependencies"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

      - id: "01-02"
        agent: "software-crafter"
        deps: ["01-01"]
        name: "Create StaleDetectionResult entity"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_005_alert_includes_step_phase_and_age_details"
        criteria: "StaleDetectionResult entity with stale_executions list, is_blocked boolean, alert_message; Format alert message 'Stale execution found: {step_file}, phase {phase_name} ({age} min)'; Multiple stale executions supported"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

  - id: "02"
    name: "Application Layer - Stale Detection Service"
    description: "Implement stale execution detector service with configurable threshold and pure file scanning"
    steps:
      - id: "02-01"
        agent: "software-crafter"
        deps: ["01-02"]
        name: "Create StaleExecutionDetector service with threshold configuration"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_002_clean_start_when_no_stale_executions"
        criteria: "StaleExecutionDetector service in application layer; Scan steps directory for IN_PROGRESS phases; Configurable threshold (default 30 min, env var DES_STALE_THRESHOLD_MINUTES); Return StaleDetectionResult; Pure file scanning (no DB, HTTP, or external services)"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

      - id: "02-02"
        agent: "software-crafter"
        deps: ["02-01"]
        name: "Implement threshold logic and age calculation"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_003_recent_in_progress_within_threshold_not_stale"
        criteria: "Calculate phase age from started_at timestamp; Compare age to threshold; Recent phases within threshold not flagged; Only phases exceeding threshold flagged as stale; Handle missing timestamps gracefully"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

      - id: "02-03"
        agent: "software-crafter"
        deps: ["02-02"]
        name: "Support custom threshold via environment variable"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_004_custom_threshold_via_environment_variable"
        criteria: "Read DES_STALE_THRESHOLD_MINUTES environment variable; Parse and validate threshold value; Fall back to 30-minute default if not set; Support 10-minute custom threshold test case"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

      - id: "02-04"
        agent: "software-crafter"
        deps: ["02-03"]
        name: "Handle multiple stale executions and corrupted files"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_010_multiple_stale_executions_all_reported"
        criteria: "Detect all stale steps across entire steps directory; Report all stale executions (not just first); Gracefully handle corrupted JSON files with warnings; Continue scan if individual file fails to parse; Session-scoped (no persistent daemon)"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

  - id: "03"
    name: "Resolution Mechanism - Mark Steps ABANDONED"
    description: "Create StaleResolver service to mark stale steps as ABANDONED with recovery suggestions"
    steps:
      - id: "03-01"
        agent: "software-crafter"
        deps: ["02-04"]
        name: "Create StaleResolver service to mark steps ABANDONED"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_007_mark_step_abandoned_updates_state_correctly"
        criteria: "StaleResolver service in application layer; Mark step state as ABANDONED; Update phase status to ABANDONED; Add failure_reason to state; Generate recovery_suggestions list; Add abandoned_at timestamp"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

      - id: "03-02"
        agent: "software-crafter"
        deps: ["03-01"]
        name: "Verify resolved steps unblock new executions"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_006_resolve_stale_step_unblocks_new_execution"
        criteria: "ABANDONED status not flagged as stale; Pre-execution scan passes when stale step resolved; New execution can proceed after resolution; Recovery suggestions include transcript review and phase reset instructions"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

  - id: "04"
    name: "Orchestrator Integration - Pre-execution Hook"
    description: "Integrate stale detection into DES orchestrator pre-execution workflow"
    steps:
      - id: "04-01"
        agent: "software-crafter"
        deps: ["03-02"]
        name: "Add pre-execution stale check to orchestrator"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_001_pre_execution_scan_detects_stale_execution"
        criteria: "Invoke StaleExecutionDetector before step execution; Block execution if stale detected (is_blocked=true); Set blocking_reason to STALE_EXECUTION_DETECTED; Display stale alert with step_file, phase_name, age_minutes; Provide resolution instructions"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

      - id: "04-02"
        agent: "software-crafter"
        deps: ["04-01"]
        name: "Verify clean execution path when no stale steps"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_002_clean_start_when_no_stale_executions"
        criteria: "Pre-execution check passes (is_blocked=false); Execution proceeds normally when clean; No performance overhead for clean state; Session-scoped check terminates after completion"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

  - id: "05"
    name: "Session Scope Validation and Edge Cases"
    description: "Validate session-scoped behavior and handle edge cases (no daemon, corrupted files)"
    steps:
      - id: "05-01"
        agent: "software-crafter"
        deps: ["04-02"]
        name: "Validate pure file scanning with zero external dependencies"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_008_pure_file_scanning_no_external_dependencies"
        criteria: "No database connections; No HTTP calls; No external services; Pure Python file I/O only; Works with basic file system; Validate uses_external_services=False; Validate is_session_scoped=True"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

      - id: "05-02"
        agent: "software-crafter"
        deps: ["05-01"]
        name: "Verify no persistent daemon after check completes"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_009_no_persistent_daemon_after_check_completes"
        criteria: "No background threads remain after check; No daemon processes spawned; No file watchers left running; Thread count unchanged before/after; Process count unchanged before/after; Clean termination"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

      - id: "05-03"
        agent: "software-crafter"
        deps: ["05-02"]
        name: "Handle corrupted step files gracefully"
        test_file: "tests/des/acceptance/test_us008_stale_detection.py"
        scenario_name: "test_scenario_011_corrupted_step_file_gracefully_handled"
        criteria: "Continue scan if JSON parse fails; Report corrupted file as warning (not crash); Still detect valid stale steps; Warning includes file_path and parse error message; Robust error handling"
        quality_gates:
          acceptance_test_must_fail_first: true
          unit_tests_must_fail_first: true
          no_mocks_inside_hexagon: true
          refactor_level: 3

implementation_scope:
  source_directories:
    - "src/des/"
  test_directories:
    - "tests/des/"
  excluded_patterns:
    - "__init__.py"
    - "__pycache__/**"

validation:
  status: "approved"
  reviewer: "software-crafter-reviewer"
  approved_at: "2026-01-31T00:00:00Z"
  acceptance_tests: "tests/des/acceptance/test_us008_stale_detection.py"
  test_count: 11
  current_state: "RED (all tests skipped, awaiting DEVELOP wave)"
  review_notes: "All validation criteria passed. Format compliance ✓, Implementation scope ✓, Step atomicity ✓, Dependency correctness ✓, Quality gates ✓, Test mapping (11 scenarios) ✓, Hexagonal architecture (Domain→Application→Integration→Validation) ✓, Acceptance criteria ✓, Agent assignment ✓, External validity via orchestrator integration ✓. Ready for split and execution."
