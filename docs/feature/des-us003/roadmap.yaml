# Roadmap: US-003 Post-Execution State Validation
# Created by: solution-architect agent (Morgan)
# Updated: 2026-01-24 - Added wiring tests per reviewer feedback
# Methodology: Outside-In TDD with strict 1:1 step-to-scenario mapping
# Evidence: 10 acceptance test scenarios (8 feature + 2 wiring)

roadmap:
  project_id: des-us003
  feature_name: "Post-Execution State Validation"
  created_at: "2026-01-24T16:00:00Z"
  updated_at: "2026-01-24T18:00:00Z"

  # =============================================================================
  # SUMMARY
  # =============================================================================

  summary:
    total_phases: 1
    total_steps: 8
    approach: "Outside-In TDD with strict 1:1 step-to-scenario mapping"
    step_to_scenario_mapping: "1 acceptance test scenario = 1 step file = 1 complete 14-phase TDD cycle"

    acceptance_test_file: "tests/acceptance/test_us003_post_execution_validation.py"
    acceptance_test_scenarios: 10
    scenario_breakdown:
      feature_scenarios: 8
      wiring_scenarios: 2
    step_files_to_generate: 8
    note: "Step 01-07 covers 2 happy paths; Step 01-08 covers 2 wiring tests"

    validation_rules:
      rule_1: "num_step_files covers num_acceptance_test_scenarios (8 steps cover 10 scenarios)"
      rule_2: "at_least_one_step.step_type == 'integration' (step 01-08)"
      rule_3: "at_least_one_test.imports_entry_point == true (wiring tests added)"

    component_architecture:
      new_module: "des/hooks.py"
      new_classes:
        - "SubagentStopHook"
        - "HookResult (dataclass)"
        - "ValidationRule (Protocol/ABC)"
      integration_point: "DESOrchestrator.on_subagent_complete()"

  # =============================================================================
  # PHASES
  # =============================================================================

  phases:
    - phase_id: "01"
      name: "SubagentStop Hook Implementation"
      description: |
        Implement SubagentStopHook with all validation rules following strict
        Outside-In TDD discipline. Each step makes exactly one acceptance test
        scenario pass (RED -> GREEN).

      step_count: 8

      # =========================================================================
      # STEPS (1:1 mapping to acceptance test scenarios)
      # =========================================================================

      steps:
        # -----------------------------------------------------------------------
        # Step 01-01: Hook Infrastructure + Fires on Completion (AC-003.1)
        # -----------------------------------------------------------------------
        - step_id: "01-01"
          name: "Hook fires on agent completion"
          step_type: "feature"
          acceptance_test_scenario: "test_subagent_stop_hook_fires_on_agent_completion"
          acceptance_test_file: "tests/acceptance/test_us003_post_execution_validation.py"
          acceptance_criteria: "AC-003.1"
          description: |
            Make test_subagent_stop_hook_fires_on_agent_completion pass (RED -> GREEN).

            Implements:
            - SubagentStopHook class skeleton in des/hooks.py
            - on_agent_complete(step_file_path) method
            - HookResult dataclass with validation_status field
            - Basic hook invocation tracking

            Test expectation:
            - hook.on_agent_complete() is callable with step file path
            - Returns HookResult with hook_fired=True
            - Validates step file state
          suggested_agent: "software-crafter"
          estimated_complexity: "medium"
          dependencies: []

        # -----------------------------------------------------------------------
        # Step 01-02: Abandoned IN_PROGRESS Phase Detection (AC-003.2)
        # -----------------------------------------------------------------------
        - step_id: "01-02"
          name: "Detect abandoned IN_PROGRESS phases"
          step_type: "feature"
          acceptance_test_scenario: "test_abandoned_in_progress_phase_detected"
          acceptance_test_file: "tests/acceptance/test_us003_post_execution_validation.py"
          acceptance_criteria: "AC-003.2"
          description: |
            Make test_abandoned_in_progress_phase_detected pass (RED -> GREEN).

            Implements:
            - Validation rule: Detect phases with status "IN_PROGRESS"
            - Return FAILED validation_status when abandoned phase found
            - Populate abandoned_phases list in HookResult
            - Error message format: "Phase {name} left IN_PROGRESS (abandoned)"

            Test expectation:
            - Hook detects GREEN_UNIT phase with IN_PROGRESS status
            - validation_status == "FAILED"
            - abandoned_phases == ["GREEN_UNIT"]
            - Specific error message present
          suggested_agent: "software-crafter"
          estimated_complexity: "medium"
          dependencies: ["01-01"]

        # -----------------------------------------------------------------------
        # Step 01-03: Silent Completion Detection (AC-003.3)
        # -----------------------------------------------------------------------
        - step_id: "01-03"
          name: "Flag silent completion (no phases executed)"
          step_type: "feature"
          acceptance_test_scenario: "test_done_task_with_not_executed_phases_flagged"
          acceptance_test_file: "tests/acceptance/test_us003_post_execution_validation.py"
          acceptance_criteria: "AC-003.3"
          description: |
            Make test_done_task_with_not_executed_phases_flagged pass (RED -> GREEN).

            Implements:
            - Validation rule: Detect task IN_PROGRESS but all phases NOT_EXECUTED
            - error_type = "SILENT_COMPLETION"
            - Error message: "Agent completed without updating step file"
            - Count not_executed_phases for diagnostic

            Test expectation:
            - Hook detects 14 phases all with NOT_EXECUTED status
            - validation_status == "FAILED"
            - error_type == "SILENT_COMPLETION"
            - Appropriate error message
          suggested_agent: "software-crafter"
          estimated_complexity: "medium"
          dependencies: ["01-01"]

        # -----------------------------------------------------------------------
        # Step 01-04: Missing Outcome Detection (AC-003.4)
        # -----------------------------------------------------------------------
        - step_id: "01-04"
          name: "Flag EXECUTED phases without outcome"
          step_type: "feature"
          acceptance_test_scenario: "test_executed_phase_without_outcome_flagged"
          acceptance_test_file: "tests/acceptance/test_us003_post_execution_validation.py"
          acceptance_criteria: "AC-003.4"
          description: |
            Make test_executed_phase_without_outcome_flagged pass (RED -> GREEN).

            Implements:
            - Validation rule: EXECUTED phases must have outcome field
            - Populate incomplete_phases list in HookResult
            - error_type = "MISSING_OUTCOME"
            - Error message: "Phase {name} marked EXECUTED but missing outcome"

            Test expectation:
            - Hook detects REFACTOR_L1 with EXECUTED status but no outcome
            - validation_status == "FAILED"
            - incomplete_phases == ["REFACTOR_L1"]
            - error_type == "MISSING_OUTCOME"
          suggested_agent: "software-crafter"
          estimated_complexity: "low"
          dependencies: ["01-01"]

        # -----------------------------------------------------------------------
        # Step 01-05: Invalid Skip Detection (AC-003.5)
        # -----------------------------------------------------------------------
        - step_id: "01-05"
          name: "Flag SKIPPED phases without blocked_by"
          step_type: "feature"
          acceptance_test_scenario: "test_skipped_phase_without_blocked_by_reason_flagged"
          acceptance_test_file: "tests/acceptance/test_us003_post_execution_validation.py"
          acceptance_criteria: "AC-003.5"
          description: |
            Make test_skipped_phase_without_blocked_by_reason_flagged pass (RED -> GREEN).

            Implements:
            - Validation rule: SKIPPED phases must have blocked_by reason
            - Populate invalid_skips list in HookResult
            - error_type = "INVALID_SKIP"
            - Error message: "Phase {name} marked SKIPPED but missing blocked_by reason"

            Test expectation:
            - Hook detects REFACTOR_L3 with SKIPPED status but no blocked_by
            - validation_status == "FAILED"
            - invalid_skips == ["REFACTOR_L3"]
            - error_type == "INVALID_SKIP"
          suggested_agent: "software-crafter"
          estimated_complexity: "low"
          dependencies: ["01-01"]

        # -----------------------------------------------------------------------
        # Step 01-06: Multiple Errors with Recovery (AC-003.6)
        # -----------------------------------------------------------------------
        - step_id: "01-06"
          name: "Handle multiple errors with recovery suggestions"
          step_type: "feature"
          acceptance_test_scenario: "test_validation_errors_trigger_failed_state_with_recovery"
          acceptance_test_file: "tests/acceptance/test_us003_post_execution_validation.py"
          acceptance_criteria: "AC-003.6"
          description: |
            Make test_validation_errors_trigger_failed_state_with_recovery pass (RED -> GREEN).

            Implements:
            - Aggregate multiple validation errors
            - error_count reflects total issues found
            - Update step file state to FAILED with failure_reason
            - Generate recovery_suggestions (minimum 3):
              * At least one explains WHY error occurred
              * At least one explains HOW to fix
              * Format: Complete sentences (20+ chars), proper capitalization

            Test expectation:
            - Hook detects GREEN_UNIT abandoned + REVIEW missing outcome
            - error_count == 2
            - Step file updated with status=FAILED
            - recovery_suggestions has 3+ actionable items
            - Suggestions include transcript review, status reset, resume command
          suggested_agent: "software-crafter"
          estimated_complexity: "high"
          dependencies: ["01-02", "01-04"]

        # -----------------------------------------------------------------------
        # Step 01-07: Happy Paths (Clean + Valid Skip)
        # -----------------------------------------------------------------------
        - step_id: "01-07"
          name: "Pass validation for clean completion and valid skips"
          step_type: "feature"
          acceptance_test_scenario: "test_clean_completion_passes_validation"
          acceptance_test_file: "tests/acceptance/test_us003_post_execution_validation.py"
          acceptance_criteria: "Happy path scenarios"
          description: |
            Make test_clean_completion_passes_validation AND
            test_valid_skip_with_blocked_by_passes_validation pass (RED -> GREEN).

            Note: These two happy path scenarios are tightly coupled as they both
            test the PASSED validation_status path. Implementing them together
            maintains logical cohesion while still following Outside-In TDD.

            Implements:
            - PASSED validation_status when no errors found
            - Empty lists for abandoned_phases, incomplete_phases, invalid_skips
            - Accept SKIPPED phases that have valid blocked_by reason
            - Audit log success event recording

            Test expectation (clean completion):
            - All 14 phases EXECUTED with outcomes
            - validation_status == "PASSED"
            - All error lists empty

            Test expectation (valid skip):
            - REFACTOR_L2 SKIPPED with blocked_by reason present
            - validation_status == "PASSED"
            - invalid_skips == []
          suggested_agent: "software-crafter"
          estimated_complexity: "medium"
          dependencies: ["01-02", "01-03", "01-04", "01-05"]
          note: |
            This step covers 2 acceptance test scenarios (happy paths) because:
            1. Both test the same code path (PASSED status)
            2. Both are essential for validation completeness
            3. Strictly: could be split into 01-07 and 01-08, making 9 total steps
            If strict 1:1 is required, split this into two steps.

        # -----------------------------------------------------------------------
        # Step 01-08: Integration - Wire into DESOrchestrator
        # -----------------------------------------------------------------------
        - step_id: "01-08"
          name: "Integration: Wire SubagentStopHook into DESOrchestrator"
          step_type: "integration"
          acceptance_test_scenario: "test_orchestrator_invokes_subagent_stop_hook_on_completion"
          acceptance_test_file: "tests/acceptance/test_us003_post_execution_validation.py"
          acceptance_criteria: "CM-B: Integration step requirement"
          description: |
            Wire SubagentStopHook into DESOrchestrator entry point.

            This is the INTEGRATION step required by CM-B countermeasure.
            Ensures the hook is properly integrated into the system entry point,
            not just tested as an isolated component.

            Implements:
            - DESOrchestrator.on_subagent_complete(step_file_path) method
            - Hook registration mechanism in orchestrator
            - Entry point validation that invokes SubagentStopHook
            - Uncomment and enable wiring acceptance tests

            Also makes pass:
            - test_orchestrator_detects_abandoned_phase_via_entry_point

            Validation:
            - Acceptance tests import DESOrchestrator (entry point)
            - Hook is invoked through orchestrator, not directly
            - End-to-end flow: orchestrator -> hook -> validation -> result
          suggested_agent: "software-crafter"
          estimated_complexity: "medium"
          dependencies: ["01-01", "01-02", "01-03", "01-04", "01-05", "01-06", "01-07"]

  # =============================================================================
  # VALIDATION METADATA
  # =============================================================================

  validation:
    status: "approved"
    reviewed_by: "software-crafter-reviewer"
    reviewed_at: "2026-01-24T19:15:00Z"
    notes: |
      APPROVED - All fixes verified on attempt 2/2.

      Verification Results:
      1. Wiring tests exist in TestOrchestratorHookIntegration class (lines 852-917)
      2. Step 01-08 references actual test: test_orchestrator_invokes_subagent_stop_hook_on_completion
      3. Both wiring tests import DESOrchestrator (entry point, not SubagentStopHook)
      4. 8 steps properly cover 10 acceptance scenarios with documented grouping

    step_to_scenario_check:
      acceptance_scenarios: 10
      roadmap_steps: 8
      mapping: "8 steps cover 10 scenarios (logical grouping)"
      status: "VERIFIED"
      note: "Step 01-07 covers 2 happy paths; Step 01-08 covers 2 wiring tests"

    integration_step_check:
      integration_steps: 1
      step_id: "01-08"
      step_type: "integration"
      targets_entry_point: true
      entry_point: "DESOrchestrator.on_subagent_complete()"
      wiring_test_added: true
      status: "VERIFIED"

    boundary_check:
      entry_point_module: "des.orchestrator.DESOrchestrator"
      acceptance_test_imports_entry_point: true
      wiring_tests:
        - "test_orchestrator_invokes_subagent_stop_hook_on_completion"
        - "test_orchestrator_detects_abandoned_phase_via_entry_point"
      status: "VERIFIED"

  # =============================================================================
  # DEPENDENCIES AND ARCHITECTURE NOTES
  # =============================================================================

  architecture_notes:
    module_structure:
      new_file: "des/hooks.py"
      reason: "Separate hooks module maintains single responsibility"
      classes:
        - name: "SubagentStopHook"
          purpose: "Validates step file state after sub-agent completion"
          methods:
            - "on_agent_complete(step_file_path: str) -> HookResult"
            - "_validate_phases(phases: list) -> list[ValidationError]"
            - "_generate_recovery_suggestions(errors: list) -> list[str]"
        - name: "HookResult"
          purpose: "Dataclass for validation result"
          fields:
            - "validation_status: str"
            - "abandoned_phases: list[str]"
            - "incomplete_phases: list[str]"
            - "invalid_skips: list[str]"
            - "error_count: int"
            - "error_type: Optional[str]"
            - "error_message: Optional[str]"
            - "recovery_suggestions: list[str]"
        - name: "ValidationRule (Protocol)"
          purpose: "Interface for pluggable validation rules"
          methods:
            - "validate(phase: dict) -> Optional[ValidationError]"

    integration_strategy:
      approach: "Dependency injection"
      description: |
        DESOrchestrator will receive SubagentStopHook via constructor injection,
        allowing easy testing and future hook extensions.
      orchestrator_changes:
        - "Add _hook: SubagentStopHook field"
        - "Add on_subagent_complete(step_file_path) method"
        - "Wire hook invocation in method"

    test_strategy:
      unit_tests:
        location: "tests/unit/des/test_hooks.py"
        coverage_target: 80
        test_count_estimate: "15-20 tests"
      acceptance_tests:
        location: "tests/acceptance/test_us003_post_execution_validation.py"
        scenarios: 8
        current_state: "all_skipped (RED)"
        target_state: "all_passing (GREEN)"
