{
  "task_specification": {
    "task_id": "05-04",
    "phase_id": "05",
    "name": "Scenario 014: Include timeout warnings in agent prompt",
    "description": "Update prompt rendering to include emitted timeout warnings in context when phase has crossed warning thresholds. Format: 'TIMEOUT WARNING: 75% elapsed (30 minutes) - 10 minutes remaining'. Warnings appear in visible agent context before tool invocations.",
    "acceptance_test_scenario": "test_scenario_014_agent_receives_timeout_warnings_in_prompt",
    "acceptance_criteria": [
      "GIVEN phase execution crossed 75% threshold (30 minutes of 40-minute budget)",
      "WHEN agent receives next turn prompt",
      "THEN prompt includes 'TIMEOUT WARNING' prefix AND threshold value AND 'minute' unit AND ('elapsed' OR 'running') indication"
    ],
    "requires": [
      "05-03"
    ],
    "estimated_hours": 2
  },
  "tdd_cycle": {
    "phases": [
      {
        "phase_number": 1,
        "phase_name": "PREPARE",
        "description": "Remove @skip tags, verify scenario setup",
        "checks": [
          "Acceptance test file located: tests/acceptance/test_us006_turn_discipline.py",
          "@skip tag removed from test_scenario_014",
          "Warning emission from 05-03 confirmed",
          "Prompt rendering mechanism understood"
        ]
      },
      {
        "phase_number": 2,
        "phase_name": "RED_ACCEPTANCE",
        "description": "Run acceptance test, expect FAIL",
        "checks": [
          "Test discovered: test_scenario_014_agent_receives_timeout_warnings_in_prompt",
          "Test simulates phase with threshold crossed",
          "Test renders prompt and checks for warning",
          "Test fails: prompt does not include warning or format incorrect"
        ]
      },
      {
        "phase_number": 3,
        "phase_name": "RED_UNIT",
        "description": "Write failing unit tests",
        "checks": [
          "Unit test file created: tests/unit/test_warning_in_prompt.py",
          "Test: Warnings not included if none emitted",
          "Test: Warning included in prompt when emitted",
          "Test: Warning includes 'TIMEOUT WARNING' prefix",
          "Test: Warning includes threshold value (%)",
          "Test: Warning includes 'minute' unit",
          "Test: Warning includes 'elapsed' or 'running' indication",
          "Test: Multiple warnings rendered if multiple thresholds crossed",
          "All tests fail (warnings not yet rendered in prompt)"
        ]
      },
      {
        "phase_number": 4,
        "phase_name": "GREEN_UNIT",
        "description": "Implement minimum code to pass",
        "checks": [
          "Retrieve warnings_emitted from execution context",
          "If warnings exist, add them to prompt context",
          "Format each warning in prompt-visible section",
          "Use format: 'TIMEOUT WARNING: 75% elapsed (30 minutes) - 10 minutes remaining'",
          "Include before tool invocation context (agents see it prominently)",
          "All unit tests PASS"
        ]
      },
      {
        "phase_number": 5,
        "phase_name": "CHECK_ACCEPTANCE",
        "description": "Verify unit implementation",
        "checks": [
          "Warning retrieval from context verified",
          "Warning format in prompt verified",
          "Warnings appear in correct location (before tools)",
          "Multiple warnings handled correctly",
          "No warnings when none emitted"
        ]
      },
      {
        "phase_number": 6,
        "phase_name": "GREEN_ACCEPTANCE",
        "description": "Run acceptance test, expect PASS",
        "checks": [
          "Acceptance test PASSES: warnings included in prompt with correct format",
          "test_scenario_014_agent_receives_timeout_warnings_in_prompt PASSES"
        ]
      },
      {
        "phase_number": 7,
        "phase_name": "REVIEW",
        "description": "Self-review (SOLID, coverage, acceptance criteria)",
        "checks": [
          "SOLID review: Warning rendering has single responsibility",
          "Test coverage >80% for warning rendering",
          "Acceptance criteria met: TIMEOUT WARNING prefix, threshold, minutes, elapsed indication",
          "No security issues with warning display",
          "Warning visibility optimal for agent comprehension"
        ]
      },
      {
        "phase_number": 8,
        "phase_name": "REFACTOR_L1",
        "description": "Naming clarity improvements",
        "checks": [
          "Warning format clear and prominent ('TIMEOUT WARNING')",
          "Variable names descriptive",
          "All tests still pass"
        ]
      },
      {
        "phase_number": 9,
        "phase_name": "REFACTOR_L2",
        "description": "Method extraction",
        "checks": [
          "Warning formatting extracted to helper method",
          "Context insertion extracted if needed",
          "All tests still pass"
        ]
      },
      {
        "phase_number": 10,
        "phase_name": "REFACTOR_L3",
        "description": "Class responsibilities",
        "checks": [
          "Prompt builder maintains clear responsibility",
          "Warning rendering cohesive with prompt building",
          "All tests still pass"
        ]
      },
      {
        "phase_number": 11,
        "phase_name": "REFACTOR_L4",
        "description": "Architecture patterns",
        "checks": [
          "Follows existing prompt rendering patterns",
          "All tests still pass"
        ]
      },
      {
        "phase_number": 12,
        "phase_name": "POST_REFACTOR_REVIEW",
        "description": "Self-review (tests pass, quality improved)",
        "checks": [
          "All unit tests PASS",
          "Acceptance test PASSES",
          "Code quality maintained",
          "No regressions in prompt building"
        ]
      },
      {
        "phase_number": 13,
        "phase_name": "FINAL_VALIDATE",
        "description": "Full test suite validation",
        "checks": [
          "Full test suite executes: pytest tests/",
          "Coverage >=80% for warning rendering",
          "No new warnings or errors",
          "Scenarios 001-010, 006-007, 013 still pass"
        ]
      },
      {
        "phase_number": 14,
        "phase_name": "COMMIT",
        "description": "Commit with detailed message",
        "checks": [
          "Commit message format: 'feat(timeout-warnings-014): Include timeout warnings in agent prompt'",
          "All tests still pass",
          "Clean working directory"
        ]
      }
    ],
    "tdd_phase_tracking": {
      "current_phase": "PREPARE",
      "phase_execution_log": []
    }
  },
  "validation": {
    "status": "approved",
    "notes": "Feature step: Scenario 014 - Warning visibility to agents",
    "approval_date": "2026-01-28T15:33:57.296549+00:00"
  }
}
