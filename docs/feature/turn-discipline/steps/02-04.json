{
  "task_specification": {
    "task_id": "02-04",
    "phase_id": "02",
    "name": "Scenario 004: Document early exit protocol in TIMEOUT_INSTRUCTION",
    "description": "Add early exit protocol guidance explaining how agents should gracefully exit when stuck: save progress, set phase to IN_PROGRESS, return with PARTIAL_COMPLETION status. Include state-saving guidance (save, progress, in_progress, notes, update).",
    "acceptance_test_scenario": "test_scenario_004_timeout_instruction_documents_early_exit_protocol",
    "acceptance_criteria": [
      "GIVEN TIMEOUT_INSTRUCTION with early exit guidance",
      "WHEN prompt renders",
      "THEN section contains 'early exit', 'cannot complete', 'save progress', 'partial', 'stuck' OR 'return...budget' AND mentions state-saving terms"
    ],
    "requires": [
      "02-03"
    ],
    "estimated_hours": 2
  },
  "tdd_cycle": {
    "phases": [
      {
        "phase_number": 1,
        "phase_name": "PREPARE",
        "description": "Remove @skip tags, verify scenario setup",
        "checks": [
          "Acceptance test file located: tests/acceptance/test_us006_turn_discipline.py",
          "@skip tag removed from test_scenario_004",
          "Previous checkpoints and turn budget confirmed",
          "Early exit protocol requirements reviewed"
        ]
      },
      {
        "phase_number": 2,
        "phase_name": "RED_ACCEPTANCE",
        "description": "Run acceptance test, expect FAIL",
        "checks": [
          "Test discovered: test_scenario_004_timeout_instruction_documents_early_exit_protocol",
          "Test invokes /nw:execute command",
          "Test fails: prompt does not contain early exit protocol keywords"
        ]
      },
      {
        "phase_number": 3,
        "phase_name": "RED_UNIT",
        "description": "Write failing unit tests",
        "checks": [
          "Unit test file created: tests/unit/test_early_exit_protocol.py",
          "Test: TIMEOUT_INSTRUCTION contains at least one of ('early exit', 'cannot complete', 'save progress', 'partial', 'stuck', 'return...budget')",
          "Test: TIMEOUT_INSTRUCTION mentions state-saving terms (save, progress, in_progress, notes, update)",
          "Test: Early exit and state-saving terms appear together or in close proximity",
          "All tests fail (protocol not yet added)"
        ]
      },
      {
        "phase_number": 4,
        "phase_name": "GREEN_UNIT",
        "description": "Implement minimum code to pass",
        "checks": [
          "Add early exit protocol section to TIMEOUT_INSTRUCTION",
          "Include at least one keyword: 'early exit', 'cannot complete', 'save progress', 'partial', 'stuck', or 'return...budget'",
          "Include state-saving guidance: save progress, set phase to IN_PROGRESS, return PARTIAL_COMPLETION",
          "Mention state-saving terms: save, progress, in_progress, notes, update",
          "Provide clear instructions for graceful exit when blocked",
          "All unit tests PASS"
        ]
      },
      {
        "phase_number": 5,
        "phase_name": "CHECK_ACCEPTANCE",
        "description": "Verify unit implementation",
        "checks": [
          "Early exit protocol language verified in template",
          "State-saving guidance verified: save progress, IN_PROGRESS status, PARTIAL_COMPLETION return",
          "Protocol clarity verified: agents understand what to do when stuck",
          "Integration with checkpoints verified: flows naturally from previous content"
        ]
      },
      {
        "phase_number": 6,
        "phase_name": "GREEN_ACCEPTANCE",
        "description": "Run acceptance test, expect PASS",
        "checks": [
          "Acceptance test PASSES: early exit keywords and state-saving terms found",
          "test_scenario_004_timeout_instruction_documents_early_exit_protocol PASSES"
        ]
      },
      {
        "phase_number": 7,
        "phase_name": "REVIEW",
        "description": "Self-review (SOLID, coverage, acceptance criteria)",
        "checks": [
          "SOLID review: Content focused on early exit protocol",
          "Test coverage >80% for early exit content",
          "Acceptance criteria met: keywords and state-saving terms present",
          "No security issues",
          "Protocol aligns with technical requirements"
        ]
      },
      {
        "phase_number": 8,
        "phase_name": "REFACTOR_L1",
        "description": "Naming clarity improvements",
        "checks": [
          "Early exit terminology is clear for agents",
          "State-saving steps are clearly described",
          "Language uses business/technical terms (progress, IN_PROGRESS, PARTIAL_COMPLETION)",
          "All tests still pass"
        ]
      },
      {
        "phase_number": 9,
        "phase_name": "REFACTOR_L2",
        "description": "Method extraction",
        "checks": [
          "Early exit guidance is template text (no method extraction)",
          "All tests still pass"
        ]
      },
      {
        "phase_number": 10,
        "phase_name": "REFACTOR_L3",
        "description": "Class responsibilities",
        "checks": [
          "Template builder maintains clear responsibility",
          "Early exit content cohesive with template",
          "All tests still pass"
        ]
      },
      {
        "phase_number": 11,
        "phase_name": "REFACTOR_L4",
        "description": "Architecture patterns",
        "checks": [
          "Follows existing template content patterns",
          "All tests still pass"
        ]
      },
      {
        "phase_number": 12,
        "phase_name": "POST_REFACTOR_REVIEW",
        "description": "Self-review (tests pass, quality improved)",
        "checks": [
          "All unit tests PASS",
          "Acceptance test PASSES",
          "Code quality maintained",
          "No regressions in previous scenarios"
        ]
      },
      {
        "phase_number": 13,
        "phase_name": "FINAL_VALIDATE",
        "description": "Full test suite validation",
        "checks": [
          "Full test suite executes: pytest tests/",
          "Coverage maintained",
          "No new warnings or errors",
          "Scenarios 001, 002, 003 still pass"
        ]
      },
      {
        "phase_number": 14,
        "phase_name": "COMMIT",
        "description": "Commit with detailed message",
        "checks": [
          "Commit message format: 'feat(timeout-instruction-004): Add early exit protocol to TIMEOUT_INSTRUCTION'",
          "All tests still pass",
          "Clean working directory"
        ]
      }
    ],
    "tdd_phase_tracking": {
      "current_phase": "PREPARE",
      "phase_execution_log": []
    }
  },
  "validation": {
    "status": "approved",
    "notes": "Feature step: Scenario 004 - Early exit protocol guidance",
    "approval_date": "2026-01-28T15:33:57.296549+00:00"
  }
}
