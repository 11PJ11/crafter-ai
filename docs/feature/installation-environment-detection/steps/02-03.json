{
  "schema_version": "2.0",
  "task_id": "02-03",
  "project_id": "installation-environment-detection",
  "step_type": "atdd",
  "execution_agent": "software-crafter",

  "self_contained_context": {
    "background": "The installer must verify required Python dependencies before attempting to build. This prevents cryptic build failures and provides actionable remediation.",
    "prerequisites": [
      "01-01: Error Codes Module must be complete",
      "02-01: Virtual Environment Check must be complete",
      "02-02: Pipenv Availability Check must be complete"
    ],
    "relevant_files": [
      "scripts/install/error_codes.py",
      "scripts/install/preflight_checker.py",
      "tests/unit/test_preflight_checker.py",
      "tests/unit/test_preflight_dependencies.py"
    ],
    "technical_context": "Extend preflight_checker.py with check_dependencies() function. Check for yaml, pathlib, and other required modules using importlib.util.find_spec(). Return PreflightResult with DEP_MISSING error code listing all missing modules. Run dependency check before build phase."
  },

  "task_specification": {
    "name": "Dependency Verification",
    "description": "Extend preflight_checker.py with dependency verification. Check for yaml, pathlib and other required modules. Report all missing modules before build phase begins.",
    "motivation": "Build failures due to missing dependencies are confusing. Pre-flight dependency checks provide clear remediation steps.",
    "detailed_instructions": "1. Add check_dependencies() function to preflight_checker.py. 2. Define REQUIRED_MODULES list with yaml, pathlib, etc. 3. Use importlib.util.find_spec() for module detection. 4. Collect ALL missing modules before returning result. 5. Return DEP_MISSING error code with full module list. 6. Create tests/unit/test_preflight_dependencies.py.",
    "acceptance_criteria": "All dependencies present allows check to pass; Single missing dependency shows module name; Multiple missing dependencies lists all modules; Dependency check runs before build attempt; Required dependencies list is comprehensive; Dependency error provides complete remediation",
    "estimated_hours": 2
  },

  "dependencies": {
    "requires": ["02-02"],
    "blocking": ["05-01"]
  },

  "state": {
    "status": "DONE",
    "assigned_to": "software-crafter",
    "started_at": "2026-01-29T10:00:00Z",
    "completed_at": "2026-01-29T10:30:00Z"
  },

  "tdd_cycle": {
    "acceptance_test": {
      "scenario_name": "All dependencies present allows check to pass",
      "test_file": "tests/acceptance/installation/test_preflight_dependencies.feature",
      "test_file_format": "py_pytest",
      "scenario_index": 0,
      "initially_ignored": true,
      "is_walking_skeleton": false,
      "mapped_scenario": {
        "description": "Validates dependency verification with all dependencies present",
        "scenario_function": "test_all_dependencies_present_passes",
        "scenario_description": "All dependencies present allows check to pass",
        "mapping_type": "feature",
        "notes": "First of 6 scenarios for dependency verification"
      }
    },
    "expected_unit_tests": [
      "test_check_dependencies_all_present",
      "test_check_dependencies_single_missing",
      "test_check_dependencies_multiple_missing",
      "test_dependency_check_before_build",
      "test_required_modules_list_comprehensive",
      "test_dependency_error_remediation_message"
    ],
    "mock_boundaries": {
      "allowed_ports": ["importlib.util.find_spec"],
      "forbidden_domain_classes": ["PreflightChecker"],
      "in_memory_adapters": []
    },
    "tdd_phase_tracking": {
      "current_phase": "COMMIT",
      "active_e2e_test": "",
      "inactive_e2e_tests": "All other @skip scenarios remain disabled",
      "phases_completed": ["PREPARE", "RED_UNIT", "GREEN", "REFACTOR_CONTINUOUS", "COMMIT"],
      "test_results": {
        "total": 7,
        "passed": 7,
        "failed": 0,
        "skipped": 0
      }
    },
    "phase_execution_log": [
      {
        "phase_name": "PREPARE",
        "phase_index": 0,
        "status": "EXECUTED",
        "started_at": "2026-01-29T10:00:00Z",
        "ended_at": "2026-01-29T10:02:00Z",
        "duration_minutes": 2,
        "outcome": "PASS",
        "notes": "Read step file 02-03.json, reviewed preflight_checker.py, error_codes.py, and existing test patterns",
        "blocked_by": null
      },
      {
        "phase_name": "RED_ACCEPTANCE",
        "phase_index": 1,
        "status": "SKIPPED",
        "started_at": null,
        "ended_at": null,
        "duration_minutes": null,
        "outcome": "NOT_APPLICABLE",
        "notes": "No acceptance test file exists yet - proceeding directly to unit tests per step instructions",
        "blocked_by": null
      },
      {
        "phase_name": "RED_UNIT",
        "phase_index": 2,
        "status": "EXECUTED",
        "started_at": "2026-01-29T10:02:00Z",
        "ended_at": "2026-01-29T10:10:00Z",
        "duration_minutes": 8,
        "outcome": "PASS",
        "notes": "Created tests/unit/test_preflight_dependencies.py with 7 tests. ImportError confirmed - DependencyCheck and REQUIRED_MODULES do not exist (expected RED)",
        "blocked_by": null
      },
      {
        "phase_name": "GREEN",
        "phase_index": 3,
        "status": "EXECUTED",
        "started_at": "2026-01-29T10:10:00Z",
        "ended_at": "2026-01-29T10:22:00Z",
        "duration_minutes": 12,
        "outcome": "PASS",
        "notes": "Implemented DependencyCheck class, REQUIRED_MODULES constant, added to PreflightChecker._checks. Fixed run_all_checks to iterate through all checks. All 7 tests pass, 25 total preflight tests pass.",
        "blocked_by": null
      },
      {
        "phase_name": "REVIEW",
        "phase_index": 4,
        "status": "SKIPPED",
        "started_at": null,
        "ended_at": null,
        "duration_minutes": null,
        "outcome": "NOT_APPLICABLE",
        "notes": "No peer review requested for this step",
        "blocked_by": null
      },
      {
        "phase_name": "REFACTOR_CONTINUOUS",
        "phase_index": 5,
        "status": "EXECUTED",
        "started_at": "2026-01-29T10:22:00Z",
        "ended_at": "2026-01-29T10:25:00Z",
        "duration_minutes": 3,
        "outcome": "PASS",
        "notes": "Code already follows clean patterns. Fixed run_all_checks to properly iterate through _checks list instead of creating new VirtualEnvironmentCheck. Linting passes.",
        "blocked_by": null
      },
      {
        "phase_name": "REFACTOR_L4",
        "phase_index": 6,
        "status": "SKIPPED",
        "started_at": null,
        "ended_at": null,
        "duration_minutes": null,
        "outcome": "NOT_APPLICABLE",
        "notes": "No architecture patterns needed - DependencyCheck follows established check pattern",
        "blocked_by": null
      },
      {
        "phase_name": "COMMIT",
        "phase_index": 7,
        "status": "PENDING",
        "started_at": "2026-01-29T10:25:00Z",
        "ended_at": null,
        "duration_minutes": null,
        "outcome": null,
        "notes": "Ready for commit - all tests pass, linting clean",
        "blocked_by": null
      }
    ]
  },

  "quality_gates": {
    "test_coverage_minimum": 80,
    "all_acceptance_tests_pass": true,
    "no_linting_errors": true
  }
}
