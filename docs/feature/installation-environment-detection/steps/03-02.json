{
  "schema_version": "2.0",
  "task_id": "03-02",
  "project_id": "installation-environment-detection",
  "step_type": "atdd",
  "execution_agent": "software-crafter",

  "self_contained_context": {
    "background": "When running in Claude Code context, the installer must output JSON for machine parsing. This enables automated error handling and remediation.",
    "prerequisites": [
      "01-01: Error Codes Module must be complete",
      "01-02: Context Detector - Terminal/Claude Detection must be complete",
      "03-01: Terminal Error Formatting must be complete"
    ],
    "relevant_files": [
      "scripts/install/error_codes.py",
      "scripts/install/context_detector.py",
      "scripts/install/output_formatter.py",
      "tests/unit/test_output_formatter.py",
      "tests/unit/test_output_formatter_json.py"
    ],
    "technical_context": "Extend output_formatter.py with format_json_error() function. JSON output must include: error_code (from error_codes.py), message (human-readable), remediation (action to take), recoverable (boolean), timestamp (ISO 8601). Use context_detector.is_claude_code_context() to determine when to use JSON output."
  },

  "task_specification": {
    "name": "Claude Code JSON Formatting",
    "description": "Extend output_formatter.py with JSON output for Claude Code context. Include error_code, message, remediation, recoverable, timestamp fields.",
    "motivation": "Claude Code can parse JSON errors and provide automated remediation, improving the user experience when running through the AI assistant.",
    "detailed_instructions": "1. Add format_json_error() function to output_formatter.py. 2. Include all required fields: error_code, message, remediation, recoverable, timestamp. 3. Use ISO 8601 format for timestamp. 4. Add format_error() method that selects terminal or JSON based on context. 5. Create tests/unit/test_output_formatter_json.py.",
    "acceptance_criteria": "Claude Code context outputs JSON error for missing venv; Claude Code context outputs JSON error for missing pipenv; Claude Code context outputs JSON error for missing dependency; Claude Code JSON includes all required error fields",
    "estimated_hours": 2
  },

  "dependencies": {
    "requires": ["03-01"],
    "blocking": ["03-03", "04-02"]
  },

  "state": {
    "status": "DONE",
    "assigned_to": "software-crafter",
    "started_at": "2026-01-29T10:00:00Z",
    "completed_at": "2026-01-29T10:30:00Z"
  },

  "tdd_cycle": {
    "acceptance_test": {
      "scenario_name": "Claude Code context outputs JSON error for missing venv",
      "test_file": "tests/unit/test_output_formatter_json.py",
      "test_file_format": "py_pytest",
      "scenario_index": 0,
      "initially_ignored": false,
      "is_walking_skeleton": false,
      "mapped_scenario": {
        "description": "Validates JSON error output for venv errors in Claude Code context",
        "scenario_function": "test_claude_code_context_outputs_json_error_for_missing_venv",
        "scenario_description": "Claude Code context outputs JSON error for missing venv",
        "mapping_type": "feature",
        "notes": "First of 4 scenarios for JSON formatting"
      }
    },
    "expected_unit_tests": [
      "test_format_json_error_structure",
      "test_format_json_error_venv",
      "test_format_json_error_pipenv",
      "test_format_json_error_dependency",
      "test_format_json_all_required_fields",
      "test_format_json_timestamp_iso8601",
      "test_format_error_selects_mode"
    ],
    "mock_boundaries": {
      "allowed_ports": [],
      "forbidden_domain_classes": ["OutputFormatter"],
      "in_memory_adapters": []
    },
    "tdd_phase_tracking": {
      "current_phase": "COMMIT",
      "active_e2e_test": "test_claude_code_context_outputs_json_error_for_missing_venv",
      "inactive_e2e_tests": "None - all scenarios passing",
      "phases_completed": ["PREPARE", "RED_UNIT", "GREEN", "REVIEW", "REFACTOR_CONTINUOUS", "COMMIT"],
      "test_results": {
        "total": 14,
        "passed": 14,
        "failed": 0,
        "skipped": 0
      }
    },
    "phase_execution_log": [
      {"phase_name": "PREPARE", "phase_index": 0, "status": "EXECUTED", "started_at": "2026-01-29T10:00:00Z", "ended_at": "2026-01-29T10:02:00Z", "duration_minutes": 2, "outcome": "SUCCESS", "notes": "Read step file, output_formatter.py, error_codes.py, context_detector.py", "blocked_by": null},
      {"phase_name": "RED_ACCEPTANCE", "phase_index": 1, "status": "SKIPPED", "started_at": null, "ended_at": null, "duration_minutes": null, "outcome": "NOT_APPLICABLE", "notes": "Unit tests serve as acceptance criteria for this step", "blocked_by": null},
      {"phase_name": "RED_UNIT", "phase_index": 2, "status": "EXECUTED", "started_at": "2026-01-29T10:02:00Z", "ended_at": "2026-01-29T10:10:00Z", "duration_minutes": 8, "outcome": "SUCCESS", "notes": "Created tests/unit/test_output_formatter_json.py with 14 failing tests", "blocked_by": null},
      {"phase_name": "GREEN", "phase_index": 3, "status": "EXECUTED", "started_at": "2026-01-29T10:10:00Z", "ended_at": "2026-01-29T10:22:00Z", "duration_minutes": 12, "outcome": "SUCCESS", "notes": "Added ClaudeCodeFormatter class and format_error function to output_formatter.py", "blocked_by": null},
      {"phase_name": "REVIEW", "phase_index": 4, "status": "EXECUTED", "started_at": "2026-01-29T10:22:00Z", "ended_at": "2026-01-29T10:25:00Z", "duration_minutes": 3, "outcome": "SUCCESS", "notes": "All 14 new tests pass, 20 existing tests pass, linting clean", "blocked_by": null},
      {"phase_name": "REFACTOR_CONTINUOUS", "phase_index": 5, "status": "EXECUTED", "started_at": "2026-01-29T10:25:00Z", "ended_at": "2026-01-29T10:28:00Z", "duration_minutes": 3, "outcome": "SUCCESS", "notes": "Fixed unused imports in test file, code structure clean", "blocked_by": null},
      {"phase_name": "REFACTOR_L4", "phase_index": 6, "status": "SKIPPED", "started_at": null, "ended_at": null, "duration_minutes": null, "outcome": "NOT_APPLICABLE", "notes": "No architectural patterns needed - simple class addition", "blocked_by": null},
      {"phase_name": "COMMIT", "phase_index": 7, "status": "EXECUTED", "started_at": "2026-01-29T10:28:00Z", "ended_at": "2026-01-29T10:30:00Z", "duration_minutes": 2, "outcome": "SUCCESS", "notes": "Step marked DONE, ready for commit", "blocked_by": null}
    ]
  },

  "quality_gates": {
    "test_coverage_minimum": 80,
    "all_acceptance_tests_pass": true,
    "no_linting_errors": true
  },

  "implementation_summary": {
    "files_created": [
      "tests/unit/test_output_formatter_json.py"
    ],
    "files_modified": [
      "scripts/install/output_formatter.py"
    ],
    "classes_added": [
      "ClaudeCodeFormatter"
    ],
    "functions_added": [
      "format_error",
      "ClaudeCodeFormatter.format_json_error",
      "ClaudeCodeFormatter.format_venv_error",
      "ClaudeCodeFormatter.format_pipenv_error",
      "ClaudeCodeFormatter.format_dependency_error"
    ],
    "test_count": 14,
    "backward_compatible": true
  }
}
