# Baseline Measurement: Installation Environment Detection
# Feature ID: APEX-002
# Created by: Nova (Evidence-Driven Knowledge Researcher)

baseline:
  project_id: "installation-environment-detection"
  feature_id: "APEX-002"
  created_at: "2026-01-29T16:00:00Z"
  type: "feature_development"
  brownfield: true
  feature: "Pre-flight environment detection with context-aware errors for nWave installer"

# =============================================================================
# Requirements Source and Context
# =============================================================================
requirements_source:
  origin: "Smoke testing on virgin machine"
  parking_lot_item: "docs/parking-lot/APEX-002-install-script-environment-detection.md"
  discovery_date: "2026-01-29"
  reporter: "Vera (orchestrator)"
  problem_statement: |
    Users running install_nwave.py on virgin machines encounter cryptic
    'ModuleNotFoundError: No module named yaml' with no guidance on how to fix.
    Marco spent 30 minutes searching before discovering he needed pipenv and
    a virtual environment.

# =============================================================================
# Current State Analysis
# =============================================================================
current_state:
  existing_script: "scripts/install/install_nwave.py"
  existing_utilities: "scripts/install/install_utils.py"

  what_exists:
    - name: "Basic installation flow"
      location: "install_nwave.py"
      description: "Builds and installs nWave framework to ~/.claude/"
    - name: "Validation after install"
      location: "install_nwave.py:validate_installation()"
      description: "Checks agent/command directories exist, essential commands present"
    - name: "Logging infrastructure"
      location: "install_utils.py:Logger"
      description: "Timestamped logging to file and console"
    - name: "Color output"
      location: "install_utils.py:Colors"
      description: "ANSI color codes for terminal output"
    - name: "Path utilities"
      location: "install_utils.py:PathUtils"
      description: "Cross-platform path handling, file counting"
    - name: "Backup management"
      location: "install_utils.py:BackupManager"
      description: "Backup existing installation before upgrade"

  what_is_missing:
    - name: "Pre-flight environment validation"
      gap: "No check before build; script fails mid-way with raw traceback"
    - name: "Virtual environment detection"
      gap: "Users may pollute global Python without warning"
    - name: "Pipenv availability check"
      gap: "No check if pipenv is installed before referencing it"
    - name: "Dependency verification before build"
      gap: "Build phase fails instead of failing gracefully at start"
    - name: "Context-aware error messages"
      gap: "No JSON output for Claude Code self-healing"
    - name: "Standalone verification script"
      gap: "No way to verify installation health without re-running installer"

  insufficiency_rationale: |
    The current approach is insufficient because:
    1. Errors occur mid-installation instead of at start (fails slow, not fast)
    2. Error messages are raw Python tracebacks, not actionable guidance
    3. No detection of execution context (terminal vs Claude Code)
    4. No structured errors for automated remediation
    5. No pre-flight validation of environment prerequisites

# =============================================================================
# Measurements
# =============================================================================
measurements:
  - name: "acceptance_tests_passing"
    description: "Number of acceptance test scenarios currently passing"
    current: 0
    target: 57
    unit: "scenarios"
    method: "All tests marked with @skip; 0 passing until implementation begins"
    breakdown:
      ac01_preflight_checks: {scenarios: 3, status: "skip"}
      ac02_venv_hard_block: {scenarios: 3, status: "skip"}
      ac03_pipenv_only: {scenarios: 3, status: "skip"}
      ac04_terminal_errors: {scenarios: 3, status: "skip"}
      ac05_claude_code_errors: {scenarios: 5, status: "skip"}
      ac06_dependency_verification: {scenarios: 6, status: "skip"}
      ac07_auto_verification: {scenarios: 5, status: "skip"}
      ac08_standalone_verification: {scenarios: 5, status: "skip"}
      ac09_logging: {scenarios: 6, status: "skip"}
      ac10_documentation: {scenarios: 5, status: "skip"}
      ac11_ci_detection: {scenarios: 4, status: "skip"}
      ac12_ci_output: {scenarios: 3, status: "skip"}
      ac13_ci_exit_codes: {scenarios: 2, status: "skip"}
      ac14_container_detection: {scenarios: 2, status: "skip"}
      ac15_ci_container_combined: {scenarios: 2, status: "skip"}

  - name: "components_implemented"
    description: "New Python modules created for environment detection"
    current: 0
    target: 6
    unit: "modules"
    method: "Count new .py files in scripts/install/ for this feature"
    target_components:
      - preflight_checker.py
      - context_detector.py
      - output_formatter.py
      - installation_verifier.py
      - error_codes.py
      - verify_nwave.py

  - name: "install_scripts_count"
    description: "Total Python scripts in scripts/install/"
    current: 5
    target: 11
    unit: "files"
    method: "ls scripts/install/*.py | wc -l"
    current_files:
      - install_nwave.py
      - install_utils.py
      - uninstall_nwave.py
      - update_nwave.py
      - enhanced_backup_system.py

  - name: "feature_files_exist"
    description: "Gherkin feature files for acceptance testing"
    current: 7
    target: 7
    unit: "files"
    method: "All feature files created during DISTILL wave"
    files:
      - 01_preflight_checks.feature
      - 02_error_messages.feature
      - 03_dependency_verification.feature
      - 04_post_installation.feature
      - 05_logging.feature
      - 06_documentation.feature
      - 07_ci_environment.feature

  - name: "documentation_updated"
    description: "Installation guide updated with correct prerequisites"
    current: false
    target: true
    unit: "boolean"
    file: "docs/installation/installation-guide.md"
    changes_needed:
      - "Update Python version to 3.8+ (not 3.11+)"
      - "Add pipenv as prerequisite"
      - "Add virtual environment setup section"
      - "Update quick start with pipenv commands"

# =============================================================================
# User Stories
# =============================================================================
user_stories:
  US-001:
    title: "First-Time Installation on Virgin Machine"
    persona: "Marco (new developer)"
    priority: "High"
    tests: 9
    passing: 0
    components_needed:
      - preflight_checker.py
      - context_detector.py
      - output_formatter.py
      - error_codes.py
    target_components: 4
    acceptance_criteria:
      - AC-01
      - AC-02
      - AC-03
      - AC-04

  US-002:
    title: "Dependency Verification Before Build"
    persona: "Sofia (returning user)"
    priority: "High"
    tests: 6
    passing: 0
    components_needed:
      - preflight_checker.py
      - output_formatter.py
    target_components: 2
    acceptance_criteria:
      - AC-04
      - AC-06

  US-003:
    title: "Post-Installation Verification"
    persona: "Kenji (methodical user)"
    priority: "Medium"
    tests: 10
    passing: 0
    components_needed:
      - installation_verifier.py
      - verify_nwave.py
      - output_formatter.py
    target_components: 3
    acceptance_criteria:
      - AC-07
      - AC-08

  US-004:
    title: "Claude Code Self-Healing Installation"
    persona: "Vera (Claude Code agent)"
    priority: "Medium"
    tests: 5
    passing: 0
    components_needed:
      - context_detector.py
      - output_formatter.py
      - error_codes.py
    target_components: 3
    acceptance_criteria:
      - AC-05

  US-005:
    title: "Installation Documentation Clarity"
    persona: "Alex (documentation follower)"
    priority: "High"
    tests: 5
    passing: 0
    components_needed: []
    target_components: 0
    documentation_only: true
    acceptance_criteria:
      - AC-10
    files_to_update:
      - docs/installation/installation-guide.md

# =============================================================================
# Component Dependencies
# =============================================================================
dependencies:
  component_dependencies:
    - source: "preflight_checker.py"
      depends_on: "error_codes.py"
      reason: "Uses error code constants for check results"

    - source: "output_formatter.py"
      depends_on: "error_codes.py"
      reason: "Uses error code constants for message formatting"

    - source: "output_formatter.py"
      depends_on: "context_detector.py"
      reason: "Needs execution context to determine output format"

    - source: "output_formatter.py"
      depends_on: "install_utils.py:Colors"
      reason: "Uses existing Colors class for terminal formatting"

    - source: "verify_nwave.py"
      depends_on: "installation_verifier.py"
      reason: "Thin wrapper around verification logic"

    - source: "verify_nwave.py"
      depends_on: "context_detector.py"
      reason: "Determines output mode (terminal vs JSON)"

    - source: "verify_nwave.py"
      depends_on: "output_formatter.py"
      reason: "Formats verification results"

    - source: "install_nwave.py"
      depends_on: "preflight_checker.py"
      reason: "Calls preflight checks before installation"

    - source: "install_nwave.py"
      depends_on: "installation_verifier.py"
      reason: "Refactored validate_installation() uses shared verifier"

  implementation_order:
    - order: 1
      component: "error_codes.py"
      reason: "No dependencies, provides constants for other modules"
    - order: 2
      component: "context_detector.py"
      reason: "Minimal dependencies (sys, os only)"
    - order: 3
      component: "preflight_checker.py"
      reason: "Depends only on error_codes and stdlib"
    - order: 4
      component: "output_formatter.py"
      reason: "Depends on error_codes, context_detector, and install_utils"
    - order: 5
      component: "installation_verifier.py"
      reason: "Depends on install_utils for PathUtils"
    - order: 6
      component: "verify_nwave.py"
      reason: "Depends on all other new components"

# =============================================================================
# Validation
# =============================================================================
validation:
  status: "approved"
  reviewer: "software-crafter-reviewer"
  reviewed_at: "2026-01-29T17:45:00Z"
  checklist:
    - item: "All measurements documented with current and target values"
      status: true
    - item: "User stories linked to acceptance criteria"
      status: true
    - item: "Component dependencies mapped"
      status: true
    - item: "Implementation order defined"
      status: true
    - item: "Current state vs target state clearly documented"
      status: true
    - item: "Requirements source traced to parking lot item"
      status: true

# =============================================================================
# Metadata
# =============================================================================
metadata:
  schema_version: "1.0"
  wave: "ROADMAP"
  previous_waves:
    - wave: "DISCUSS"
      artifacts:
        - requirements.md
        - user-stories.md
        - acceptance-criteria.md
    - wave: "DESIGN"
      artifacts:
        - architecture-design.md
        - component-boundaries.md
        - technology-decisions.md
        - integration-plan.md
    - wave: "DISTILL"
      artifacts:
        - test-scenarios.md
        - feature files (7 files)
        - step definitions (7 files)
