# Roadmap: Installation Environment Detection
# Feature ID: APEX-002
# Created by: Morgan (Solution Architect)

roadmap:
  project_id: "installation-environment-detection"
  feature_id: "APEX-002"
  created_at: "2026-01-29T18:30:00Z"
  baseline_file: "docs/feature/installation-environment-detection/baseline.yaml"

  goal: "Implement pre-flight environment detection for nWave installer with context-aware errors"

  summary:
    total_scenarios: 57
    total_components: 6
    total_phases: 6
    total_steps: 15
    estimated_effort: "medium"

  # =============================================================================
  # Phase 01: Core Infrastructure
  # Foundation modules with no dependencies - can be implemented first
  # =============================================================================
  phases:
    - phase_id: "01"
      name: "Core Infrastructure"
      description: "Build foundational modules that other components depend on: error codes and context detection"
      user_stories: ["US-001", "US-004"]

      steps:
        - step_id: "01-01"
          name: "Error Codes Module"
          description: |
            Create error_codes.py module defining standardized error codes for all
            installer error conditions. This provides constants used by preflight_checker,
            output_formatter, and other modules.

            Error codes: ENV_NO_VENV, ENV_NO_PIPENV, DEP_MISSING, BUILD_FAILED, VERIFY_FAILED
          agent: "software-crafter"
          acceptance_criteria: ["AC-05"]
          scenarios_enabled: 1
          scenarios:
            - "Error code mapping is consistent"
          deliverables:
            - "scripts/install/error_codes.py"
            - "tests/unit/test_error_codes.py"
          estimated_effort: "small"
          dependencies: []

        - step_id: "01-02"
          name: "Context Detector - Terminal/Claude Detection"
          description: |
            Create context_detector.py with TTY/terminal detection and Claude Code
            context detection. Determines if running in interactive terminal vs
            non-interactive context (checks environment variables and stdout TTY).
            Foundation for output formatting decisions.

            Note: While "Claude Code context detection" is in the acceptance criteria
            document, it was not implemented as a separate feature scenario. Context
            detection is validated through AC-05 JSON error scenarios which test that
            the context is correctly detected by validating output format.
          agent: "software-crafter"
          acceptance_criteria: ["AC-05"]
          scenarios_enabled: 0
          scenarios: []
          note: "No direct acceptance test - validated through AC-05 JSON output scenarios"
          deliverables:
            - "scripts/install/context_detector.py"
            - "tests/unit/test_context_detector.py"
          estimated_effort: "small"
          dependencies: []

        - step_id: "01-03"
          name: "Context Detector - CI/Container Detection"
          description: |
            Extend context_detector.py with CI environment detection (GITHUB_ACTIONS,
            GITLAB_CI, CI, JENKINS_URL) and container detection (Docker, Kubernetes).
          agent: "software-crafter"
          acceptance_criteria: ["AC-11", "AC-14", "AC-15"]
          scenarios_enabled: 8
          scenarios:
            - "CI detection via GITHUB_ACTIONS environment variable"
            - "CI detection via GITLAB_CI environment variable"
            - "CI detection via generic CI environment variable"
            - "CI detection via JENKINS_URL environment variable"
            - "Container environment triggers warning but not block"
            - "Kubernetes container environment is detected"
            - "CI inside container shows both contexts"
            - "Non-CI non-container environment uses default behavior"
          deliverables:
            - "scripts/install/context_detector.py (extended)"
            - "tests/unit/test_context_detector_ci.py"
          estimated_effort: "medium"
          dependencies: ["01-02"]

    # =============================================================================
    # Phase 02: Pre-flight Validation
    # Core validation logic - depends on error_codes
    # =============================================================================
    - phase_id: "02"
      name: "Pre-flight Validation"
      description: "Implement pre-flight environment checks: virtual environment, pipenv, and dependencies"
      user_stories: ["US-001", "US-002"]

      steps:
        - step_id: "02-01"
          name: "Virtual Environment Check"
          description: |
            Create preflight_checker.py with virtual environment detection.
            Hard block when not in virtual environment. No bypass flag allowed.
          agent: "software-crafter"
          acceptance_criteria: ["AC-01", "AC-02"]
          scenarios_enabled: 6
          scenarios:
            # AC-01 scenarios
            - "Environment validation runs before any installation action"
            - "Pre-flight check validates virtual environment first"
            - "Pre-flight results are logged"
            # AC-02 scenarios
            - "Installation blocked when not in virtual environment"
            - "Skip-checks flag does not bypass virtual environment requirement"
            - "Installation proceeds when in virtual environment"
          deliverables:
            - "scripts/install/preflight_checker.py"
            - "tests/unit/test_preflight_checker.py"
          estimated_effort: "medium"
          dependencies: ["01-01"]

        - step_id: "02-02"
          name: "Pipenv Availability Check"
          description: |
            Extend preflight_checker.py with pipenv detection. Enforce pipenv-only
            policy - no mentions of pip, poetry, or conda alternatives.
          agent: "software-crafter"
          acceptance_criteria: ["AC-03"]
          scenarios_enabled: 3
          scenarios:
            - "Error when pipenv is not installed"
            - "Error messages reference only pipenv for dependency installation"
            - "Pipenv installation guidance is actionable"
          deliverables:
            - "scripts/install/preflight_checker.py (extended)"
            - "tests/unit/test_preflight_pipenv.py"
          estimated_effort: "small"
          dependencies: ["02-01"]

        - step_id: "02-03"
          name: "Dependency Verification"
          description: |
            Extend preflight_checker.py with dependency verification. Check for
            yaml, pathlib and other required modules. Report all missing modules
            before build phase begins.
          agent: "software-crafter"
          acceptance_criteria: ["AC-06"]
          scenarios_enabled: 6
          scenarios:
            - "All dependencies present allows check to pass"
            - "Single missing dependency shows module name"
            - "Multiple missing dependencies lists all modules"
            - "Dependency check runs before build attempt"
            - "Required dependencies list is comprehensive"
            - "Dependency error provides complete remediation"
          deliverables:
            - "scripts/install/preflight_checker.py (extended)"
            - "tests/unit/test_preflight_dependencies.py"
          estimated_effort: "medium"
          dependencies: ["02-02"]

    # =============================================================================
    # Phase 03: Output Formatting
    # Context-aware output - depends on error_codes and context_detector
    # =============================================================================
    - phase_id: "03"
      name: "Output Formatting"
      description: "Implement context-aware output formatting for terminal, Claude Code, and CI environments"
      user_stories: ["US-001", "US-004"]

      steps:
        - step_id: "03-01"
          name: "Terminal Error Formatting"
          description: |
            Create output_formatter.py with terminal-friendly error formatting.
            Use [ERROR]/[FIX]/[THEN] structure. Human-readable messages.
          agent: "software-crafter"
          acceptance_criteria: ["AC-04"]
          scenarios_enabled: 3
          scenarios:
            - "Terminal error format uses ERROR/FIX/THEN structure"
            - "Missing dependency error shows module name in terminal"
            - "Permission error provides clear terminal guidance"
          deliverables:
            - "scripts/install/output_formatter.py"
            - "tests/unit/test_output_formatter.py"
          estimated_effort: "small"
          dependencies: ["01-01", "01-02"]

        - step_id: "03-02"
          name: "Claude Code JSON Formatting"
          description: |
            Extend output_formatter.py with JSON output for Claude Code context.
            Include error_code, message, remediation, recoverable, timestamp fields.
          agent: "software-crafter"
          acceptance_criteria: ["AC-05"]
          scenarios_enabled: 4
          scenarios:
            - "Claude Code context outputs JSON error for missing venv"
            - "Claude Code context outputs JSON error for missing pipenv"
            - "Claude Code context outputs JSON error for missing dependency"
            - "Claude Code JSON includes all required error fields"
          deliverables:
            - "scripts/install/output_formatter.py (extended)"
            - "tests/unit/test_output_formatter_json.py"
          estimated_effort: "medium"
          dependencies: ["03-01"]

        - step_id: "03-03"
          name: "CI Mode Output Formatting"
          description: |
            Extend output_formatter.py with CI-specific formatting: no ANSI colors,
            verbose output by default, no interactive prompts.
          agent: "software-crafter"
          acceptance_criteria: ["AC-12", "AC-13"]
          scenarios_enabled: 5
          scenarios:
            - "CI mode disables ANSI color codes in output"
            - "CI mode enables verbose output by default"
            - "CI mode disables interactive prompts"
            - "CI mode returns non-zero exit code on failure"
            - "CI mode returns zero exit code on success"
          deliverables:
            - "scripts/install/output_formatter.py (extended)"
            - "tests/unit/test_output_formatter_ci.py"
          estimated_effort: "small"
          dependencies: ["03-02", "01-03"]

    # =============================================================================
    # Phase 04: Verification System
    # Post-installation checks - depends on install_utils
    # =============================================================================
    - phase_id: "04"
      name: "Verification System"
      description: "Implement installation verification components for post-install checks"
      user_stories: ["US-003"]

      steps:
        - step_id: "04-01"
          name: "Installation Verifier"
          description: |
            Create installation_verifier.py with verification logic. Check agent
            file counts, command file counts, manifest existence, essential commands.
          agent: "software-crafter"
          acceptance_criteria: ["AC-07"]
          scenarios_enabled: 5
          scenarios:
            - "Verification runs after successful build"
            - "Verification reports agent file count"
            - "Verification reports command file count"
            - "Verification reports manifest existence"
            - "Verification detects missing essential files"
          deliverables:
            - "scripts/install/installation_verifier.py"
            - "tests/unit/test_installation_verifier.py"
          estimated_effort: "medium"
          dependencies: ["01-01"]

        - step_id: "04-02"
          name: "Standalone Verification Script"
          description: |
            Create verify_nwave.py as standalone verification entry point.
            Use installation_verifier, context_detector, and output_formatter.
            Support terminal and JSON output modes.
          agent: "software-crafter"
          acceptance_criteria: ["AC-08"]
          scenarios_enabled: 5
          scenarios:
            - "Standalone verification script exists"
            - "Verification passes when fully installed"
            - "Verification fails with remediation when files missing"
            - "Verification checks essential DW commands"
            - "Verification validates schema template"
          deliverables:
            - "scripts/install/verify_nwave.py"
            - "tests/acceptance/installation/test_verify_nwave.py"
          estimated_effort: "medium"
          dependencies: ["04-01", "03-02", "01-02"]

    # =============================================================================
    # Phase 05: Integration
    # Connect new components to existing installer
    # =============================================================================
    - phase_id: "05"
      name: "Integration"
      description: "Integrate new components into existing install_nwave.py and add logging"
      user_stories: ["US-001", "US-002", "US-003"]

      steps:
        - step_id: "05-01"
          name: "Installer Pre-flight Integration"
          description: |
            Modify install_nwave.py to call preflight_checker before any build actions.
            Add output_formatter for error display. Connect context_detector for
            output mode selection.
          agent: "software-crafter"
          acceptance_criteria: ["AC-01", "AC-02", "AC-03", "AC-04"]
          scenarios_enabled: 0
          scenarios: []
          note: "Integration step - scenarios already enabled in Phase 02 and 03. This enables end-to-end flow."
          deliverables:
            - "scripts/install/install_nwave.py (modified)"
          estimated_effort: "medium"
          dependencies: ["02-03", "03-03"]

        - step_id: "05-02"
          name: "Installation Logging"
          description: |
            Integrate comprehensive logging into installer and verifier.
            Log to ~/.claude/nwave-install.log with timestamps, levels, and
            parseable format. Preserve logs across attempts.
          agent: "software-crafter"
          acceptance_criteria: ["AC-09"]
          scenarios_enabled: 6
          scenarios:
            - "Log file is created at standard location"
            - "Successful actions are logged with timestamp"
            - "Errors are logged with detail"
            - "Pre-flight check results are logged"
            - "Log persists across installation attempts"
            - "Log format is parseable"
          deliverables:
            - "scripts/install/install_nwave.py (modified)"
            - "scripts/install/verify_nwave.py (modified)"
          estimated_effort: "small"
          dependencies: ["05-01", "04-02"]

        - step_id: "05-03"
          name: "Post-Installation Verification Integration"
          description: |
            Integrate installation_verifier into install_nwave.py for automatic
            post-installation verification. Replace existing validate_installation()
            with shared verifier logic.
          agent: "software-crafter"
          acceptance_criteria: ["AC-07"]
          scenarios_enabled: 0
          scenarios: []
          note: "Scenarios already enabled in 04-01. This step enables end-to-end flow."
          deliverables:
            - "scripts/install/install_nwave.py (modified)"
          estimated_effort: "small"
          dependencies: ["05-02", "04-01"]

    # =============================================================================
    # Phase 06: Documentation
    # Update installation guide with correct prerequisites
    # =============================================================================
    - phase_id: "06"
      name: "Documentation"
      description: "Update installation documentation with accurate prerequisites and troubleshooting"
      user_stories: ["US-005"]

      steps:
        - step_id: "06-01"
          name: "Update Installation Guide"
          description: |
            Update docs/installation/installation-guide.md:
            - Prerequisites: Python 3.8+ (not 3.11+), pipenv required
            - Quick start: pipenv install --dev, pipenv run commands
            - Troubleshooting: ModuleNotFoundError, venv errors
          agent: "software-crafter"
          acceptance_criteria: ["AC-10"]
          scenarios_enabled: 5
          scenarios:
            - "Quick start commands work on virgin machine"
            - "Prerequisites are correctly stated"
            - "Quick start section includes virtual environment setup"
            - "Documentation mentions pipenv requirement"
            - "Troubleshooting section addresses common errors"
          deliverables:
            - "docs/installation/installation-guide.md (updated)"
          estimated_effort: "small"
          dependencies: ["05-03"]

  # =============================================================================
  # Validation
  # =============================================================================
  validation:
    status: "approved"
    reviewer: "software-crafter-reviewer"
    reviewed_at: "2026-01-29T19:15:00Z"
    checklist:
      - item: "All 57 scenarios mapped to steps"
        status: true
      - item: "Dependencies respect implementation order from baseline"
        status: true
      - item: "Each step enables 2-7 scenarios (with exceptions noted)"
        status: true
      - item: "User stories covered"
        status: true
      - item: "Acceptance criteria mapped"
        status: true

# =============================================================================
# Implementation Order Summary
# =============================================================================
#
# The roadmap follows the dependency order from baseline.yaml:
#
# 1. error_codes.py (no deps)
# 2. context_detector.py (no deps)
# 3. preflight_checker.py (depends on error_codes)
# 4. output_formatter.py (depends on error_codes, context_detector)
# 5. installation_verifier.py (depends on error_codes)
# 6. verify_nwave.py (depends on all new components)
#
# Total: 57 scenarios across 15 steps in 6 phases
#
# =============================================================================
