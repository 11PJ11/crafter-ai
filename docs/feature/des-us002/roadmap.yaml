# US-002 Template Validation - Implementation Roadmap
# Generated following Outside-In TDD Step-to-Scenario Mapping principle
# Each step targets exactly ONE acceptance test scenario

project_id: des-us002
feature: "US-002 Template Validation - Pre-Invocation template validation ensuring prompts contain all mandatory DES sections before Task invocation"
created_at: "2026-01-24T11:00:00Z"

roadmap:
  phases:
    # Phase 01: Foundation - Core validation infrastructure
    - phase_id: "01"
      name: "Validation Foundation"
      description: "Establish core validation infrastructure and happy path"
      steps:
        - step_id: "01-01"
          name: "Complete prompt validation (happy path)"
          description: |
            Implement TemplateValidator class with MandatorySectionChecker and TDDPhaseValidator.
            Validate that a complete prompt with all 8 mandatory sections and 14 TDD phases
            passes validation and allows Task invocation.
          acceptance_test_scenario: "test_complete_prompt_passes_all_validation_checks"
          acceptance_criteria:
            - "AC-002.1: All 8 mandatory sections validated as present"
            - "Validation returns status PASSED for complete prompts"
            - "Task invocation is allowed when validation passes"
            - "ValidationResult dataclass returns errors=[] for valid prompts"
          suggested_agent: "software-crafter"
          requires: []
          estimated_hours: 4
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            Create des/validator.py with:
            - TemplateValidator class (main entry point)
            - MandatorySectionChecker (validates 8 sections)
            - TDDPhaseValidator (validates 14 phases)
            - ValidationResult dataclass (status, errors, task_invocation_allowed)

            Mandatory sections to validate:
            DES_METADATA, AGENT_IDENTITY, TASK_CONTEXT, TDD_14_PHASES,
            QUALITY_GATES, OUTCOME_RECORDING, BOUNDARY_RULES, TIMEOUT_INSTRUCTION

            TDD phases to validate:
            PREPARE, RED_ACCEPTANCE, RED_UNIT, GREEN_UNIT, CHECK_ACCEPTANCE,
            GREEN_ACCEPTANCE, REVIEW, REFACTOR_L1, REFACTOR_L2, REFACTOR_L3,
            REFACTOR_L4, POST_REFACTOR_REVIEW, FINAL_VALIDATE, COMMIT

    # Phase 02: Error Detection - Specific validation failures
    - phase_id: "02"
      name: "Error Detection"
      description: "Implement specific error detection for missing TDD phases and sections"
      steps:
        - step_id: "02-01"
          name: "Missing TDD phase detection"
          description: |
            Extend TDDPhaseValidator to detect and report missing TDD phases.
            When a prompt is missing a specific phase (e.g., REFACTOR_L3),
            validation fails with a specific error naming the missing phase.
          acceptance_test_scenario: "test_missing_tdd_phase_blocks_task_invocation"
          acceptance_criteria:
            - "AC-002.2: All 14 TDD phases must be explicitly mentioned"
            - "Missing phase is identified by name in error message"
            - "Error format: 'INCOMPLETE: TDD phase 'REFACTOR_L3' not mentioned'"
            - "Task invocation is blocked (task_invocation_allowed=False)"
          suggested_agent: "software-crafter"
          requires:
            - "01-01"
          estimated_hours: 2
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            Enhance TDDPhaseValidator to:
            - Check each of 14 phases individually
            - Report specific phase name when missing
            - Block Task invocation on any missing phase

            Test with prompt missing REFACTOR_L3 phase specifically.

        - step_id: "02-02"
          name: "Missing mandatory section with actionable error"
          description: |
            Extend MandatorySectionChecker to provide actionable error messages
            with recovery guidance when a mandatory section is missing.
          acceptance_test_scenario: "test_missing_mandatory_section_provides_actionable_error"
          acceptance_criteria:
            - "AC-002.3: Validation errors are specific and actionable"
            - "Error names the missing section: 'MISSING: Mandatory section 'TIMEOUT_INSTRUCTION' not found'"
            - "Recovery guidance provided: 'Add TIMEOUT_INSTRUCTION section with turn budget guidance'"
            - "Task invocation is blocked"
          suggested_agent: "software-crafter"
          requires:
            - "01-01"
          estimated_hours: 2
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            Enhance MandatorySectionChecker to:
            - Provide section-specific error messages
            - Include recovery_guidance field in ValidationResult
            - Map each mandatory section to its recovery guidance text

            Recovery guidance mapping:
            - TIMEOUT_INSTRUCTION: "Add TIMEOUT_INSTRUCTION section with turn budget guidance"
            - BOUNDARY_RULES: "Add BOUNDARY_RULES section defining allowed file patterns"
            - etc.

    # Phase 03: Error Aggregation - Multiple errors handling
    - phase_id: "03"
      name: "Error Aggregation"
      description: "Handle multiple validation errors in a single pass"
      steps:
        - step_id: "03-01"
          name: "Multiple validation errors reported together"
          description: |
            Modify TemplateValidator to collect and report ALL validation errors
            in a single validation pass, rather than stopping at the first error.
          acceptance_test_scenario: "test_multiple_validation_errors_reported_together"
          acceptance_criteria:
            - "AC-002.4: Task tool is NOT invoked if validation fails"
            - "All validation errors collected in single pass"
            - "error_count reflects total number of issues"
            - "Each error is actionable (has recovery guidance)"
            - "Task invocation blocked with all errors visible"
          suggested_agent: "software-crafter"
          requires:
            - "02-01"
            - "02-02"
          estimated_hours: 2
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            Modify validation approach:
            - Run MandatorySectionChecker to completion (collect all missing sections)
            - Run TDDPhaseValidator to completion (collect all missing phases)
            - Aggregate errors into ValidationResult.errors list
            - Set error_count = len(errors)

            Test scenario: 3 issues
            1. Missing BOUNDARY_RULES section
            2. Missing GREEN_ACCEPTANCE phase
            3. Missing POST_REFACTOR_REVIEW phase

    # Phase 04: Non-Functional Requirements
    - phase_id: "04"
      name: "Non-Functional Requirements"
      description: "Performance and robustness validation"
      steps:
        - step_id: "04-01"
          name: "Validation performance within budget"
          description: |
            Optimize TemplateValidator to complete validation within 500ms
            performance budget, ensuring non-blocking developer workflow.
          acceptance_test_scenario: "test_validation_completes_within_performance_budget"
          acceptance_criteria:
            - "AC-002.5: Validation completes in < 500ms"
            - "Performance measured with time.perf_counter()"
            - "Validation still accurate (no shortcuts that break correctness)"
            - "Valid prompts processed within budget"
          suggested_agent: "software-crafter"
          requires:
            - "03-01"
          estimated_hours: 1
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            Performance considerations:
            - Use efficient string searching (regex or simple in-operator)
            - Avoid unnecessary object allocations
            - Single-pass validation where possible
            - Measure with time.perf_counter() for millisecond precision

            Acceptance test includes timing assertion:
            assert duration_ms < 500

        - step_id: "04-02"
          name: "Malformed DES marker detection"
          description: |
            Implement DESMarkerValidator to detect and reject malformed
            DES-VALIDATION markers with invalid values.
          acceptance_test_scenario: "test_malformed_des_marker_detected_and_rejected"
          acceptance_criteria:
            - "Edge case: Robustness against corrupted prompts"
            - "Detect invalid DES-VALIDATION values (e.g., 'unknown' instead of 'required')"
            - "Error format: 'INVALID_MARKER: DES-VALIDATION value must be 'required''"
            - "Task invocation blocked for malformed markers"
          suggested_agent: "software-crafter"
          requires:
            - "01-01"
          estimated_hours: 1
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            Create DESMarkerValidator component:
            - Parse <!-- DES-VALIDATION: value --> markers
            - Validate value is exactly 'required'
            - Reject 'unknown', empty, or other invalid values
            - Return INVALID_MARKER error type

            Integrate with TemplateValidator as first validation step
            (marker validation before section/phase validation)

  summary:
    total_steps: 6
    total_phases: 4
    estimated_hours: 12
    step_to_scenario_mapping:
      "01-01": "test_complete_prompt_passes_all_validation_checks (AC-002.1)"
      "02-01": "test_missing_tdd_phase_blocks_task_invocation (AC-002.2)"
      "02-02": "test_missing_mandatory_section_provides_actionable_error (AC-002.3)"
      "03-01": "test_multiple_validation_errors_reported_together (AC-002.4)"
      "04-01": "test_validation_completes_within_performance_budget (AC-002.5)"
      "04-02": "test_malformed_des_marker_detected_and_rejected (Edge case)"
    dependency_order:
      - "01-01 (foundation - no dependencies)"
      - "02-01, 02-02, 04-02 (parallel - depend on 01-01)"
      - "03-01 (depends on 02-01 and 02-02)"
      - "04-01 (depends on 03-01 - needs complete validator)"

  validation:
    status: "approved"
    reviewer: "software-crafter-reviewer"
    reviewed_at: "2026-01-24T12:15:00Z"
    notes: |
      Roadmap passes all 6 review criteria:
      1. Step Atomicity: All 6 steps sized 1-4h, each independently testable
      2. Dependency Mapping: Linear flow with no cycles, parallelization opportunities identified
      3. Technical Feasibility: Sound Outside-In TDD approach with clear component structure
      4. TDD Compliance: All 14 phases required for each step
      5. Step-to-Scenario Mapping: Exactly 6 steps with 1:1 acceptance test mapping verified
      6. Completeness: All 5 AC scenarios + 1 edge case covered

      Quality observations:
      - Excellent architecture notes with component diagram
      - Clear recovery guidance patterns
      - Proper dependency order documented
      - Summary section enables quick reference
    issues: []

  architecture_notes: |
    Component Structure:

    des/validator.py
    ├── TemplateValidator (main entry point)
    │   ├── validate_prompt(prompt: str) -> ValidationResult
    │   └── _aggregate_errors(section_errors, phase_errors, marker_errors)
    │
    ├── DESMarkerValidator
    │   └── validate_marker(prompt: str) -> List[ValidationError]
    │
    ├── MandatorySectionChecker
    │   ├── check_sections(prompt: str) -> List[ValidationError]
    │   └── _get_recovery_guidance(section_name: str) -> str
    │
    ├── TDDPhaseValidator
    │   └── validate_phases(prompt: str) -> List[ValidationError]
    │
    └── ValidationResult (dataclass)
        ├── status: Literal["PASSED", "FAILED"]
        ├── errors: List[ValidationError]
        ├── error_count: int
        ├── task_invocation_allowed: bool
        ├── recovery_guidance: Optional[str]
        └── duration_ms: float

    ValidationError (dataclass)
    ├── error_type: Literal["MISSING", "INCOMPLETE", "INVALID_MARKER"]
    ├── message: str
    ├── recovery_guidance: str
    └── is_actionable: bool = True

    Integration with DESOrchestrator:
    - Pre-invocation hook calls TemplateValidator.validate_prompt()
    - If validation fails, Task invocation is blocked
    - Validation errors surfaced to user before execution

  mandatory_sections:
    - DES_METADATA
    - AGENT_IDENTITY
    - TASK_CONTEXT
    - TDD_14_PHASES
    - QUALITY_GATES
    - OUTCOME_RECORDING
    - BOUNDARY_RULES
    - TIMEOUT_INSTRUCTION

  tdd_phases:
    - PREPARE
    - RED_ACCEPTANCE
    - RED_UNIT
    - GREEN_UNIT
    - CHECK_ACCEPTANCE
    - GREEN_ACCEPTANCE
    - REVIEW
    - REFACTOR_L1
    - REFACTOR_L2
    - REFACTOR_L3
    - REFACTOR_L4
    - POST_REFACTOR_REVIEW
    - FINAL_VALIDATE
    - COMMIT
