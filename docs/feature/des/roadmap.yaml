project_id: des
feature: "DES Command-Origin Task Filtering (US-001)"
created_at: "2026-01-23T16:00:00Z"

roadmap:
  phases:
    - phase_id: "01"
      name: "Test Infrastructure"
      description: "Implement test fixtures and infrastructure to support acceptance tests"
      steps:
        - step_id: "01-01"
          name: "Implement des_orchestrator fixture"
          description: |
            Create the conftest.py fixture that provides des_orchestrator instance
            to acceptance tests. This fixture will instantiate the DESOrchestrator
            class and provide it to all tests in test_us001_command_filtering.py.
          acceptance_criteria:
            - "Fixture des_orchestrator available in conftest.py"
            - "Fixture returns DESOrchestrator instance"
            - "Tests can import and use des_orchestrator without errors"
            - "Fixture properly scoped (function-level isolation)"
          suggested_agent: "software-crafter"
          requires: []
          estimated_hours: 1
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            - Create tests/acceptance/conftest.py if not exists
            - Add @pytest.fixture for des_orchestrator
            - Return DESOrchestrator() instance
            - Ensure fixture properly isolated per test

    - phase_id: "02"
      name: "Core Orchestrator Implementation"
      description: "Implement DESOrchestrator class with marker rendering logic"
      steps:
        - step_id: "02-01"
          name: "Create DESOrchestrator class skeleton"
          description: |
            Create src/orchestrator/des_orchestrator.py with DESOrchestrator class
            defining the interface for render_prompt() and prepare_ad_hoc_prompt().
            This establishes the contract that tests expect.
          acceptance_criteria:
            - "DESOrchestrator class exists in src/orchestrator/des_orchestrator.py"
            - "Class has render_prompt(**kwargs) method signature"
            - "Class has prepare_ad_hoc_prompt(prompt, project_root) method signature"
            - "Methods raise NotImplementedError initially (RED state preserved)"
            - "Class can be instantiated without errors"
          suggested_agent: "software-crafter"
          requires: ["01-01"]
          estimated_hours: 1
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            - Create src/orchestrator/ directory if needed
            - Define DESOrchestrator class
            - Add __init__() method
            - Add method stubs with NotImplementedError
            - Ensure conftest.py imports from correct module path

        - step_id: "02-02"
          name: "Implement render_prompt() for /nw:execute"
          description: |
            Implement render_prompt() method to generate Task prompts with DES
            markers for /nw:execute command. This makes the first acceptance test pass.
          acceptance_criteria:
            - "test_execute_command_includes_des_validation_marker passes"
            - "Prompt contains <!-- DES-VALIDATION: required --> marker"
            - "Prompt contains <!-- DES-STEP-FILE: {path} --> marker"
            - "Prompt contains <!-- DES-ORIGIN: command:/nw:execute --> marker"
            - "Unit tests verify marker injection logic"
          suggested_agent: "software-crafter"
          requires: ["02-01"]
          estimated_hours: 2
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            - Parse command parameter to detect /nw:execute
            - Build prompt string with required markers
            - Use step_file parameter for step file path marker
            - Inject DES-ORIGIN marker with command name
            - Ensure markers are HTML comments (<!-- -->)

        - step_id: "02-03"
          name: "Implement prepare_ad_hoc_prompt() for Task tool"
          description: |
            Implement prepare_ad_hoc_prompt() to handle ad-hoc Task invocations
            without DES markers. This makes the second acceptance test pass.
          acceptance_criteria:
            - "test_ad_hoc_task_bypasses_des_validation passes"
            - "Ad-hoc prompts do NOT contain DES-VALIDATION marker"
            - "Ad-hoc prompts do NOT contain DES-STEP-FILE marker"
            - "Ad-hoc prompts do NOT contain DES-ORIGIN marker"
            - "Unit tests verify marker absence for ad-hoc tasks"
          suggested_agent: "software-crafter"
          requires: ["02-01"]
          estimated_hours: 1
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            - Return prompt as-is without modification
            - No DES marker injection for ad-hoc tasks
            - Simple pass-through implementation

        - step_id: "02-04"
          name: "Implement render_prompt() for /nw:research"
          description: |
            Extend render_prompt() to handle /nw:research command, which bypasses
            DES validation (no markers). This makes the third acceptance test pass.
          acceptance_criteria:
            - "test_research_command_skips_full_validation passes"
            - "Research prompts do NOT contain DES-VALIDATION marker"
            - "Research prompts do NOT contain DES-STEP-FILE marker"
            - "Research prompts do NOT contain DES-ORIGIN marker"
            - "Unit tests verify research command marker bypass"
          suggested_agent: "software-crafter"
          requires: ["02-02"]
          estimated_hours: 1
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            - Detect /nw:research command in command parameter
            - Build prompt without DES markers
            - Treat as lightweight execution path
            - Architecture decision: research grouped with ad-hoc (no validation)

        - step_id: "02-05"
          name: "Implement render_prompt() for /nw:develop"
          description: |
            Extend render_prompt() to handle /nw:develop command, which requires
            full DES validation (same as /nw:execute). Makes final test pass.
          acceptance_criteria:
            - "test_develop_command_includes_des_validation_marker passes"
            - "Develop prompts contain <!-- DES-VALIDATION: required --> marker"
            - "Develop prompts contain <!-- DES-STEP-FILE: {path} --> marker"
            - "Develop prompts contain <!-- DES-ORIGIN: command:/nw:develop --> marker"
            - "Unit tests verify develop command marker injection"
          suggested_agent: "software-crafter"
          requires: ["02-02"]
          estimated_hours: 1
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            - Detect /nw:develop command in command parameter
            - Reuse marker injection logic from /nw:execute
            - DRY: Extract common marker generation method
            - Update DES-ORIGIN marker to reflect /nw:develop

    - phase_id: "03"
      name: "Command-Type Detection Logic"
      description: "Implement command classification to determine validation requirements"
      steps:
        - step_id: "03-01"
          name: "Extract command detection into dedicated method"
          description: |
            Refactor command parameter parsing into _get_validation_level(command)
            method that returns validation level ("full", "none"). This improves
            maintainability and testability of command classification logic.
          acceptance_criteria:
            - "_get_validation_level(command) method exists"
            - "Returns 'full' for /nw:execute and /nw:develop"
            - "Returns 'none' for /nw:research"
            - "All acceptance tests still pass (no regression)"
            - "Unit tests verify command classification"
          suggested_agent: "software-crafter"
          requires: ["02-02", "02-04", "02-05"]
          estimated_hours: 1
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            - Extract command string parsing logic
            - Map commands to validation levels
            - Use constants for validation level strings
            - Add unit tests for edge cases (unknown commands, malformed input)

    - phase_id: "04"
      name: "Integration and Quality Assurance"
      description: "Final integration, refactoring, and validation of complete implementation"
      steps:
        - step_id: "04-01"
          name: "DRY refactoring: Extract marker generation"
          description: |
            Extract DES marker generation into _generate_des_markers(command, step_file)
            helper method to eliminate code duplication between /nw:execute and
            /nw:develop implementations.
          acceptance_criteria:
            - "_generate_des_markers() method exists and is reused"
            - "No duplicate marker generation code"
            - "All acceptance tests still pass"
            - "Cyclomatic complexity reduced (measured)"
            - "Unit tests verify marker generation independently"
          suggested_agent: "software-crafter"
          requires: ["02-02", "02-05", "03-01"]
          estimated_hours: 1
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            - Create _generate_des_markers(command, step_file) -> str
            - Return formatted marker string
            - Reuse in both render_prompt() branches
            - Measure complexity reduction with radon cc

        - step_id: "04-02"
          name: "Add error handling and edge cases"
          description: |
            Add defensive error handling for missing parameters, invalid commands,
            and malformed inputs. Ensure graceful failure with actionable errors.
          acceptance_criteria:
            - "Handles missing step_file parameter gracefully"
            - "Handles unknown command types with clear error message"
            - "Handles None or empty prompt parameter"
            - "All acceptance tests pass with edge case coverage"
            - "Unit tests verify error handling paths"
          suggested_agent: "software-crafter"
          requires: ["04-01"]
          estimated_hours: 2
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            - Add parameter validation at method entry
            - Raise ValueError with actionable error messages
            - Handle None/empty/whitespace inputs
            - Log warnings for unexpected command types
            - Architecture v1.6.0 Improvement #4: actionable error messages

        - step_id: "04-03"
          name: "Run full test suite and measure coverage"
          description: |
            Execute complete test suite, measure code coverage, validate all
            quality gates. Verify all 4 acceptance tests pass (GREEN state).
          acceptance_criteria:
            - "All 4 acceptance tests pass (100% pass rate)"
            - "Code coverage >80% on src/orchestrator/des_orchestrator.py"
            - "Cyclomatic complexity <10 per method"
            - "No TODO/FIXME markers in production code"
            - "pytest execution with no warnings or errors"
          suggested_agent: "software-crafter"
          requires: ["04-02"]
          estimated_hours: 1
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            - Run: pytest tests/acceptance/test_us001_command_filtering.py -v
            - Run: pytest --cov=src/orchestrator --cov-report=term-missing
            - Run: radon cc src/orchestrator --min B
            - Verify baseline targets achieved
            - Document actual measurements vs baseline targets

        - step_id: "04-04"
          name: "Create unit test suite"
          description: |
            Add comprehensive unit tests for DESOrchestrator class methods.
            Test marker generation, command detection, error handling in isolation.
          acceptance_criteria:
            - "Unit tests exist in tests/unit/test_des_orchestrator.py"
            - "Test coverage for all public methods"
            - "Test coverage for _get_validation_level()"
            - "Test coverage for _generate_des_markers()"
            - "Unit tests pass independently of acceptance tests"
          suggested_agent: "software-crafter"
          requires: ["04-01", "04-02"]
          estimated_hours: 2
          tdd_phases: "All 14 phases required"
          implementation_notes: |
            - Create tests/unit/ directory if needed
            - Test each method in isolation
            - Mock dependencies if any
            - Parametrize tests for multiple command types
            - Test error conditions and edge cases

  validation:
    status: "approved"
    reviewer: "software-crafter-reviewer"
    reviewed_at: "2026-01-23T16:30:00Z"
    notes: |
      âœ… APPROVED - Roadmap meets all required quality gates

      TECHNICAL FEASIBILITY REVIEW (Iteration 1/2)

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ðŸ“‹ QUALITY GATE VALIDATION
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      âœ… Step Atomicity: PASS
      - All 11 steps are independently testable and completable
      - Step sizes appropriate (1-2h each, none exceeding 2h)
      - Each step has clear entry/exit criteria via acceptance criteria
      - No steps are too large or too granular

      âœ… Dependency Mapping: PASS
      - Dependencies correctly identified with explicit requires[] arrays
      - No circular dependencies detected
      - Clear critical path identified: 01-01â†’02-01â†’02-02â†’02-05â†’03-01â†’04-01â†’04-02â†’04-03
      - Parallelization opportunities correctly identified (02-03, 02-04 parallel with 02-02)
      - Bottom-up implementation enables progressive completion

      âœ… Technical Feasibility: PASS
      - Technical approach sound and aligned with Outside-In TDD
      - Acceptance criteria are specific, measurable, and testable
      - Implementation notes provide sufficient technical guidance
      - Architecture alignment with v1.6.0 confirmed (DES markers, Layer 1 filtering)
      - Error handling addressed explicitly in step 04-02
      - Regex pattern compliance with v1.6.0 improvements noted

      âœ… TDD Compliance: PASS
      - All 11 steps require "All 14 phases required" (100% compliance)
      - Outside-In progression clear: E2E acceptance tests â†’ unit tests â†’ implementation
      - Test requirements explicitly specified in acceptance criteria
      - RED-GREEN-REFACTOR cycle embedded in phase structure
      - Step 04-04 creates comprehensive unit test suite as required
      - Fixture-based test infrastructure (step 01-01) enables proper test isolation

      âœ… Completeness: PASS
      - All 4 acceptance test scenarios from baseline mapped to implementation steps
      - Error handling covered in step 04-02 with actionable error messages
      - Edge cases addressed: missing parameters, unknown commands, None/empty inputs
      - Refactoring planned in Phase 3 (step 03-01) and Phase 4 (step 04-01)
      - Code quality metrics validation in step 04-03 (coverage, complexity, warnings)
      - Unit test suite creation in step 04-04 ensures comprehensive test coverage

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ðŸ’ª STRENGTHS
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      1. **Excellent Outside-In TDD Structure**
         - Starts with test infrastructure (fixtures) before production code
         - Each step makes one acceptance test pass incrementally
         - Clear progression from RED â†’ GREEN â†’ REFACTOR
         - Unit tests added explicitly (step 04-04) rather than assumed

      2. **Realistic Time Estimates**
         - 1-2h per step is achievable for focused atomic work
         - Total 15h aligns with feature complexity
         - Critical path clearly identified for sprint planning

      3. **Proper Dependency Management**
         - Clean dependency tree enables parallel work
         - No unnecessary coupling between independent steps
         - Bottom-up implementation supports incremental delivery

      4. **Architecture-Design Alignment**
         - DES marker injection matches architecture v1.6.0 Section 4.1
         - Command-origin filtering implements Layer 1 correctly
         - Validation level mapping ("full" vs "none") as specified
         - Error handling follows v1.6.0 Improvement #4 (actionable messages)

      5. **Quality-Focused Implementation**
         - Dedicated steps for refactoring (03-01, 04-01)
         - Error handling explicitly scoped (04-02)
         - Coverage and complexity measurement mandated (04-03)
         - Comprehensive unit tests required (04-04)

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ðŸ“ OBSERVATIONS (Not Issues - Enhancement Opportunities)
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      1. **Measurement Completeness**: Step 04-01 mentions "Cyclomatic complexity reduced (measured)"
         which is excellent - this validates the refactoring quantitatively per CRITICAL ACCURACY PRINCIPLE.

      2. **DRY Refactoring Timing**: Step 04-01 appropriately defers marker generation extraction
         until after both /nw:execute and /nw:develop implementations exist (good judgment - no
         premature abstraction).

      3. **Test Infrastructure Isolation**: Step 01-01 correctly specifies function-level fixture
         scoping to prevent test pollution.

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      âœ… APPROVAL DECISION
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      This roadmap is PRODUCTION-READY for split and execution.

      All mandatory quality gates satisfied:
      âœ“ Step atomicity verified
      âœ“ Dependencies correct (no cycles)
      âœ“ Steps map to all 4 acceptance tests
      âœ“ 14-phase TDD documented for all steps
      âœ“ Estimated hours realistic (1-2h each, 15h total)

      The orchestrator may proceed to split this roadmap into executable step files.

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ðŸ“Š ROADMAP METRICS
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      Total Steps: 11
      Total Phases: 4
      Critical Path Length: 8 steps
      Parallel Work Opportunities: 2 steps (02-03, 02-04)
      Estimated Effort: 15 hours
      Acceptance Tests Covered: 4/4 (100%)
      TDD Compliance: 11/11 steps (100%)
      Steps with Measurement: 2 (04-01 complexity, 04-03 coverage/complexity)
    issues: []
