---
schema_version: "2.0"
feature_name: test-hexagonal-rewrite
goal: Rewrite 29 skipped tests to respect hexagonal architecture by testing through public port interfaces
business_context: |
  Problem: 29 tests currently skipped due to hexagonal architecture violations
  - Tests import internal adapter classes instead of public port interfaces
  - Violates ADR-6 hexagonal architecture principles (test behavior through ports, not implementation)
  - Skip reason: "Internal SubagentStopHook class testing, needs hexagonal port rewrite"

  Solution: Rewrite tests to invoke through public ports with test doubles for dependencies
  - Test through SubagentStopPort (driver port) and SubagentStopService (service layer)
  - Use mock implementations of driven ports (ExecutionLogReader, ScopeChecker, AuditLogWriter, TimeProvider)
  - Preserve test intent while fixing architecture compliance

  Impact: Improved test quality, hexagonal architecture compliance, no more skipped tests

steps:
  - id: "01-01"
    description: Create test doubles for all driven ports
    why: Needed for port-based testing without internal adapter coupling
    acceptance_criteria:
      - MockExecutionLogReader implements ExecutionLogReader port with configurable responses
      - MockScopeChecker implements ScopeChecker port with configurable violation scenarios
      - MockAuditWriter implements AuditLogWriter port with event capture capability
      - MockTimeProvider implements TimeProvider port with fixed timestamp
      - All mocks expose simple constructor APIs for test setup
    notes: |
      Quick win: test_real_hook_audit.py and test_real_hook_scope_violations.py already have these mocks defined.
      Extract to shared test fixture module at tests/des/unit/fixtures/mock_ports.py

  - id: "01-02"
    description: Rewrite test_real_hook_audit.py tests to invoke SubagentStopService through SubagentStopPort
    why: 4 tests already have port-based structure, just need to remove skip markers
    acceptance_criteria:
      - test_audit_log_passed_includes_feature_name_and_step_id passes (invokes service.validate())
      - test_audit_log_failed_includes_feature_name_and_step_id passes (validates blocked completion)
      - test_audit_log_scope_violation_includes_feature_name_and_step_id passes (validates scope violations)
      - test_audit_log_retains_all_existing_fields passes (validates data preservation)
      - All tests construct SubagentStopService with mock driven ports
      - No imports of internal adapter classes (SubagentStopHook removed from imports)
    notes: |
      Current state: Tests already written correctly with port invocation patterns.
      Action required: Remove @pytest.mark.skip markers, verify tests pass.
      File: tests/des/unit/adapters/drivers/hooks/test_real_hook_audit.py

  - id: "01-03"
    description: Rewrite test_real_hook_scope_violations.py tests to invoke SubagentStopService through SubagentStopPort
    why: 3 tests validate scope violation logging behavior through service layer
    acceptance_criteria:
      - test_single_scope_violation_logs_feature_name passes (single violation scenario)
      - test_multiple_scope_violations_each_log_feature_name passes (multiple violations)
      - test_no_scope_violations_no_events_logged passes (clean execution scenario)
      - All tests use SubagentStopContext (driver port input) and validate HookDecision (port output)
      - Tests verify audit events logged via MockAuditWriter.events inspection
    notes: |
      Current state: Tests already use port-based patterns with mocks.
      Action required: Remove @pytest.mark.skip markers and validate test logic.
      File: tests/des/unit/adapters/drivers/hooks/test_real_hook_scope_violations.py

  - id: "02-01"
    description: Rewrite test_audit_logging_integration.py tests to test through SubagentStopService
    why: 4 tests validate audit logging integration, need port-based approach
    acceptance_criteria:
      - test_hook_logs_scope_violation_to_audit_logger rewritten to invoke SubagentStopService.validate()
      - test_hook_logs_each_violation_separately validates multiple audit events
      - test_hook_does_not_log_when_no_violations validates clean execution silence
      - test_hook_includes_allowed_patterns_in_audit_event validates audit data completeness
      - Remove all references to RealSubagentStopHook internal class
      - Tests verify behavior through SubagentStopContext input and HookDecision output
    notes: |
      Current issues: Tests construct RealSubagentStopHook directly (internal adapter).
      Solution: Replace with SubagentStopService construction using port interface.
      File: tests/des/unit/adapters/drivers/hooks/test_audit_logging_integration.py

  - id: "02-02"
    description: Rewrite test_clean_execution_silence.py tests to test through SubagentStopService
    why: 4 tests validate that clean executions produce no log noise
    acceptance_criteria:
      - test_no_violations_produces_no_audit_entries validates no SCOPE_VIOLATION events
      - test_no_violations_produces_no_logger_info_calls validates logger.info not called
      - test_no_violations_produces_no_logger_debug_calls validates logger.debug not called
      - test_clean_execution_else_branch_truly_silent validates complete silence
      - All tests invoke through SubagentStopService.validate() with clean scenario mocks
      - Logger patching still valid for asserting no log calls
    notes: |
      Current issues: Tests use RealSubagentStopHook with constructor injection mocks.
      Solution: Replace with SubagentStopService and verify logger silence through patching.
      File: tests/des/unit/adapters/drivers/hooks/test_clean_execution_silence.py

  - id: "02-03"
    description: Rewrite test_scope_validation_integration.py tests to test through SubagentStopService
    why: 5 tests validate scope validation integration behavior
    acceptance_criteria:
      - test_hook_invokes_scope_validator_post_execution validates scope check occurs
      - test_validation_runs_without_user_interaction validates automatic validation
      - test_git_diff_failure_logged_as_warning_doesnt_block_completion validates graceful degradation
      - test_validation_skipped_allows_step_completion_with_warning_log validates skip handling
      - test_validation_result_stored_for_audit_logging validates result preservation
      - All tests invoke SubagentStopService.validate() and verify HookDecision outcomes
      - MockScopeChecker configured for different validation scenarios
    notes: |
      Current issues: Tests reference RealSubagentStopHook and patch internal ScopeValidator.
      Solution: Use SubagentStopService with MockScopeChecker injected as driven port.
      File: tests/des/unit/adapters/drivers/hooks/test_scope_validation_integration.py

  - id: "03-01"
    description: Analyze test_orchestrator_recovery_integration.py for rewrite feasibility
    why: 17 tests reference Schema v1.x SubagentStopHook which no longer exists
    acceptance_criteria:
      - Document which tests validate still-relevant behavior vs obsolete Schema v1.x concerns
      - Identify which tests can be rewritten to validate RecoveryGuidanceHandler behavior
      - Determine if RecoveryGuidanceHandler integration still exists in current architecture
      - Create recommendation for each test (rewrite, delete, defer pending feature restoration)
    notes: |
      Complexity: Tests reference Schema v1.x step.json format and SubagentStopHook.
      Current architecture uses Schema v2.0 execution-log.yaml format.
      May require separate feature to restore recovery guidance integration.
      File: tests/des/unit/application/test_orchestrator_recovery_integration.py

  - id: "03-02"
    description: Rewrite or remove test_orchestrator_recovery_integration.py tests based on analysis
    why: Complete rewrite of 29 skipped tests requires resolving recovery integration tests
    acceptance_criteria:
      - Tests validating current recovery behavior rewritten to use port interfaces
      - Tests validating obsolete Schema v1.x behavior removed with documentation
      - Tests blocked by missing features marked as pending with clear unblock conditions
      - No skipped tests remain in file unless explicitly marked as future work
    notes: |
      Dependency: Requires completion of step 03-01 analysis.
      Expected outcome: Likely 5-10 tests removed (obsolete), 5-7 tests rewritten if recovery still exists.
      File: tests/des/unit/application/test_orchestrator_recovery_integration.py

integration_risks:
  - risk: RecoveryGuidanceHandler integration may no longer exist in current architecture
    mitigation: Step 03-01 analysis will determine actual architecture state before rewrite
  - risk: Test intent may be lost during rewrite from internal adapter to port interface
    mitigation: Each rewrite preserves original Given-When-Then structure and business context comments
  - risk: Mock port fixtures may have subtle behavioral differences from real implementations
    mitigation: Integration tests (not in scope) will validate real port implementations

success_criteria:
  - Zero skipped tests with reason "Internal SubagentStopHook class testing, needs hexagonal port rewrite"
  - All tests invoke through public port interfaces (SubagentStopPort, driver ports)
  - All tests use mock driven ports (ExecutionLogReader, ScopeChecker, AuditLogWriter, TimeProvider)
  - Test intent and business context preserved from original skipped tests
  - All rewritten tests pass in CI

dependencies:
  blocking: []
  optional:
    - Integration tests for real port implementations (future work, not in this feature scope)

estimated_effort:
  total_steps: 7
  quick_wins:
    - "01-01: Extract existing mocks to shared fixture (30 minutes)"
    - "01-02: Remove skip markers from test_real_hook_audit.py (15 minutes)"
    - "01-03: Remove skip markers from test_real_hook_scope_violations.py (15 minutes)"
  medium_effort:
    - "02-01: Rewrite test_audit_logging_integration.py (1 hour)"
    - "02-02: Rewrite test_clean_execution_silence.py (1 hour)"
    - "02-03: Rewrite test_scope_validation_integration.py (1.5 hours)"
  complex:
    - "03-01: Analyze recovery integration tests (2 hours)"
    - "03-02: Rewrite or remove recovery tests (2-4 hours depending on findings)"
  total_estimated: "8-10 hours"
