{
  "step_id": "01-04",
  "name": "Implement BackupPolicy domain service",
  "description": "Rolling retention rules: maximum 3 backups. Determine which backups to delete, generate backup directory names with timestamps.",
  "type": "domain_model",
  "phase": "01",
  "phase_name": "Domain Model Foundation",
  "components": [
    {
      "name": "BackupPolicy",
      "type": "domain_service",
      "location": "nWave/core/versioning/domain/backup_policy.py"
    }
  ],
  "dependencies": [],
  "acceptance_criteria": "With 3 existing backups, returns oldest for deletion; Generates backup path as ~/.claude.backup.{YYYYMMDDHHMMSS}/; With 0-2 existing backups, returns empty deletion list",
  "tdd_cycle": {
    "acceptance_test": {
      "scenario_name": "NOT_APPLICABLE",
      "test_file": "tests/unit/domain/test_backup_policy.py",
      "test_file_format": "py_pytest",
      "scenario_index": 0,
      "initially_ignored": false,
      "is_walking_skeleton": false,
      "mapped_scenario": {
        "scenario_function": "",
        "scenario_description": "Domain service - no acceptance scenario, unit tests only",
        "mapping_type": "infrastructure",
        "notes": "Domain services are tested via unit tests, not acceptance tests"
      }
    },
    "expected_unit_tests": [
      "test_backup_policy_returns_oldest_when_3_exist",
      "test_backup_policy_returns_empty_when_less_than_3",
      "test_backup_policy_generates_timestamp_path",
      "test_backup_policy_path_format_is_correct",
      "test_backup_policy_handles_empty_backup_list",
      "test_backup_policy_sorts_by_timestamp"
    ],
    "mock_boundaries": {
      "allowed_ports": [],
      "forbidden_domain_classes": ["BackupPolicy"],
      "in_memory_adapters": []
    },
    "tdd_phase_tracking": {
      "current_phase": "COMMIT",
      "active_e2e_test": "",
      "inactive_e2e_tests": "N/A - domain model step",
      "phases_completed": ["PREPARE", "RED_ACCEPTANCE", "RED_UNIT", "GREEN", "REVIEW", "REFACTOR_CONTINUOUS", "REFACTOR_L4", "COMMIT"],
      "test_results": {
        "total": 7,
        "passed": 7,
        "failed": 0,
        "skipped": 0
      }
    },
    "phase_execution_log": [
      {
        "phase_name": "PREPARE",
        "status": "SKIPPED",
        "started_at": "2026-01-28T16:30:00Z",
        "ended_at": "2026-01-28T16:30:00Z",
        "outcome": "SKIPPED",
        "notes": "NOT_APPLICABLE: Domain model - no acceptance test to prepare",
        "blocked_by": "NOT_APPLICABLE: Domain service - no acceptance test"
      },
      {
        "phase_name": "RED_ACCEPTANCE",
        "status": "SKIPPED",
        "started_at": "2026-01-28T16:30:00Z",
        "ended_at": "2026-01-28T16:30:00Z",
        "outcome": "SKIPPED",
        "notes": "NOT_APPLICABLE: Domain model - no acceptance test",
        "blocked_by": "NOT_APPLICABLE: Domain service - no acceptance test"
      },
      {
        "phase_name": "RED_UNIT",
        "status": "EXECUTED",
        "started_at": "2026-01-28T16:31:00Z",
        "ended_at": "2026-01-28T16:35:00Z",
        "outcome": "RED",
        "notes": "7 failing unit tests written: retention rules (4 tests), path generation (3 tests). All fail with ModuleNotFoundError as expected.",
        "blocked_by": null
      },
      {
        "phase_name": "GREEN",
        "status": "EXECUTED",
        "started_at": "2026-01-28T16:35:00Z",
        "ended_at": "2026-01-28T16:42:00Z",
        "outcome": "GREEN",
        "notes": "Implemented BackupPolicy domain service. All 7 unit tests pass: retention rules (4 tests) + path generation (3 tests).",
        "blocked_by": null
      },
      {
        "phase_name": "REVIEW",
        "status": "EXECUTED",
        "started_at": "2026-01-28T16:42:00Z",
        "ended_at": "2026-01-28T16:45:00Z",
        "outcome": "APPROVED",
        "notes": "Self-review APPROVED: Clean hexagonal architecture, business language naming, type hints, AAA test pattern, all quality gates pass. No mocking violations.",
        "blocked_by": null
      },
      {
        "phase_name": "REFACTOR_CONTINUOUS",
        "status": "EXECUTED",
        "started_at": "2026-01-28T16:45:00Z",
        "ended_at": "2026-01-28T16:46:00Z",
        "outcome": "NO_CHANGES_NEEDED",
        "notes": "L1+L2+L3 assessment: L1 (naming) - clear business language; L2 (complexity) - methods short and focused; L3 (responsibilities) - single responsibility. Code already clean.",
        "blocked_by": null
      },
      {
        "phase_name": "REFACTOR_L4",
        "status": "SKIPPED",
        "started_at": "2026-01-28T16:46:00Z",
        "ended_at": "2026-01-28T16:46:00Z",
        "outcome": "SKIPPED",
        "notes": "NOT_APPLICABLE: Simple domain service - no complex patterns needed. Value objects for paths would be over-engineering.",
        "blocked_by": "NOT_APPLICABLE: Small focused domain service"
      },
      {
        "phase_name": "COMMIT",
        "status": "EXECUTED",
        "started_at": "2026-01-28T16:46:00Z",
        "ended_at": "2026-01-28T16:48:00Z",
        "outcome": "COMMITTED",
        "notes": "Committed BackupPolicy domain service with 7 passing unit tests",
        "blocked_by": null
      }
    ]
  },
  "quality_gates": {
    "acceptance_test_must_fail_first": false,
    "unit_tests_must_fail_first": true,
    "no_mocks_inside_hexagon": true,
    "business_language_required": true,
    "refactor_level": 4,
    "in_memory_test_ratio_target": 1.0,
    "validation_after_each_phase": true,
    "all_8_phases_mandatory": true,
    "phase_documentation_required": true
  },
  "review_validation": {
    "reviewed_by": "software-crafter-reviewer",
    "reviewed_at": "2026-01-28T11:00:00Z",
    "schema_version": "2.0",
    "status": "APPROVED",
    "checks": {
      "8_phase_structure": {
        "status": "PASS",
        "details": "All 8 phases present: PREPARE, RED_ACCEPTANCE, RED_UNIT, GREEN, REVIEW, REFACTOR_CONTINUOUS, REFACTOR_L4, COMMIT"
      },
      "tdd_cycle_complete": {
        "status": "PASS",
        "details": "acceptance_test defined (NOT_APPLICABLE for domain service), expected_unit_tests (6 tests), mock_boundaries, phase_tracking all present"
      },
      "self_contained": {
        "status": "PASS",
        "details": "Step has clear description with 3 specific behaviors: retention rules (max 3), determine deletions, generate timestamped paths. Components specify exact location. Acceptance criteria are testable."
      },
      "dependencies_valid": {
        "status": "PASS",
        "details": "Empty dependencies array - valid for domain service with no entity dependencies. Confirmed via roadmap: BackupPolicy is independent (no 01-01 dependency unlike Watermark). Step 02-02 (FileSystemPort) and 04-01 (UpdateService) correctly depend on this step."
      },
      "acceptance_criteria_testable": {
        "status": "PASS",
        "details": "Three concrete, testable criteria: (1) 3 existing backups returns oldest for deletion, (2) path format ~/.claude.backup.{YYYYMMDDHHMMSS}/, (3) 0-2 backups returns empty deletion list"
      },
      "domain_model_adaptations": {
        "status": "PASS",
        "details": "Correctly configured for domain service: mapping_type=infrastructure, acceptance_test_must_fail_first=false, in_memory_test_ratio=1.0"
      },
      "mock_boundaries_appropriate": {
        "status": "PASS",
        "details": "BackupPolicy correctly listed in forbidden_domain_classes - no mocking domain services. allowed_ports and in_memory_adapters correctly empty for pure domain service."
      },
      "unit_tests_coverage": {
        "status": "PASS",
        "details": "6 unit tests cover all acceptance criteria: oldest deletion (1), empty when <3 (2), timestamp path generation (1), path format validation (1), empty list handling (1), timestamp sorting (1)"
      },
      "roadmap_alignment": {
        "status": "PASS",
        "details": "Step matches roadmap.yaml 01-04 exactly: name, description, type, components, dependencies, and acceptance criteria all align"
      }
    },
    "observations": [
      {
        "severity": "INFO",
        "message": "PREPARE and RED_ACCEPTANCE phases marked NOT_APPLICABLE in notes - correct for domain service step",
        "recommendation": "During execution, set status to SKIPPED with blocked_by: 'NOT_APPLICABLE: Domain service - no acceptance test'"
      },
      {
        "severity": "INFO",
        "message": "BackupPolicy has downstream dependents: 02-02 (FileSystemPort needs backup operations) and 04-01 (UpdateService uses backup policy)",
        "recommendation": "Ensure implementation provides backup path generation and deletion recommendation interfaces"
      }
    ],
    "approval_notes": "Step is well-structured for domain service TDD. Clear acceptance criteria with three concrete behaviors. Unit test names align with acceptance criteria. No dependencies required - BackupPolicy is self-contained business logic. Ready for execution."
  }
}
