{
  "step_id": "04-08",
  "name": "Backup rotation maintains exactly 3 copies",
  "description": "Roberto has 3 existing backups, performs update. New backup created, oldest deleted, exactly 3 remain.",
  "type": "scenario_implementation",
  "phase": "04",
  "phase_name": "US-002: Update",
  "acceptance_scenario": "Backup rotation maintains exactly 3 copies",
  "acceptance_test_line": 188,
  "components": [],
  "dependencies": ["04-01"],
  "acceptance_criteria": "New backup created with current timestamp; Oldest backup ~/.claude.backup.20260124120000/ is deleted; Exactly 3 backups remain",
  "tdd_cycle": {
    "acceptance_test": {
      "scenario_name": "Backup rotation maintains exactly 3 copies",
      "test_file": "docs/features/versioning-release-management/distill/acceptance-tests.feature",
      "test_file_format": "feature",
      "scenario_index": 8,
      "initially_ignored": true,
      "is_walking_skeleton": false,
      "mapped_scenario": {
        "scenario_function": "backup_rotation_maintains_exactly_3_copies",
        "scenario_description": "Roberto has 3 backups, new update creates 4th and deletes oldest",
        "mapping_type": "feature",
        "notes": "Backup rotation policy enforcement"
      }
    },
    "expected_unit_tests": [
      "test_backup_policy_identifies_oldest_for_deletion",
      "test_update_service_rotates_backups",
      "test_exactly_3_backups_remain_after_rotation"
    ],
    "mock_boundaries": {
      "allowed_ports": ["GitHubAPIPort", "FileSystemPort", "DownloadPort", "ChecksumPort"],
      "forbidden_domain_classes": ["Version", "Watermark", "BackupPolicy", "CoreContentIdentifier"],
      "in_memory_adapters": ["InMemoryFileSystemAdapter", "MockGitHubAPIAdapter", "MockDownloadAdapter"]
    },
    "tdd_phase_tracking": {
      "current_phase": "COMMIT",
      "active_e2e_test": "Backup rotation maintains exactly 3 copies",
      "inactive_e2e_tests": "All other @skip scenarios remain disabled",
      "phases_completed": ["PREPARE", "RED_ACCEPTANCE", "RED_UNIT", "GREEN", "REVIEW", "REFACTOR_CONTINUOUS", "REFACTOR_L4", "COMMIT"],
      "test_results": {
        "total": 13,
        "passed": 13,
        "failed": 0,
        "skipped": 0
      }
    },
    "phase_execution_log": [
      {
        "phase_name": "PREPARE",
        "status": "EXECUTED",
        "started_at": "2026-01-28T23:58:00Z",
        "ended_at": "2026-01-28T23:59:00Z",
        "outcome": "PASS",
        "notes": "Scenario already activated (ACTIVE comment present, @skip removed). Verified ONE acceptance test active.",
        "blocked_by": null
      },
      {
        "phase_name": "RED_ACCEPTANCE",
        "status": "EXECUTED",
        "started_at": "2026-01-29T00:02:00Z",
        "ended_at": "2026-01-29T00:05:00Z",
        "outcome": "FAIL_AS_EXPECTED",
        "notes": "Acceptance test FAILS: test_exactly_3_backups_remain_after_rotation fails with 2 backups instead of 3. Bug in BackupPolicy.get_backups_to_delete() formula: excess_count = len - max + 1 should be len - max",
        "blocked_by": null
      },
      {
        "phase_name": "RED_UNIT",
        "status": "EXECUTED",
        "started_at": "2026-01-29T00:06:00Z",
        "ended_at": "2026-01-29T00:10:00Z",
        "outcome": "FAIL_AS_EXPECTED",
        "notes": "Added 2 unit tests: test_backup_policy_deletes_only_1_when_4_exist_and_max_is_3, test_backup_policy_deletes_2_when_5_exist_and_max_is_3. Both fail confirming bug in excess_count formula.",
        "blocked_by": null
      },
      {
        "phase_name": "GREEN",
        "status": "EXECUTED",
        "started_at": "2026-01-29T00:12:00Z",
        "ended_at": "2026-01-29T00:20:00Z",
        "outcome": "PASS",
        "notes": "Fixed BackupPolicy.get_backups_to_delete() formula: changed excess_count from 'len - max + 1' to 'len - max'. Fixed condition from '<' to '<='. All 4 acceptance tests and 9 unit tests pass.",
        "blocked_by": null
      },
      {
        "phase_name": "REVIEW",
        "status": "EXECUTED",
        "started_at": "2026-01-29T00:22:00Z",
        "ended_at": "2026-01-29T00:25:00Z",
        "outcome": "APPROVED",
        "notes": "Self-review PASSED. Minimal fix (4 lines), comprehensive tests (4 acceptance, 9 unit), follows GIVEN-WHEN-THEN, no domain mocking. No critical or high issues.",
        "blocked_by": null
      },
      {
        "phase_name": "REFACTOR_CONTINUOUS",
        "status": "EXECUTED",
        "started_at": "2026-01-29T00:26:00Z",
        "ended_at": "2026-01-29T00:28:00Z",
        "outcome": "NOT_APPLICABLE",
        "notes": "L1+L2+L3 review: Code already follows best practices. Good naming (get_backups_to_delete, excess_count), short methods (<10 lines), clear docstrings. No refactoring needed.",
        "blocked_by": null
      },
      {
        "phase_name": "REFACTOR_L4",
        "status": "SKIPPED",
        "started_at": "2026-01-29T00:28:00Z",
        "ended_at": "2026-01-29T00:28:00Z",
        "outcome": "NOT_APPLICABLE",
        "notes": "NOT_APPLICABLE: Bug fix in existing domain service. No new patterns needed. BackupPolicy already follows Domain Service pattern correctly.",
        "blocked_by": null
      },
      {
        "phase_name": "COMMIT",
        "status": "EXECUTED",
        "started_at": "2026-01-29T00:30:00Z",
        "ended_at": "2026-01-29T00:32:00Z",
        "outcome": "PASS",
        "notes": "All 8 phases complete. 13 tests passing (4 acceptance, 9 unit). Commit ready.",
        "blocked_by": null
      }
    ]
  },
  "quality_gates": {
    "acceptance_test_must_fail_first": true,
    "unit_tests_must_fail_first": true,
    "no_mocks_inside_hexagon": true,
    "business_language_required": true,
    "refactor_level": 4,
    "in_memory_test_ratio_target": 0.8,
    "validation_after_each_phase": true,
    "all_8_phases_mandatory": true,
    "phase_documentation_required": true
  },
  "review_validation": {
    "reviewed_by": "software-crafter-reviewer",
    "reviewed_at": "2026-01-28T10:30:00Z",
    "validation_status": "APPROVED",
    "eight_phase_tdd_compliance": {
      "all_phases_present": true,
      "phase_count": 8,
      "phases_validated": ["PREPARE", "RED_ACCEPTANCE", "RED_UNIT", "GREEN", "REVIEW", "REFACTOR_CONTINUOUS", "REFACTOR_L4", "COMMIT"],
      "phase_notes_adequate": true,
      "compliance_status": "PASS"
    },
    "self_contained_context": {
      "acceptance_scenario_referenced": true,
      "scenario_line_verified": true,
      "scenario_line": 188,
      "scenario_exists_in_feature_file": true,
      "acceptance_criteria_clear": true,
      "expected_unit_tests_defined": true,
      "unit_test_count": 3,
      "mock_boundaries_specified": true,
      "compliance_status": "PASS"
    },
    "dependencies_validation": {
      "dependencies_declared": ["04-01"],
      "dependencies_exist": true,
      "dependency_chain_valid": true,
      "dependency_rationale": "04-01 establishes UpdateService, backup creation, download/checksum adapters. 04-08 extends with backup rotation policy enforcement.",
      "compliance_status": "PASS"
    },
    "quality_gates_validation": {
      "all_gates_defined": true,
      "gate_values_appropriate": true,
      "compliance_status": "PASS"
    },
    "issues_identified": [
      {
        "severity": "MEDIUM",
        "category": "completeness",
        "description": "Components array is empty but step will likely need BackupPolicy domain class reference for rotation logic",
        "recommendation": "Consider adding BackupPolicy component when implementing, or document that it will be discovered during TDD"
      },
      {
        "severity": "LOW",
        "category": "specificity",
        "description": "Expected unit test names could be more specific about max backup count",
        "recommendation": "Optional: rename test_update_service_rotates_backups to test_update_service_rotates_backups_keeping_max_3"
      }
    ],
    "approval_decision": {
      "status": "APPROVED",
      "rationale": "Step file is well-structured with complete 8-phase TDD tracking, valid dependency on 04-01, and clear acceptance criteria. Minor issues identified are LOW/MEDIUM severity and do not block execution.",
      "blocking_issues": 0,
      "total_issues": 2,
      "ready_for_execution": true
    }
  }
}
