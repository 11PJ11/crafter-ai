{
  "step_id": "02-02",
  "name": "Define FileSystemPort interface",
  "description": "Read/write ~/.claude/ directory operations. Read VERSION file, read/write watermark file, create and manage backup directories.",
  "type": "port_interface",
  "phase": "02",
  "phase_name": "Port Interface Definitions",
  "components": [
    {
      "name": "FileSystemPort",
      "type": "port_interface",
      "location": "nWave/core/versioning/ports/file_system_port.py"
    }
  ],
  "dependencies": ["01-03", "01-04"],
  "acceptance_criteria": "Abstract methods for read_version(), read_watermark(), write_watermark(); Abstract methods for create_backup(), list_backups(), delete_backup(); FileNotFoundError and PermissionError handling defined",
  "tdd_cycle": {
    "acceptance_test": {
      "scenario_name": "NOT_APPLICABLE",
      "test_file": "tests/unit/ports/test_file_system_port.py",
      "test_file_format": "py_pytest",
      "scenario_index": 0,
      "initially_ignored": false,
      "is_walking_skeleton": false,
      "mapped_scenario": {
        "scenario_function": "",
        "scenario_description": "Port interface definition - no acceptance scenario, interface contract tests only",
        "mapping_type": "infrastructure",
        "notes": "Port interfaces define contracts, tested via contract tests and adapter integration"
      }
    },
    "expected_unit_tests": [
      "test_file_system_port_is_abstract",
      "test_read_version_method_defined",
      "test_read_watermark_method_defined",
      "test_write_watermark_method_defined",
      "test_create_backup_method_defined",
      "test_list_backups_method_defined",
      "test_delete_backup_method_defined",
      "test_file_not_found_error_handling",
      "test_permission_error_handling"
    ],
    "mock_boundaries": {
      "allowed_ports": ["FileSystemPort"],
      "forbidden_domain_classes": ["Watermark", "BackupPolicy"],
      "in_memory_adapters": []
    },
    "tdd_phase_tracking": {
      "current_phase": "COMPLETE",
      "active_e2e_test": "",
      "inactive_e2e_tests": "N/A - port interface step",
      "phases_completed": ["PREPARE", "RED_ACCEPTANCE", "RED_UNIT", "GREEN", "REVIEW", "REFACTOR_CONTINUOUS", "REFACTOR_L4", "COMMIT"],
      "test_results": {
        "total": 9,
        "passed": 9,
        "failed": 0,
        "skipped": 0
      }
    },
    "phase_execution_log": [
      {
        "phase_name": "PREPARE",
        "status": "SKIPPED",
        "started_at": "2026-01-28T21:30:00Z",
        "ended_at": "2026-01-28T21:30:00Z",
        "outcome": "SKIPPED",
        "notes": "NOT_APPLICABLE: Port interface - no acceptance test to prepare",
        "blocked_by": "NOT_APPLICABLE: Port interface step"
      },
      {
        "phase_name": "RED_ACCEPTANCE",
        "status": "SKIPPED",
        "started_at": "2026-01-28T21:30:00Z",
        "ended_at": "2026-01-28T21:30:00Z",
        "outcome": "SKIPPED",
        "notes": "NOT_APPLICABLE: Port interface - no acceptance test",
        "blocked_by": "NOT_APPLICABLE: Port interface step"
      },
      {
        "phase_name": "RED_UNIT",
        "status": "EXECUTED",
        "started_at": "2026-01-28T21:31:00Z",
        "ended_at": "2026-01-28T21:33:00Z",
        "outcome": "PASS",
        "notes": "Created 9 failing contract tests for FileSystemPort interface in tests/unit/ports/test_file_system_port.py. All tests failed with ModuleNotFoundError as expected.",
        "blocked_by": null
      },
      {
        "phase_name": "GREEN",
        "status": "EXECUTED",
        "started_at": "2026-01-28T21:33:00Z",
        "ended_at": "2026-01-28T21:38:00Z",
        "outcome": "PASS",
        "notes": "Implemented FileSystemPort abstract class with 6 abstract methods: read_version, read_watermark, write_watermark, create_backup, list_backups, delete_backup. All 9 tests pass.",
        "blocked_by": null
      },
      {
        "phase_name": "REVIEW",
        "status": "EXECUTED",
        "started_at": "2026-01-28T21:38:00Z",
        "ended_at": "2026-01-28T21:40:00Z",
        "outcome": "PASS",
        "notes": "Reviewed interface design. All acceptance criteria met: abstract methods defined, FileNotFoundError and PermissionError documented in docstrings, hexagonal architecture compliance confirmed.",
        "blocked_by": null
      },
      {
        "phase_name": "REFACTOR_CONTINUOUS",
        "status": "EXECUTED",
        "started_at": "2026-01-28T21:40:00Z",
        "ended_at": "2026-01-28T21:41:00Z",
        "outcome": "PASS",
        "notes": "L1+L2+L3 review: Naming is intention-revealing, single responsibility per method, class organization is clean. No refactoring needed.",
        "blocked_by": null
      },
      {
        "phase_name": "REFACTOR_L4",
        "status": "SKIPPED",
        "started_at": "2026-01-28T21:41:00Z",
        "ended_at": "2026-01-28T21:41:00Z",
        "outcome": "SKIPPED",
        "notes": "NOT_APPLICABLE: Port interface already follows hexagonal architecture pattern (Ports and Adapters).",
        "blocked_by": "NOT_APPLICABLE: Already implements hexagonal architecture pattern"
      },
      {
        "phase_name": "COMMIT",
        "status": "EXECUTED",
        "started_at": "2026-01-28T21:41:00Z",
        "ended_at": "2026-01-28T21:45:00Z",
        "outcome": "PASS",
        "notes": "Committed FileSystemPort interface with contract tests.",
        "blocked_by": null
      }
    ]
  },
  "quality_gates": {
    "acceptance_test_must_fail_first": false,
    "unit_tests_must_fail_first": true,
    "no_mocks_inside_hexagon": true,
    "business_language_required": true,
    "refactor_level": 4,
    "in_memory_test_ratio_target": 1.0,
    "validation_after_each_phase": true,
    "all_8_phases_mandatory": true,
    "phase_documentation_required": true
  },
  "review_validation": {
    "reviewed_by": "software-crafter-reviewer",
    "reviewed_at": "2026-01-28T15:45:00Z",
    "schema_version": "2.0",
    "status": "APPROVED",
    "review_iteration": 2,
    "checks": {
      "8_phase_structure": {
        "status": "PASS",
        "details": "All 8 phases present: PREPARE, RED_ACCEPTANCE, RED_UNIT, GREEN, REVIEW, REFACTOR_CONTINUOUS, REFACTOR_L4, COMMIT"
      },
      "tdd_cycle_complete": {
        "status": "PASS",
        "details": "acceptance_test defined (NOT_APPLICABLE for port interface), expected_unit_tests (9 tests), mock_boundaries, phase_tracking all present"
      },
      "self_contained": {
        "status": "PASS",
        "details": "Step has clear description covering VERSION file read, watermark read/write, and backup directory management. Component location explicitly specified."
      },
      "dependencies_valid": {
        "status": "PASS",
        "details": "Depends on 01-03 (Watermark entity) - APPROVED; Depends on 01-04 (BackupPolicy domain service) - APPROVED. Both provide required domain knowledge for port interface design."
      },
      "acceptance_criteria_testable": {
        "status": "PASS",
        "details": "Specific abstract methods: read_version(), read_watermark(), write_watermark(), create_backup(), list_backups(), delete_backup(). Error handling: FileNotFoundError, PermissionError."
      },
      "port_interface_adaptations": {
        "status": "PASS",
        "details": "Correctly configured for port interface: mapping_type=infrastructure, acceptance_test_must_fail_first=false, in_memory_test_ratio=1.0"
      },
      "mock_boundaries_appropriate": {
        "status": "PASS",
        "details": "FileSystemPort correctly listed in allowed_ports (mocking allowed at port boundary). Watermark and BackupPolicy in forbidden_domain_classes - no mocking domain objects."
      },
      "unit_tests_coverage": {
        "status": "PASS",
        "details": "9 unit tests defined covering all acceptance criteria: abstract port validation, 6 method definitions, FileNotFoundError and PermissionError handling."
      }
    },
    "defects": [],
    "resolved_defects": [
      {
        "id": "DEF-02-02-001",
        "severity": "MEDIUM",
        "category": "test_coverage",
        "description": "Missing unit test for PermissionError handling",
        "resolution": "Added test_permission_error_handling to expected_unit_tests array",
        "resolved_in_iteration": 2,
        "resolved_at": "2026-01-28T15:45:00Z"
      }
    ],
    "observations": [
      {
        "severity": "INFO",
        "message": "PREPARE and RED_ACCEPTANCE phases marked NOT_APPLICABLE in notes - correct for port interface step",
        "recommendation": "During execution, set status to SKIPPED with blocked_by: 'NOT_APPLICABLE: Port interface - no acceptance test'"
      },
      {
        "severity": "INFO",
        "message": "FileSystemPort has downstream dependents: 03-01 (FileSystemAdapter) implements this interface",
        "recommendation": "Ensure interface methods provide clear contracts for adapter implementation"
      },
      {
        "severity": "INFO",
        "message": "Dependencies on 01-03 (Watermark) and 01-04 (BackupPolicy) ensure port understands domain concepts for method signatures",
        "recommendation": "Ensure 01-03 and 01-04 are completed before executing this step"
      }
    ],
    "approval_notes": "APPROVED on iteration 2. Defect DEF-02-02-001 resolved: test_permission_error_handling added to expected_unit_tests. All 9 unit tests now map to acceptance criteria. Step is ready for execution following 8-phase TDD cycle."
  }
}
