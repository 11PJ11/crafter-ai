# Integration Plan: Modern CLI â†’ Alessandro's Plugin System

**Date:** 2026-02-06
**Goal:** Wire modern installer to use Alessandro's `scripts/install/install_nwave.py` as the canonical installation engine

---

## Current State

**Modern CLI (`forge install`):**
- Entry: `src/crafter_ai/installer/cli/forge_install.py`
- Uses: Custom services (AssetDeploymentService, DeploymentValidationService, etc.)
- TUI: Rich console with spinners and progress
- Status: Duplicates Alessandro's work

**Alessandro's Plugin System:**
- Entry: `scripts/install/install_nwave.py`
- Uses: PluginRegistry with 5 plugins (agents, commands, templates, utilities, des)
- Features: Rollback, dependency resolution (topological sort), verification
- Status: Complete but not integrated

---

## Integration Strategy

### Phase 1: Create Bridge Adapter

**File:** `src/crafter_ai/installer/adapters/plugin_installer_adapter.py`

```python
"""Adapter to invoke Alessandro's plugin-based installer from modern CLI."""

from pathlib import Path
from typing import Protocol
import sys

# Import Alessandro's installer components
sys.path.insert(0, str(Path(__file__).parent.parent.parent.parent / "scripts/install"))

from install_nwave import NWaveInstaller
from plugins.registry import PluginRegistry
from plugins.agents_plugin import AgentsPlugin
from plugins.commands_plugin import CommandsPlugin
from plugins.templates_plugin import TemplatesPlugin
from plugins.utilities_plugin import UtilitiesPlugin
from plugins.des_plugin import DESPlugin


class PluginInstallerAdapter:
    """Adapter that bridges modern CLI to Alessandro's plugin installer."""

    def __init__(self, framework_source: Path, claude_dir: Path, dry_run: bool = False):
        """Initialize adapter with installation paths."""
        self.framework_source = framework_source
        self.claude_dir = claude_dir
        self.dry_run = dry_run

    def install(self) -> bool:
        """Run Alessandro's plugin-based installation.

        Returns:
            True if installation succeeded, False otherwise.
        """
        # Create Alessandro's installer instance
        installer = NWaveInstaller(
            framework_source=str(self.framework_source),
            claude_config_dir=str(self.claude_dir),
            dry_run=self.dry_run
        )

        # Create and register plugins
        registry = PluginRegistry()
        registry.register(AgentsPlugin())
        registry.register(CommandsPlugin())
        registry.register(TemplatesPlugin())
        registry.register(UtilitiesPlugin())
        registry.register(DESPlugin())

        # Run installation through plugin registry
        # This gives us: dependency resolution, rollback, verification
        results = registry.install_all(
            context=installer.context,
            exclude=None
        )

        # Check if all plugins succeeded
        return all(result.success for result in results.values())

    def get_installed_counts(self) -> dict[str, int]:
        """Get counts of installed artifacts."""
        # Alessandro's system tracks this in manifest
        manifest_path = self.claude_dir / "manifest.json"
        if manifest_path.exists():
            import json
            with open(manifest_path) as f:
                manifest = json.load(f)
                return manifest.get("counts", {})
        return {}
```

**Why this works:**
- Delegates ALL installation logic to Alessandro's proven system
- Modern CLI just provides the wrapper and TUI
- No duplication of installation logic

---

### Phase 2: Rewire `forge_install.py`

**File:** `src/crafter_ai/installer/cli/forge_install.py`

**Replace lines 200-450 (the entire install logic) with:**

```python
def install(
    wheel_path: Annotated[
        Path | None,
        typer.Argument(help="Path to wheel file. If not provided, auto-detect from dist/"),
    ] = None,
    no_prompt: Annotated[
        bool,
        typer.Option("--no-prompt", help="Skip confirmation prompts"),
    ] = False,
    force: Annotated[
        bool,
        typer.Option("--force", help="Force reinstall even if already installed"),
    ] = False,
) -> None:
    """Install nWave framework from local wheel using Alessandro's plugin system."""

    ci_mode = is_ci_mode()

    # Phase 1: Pre-flight checks (keep modern CLI checks)
    console.print("\nğŸ” Pre-flight Checks")
    check_registry = create_install_check_registry()
    executor = CheckExecutor(check_registry)
    results = executor.execute_all()

    display_pre_flight_results(console, results)
    blocking = get_blocking_failures(results)

    if blocking:
        display_blocking_failure_summary(console, blocking)
        raise typer.Exit(code=1)

    # Phase 2: Find or build wheel (keep modern CLI wheel handling)
    if wheel_path is None:
        wheel_path = find_latest_wheel()
        if wheel_path is None:
            wheel_path = run_auto_chain_build(no_prompt)

    # Phase 3: Extract wheel to get framework files
    console.print("\nğŸ“¦ Preparing framework files...")
    temp_extract_dir = Path("dist/ide")  # Modern CLI extracts here

    # Extract wheel if not already extracted
    if not temp_extract_dir.exists():
        # Use modern CLI's wheel extraction
        # ... extraction logic ...
        pass

    # Phase 4: INVOKE ALESSANDRO'S PLUGIN INSTALLER
    console.print("\nğŸ”§ Installing nWave framework (via plugin system)...")

    from crafter_ai.installer.adapters.plugin_installer_adapter import PluginInstallerAdapter

    adapter = PluginInstallerAdapter(
        framework_source=temp_extract_dir,
        claude_dir=Path.home() / ".claude",
        dry_run=False
    )

    with console.status("Installing components...", spinner=SPINNER_STYLE):
        success = adapter.install()

    if not success:
        console.print("\nâŒ Installation failed")
        console.print("  Check logs above for details")
        raise typer.Exit(code=1)

    # Phase 5: Verify installation (Alessandro's system does this)
    console.print("\nâœ… Installation complete!")

    # Display what was installed (from Alessandro's manifest)
    counts = adapter.get_installed_counts()
    console.print(f"  ğŸ“ Agents: {counts.get('agents', 0)}")
    console.print(f"  ğŸ“ Commands: {counts.get('commands', 0)}")
    console.print(f"  ğŸ“ Templates: {counts.get('templates', 0)}")
    console.print(f"  ğŸ“ Scripts: {counts.get('scripts', 0)}")

    console.print("\nğŸ‰ nWave is ready to use in Claude Code!")
```

**What this achieves:**
- Modern CLI keeps: TUI, pre-flight checks, wheel handling
- Alessandro's system does: ALL installation logic, rollback, verification, DES hooks
- Zero duplication

---

### Phase 3: Update Build Service

**File:** `src/crafter_ai/installer/cli/forge_build.py`

**Keep as-is** - build still creates the wheel and extracts to `dist/ide/`

**Why:** Build prepares artifacts, install deploys them via Alessandro's plugins

---

### Phase 4: Fix Path Mismatches

**Problem:** Old build tool creates `dist/ide/commands/`, new creates `dist/ide/tasks/nw/`

**Solution:** Alessandro's CommandsPlugin expects source at `framework_source / "commands"`

**Two options:**

**Option A: Update Alessandro's plugin (minimal change)**
```python
# In scripts/install/plugins/commands_plugin.py line 38
# OLD:
commands_source = context.framework_source / "commands"

# NEW:
commands_source = context.framework_source / "tasks" / "nw"
if not commands_source.exists():
    # Fallback to old path for backward compatibility
    commands_source = context.framework_source / "commands"
```

**Option B: Update modern build service**
Keep `dist/ide/tasks/nw/` as-is, update plugins

**Recommendation:** Option A (update plugin for modern path)

---

### Phase 5: Test Strategy

**Step 1: Integration test**
```bash
# Build the wheel
nw forge build

# Install using new integrated system
nw forge install --no-prompt

# Verify installation
ls -la ~/.claude/agents/nw/
ls -la ~/.claude/commands/nw/
ls -la ~/.claude/templates/
ls -la ~/.claude/scripts/
cat ~/.claude/manifest.json
cat ~/.claude/settings.local.json  # Check DES hooks installed
```

**Step 2: Run Alessandro's plugin tests**
```bash
pytest tests/nwave/plugin-architecture/ -v
```

Should now PASS (currently 15 failing due to path mismatch)

**Step 3: Run modern installer tests**
```bash
pytest tests/installer/ -v
```

Update to use PluginInstallerAdapter

---

### Phase 6: Remove Duplicated Code

**After all tests are GREEN, delete:**

```
src/crafter_ai/installer/services/
â”œâ”€â”€ asset_deployment_service.py          # DELETE - Alessandro's plugins do this
â”œâ”€â”€ deployment_validation_service.py     # DELETE - Alessandro's verification does this
â”œâ”€â”€ install_service.py                   # DELETE - now using plugin adapter

src/crafter_ai/installer/domain/
â”œâ”€â”€ deployment_validation_result.py      # DELETE - Alessandro has PluginResult
â”œâ”€â”€ asset_deployment_result.py           # DELETE - Alessandro has PluginResult

tests/installer/services/
â”œâ”€â”€ test_asset_deployment_service.py     # DELETE
â”œâ”€â”€ test_deployment_validation_service.py # DELETE
â”œâ”€â”€ test_install_service.py              # DELETE (or rewrite for adapter)
```

**Keep:**
```
src/crafter_ai/installer/
â”œâ”€â”€ adapters/plugin_installer_adapter.py  # KEEP - the bridge
â”œâ”€â”€ cli/forge_build.py                    # KEEP - wheel creation
â”œâ”€â”€ cli/forge_install.py                  # KEEP - TUI wrapper (rewired)
â”œâ”€â”€ checks/                               # KEEP - pre-flight checks
â”œâ”€â”€ domain/ide_bundle_constants.py        # KEEP - shared constants
```

---

## Execution Order

1. âœ… **Create:** `plugin_installer_adapter.py` (the bridge)
2. âœ… **Update:** `commands_plugin.py` line 38 (handle tasks/nw path)
3. âœ… **Rewire:** `forge_install.py` to use adapter
4. âœ… **Test:** Full installation flow end-to-end
5. âœ… **Fix:** Any path mismatches or import issues
6. âœ… **Verify:** All tests green (plugin tests + installer tests)
7. âœ… **Delete:** Duplicated services and domain objects
8. âœ… **Commit:** "refactor(installer): integrate with Alessandro's plugin system"

---

## Benefits After Integration

âœ… **Rollback mechanism** (from Alessandro's BackupManager)
âœ… **Dependency resolution** (from PluginRegistry topological sort)
âœ… **DES hooks installation** (from DESPlugin)
âœ… **Verification** (from Alessandro's InstallationVerifier)
âœ… **No duplication** (single source of truth)
âœ… **15 failing tests fixed** (path mismatch resolved)
âœ… **Modern TUI** (preserved from modern CLI)

---

## Risk Mitigation

**Risk:** Breaking existing installations
**Mitigation:** Test on clean machine, verify rollback works

**Risk:** Import path issues
**Mitigation:** Add scripts/install to sys.path in adapter

**Risk:** Tests still failing after integration
**Mitigation:** Fix path mismatches in plugins first

---

## Success Criteria

- [ ] `nw forge install` completes without errors
- [ ] All nWave files installed to `~/.claude/`
- [ ] DES hooks present in `settings.local.json`
- [ ] Manifest.json created with correct counts
- [ ] All 15 plugin tests GREEN
- [ ] All modern installer tests GREEN (or rewritten for adapter)
- [ ] Duplicated code deleted
- [ ] Documentation updated

Ready to execute?
