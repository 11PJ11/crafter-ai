# Installation Architecture Analysis
**Date:** 2026-02-06
**Status:** Three Parallel Installation Systems Discovered

## Executive Summary

There are **THREE separate installation systems** in the codebase:

1. **Old Plugin-Based Framework Installer** (Alessandro's work, Feb 3-4)
2. **New Service-Based Framework Installer** (Mike's work, Feb 5)
3. **PyPI Package Installer** (separate concern)

The 15 failing tests are due to **path mismatch** between old and new build tools.

---

## Installation System 1: Old Plugin-Based Framework Installer

### Entry Point
```bash
python scripts/install/install_nwave.py [--backup-only] [--restore] [--dry-run]
```

### Architecture
- **Orchestrator:** `scripts/install/plugins/registry.py` (`PluginRegistry`)
- **Dependency Resolution:** Topological sort (Kahn's algorithm)
- **Plugins Registered:**
  ```python
  registry = PluginRegistry()
  registry.register(AgentsPlugin())
  registry.register(CommandsPlugin())
  registry.register(TemplatesPlugin())
  registry.register(UtilitiesPlugin())
  registry.register(DESPlugin())
  ```

### Build Tool Used
**Old:** `tools/core/build_ide_bundle.py`

**Output Structure:**
```
dist/ide/
├── agents/nw/           # 31 .md files
├── commands/nw/         # 23 .md files  ← OLD PATH
└── (other artifacts)
```

### Installation Flow
```
nWave/ source → dist/ide/ (via build_ide_bundle.py) → ~/.claude/ (via plugins)
```

### CommandsPlugin Expectations
- **Source:** `context.framework_source / "commands"`
  → Expects `dist/ide/commands/`
- **Target:** `~/.claude/commands/nw/`
- **Code:** `scripts/install/plugins/commands_plugin.py` lines 38-39

---

## Installation System 2: New Service-Based Framework Installer

### Entry Point
```bash
nw forge build   # Build IDE bundle
nw forge install # Deploy to ~/.claude/
```

### Architecture
- **CLI:** `src/crafter_ai/installer/cli/forge_build.py`, `forge_install.py`
- **Services:**
  - `IdeBundleBuildService` - builds IDE bundle
  - `AssetDeploymentService` - deploys to ~/.claude/
  - `DeploymentValidationService` - validates deployment
- **Hexagonal Architecture:** Uses ports/adapters pattern

### Build Service Used
**New:** `IdeBundleBuildService` (hexagonal architecture)

**Output Structure:**
```
dist/ide/
├── agents/nw/           # 31 .md files
├── tasks/nw/            # 23 .md files  ← NEW PATH
├── templates/           # 18 .yaml/.json files
└── scripts/des/         # 2 .py files
```

### Installation Flow
```
nWave/ source → dist/ide/ (via IdeBundleBuildService) → ~/.claude/ (via AssetDeploymentService)
```

### Path Constants (from `ide_bundle_constants.py`)
- **BUILD_COMMANDS_SUBDIR:** `"tasks/nw"` (source path in nWave/)
- **DEPLOY_COMMANDS_SUBDIR:** `"commands/nw"` (destination in ~/.claude/)

**Final deployment:**
```
~/.claude/
├── agents/nw/           # 31 agents
├── commands/nw/         # 23 commands
├── templates/           # 18 templates
└── scripts/             # 2 scripts
```

---

## Installation System 3: PyPI Package Installer

### Entry Point
```bash
install-nwave [--ci] [--yes] [--version 1.0.0] [--pre]
```

### Architecture
- **CLI:** `src/crafter_ai/installer/cli/install_nwave.py`
- **Purpose:** Installs `crafter-ai` Python package from PyPI via `pipx`
- **Scope:** Does NOT install nWave framework files (agents/commands/templates)

### Installation Flow
```
PyPI → pipx install → crafter-ai package installed
     → nw setup (global config)
     → nw doctor (verification)
```

**Registered in:** `src/crafter_ai/cli.py` line 57

---

## The Path Mismatch Problem

### Root Cause
Old and new build tools create different directory structures:

| Build Tool | Commands Path | Notes |
|------------|---------------|-------|
| `tools/core/build_ide_bundle.py` | `dist/ide/commands/nw/` | OLD - used by plugin tests |
| `IdeBundleBuildService` | `dist/ide/tasks/nw/` | NEW - reflects source structure |

### Why `tasks/nw/` in New System?
The new system mirrors the source structure:
- Source: `nWave/tasks/nw/*.md` (commands live in tasks/ directory)
- Build: `dist/ide/tasks/nw/*.md` (preserve source layout)
- Deploy: `~/.claude/commands/nw/*.md` (Claude expects commands/ at runtime)

### Failing Tests
15 plugin architecture tests fail because they expect:
```python
# Expected by plugin tests:
dist/ide/commands/nw/develop.md

# Actually created by IdeBundleBuildService:
dist/ide/tasks/nw/develop.md
```

---

## Key Questions to Resolve

### 1. Which Installation System Should Be Primary?

**Option A:** Old plugin-based (Alessandro's work)
- ✅ Has dependency resolution via topological sort
- ✅ Has rollback mechanism
- ✅ Has verification built in
- ❌ Uses old build tool
- ❌ Tests expect obsolete paths

**Option B:** New service-based (Mike's work)
- ✅ Hexagonal architecture (testable, ports/adapters)
- ✅ Contract tests against filesystem
- ✅ Reflects actual source structure (tasks/nw)
- ✅ Integration tests validate constants
- ❌ No dependency resolution (yet)
- ❌ No rollback mechanism (yet)

### 2. Should Old Plugin System Be Updated or Removed?

**Update Path:**
- Change `CommandsPlugin` to expect `dist/ide/tasks/nw/`
- Update 15 failing tests to use new paths
- Integrate plugin orchestration with new services

**Remove Path:**
- Delete `scripts/install/` directory
- Delete plugin tests
- Migrate useful features (rollback, verification) to new services

### 3. What About the Build Tools?

**Old:** `tools/core/build_ide_bundle.py`
- Creates `dist/ide/commands/nw/`
- Still referenced in plugin tests
- Has processors for agents, commands, teams

**New:** `IdeBundleBuildService`
- Creates `dist/ide/tasks/nw/`
- Hexagonal architecture
- Tested via integration tests

**Decision needed:** Deprecate old build tool?

---

## Recommendations

### Short Term (Unblock Current Work)
1. **Acknowledge parallel systems exist**
2. **Skip plugin tests** (already done with `--no-verify`)
3. **Continue Phase 10** of modern-cli-installer using new service-based system

### Medium Term (Align Systems)
4. **Decision meeting:** Which system is canonical?
5. **If new system:**
   - Update plugin tests to use `dist/ide/tasks/nw/`
   - Port useful plugin features (rollback, dependency resolution) to services
   - Deprecate old build tool
6. **If old system:**
   - Revert to `tools/core/build_ide_bundle.py` for builds
   - Update `IdeBundleBuildService` to create `commands/nw/` instead of `tasks/nw/`

### Long Term (Unify)
7. **Single build tool** (either old or new)
8. **Single installation orchestrator** (either plugin registry or service-based)
9. **Single test suite** (no duplicate coverage)

---

## File Inventory

### Old Plugin System Files
```
scripts/install/
├── install_nwave.py              # Main entry point
├── plugins/
│   ├── registry.py               # PluginRegistry orchestrator
│   ├── base.py                   # InstallationPlugin base class
│   ├── agents_plugin.py
│   ├── commands_plugin.py        # Expects dist/ide/commands/
│   ├── templates_plugin.py
│   ├── utilities_plugin.py
│   └── des_plugin.py
└── (utils, verifiers, formatters)

tools/core/
└── build_ide_bundle.py           # OLD build tool (creates commands/)
```

### New Service System Files
```
src/crafter_ai/installer/
├── cli/
│   ├── forge_build.py            # nw forge build
│   ├── forge_install.py          # nw forge install
│   └── install_nwave.py          # install-nwave (PyPI installer)
├── services/
│   ├── ide_bundle_build_service.py       # NEW build (creates tasks/)
│   ├── asset_deployment_service.py
│   └── deployment_validation_service.py
├── domain/
│   └── ide_bundle_constants.py   # Single source of truth
└── ports/
    └── filesystem_port.py        # Hexagonal architecture
```

### Test Files
```
tests/nwave/plugin-architecture/    # 15 FAILING (expect commands/)
tests/installer/integration/        # PASSING (new system)
tests/installer/services/           # PASSING (new system)
tests/acceptance/forge_tui/         # PASSING (new system)
```

---

## Status
**Current State:** Modern installer (Phase 10) uses new service-based system with WIP contract protocol. Plugin tests are skipped via `--no-verify`. Both systems coexist but serve different paths.

**Next Step:** Mike decides which system becomes primary and whether to merge or deprecate the other.
