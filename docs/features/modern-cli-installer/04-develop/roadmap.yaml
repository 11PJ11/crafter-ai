# Implementation Roadmap: modern-cli-installer
# Epic: modern_CLI_installer
# Solution Architect: Morgan
# Created: 2026-02-01
# Schema Version: 2.0

project:
  id: "modern-cli-installer"
  name: "Modern CLI Installer"
  goal: "Complete build -> install -> release pipeline for nWave framework with three interconnected journeys"
  methodology: "standard"
  schema_version: "2.0"
  created_at: "2026-02-01T00:00:00Z"

  journeys:
    - id: "J1"
      name: "forge:build-local-candidate"
      description: "Build pipx-compatible wheel with semantic versioning"
    - id: "J2"
      name: "forge:install-local-candidate"
      description: "Install and validate local wheel before release"
    - id: "J3"
      name: "install-nwave"
      description: "First-time PyPI installation for end users"

tdd_phases:
  - PREPARE
  - RED_ACCEPTANCE
  - RED_UNIT
  - GREEN
  - REVIEW
  - REFACTOR_CONTINUOUS
  - COMMIT

execution_config:
  context_extraction_method: "from_roadmap"
  status_tracking_file: "execution-log.yaml"
  token_budget_per_step: 5000
  acceptance_test_location: "docs/features/modern-cli-installer/03-distill"

implicit_prerequisites:
  runtime:
    - "Python 3.10+ installed and available as python3"
    - "pipx installed and on PATH"
    - "git installed with repository initialized"
  filesystem:
    - "Write access to ~/.claude/ directory"
    - "Write access to project dist/ directory"
  network:
    - "Internet access for PyPI/TestPyPI operations (CI only)"

implementation_scope:
  source_directories:
    - "nWave/core/installer/"
    - "nWave/infrastructure/installer/"
    - "nWave/cli/"
    - "nWave/core/versioning/"
  test_directories:
    - "tests/installer/"
    - "tests/cli/"
  excluded_patterns:
    - "__init__.py"
    - "__pycache__/**"
    - "*.pyc"

# ==============================================================================
# PHASE 00: SPRINT 0 PREREQUISITES
# ==============================================================================

phases:
  - id: "00"
    name: "Sprint 0 Prerequisites"
    description: "Platform infrastructure required before DEVELOP can begin"
    default_agent: "software-crafter"
    default_deps_strategy: "sequential"
    type: "infrastructure"
    notes: |
      These are blocking prerequisites identified in platform-readiness-review.md.
      Must complete before Phase 01 can begin.
    steps:
      - id: "00-01"
        name: "Create pyproject.toml with package configuration"
        type: "infrastructure"
        user_stories: []
        criteria: |
          - pyproject.toml exists at repository root
          - [build-system] configured with setuptools>=61.0
          - [project] section with name="nwave", version="0.0.0"
          - [project.scripts] with nw="nwave.cli:main" entry point
          - Dependencies declared: click, rich, pyyaml
          - requires-python = ">=3.10"
          - python -m build succeeds
          - twine check dist/*.whl passes
        dependencies: []
        estimated_hours: 2

      - id: "00-02"
        name: "Configure PyPI secrets in GitHub"
        type: "infrastructure"
        user_stories: []
        criteria: |
          - PYPI_API_TOKEN secret configured in GitHub repository
          - TEST_PYPI_API_TOKEN secret configured in GitHub repository
          - Secrets validated with test upload to TestPyPI
        dependencies: ["00-01"]
        estimated_hours: 1

      - id: "00-03"
        name: "Add TestPyPI publishing workflow to CI"
        type: "infrastructure"
        user_stories: []
        criteria: |
          - PR-level TestPyPI validation workflow added
          - Wheel builds on PR
          - Publishes to TestPyPI with unique dev version
          - E2E install test validates pipx install from TestPyPI
        dependencies: ["00-01", "00-02"]
        estimated_hours: 3

      - id: "00-04"
        name: "Add version sync quality gate to CI"
        type: "infrastructure"
        user_stories: []
        criteria: |
          - CI validates agent spec versions match pyproject.toml
          - Prevents version drift between components
          - Blocks PR on version mismatch
        dependencies: ["00-01"]
        estimated_hours: 2

      - id: "00-05"
        name: "Create test directory structure and pytest configuration"
        type: "infrastructure"
        user_stories: []
        criteria: |
          - tests/installer/ directory exists
          - tests/cli/ directory exists
          - pytest.ini or pyproject.toml [tool.pytest] configured
          - conftest.py with common fixtures for port mocking
          - Test dependencies added to pyproject.toml: pytest, pytest-bdd, pytest-cov
        dependencies: ["00-01"]
        estimated_hours: 1

# ==============================================================================
# PHASE 01: INFRASTRUCTURE - Shared Frameworks
# ==============================================================================

  - id: "01"
    name: "Infrastructure - Shared Frameworks"
    description: "Pre-flight check framework, Doctor health check framework, and shared artifact registry"
    default_agent: "software-crafter"
    default_deps_strategy: "sequential"
    notes: |
      Stories US-001 through US-005. These form the foundation for all three journeys.
      Hexagonal architecture with ports/adapters pattern.
    steps:
      - id: "01-01"
        name: "Create CheckResult domain object and CheckSeverity enum"
        user_stories: ["US-001"]
        scenario: "journey_1_build.feature::Pre-flight check validates Python version"
        criteria: |
          - CheckResult dataclass exists in nWave/core/installer/domain/check_result.py
          - Properties: id, name, passed, severity, message, remediation, fixable, fix_command
          - CheckSeverity enum with BLOCKING and WARNING values
          - Immutable (frozen=True dataclass)
          - Unit tests validate creation and equality
        dependencies: ["00-01"]
        estimated_hours: 2

      - id: "01-02"
        name: "Create CheckRegistry and CheckExecutor for pre-flight checks"
        user_stories: ["US-001"]
        scenario: "journey_1_build.feature::Successful local build with all checks passing"
        criteria: |
          - CheckRegistry class with register() and get_checks_for_journey() methods
          - CheckExecutor runs all registered checks for a journey
          - Returns list of CheckResult objects
          - Checks run in parallel where possible
          - Journey identifiers: "build", "install-local", "install-pypi"
        dependencies: ["01-01"]
        estimated_hours: 3

      - id: "01-03"
        name: "Create core pre-flight checks (python_version, pipx_available, claude_dir_writable)"
        user_stories: ["US-001"]
        scenario: "horizontal_coherence.feature::Pre-flight table format identical across all three journeys"
        criteria: |
          - python_version check validates >=3.10
          - pipx_available check validates pipx is installed
          - claude_dir_writable check validates ~/.claude permissions
          - All checks return CheckResult with consistent format
          - Display format: "{check_name} [check] {details}" for pass
          - Display format: "{check_name} [x] {error}" for fail
        dependencies: ["01-02"]
        estimated_hours: 3

      - id: "01-04"
        name: "Create HealthStatus enum and HealthChecker for doctor framework"
        user_stories: ["US-002"]
        scenario: "journey_2_install.feature::Doctor verification matches install-nwave pattern"
        criteria: |
          - HealthStatus enum with HEALTHY, DEGRADED, UNHEALTHY values
          - HealthChecker runs all health checks and determines overall status
          - HEALTHY: all critical checks pass
          - DEGRADED: critical pass but warnings exist
          - UNHEALTHY: one or more critical failures
          - Returns structured health report
        dependencies: ["01-01"]
        estimated_hours: 3

      - id: "01-05"
        name: "Create doctor health checks (core_installation, file counts, config, permissions, version)"
        user_stories: ["US-002"]
        scenario: "horizontal_coherence.feature::Doctor check order identical between local and PyPI install"
        criteria: |
          - Seven checks in fixed order: core_installation, agent_files, command_files, template_files, config_valid, permissions, version_match
          - File count checks compare against expected manifest counts
          - Config check validates nwave.yaml parses correctly
          - Version check compares nw --version output against expected
          - Consistent display format across Journey 2 and Journey 3
        dependencies: ["01-04"]
        estimated_hours: 4

      - id: "01-06"
        name: "Create ArtifactRegistry for shared artifact values"
        user_stories: ["US-003"]
        scenario: "horizontal_coherence.feature::Artifacts flow correctly from build to install to doctor"
        criteria: |
          - ArtifactRegistry provides get_version(), get_candidate_version(), get_wheel_path()
          - get_counts() returns ArtifactCounts with agent_count, command_count, template_count
          - Version read from pyproject.toml
          - Wheel path derived from candidate version
          - Consistent values across all journey steps
        dependencies: ["01-01"]
        estimated_hours: 3

      - id: "01-07"
        name: "Create ConfigPort and ConfigAdapter for installer configuration"
        user_stories: ["US-004"]
        scenario: "journey_3_pypi.feature::Install path resolution uses default when no override"
        criteria: |
          - ConfigPort interface with resolve_install_path(), get_env_var(), load_config()
          - ConfigAdapter implements port with real environment/filesystem
          - Resolution order: NWAVE_INSTALL_PATH env -> config file -> default ~/.claude/agents/nw/
          - CI mode detection via CI, GITHUB_ACTIONS, GITLAB_CI, JENKINS_URL
          - Path expansion for ~ handled correctly
        dependencies: []
        estimated_hours: 3

      - id: "01-08"
        name: "Create URL configuration management"
        user_stories: ["US-005"]
        scenario: "N/A - infrastructure support"
        criteria: |
          - URLs loaded from nWave/data/config/urls.yaml
          - docs.base, docs.getting_started, docs.api, docs.troubleshooting configured
          - repo.github, repo.issues, repo.releases configured
          - package.pypi configured
          - support.community, support.bug_report configured
          - All display URLs read from config, not hardcoded
        dependencies: []
        estimated_hours: 2

# ==============================================================================
# PHASE 02: JOURNEY 1 - Build Local Candidate
# ==============================================================================

  - id: "02"
    name: "Journey 1 - Build Local Candidate"
    description: "forge:build-local-candidate journey implementation"
    default_agent: "software-crafter"
    default_deps_strategy: "sequential"
    notes: |
      Stories US-010 through US-019. Build pipx-compatible wheel with semantic versioning.
      Emotional arc: Focused -> Confident -> Accomplished
    steps:
      - id: "02-01"
        name: "Create build-specific pre-flight checks"
        user_stories: ["US-010"]
        scenario: "journey_1_build.feature::Pre-flight check validates build package"
        criteria: |
          - build_package check validates python -m build --version succeeds
          - pyproject_toml_exists check validates file exists
          - pyproject_toml_valid check validates TOML parses without error
          - source_directory check validates nWave/ exists
          - dist_directory check validates dist/ is writable (creates if needed)
          - All checks registered for "build" journey
        dependencies: ["01-03"]
        estimated_hours: 3

      - id: "02-02"
        name: "Create GitPort and GitAdapter for commit analysis"
        user_stories: ["US-011"]
        scenario: "journey_1_build.feature::Version bump from conventional commits - MINOR"
        criteria: |
          - GitPort interface with get_commits_since_tag(), get_last_tag()
          - GitAdapter implements using git CLI
          - Returns list of commit messages since last tag
          - Handles case where no tags exist
          - Handles case where no commits since tag
        dependencies: []
        estimated_hours: 2

      - id: "02-03"
        name: "Create CandidateVersion domain object"
        user_stories: ["US-011", "US-017"]
        scenario: "journey_1_build.feature::Daily sequence increments on same day"
        criteria: |
          - CandidateVersion value object with base_version, date, sequence
          - Format: M.m.p-dev-YYYYMMDD-seq (e.g., 1.3.0-dev-20260201-001)
          - PEP 440 wheel format: M.m.p.devYYYYMMDDseq (e.g., 1.3.0.dev20260201001)
          - Factory method CandidateVersion.create()
          - Parser method CandidateVersion.parse()
          - Sequence tracking persists per date
        dependencies: ["01-01"]
        estimated_hours: 3

      - id: "02-04"
        name: "Create VersionBumpService for conventional commit analysis"
        user_stories: ["US-011", "US-016"]
        scenario: "journey_1_build.feature::Version bump detects breaking changes - MAJOR"
        criteria: |
          - VersionBumpService analyzes commits since last tag
          - BREAKING CHANGE or ! suffix -> MAJOR bump
          - feat: prefix -> MINOR bump
          - fix: prefix -> PATCH bump
          - --force-version flag overrides auto-calculation
          - Force version must be > current version
          - Warns if no commits since last tag
        dependencies: ["02-02", "02-03"]
        estimated_hours: 4

      - id: "02-05"
        name: "Create BuildPort and BuildAdapter for wheel building"
        user_stories: ["US-012"]
        scenario: "journey_1_build.feature::Build process shows progress phases"
        criteria: |
          - BuildPort interface with clean_dist(), build_wheel()
          - BuildAdapter wraps python -m build
          - Three phases: clean, process, build
          - Returns BuildResult with wheel_path, file_count, duration
          - Captures and reports backend errors with suggested fixes
        dependencies: []
        estimated_hours: 3

      - id: "02-06"
        name: "Create wheel validation service"
        user_stories: ["US-013"]
        scenario: "journey_1_build.feature::Wheel validation checks all required aspects"
        criteria: |
          - Validates wheel file format is correct
          - Validates pyproject.toml metadata is bundled
          - Validates nw CLI entry point is defined
          - Counts agents, commands, templates bundled in wheel
          - Validates pipx compatibility
          - Fails fast on first critical issue
          - Returns WheelValidationResult with all check results
        dependencies: ["01-06"]
        estimated_hours: 4

      - id: "02-07"
        name: "Create BuildService orchestrating build journey"
        user_stories: ["US-010", "US-011", "US-012", "US-013", "US-014"]
        scenario: "journey_1_build.feature::Successful local build with all checks passing"
        criteria: |
          - BuildService orchestrates: preflight -> version bump -> build -> validate -> summary
          - Uses PreflightService for checks
          - Uses VersionBumpService for version calculation
          - Uses BuildAdapter for wheel building
          - Uses wheel validation service
          - Returns complete BuildResult with all artifacts
        dependencies: ["02-01", "02-04", "02-05", "02-06"]
        estimated_hours: 4

      - id: "02-08"
        name: "Create forge:build CLI command"
        user_stories: ["US-010", "US-014", "US-015", "US-018"]
        scenario: "journey_1_build.feature::Build works in non-interactive CI mode"
        criteria: |
          - CLI entry point forge:build-local-candidate or nw forge build
          - Displays pre-flight table with consistent format
          - Displays version bump analysis
          - Displays build progress phases
          - Displays success summary with "FORGE: BUILD COMPLETE"
          - Prompts "Install locally now? [Y/n]" (skipped in CI mode)
          - --no-prompt flag skips install prompt
          - --install flag triggers auto-install
          - --force-version flag for version override
          - CI=true suppresses prompts, returns exit codes
        dependencies: ["02-07"]
        estimated_hours: 4

      - id: "02-09"
        name: "Create auto-repair for missing build package"
        user_stories: ["US-019"]
        scenario: "journey_1_build.feature::Developer accepts auto-repair for missing build package"
        criteria: |
          - build_package check marked as fixable=True
          - fix_command="pip install build"
          - Prompt asks "Install it now? [Y/n]"
          - On Y: runs pip install build, resumes pre-flight
          - On n: aborts with manual instructions
          - Shows spinner during install
          - Shows success message with installed version
        dependencies: ["02-01", "02-08"]
        estimated_hours: 2

# ==============================================================================
# PHASE 03: JOURNEY 2 - Install Local Candidate
# ==============================================================================

  - id: "03"
    name: "Journey 2 - Install Local Candidate"
    description: "forge:install-local-candidate journey implementation"
    default_agent: "software-crafter"
    default_deps_strategy: "sequential"
    notes: |
      Stories US-020 through US-029. Install and validate local wheel before release.
      Emotional arc: Focused -> Trust -> Celebratory
    steps:
      - id: "03-01"
        name: "Create install-specific pre-flight checks"
        user_stories: ["US-020"]
        scenario: "journey_2_install.feature::Pre-flight validates wheel exists"
        criteria: |
          - wheel_exists check validates .whl file in dist/
          - wheel_format check validates wheel filename format
          - pipx_isolation check validates pipx can create isolated env
          - install_path_resolved check confirms target path
          - All checks registered for "install-local" journey
          - wheel_exists marked fixable with chain to build
        dependencies: ["01-03"]
        estimated_hours: 3

      - id: "03-02"
        name: "Create PipxPort and PipxAdapter"
        user_stories: ["US-022"]
        scenario: "journey_2_install.feature::Install uses pipx with force flag"
        criteria: |
          - PipxPort interface with is_available(), install(), uninstall(), list_packages()
          - PipxAdapter implements using pipx CLI
          - install() accepts wheel_path and force flag
          - Returns InstallResult with success, version, path
          - Handles uninstall of previous version before install
        dependencies: []
        estimated_hours: 3

      - id: "03-03"
        name: "Create release readiness validation service"
        user_stories: ["US-021"]
        scenario: "journey_2_install.feature::Release readiness shows all PyPI requirements met"
        criteria: |
          - Runs twine check on wheel (blocking)
          - Validates metadata completeness: name, version, description, author, license
          - Validates entry points: nw CLI defined
          - Validates CHANGELOG entry exists (warning, not blocking)
          - Validates PEP 440 version format
          - Validates LICENSE and README bundled
          - Returns "READY FOR PYPI" or failure status
        dependencies: ["02-06"]
        estimated_hours: 4

      - id: "03-04"
        name: "Create BackupPort and BackupAdapter"
        user_stories: ["US-039"]
        scenario: "journey_3_pypi.feature::Backup is created before installation on upgrade"
        criteria: |
          - BackupPort interface with create_backup(), restore_backup(), list_backups()
          - BackupAdapter implements using filesystem operations
          - Backup path: ~/.claude/backups/nwave-YYYYMMDD-HHMMSS/
          - Includes agents, commands, templates, manifest
          - cleanup_old_backups() retains configurable count
        dependencies: []
        estimated_hours: 3

      - id: "03-05a"
        name: "Create InstallService core orchestration (preflight -> readiness -> backup -> install)"
        user_stories: ["US-020", "US-021", "US-022"]
        scenario: "journey_2_install.feature::Successful candidate installation with all checks passing"
        criteria: |
          - InstallService orchestrates first four phases: preflight -> readiness -> backup -> install
          - Uses PreflightService for install-specific checks
          - Uses release readiness service for PyPI validation
          - Uses BackupAdapter for backup creation before install
          - Uses PipxAdapter for wheel installation with force flag
          - Returns intermediate InstallResult with install status (pending verification)
          - Handles install failures with clear error messages
        dependencies: ["03-01", "03-02", "03-03", "03-04"]
        estimated_hours: 3

      - id: "03-05b"
        name: "Create InstallService verification orchestration (doctor verification -> result aggregation)"
        user_stories: ["US-023"]
        scenario: "journey_2_install.feature::Doctor verification matches install-nwave pattern"
        criteria: |
          - InstallService completes orchestration with verification phase
          - Uses DoctorService for post-install health verification
          - Aggregates results from all phases into complete InstallResult
          - Returns complete InstallResult with health status (HEALTHY/DEGRADED/UNHEALTHY)
          - Maps doctor results to final install outcome
          - Provides structured data for release report generation
        dependencies: ["03-05a", "01-05"]
        estimated_hours: 2

      - id: "03-06"
        name: "Create release report generator"
        user_stories: ["US-024"]
        scenario: "journey_2_install.feature::Release report provides complete summary"
        criteria: |
          - Header: "FORGE: CANDIDATE INSTALLED"
          - Release summary: version, branch, build timestamp, install timestamp
          - Install manifest: agent count, command count, template count, install path
          - Release readiness: summary of all checks
          - Test checklist: restart Claude, /nw:version, /nw:help, test agent, nw doctor
          - Supports JSON output for CI/CD
          - Supports file output via --output flag
        dependencies: ["03-05b"]
        estimated_hours: 3

      - id: "03-07"
        name: "Create forge:install CLI command"
        user_stories: ["US-020", "US-024", "US-027", "US-028", "US-029"]
        scenario: "journey_2_install.feature::Install works in non-interactive CI mode"
        criteria: |
          - CLI entry point forge:install-local-candidate or nw forge install
          - Displays pre-flight table
          - Displays release readiness validation
          - Displays install progress phases
          - Displays doctor verification
          - Displays release report
          - --json flag outputs JSON instead of TUI
          - --output flag writes report to file
          - --strict flag elevates warnings to errors
          - CI=true auto-selects newest wheel, suppresses prompts
        dependencies: ["03-05b", "03-06"]
        estimated_hours: 4

      - id: "03-08"
        name: "Create auto-chain to build when no wheel found"
        user_stories: ["US-025"]
        scenario: "journey_2_install.feature::Developer accepts auto-chain to build-local"
        criteria: |
          - wheel_exists check detects empty dist/ or no .whl files
          - Prompt asks "Run forge:build-local now? [Y/n]"
          - On Y: runs forge:build-local, then resumes install
          - On n: aborts with manual build command
          - Message shows "Resuming install-local-candidate..."
        dependencies: ["03-01", "03-07", "02-08"]
        estimated_hours: 2

      - id: "03-09"
        name: "Create multiple wheel selection prompt"
        user_stories: ["US-026"]
        scenario: "journey_2_install.feature::Developer selects wheel from multiple options"
        criteria: |
          - Detects multiple .whl files in dist/
          - Shows numbered list sorted by modification time (newest first)
          - Prompt asks "Select wheel [1-N, or 'c' to cancel]:"
          - Validates input is valid number or 'c'
          - CI mode auto-selects newest without prompt
        dependencies: ["03-07"]
        estimated_hours: 2

# ==============================================================================
# PHASE 04: JOURNEY 3 - PyPI Install
# ==============================================================================

  - id: "04"
    name: "Journey 3 - PyPI Install"
    description: "install-nwave journey for first-time PyPI installation"
    default_agent: "software-crafter"
    default_deps_strategy: "sequential"
    notes: |
      Stories US-030 through US-039. First-time PyPI installation for end users.
      Emotional arc: Excited -> Confident -> Delighted
    steps:
      - id: "04-01"
        name: "Create PyPI-specific pre-flight checks"
        user_stories: ["US-030", "US-031"]
        scenario: "journey_3_pypi.feature::Pre-flight check validates Python version"
        criteria: |
          - Reuses core checks: python_version, pipx_available, claude_dir_writable
          - Adds claude_code_installed check (warning, not blocking)
          - All checks registered for "install-pypi" journey
          - Pre-flight output shows resolved install path
        dependencies: ["01-03"]
        estimated_hours: 2

      - id: "04-02"
        name: "Create upgrade detection service"
        user_stories: ["US-041"]
        scenario: "journey_3_pypi.feature::Upgrade from older version"
        criteria: |
          - Detects existing nWave installation at install_path
          - Reads installed version from manifest.yaml or nwave.yaml
          - Compares with incoming version using semver
          - Returns upgrade path: FRESH_INSTALL, UPGRADE, REINSTALL, DOWNGRADE
          - FRESH_INSTALL: no backup, proceed directly
          - UPGRADE: create backup, show "Upgrading from X to Y"
          - REINSTALL: prompt confirmation (skipped in CI)
          - DOWNGRADE: warn and require confirmation
        dependencies: ["01-07", "03-04"]
        estimated_hours: 4

      - id: "04-03"
        name: "Create framework installation progress display"
        user_stories: ["US-032"]
        scenario: "journey_3_pypi.feature::Framework installation shows progress bars"
        criteria: |
          - Spinner for "Checking source files"
          - Progress bar for "Building distribution"
          - Per-component progress: Agents, Commands, Templates
          - Each component shows count and checkmark when complete
          - Validation table at end showing all counts
          - Final status "Validation: PASSED"
        dependencies: ["03-05b"]
        estimated_hours: 3

      - id: "04-04"
        name: "Create welcome and celebration display"
        user_stories: ["US-034", "US-035"]
        scenario: "journey_3_pypi.feature::Welcome message displays celebration"
        criteria: |
          - nWave ASCII logo displayed
          - Message: "nWave v{version} installed successfully!"
          - Message: "Your Claude is now powered by nWave"
          - Restart instruction in highlighted box
          - Next steps list: 1. Restart Claude Code, 2. /nw:version, 3. /nw:help
          - Documentation URL from urls.yaml
          - Suppressed in CI mode
        dependencies: ["01-08"]
        estimated_hours: 2

      - id: "04-05"
        name: "Create nw setup command for post-install agent setup"
        user_stories: ["US-032"]
        scenario: "journey_3_pypi.feature::Successful first-time installation"
        criteria: |
          - nw setup command copies agents to install_path
          - Auto-triggered on first run after pipx install
          - Can be run manually for repair/reinstall
          - Creates ~/.claude/agents/nw/ directory if needed
          - Copies agents, commands, templates from package
          - Creates manifest.json with version and counts
          - Uses FileSystemPort for all directory and file operations (not direct os/shutil calls)
          - FileSystemPort enables test isolation without actual filesystem operations
        dependencies: ["03-05b"]
        estimated_hours: 4

      - id: "04-06"
        name: "Create nw doctor CLI command"
        user_stories: ["US-033"]
        scenario: "journey_3_pypi.feature::Doctor runs after successful install"
        criteria: |
          - nw doctor command runs health verification
          - Displays doctor table with all seven checks
          - Shows HEALTHY/DEGRADED/UNHEALTHY status
          - --json flag for machine-readable output
          - Counts match installation validation
          - Used by both Journey 2 and Journey 3
        dependencies: ["01-05"]
        estimated_hours: 3

      - id: "04-07"
        name: "Create nw version command"
        user_stories: ["US-036"]
        scenario: "journey_3_pypi.feature::Verify installation in Claude Code"
        criteria: |
          - nw --version shows "nWave Framework v{version}"
          - Shows install path: "Installed: {path}"
          - Shows counts: "Agents: N | Commands: N | Templates: N"
          - Shows "All systems operational" if healthy
          - Counts match doctor output
        dependencies: ["01-06"]
        estimated_hours: 2

      - id: "04-08"
        name: "Create install-nwave CI mode support"
        user_stories: ["US-038"]
        scenario: "journey_3_pypi.feature::Installation works in non-interactive CI mode"
        criteria: |
          - Detects CI environment variables
          - Suppresses ASCII logo in CI
          - Suppresses interactive prompts
          - Returns exit code 0 on success, non-zero on failure
          - --format json for machine-readable output
          - JSON includes: success, version, counts
        dependencies: ["04-04", "04-05"]
        estimated_hours: 2

# ==============================================================================
# PHASE 05: CROSS-CUTTING CONCERNS
# ==============================================================================

  - id: "05"
    name: "Cross-Cutting Concerns"
    description: "Rollback, upgrade detection, and integration checkpoints"
    default_agent: "software-crafter"
    default_deps_strategy: "sequential"
    notes: |
      Stories US-040 and US-041. These apply across all journeys.
    steps:
      - id: "05-01"
        name: "Create RollbackService for automatic and manual rollback"
        user_stories: ["US-040"]
        scenario: "journey_3_pypi.feature::Automatic rollback on installation failure"
        criteria: |
          - RollbackService.auto_rollback() triggers on install failure
          - Restores from most recent backup
          - Cleans partial install files before restore
          - RollbackService.manual_rollback() for nw rollback command
          - Lists available backups with timestamps
          - User selects backup to restore
          - Runs nw doctor after restore to verify
          - Clear message: "Installation failed. Previous version restored."
        dependencies: ["03-04"]
        estimated_hours: 4

      - id: "05-02"
        name: "Create nw rollback CLI command"
        user_stories: ["US-040"]
        scenario: "journey_3_pypi.feature::Manual rollback command"
        criteria: |
          - nw rollback lists available backups
          - Shows backup date, time, and version
          - User selects backup by number
          - Restores selected backup
          - Runs nw doctor to confirm
          - Shows "Rolled back to backup from {timestamp}"
          - Error if no backups available
        dependencies: ["05-01"]
        estimated_hours: 2

      - id: "05-03"
        name: "Create integration checkpoint display"
        user_stories: ["US-003"]
        scenario: "horizontal_coherence.feature::Integration checkpoint displays at build-to-install transition"
        criteria: |
          - Checkpoint box displays at journey transitions
          - Header: "INTEGRATION CHECKPOINT"
          - Shows "version matches build" with checkmark
          - Shows "wheel path verified" with checkmark
          - Shows "artifact counts consistent" with checkmark
          - Blocks on mismatch with error details
        dependencies: ["01-06"]
        estimated_hours: 2

      - id: "05-04"
        name: "Integrate upgrade detection into install flows"
        user_stories: ["US-041"]
        scenario: "journey_3_pypi.feature::Reinstall same version prompts confirmation"
        criteria: |
          - InstallService uses upgrade detection before install
          - FRESH_INSTALL: skip backup, show "(fresh install)"
          - UPGRADE: create backup, show "Upgrading from X to Y"
          - REINSTALL: prompt confirmation, backup on Y
          - DOWNGRADE: warn, require confirmation, backup on Y
          - CI mode: auto-proceed for upgrade, skip prompts
        dependencies: ["04-02", "03-05b"]
        estimated_hours: 3

# ==============================================================================
# PHASE 06: HORIZONTAL COHERENCE AND E2E VALIDATION
# ==============================================================================

  - id: "06"
    name: "Horizontal Coherence and E2E Validation"
    description: "Cross-journey consistency validation and TestPyPI integration"
    default_agent: "software-crafter"
    default_deps_strategy: "sequential"
    notes: |
      Validates that all journeys produce consistent artifacts and displays.
      Includes TestPyPI PR-level validation.
    steps:
      - id: "06-01"
        name: "Validate pre-flight format consistency across journeys"
        user_stories: ["US-001"]
        scenario: "horizontal_coherence.feature::Pre-flight table format identical across all three journeys"
        criteria: |
          - Pre-flight table structure identical across all journeys
          - Column headers: "Check" and "Status"
          - Icons identical: [check] for pass, [x] for fail, [!] for warning
          - Python version check displays identically
          - Error formats identical across journeys
        dependencies: ["02-08", "03-07", "04-08"]
        estimated_hours: 2

      - id: "06-02"
        name: "Validate doctor format consistency between Journey 2 and 3"
        user_stories: ["US-002"]
        scenario: "horizontal_coherence.feature::Doctor output format identical between Journey 2 and Journey 3"
        criteria: |
          - Doctor table format identical
          - Check order identical (7 checks in same sequence)
          - Status terminology identical (HEALTHY, DEGRADED, UNHEALTHY)
          - Component display format identical
          - Version display format identical
          - Install path display format identical
        dependencies: ["03-07", "04-06"]
        estimated_hours: 2

      - id: "06-03"
        name: "Validate artifact flow from build to install to doctor"
        user_stories: ["US-003"]
        scenario: "horizontal_coherence.feature::Version string format consistent through build-install flow"
        criteria: |
          - Version identical in: build summary, install pre-flight, release readiness, doctor, report
          - Wheel path identical in: pre-flight, readiness, install command, report
          - Counts identical in: wheel validation, doctor, release report
          - No artifact value drift between steps
        dependencies: ["05-03"]
        estimated_hours: 2

      - id: "06-04"
        name: "Create TestPyPI E2E validation test"
        user_stories: []
        scenario: "testpypi_coherence.feature::TestPyPI install produces identical result to local install"
        type: "infrastructure"
        criteria: |
          - E2E test validates pipx install from TestPyPI
          - Fresh environment with pipx installed
          - Installs version from TestPyPI index
          - Runs nw doctor, validates HEALTHY
          - Validates version matches, counts match
          - Runs as part of PR CI pipeline
        dependencies: ["04-08"]
        estimated_hours: 4

      - id: "06-05"
        name: "Create TestPyPI CI quality gate"
        user_stories: []
        scenario: "testpypi_coherence.feature::PR cannot merge without TestPyPI validation passing"
        type: "infrastructure"
        criteria: |
          - CI gate requires: wheel_build, twine_check, testpypi_upload, testpypi_install, doctor_healthy
          - PR blocked if any check fails
          - Clear failure diagnostics with failed step and suggested fix
          - Unique dev version per PR prevents collision
          - Retries with backoff for transient failures
        dependencies: ["06-04"]
        estimated_hours: 3

# ==============================================================================
# SUMMARY
# ==============================================================================

summary:
  total_phases: 7
  total_steps: 41
  estimated_total_hours: 116

  phase_breakdown:
    - phase: "00"
      name: "Sprint 0 Prerequisites"
      steps: 5
      hours: 9
      type: "infrastructure"
    - phase: "01"
      name: "Infrastructure"
      steps: 8
      hours: 23
      type: "feature"
    - phase: "02"
      name: "Journey 1 - Build"
      steps: 9
      hours: 28
      type: "feature"
    - phase: "03"
      name: "Journey 2 - Install"
      steps: 10
      hours: 28
      type: "feature"
      notes: "Step 03-05 split into 03-05a (3h) and 03-05b (2h) for safer TDD cycles"
    - phase: "04"
      name: "Journey 3 - PyPI"
      steps: 8
      hours: 22
      type: "feature"
    - phase: "05"
      name: "Cross-Cutting"
      steps: 4
      hours: 11
      type: "feature"
    - phase: "06"
      name: "Horizontal Coherence"
      steps: 5
      hours: 13
      type: "validation"

  p0_coverage:
    total_p0_stories: 23
    steps_covering_p0: 33
    coverage: "100%"

  acceptance_test_mapping:
    journey_1_build_feature: 30
    journey_2_install_feature: 47
    journey_3_pypi_feature: 44
    horizontal_coherence_feature: 26
    testpypi_coherence_feature: 32
    total_scenarios: 179

  quality_gates:
    step_to_file_ratio: 2.1  # 39 steps / ~18 production files
    identical_pattern_batching: "Applied (e.g., core checks batched)"
    behavioral_criteria_only: true
    no_private_method_references: true
    dag_valid: true

  risks_and_decisions:
    - decision: "Phase 00 as blocking prerequisite"
      rationale: "pyproject.toml and PyPI secrets are fundamental blockers"
    - decision: "Separate infrastructure steps from feature steps"
      rationale: "Clear distinction between platform setup and feature development"
    - decision: "Doctor command shared between Journey 2 and 3"
      rationale: "Horizontal coherence requirement - identical format and checks"
    - decision: "Auto-repair as separate steps"
      rationale: "Fixable checks are enhancements to base pre-flight framework"
