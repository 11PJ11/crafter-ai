# ═══════════════════════════════════════════════════════════════════════════════
# WIP.yaml - Work In Progress Contract
# Generated by: Vera (Orchestrator)
# Protocol Version: 0.1
# ═══════════════════════════════════════════════════════════════════════════════

meta:
  generated_at: "2026-02-03T21:00:00Z"
  project: "modern-cli-installer"
  phase: "07"
  phase_name: "TUI Redesign - Forge Build + Install Emoji Stream"
  previous_steps:
    - "07-01 (commit 9f815a9, tests 18,19 GREEN)"
    - "07-02 (commit 4039199, tests 1,2,20 GREEN)"
    - "07-03 (commit 1fe08e3, tests 3,4 GREEN)"
    - "07-04 (commit 99591ca, tests 5,6,7,8 GREEN)"
    - "07-05 (commit 9e84d05, test 9 GREEN)"
    - "07-06 (commit c451d26, tests 10,11 GREEN)"
    - "07-07 (commit 1eb0673, tests 12-16 GREEN)"
    - "07-08 (commit 8cd6a79, test 17 GREEN, 20/20 total)"

# ─────────────────────────────────────────────────────────────────────────────
# STEP CONTRACT
# ─────────────────────────────────────────────────────────────────────────────
step:
  id: "07-09"
  name: "L1-L4 Refactoring: extract shared TUI components, eliminate duplication"
  agent: "software-crafter"
  dependencies_satisfied: true
  type: "refactor"

# ─────────────────────────────────────────────────────────────────────────────
# CONTEXT
# ─────────────────────────────────────────────────────────────────────────────
context:
  design_system: |
    After 8 incremental TUI steps, forge_build.py and forge_install.py share
    duplicated functions. This refactoring eliminates duplication by extracting
    shared TUI display components into a new forge_tui.py module.

    Refactoring levels applied:
    - L1 (Readability): Register e2e marker, update stale docstrings
    - L2 (Duplication): Extract identical functions to shared module
    - L3 (Responsibility): forge_tui.py owns shared display logic
    - L4 (Architecture): Clean import graph, no circular dependencies

  duplication_analysis: |
    Identical functions across forge_build.py and forge_install.py:
    1. is_ci_mode() - forge_build.py:60-66, forge_install.py:45-51
    2. display_pre_flight_results() - forge_build.py:69-90, forge_install.py:240-261
    3. create_build_service() - forge_build.py:37-57, forge_install.py:54-74

    The ReleaseReportService import in forge_install.py is UNUSED in code but
    24+ test mocks patch "crafter_ai.installer.cli.forge_install.ReleaseReportService".
    This import MUST stay with an explanatory comment.

# ─────────────────────────────────────────────────────────────────────────────
# TASK SPECIFICATION
# ─────────────────────────────────────────────────────────────────────────────
task:
  source_files:
    - "src/crafter_ai/installer/cli/forge_build.py"
    - "src/crafter_ai/installer/cli/forge_install.py"
  new_file: "src/crafter_ai/installer/cli/forge_tui.py"
  test_files:
    - "tests/acceptance/forge_tui/test_walking_skeleton.py"
  anti_regression_files:
    - "tests/installer/cli/test_forge_build.py"
    - "tests/installer/cli/test_forge_install.py"

  changes_required:
    - description: "L3 - Create forge_tui.py with shared TUI components"
      file: "src/crafter_ai/installer/cli/forge_tui.py"
      detail: |
        Create a new module with shared display functions extracted from both CLI files.
        Contents:
        1. Module docstring explaining this is shared TUI display components
        2. Imports: os, rich.console.Console, check_result.CheckResult, check_result.CheckSeverity
        3. console = Console()
        4. is_ci_mode() function (exact copy from forge_build.py:60-66)
        5. display_pre_flight_results(results) function (exact copy from forge_build.py:69-90)

        DO NOT move create_build_service() here - it's a factory, not a TUI component.
        It stays in forge_build.py and forge_install.py imports it from there.

    - description: "L2 - Update forge_build.py to import from forge_tui"
      file: "src/crafter_ai/installer/cli/forge_build.py"
      detail: |
        1. Remove the is_ci_mode() function definition (lines 60-66)
        2. Remove the display_pre_flight_results() function definition (lines 69-90)
        3. Add import: from crafter_ai.installer.cli.forge_tui import display_pre_flight_results, is_ci_mode
        4. Remove the import of CheckResult, CheckSeverity since they're no longer used directly
           (display_pre_flight_results is now imported, not defined here)
           WAIT - check if CheckResult is used elsewhere in the file first.
           BuildResult.pre_flight_results is list[CheckResult], but it's passed to
           display_pre_flight_results() which handles it. The type annotation in the
           function signature is gone since the function moved. So CheckResult and
           CheckSeverity can be removed from imports IF they're not used elsewhere.
           Actually, display_failure_summary uses result.error_message, not CheckResult.
           So YES, remove CheckResult and CheckSeverity imports.

    - description: "L2 - Update forge_install.py to import shared functions"
      file: "src/crafter_ai/installer/cli/forge_install.py"
      detail: |
        1. Remove the is_ci_mode() function definition (lines 45-51)
        2. Remove the create_build_service() function definition (lines 54-74)
        3. Remove the display_pre_flight_results() function definition (lines 240-261)
        4. Add imports:
           - from crafter_ai.installer.cli.forge_tui import display_pre_flight_results, is_ci_mode
           - from crafter_ai.installer.cli.forge_build import create_build_service
        5. Remove now-unused imports that were only needed by the removed functions:
           - SubprocessBuildAdapter (was only used by create_build_service)
           - SubprocessGitAdapter (was only used by create_build_service)
           - create_build_check_registry (was only used by create_build_service)
           - ArtifactRegistry (was only used by create_build_service)
           - BuildService (was only used by create_build_service)
           - VersionBumpService (was only used by create_build_service)
           - WheelValidationService (was only used by create_build_service)
           IMPORTANT: Check each import is truly unused before removing.
           Keep CheckResult and CheckSeverity (used by get_blocking_failures).
        6. Keep the ReleaseReportService import with a comment:
           # Kept for test mock compatibility (24+ tests patch this path)
        7. Keep CheckExecutor import (used by run_pre_flight_checks)

    - description: "L1 - Update forge_install.py module docstring"
      file: "src/crafter_ai/installer/cli/forge_install.py"
      detail: |
        Update the module docstring to remove "displays release report" since
        that functionality was replaced with emoji stream in step 07-07.
        Change to: "Displays pre-flight checks, prompts for confirmation,
        runs install service, and displays installation progress."

    - description: "L1 - Register pytest.mark.e2e custom mark"
      file: "pytest.ini"
      detail: |
        Add markers configuration to suppress PytestUnknownMarkWarning:
        [pytest]
        pythonpath = src .
        testpaths = tests
        markers =
            e2e: End-to-end acceptance tests

    - description: "L1 - Fix pre-existing test: test_exit_code_1_when_wheel_not_found"
      file: "tests/installer/cli/test_forge_install.py"
      detail: |
        The test patches find_latest_wheel but the install flow calls
        list_wheels_in_dist() first (line 382). The test needs to also
        patch list_wheels_in_dist to return an empty list.
        Add this patch inside the existing with block:
          with patch("crafter_ai.installer.cli.forge_install.find_latest_wheel") as mock_find, \
               patch("crafter_ai.installer.cli.forge_install.list_wheels_in_dist") as mock_list:
              mock_find.return_value = None
              mock_list.return_value = []

  breaking_existing_tests: []

# ─────────────────────────────────────────────────────────────────────────────
# CONSTRAINTS
# ─────────────────────────────────────────────────────────────────────────────
constraints:
  max_tool_calls: 25
  must_run_tests: true
  fail_fast: true

  mandatory_sequence:
    - "1. Read forge_build.py to identify shared functions and their exact code"
    - "2. Read forge_install.py to confirm identical duplicates"
    - "3. Create forge_tui.py with is_ci_mode() and display_pre_flight_results()"
    - "4. Update forge_build.py: remove duplicates, add imports from forge_tui"
    - "5. Update forge_install.py: remove duplicates, add imports from forge_tui + forge_build"
    - "6. Update forge_install.py module docstring"
    - "7. Add e2e marker to pytest.ini"
    - "8. Fix test_exit_code_1_when_wheel_not_found to also mock list_wheels_in_dist"
    - "9. Run: pytest tests/acceptance/forge_tui/test_walking_skeleton.py -v (ALL 20 must pass)"
    - "10. Run: pytest tests/installer/cli/test_forge_build.py -v (anti-regression)"
    - "11. Run: pytest tests/installer/cli/test_forge_install.py -v (ALL 35 must pass now)"
    - "12. Commit --no-verify with message: refactor(tui): extract shared TUI components, eliminate duplication"

  forbidden_actions:
    - "DO NOT skip running E2E test first"
    - "DO NOT modify scripts/testpypi_validation.py"
    - "DO NOT read roadmap.yaml or execution-log.yaml"

# ─────────────────────────────────────────────────────────────────────────────
# OUTPUT: What the agent must deliver (AGENT FILLS THIS SECTION)
# ─────────────────────────────────────────────────────────────────────────────
output:
  status: "completed"
  artifacts_created:
    - "src/crafter_ai/installer/cli/forge_tui.py"
  artifacts_modified:
    - "src/crafter_ai/installer/cli/forge_build.py"
    - "src/crafter_ai/installer/cli/forge_install.py"
    - "pytest.ini"
    - "tests/installer/cli/test_forge_install.py"
  walking_skeleton_tests_green: "20/20 passed"
  anti_regression_result: "51/51 passed (16 build + 35 install)"
  commit_hash: "6826ab9"
  commit_message: "refactor(tui): extract shared TUI components, eliminate duplication"
  notes: |
    The test_exit_code_1_when_wheel_not_found fix required an additional mock
    beyond what the WIP contract specified. The contract specified mocking
    list_wheels_in_dist and find_latest_wheel, but the install flow also calls
    run_auto_chain_build when no wheels exist and --no-prompt is set. Added a
    third mock for run_auto_chain_build returning None to simulate the
    "build produced no wheel" path, which correctly reaches exit code 1.

# ─────────────────────────────────────────────────────────────────────────────
# SUCCESS CRITERIA
# ─────────────────────────────────────────────────────────────────────────────
success_criteria:
  - criterion: "ALL 20 walking skeleton tests pass GREEN"
    validation: "pytest tests/acceptance/forge_tui/test_walking_skeleton.py -v shows 20 passed"

  - criterion: "Build anti-regression suite stays GREEN"
    validation: "pytest tests/installer/cli/test_forge_build.py passes (16 tests)"

  - criterion: "Install anti-regression suite ALL GREEN"
    validation: "pytest tests/installer/cli/test_forge_install.py passes (ALL 35 tests, including fixed wheel-not-found test)"

  - criterion: "No PytestUnknownMarkWarning for e2e marker"
    validation: "Walking skeleton test output shows no marker warnings"

  - criterion: "forge_tui.py exists with shared functions"
    validation: "Module contains is_ci_mode() and display_pre_flight_results()"

  - criterion: "No duplicated functions"
    validation: "is_ci_mode() and display_pre_flight_results() exist ONLY in forge_tui.py, not in forge_build.py or forge_install.py"

  - criterion: "create_build_service() exists ONLY in forge_build.py"
    validation: "forge_install.py imports it from forge_build, does not define its own"

  - criterion: "No circular imports"
    validation: "forge_tui.py does NOT import from forge_build or forge_install"

  - criterion: "Changes committed"
    validation: "commit_hash is populated"
