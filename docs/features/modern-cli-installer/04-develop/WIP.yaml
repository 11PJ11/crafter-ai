# ═══════════════════════════════════════════════════════════════════════════════
# WIP.yaml - Work In Progress Contract
# Generated by: Vera (Orchestrator)
# Protocol Version: 0.1
# ═══════════════════════════════════════════════════════════════════════════════

meta:
  generated_at: "2026-02-03T10:00:00Z"
  project: "modern-cli-installer"
  phase: "BUGFIX"
  phase_name: "Runtime Wiring Bug Fix"

# ─────────────────────────────────────────────────────────────────────────────
# STEP CONTRACT
# ─────────────────────────────────────────────────────────────────────────────
step:
  id: "BUGFIX-001"
  name: "Fix CheckExecutor wiring in forge_build.py"
  agent: "software-crafter"
  estimated_hours: 0.5
  dependencies_satisfied: true
  user_stories: []
  type: "bugfix"

# ─────────────────────────────────────────────────────────────────────────────
# BUG DESCRIPTION
# ─────────────────────────────────────────────────────────────────────────────
bug:
  symptom: "TypeError: CheckExecutor.__init__() missing 1 required positional argument: 'registry'"
  location: "src/crafter_ai/installer/cli/forge_build.py:42"
  root_cause: "create_build_service() calls CheckExecutor() without passing the required registry argument"

  error_trace: |
    File forge_build.py:165 in build
      service = create_build_service()
    File forge_build.py:42 in create_build_service
      check_executor = CheckExecutor()
    TypeError: CheckExecutor.__init__() missing 1 required positional argument: 'registry'

# ─────────────────────────────────────────────────────────────────────────────
# FIX SPECIFICATION
# ─────────────────────────────────────────────────────────────────────────────
fix:
  file: "src/crafter_ai/installer/cli/forge_build.py"

  changes:
    - location: "imports section"
      add: "from crafter_ai.installer.checks.build_checks import create_build_check_registry"

    - location: "create_build_service() function, line 42"
      before: "check_executor = CheckExecutor()"
      after: |
        registry = create_build_check_registry()
        check_executor = CheckExecutor(registry)

  validation:
    command: "crafter-ai forge build --help"
    expected: "Shows help without TypeError"

# ─────────────────────────────────────────────────────────────────────────────
# CONSTRAINTS
# ─────────────────────────────────────────────────────────────────────────────
constraints:
  max_tool_calls: 15
  must_run_tests: true
  fail_fast: true

  mandatory_sequence:
    - "1. Read forge_build.py to confirm bug location"
    - "2. Add import for create_build_check_registry"
    - "3. Fix create_build_service() to create registry and pass to CheckExecutor"
    - "4. Run: crafter-ai forge build --help (verify no TypeError)"
    - "5. Run: pytest tests/installer/cli/test_forge_build.py -v"
    - "6. Commit with message: fix(cli): wire CheckRegistry to CheckExecutor in forge build"

  forbidden_actions:
    - "DO NOT skip running E2E test first"
    - "DO NOT modify scripts/testpypi_validation.py"
    - "DO NOT read roadmap.yaml or execution-log.yaml"

# ─────────────────────────────────────────────────────────────────────────────
# OUTPUT: What the agent must deliver (AGENT FILLS THIS SECTION)
# ─────────────────────────────────────────────────────────────────────────────
output:
  status: completed

  fix_applied:
    file: "src/crafter_ai/installer/cli/forge_build.py"
    lines_changed: 3

  validation_result:
    command: "crafter-ai forge build --help"
    result: "SUCCESS - Help displayed without TypeError"

  test_result:
    command: "pytest tests/installer/cli/test_forge_build.py -v --tb=short"
    tests_passed: 16
    tests_failed: 0

  commit_hash: "7001e2c"
  commit_message: "fix(cli): wire CheckRegistry to CheckExecutor in forge build"
  notes: "Added import for create_build_check_registry, created registry instance, passed to CheckExecutor"

# ─────────────────────────────────────────────────────────────────────────────
# SUCCESS CRITERIA
# ─────────────────────────────────────────────────────────────────────────────
success_criteria:
  - criterion: "crafter-ai forge build --help runs without TypeError"
    validation: "Command exits cleanly"

  - criterion: "Unit tests pass"
    validation: "pytest tests/installer/cli/test_forge_build.py passes"

  - criterion: "Changes committed"
    validation: "commit_hash is populated"
