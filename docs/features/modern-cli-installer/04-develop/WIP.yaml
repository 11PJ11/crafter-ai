# ═══════════════════════════════════════════════════════════════════════════════
# WIP.yaml - Work In Progress Contract
# Generated by: Vera (Orchestrator)
# Protocol Version: 0.1
# ═══════════════════════════════════════════════════════════════════════════════

meta:
  generated_at: "2026-02-02T16:30:00Z"
  project: "modern-cli-installer"
  phase: "02"
  phase_name: "Journey 1 - Build Local Candidate"

# ─────────────────────────────────────────────────────────────────────────────
# STEP CONTRACT
# ─────────────────────────────────────────────────────────────────────────────
step:
  id: "02-09"
  name: "Create auto-repair for missing build package"
  agent: "software-crafter"
  estimated_hours: 2
  dependencies_satisfied: true

# ─────────────────────────────────────────────────────────────────────────────
# INPUT: What the agent receives (READ-ONLY context)
# ─────────────────────────────────────────────────────────────────────────────
input:
  source_file: "src/crafter_ai/installer/services/auto_repair_service.py"
  test_file: "tests/installer/services/test_auto_repair_service.py"

  existing_code:
    check_result: "src/crafter_ai/installer/domain/check_result.py"
    build_checks: "src/crafter_ai/installer/checks/build_checks.py"
    forge_build: "src/crafter_ai/installer/cli/forge_build.py"

  requirements:
    auto_repair_service:
      - "AutoRepairService class for handling fixable check failures"
      - "Method: can_repair(check_result: CheckResult) -> bool"
      - "Method: repair(check_result: CheckResult, console: Console) -> RepairResult"
      - "RepairResult frozen dataclass with: success, message, command_output"
      - "repair() prompts 'Install it now? [Y/n]' using Rich prompt"
      - "On Y: runs fix_command via subprocess, shows spinner during install"
      - "On n: returns RepairResult(success=False, message='User declined')"
      - "Shows success message with installed version on completion"
      - "CI mode (CI=true env) auto-accepts repairs without prompting"

    integration_with_cli:
      - "forge_build.py should use AutoRepairService for fixable failures"
      - "After successful repair, re-run the failed check to verify"
      - "Continue with remaining pre-flight checks after repair"

  test_requirements:
    - "Test can_repair returns True for fixable checks"
    - "Test can_repair returns False for non-fixable checks"
    - "Test repair prompts user and runs fix_command on Y"
    - "Test repair returns declined result on n"
    - "Test repair shows spinner during command execution"
    - "Test repair returns success with command output on success"
    - "Test repair returns failure with error on command failure"
    - "Test CI mode auto-accepts without prompting"
    - "Mock subprocess calls - no actual pip install"
    - "Mock Rich Console for prompt testing"

  architecture_notes:
    - "Application service for interactive repair flow"
    - "Uses Rich Console for prompts and spinners"
    - "Subprocess execution for fix_command"
    - "Integrates with CLI layer, not domain layer"

# ─────────────────────────────────────────────────────────────────────────────
# CONSTRAINTS: Rules the agent MUST follow
# ─────────────────────────────────────────────────────────────────────────────
constraints:
  max_tool_calls: 15
  must_run_tests: true
  fail_fast: true

  allowed_actions:
    - "Read existing check_result and build_checks for patterns"
    - "Create source file at input.source_file"
    - "Create test file at input.test_file"
    - "Update services/__init__.py"
    - "Run pytest on test file"
    - "Commit changes"

  forbidden_actions:
    - "DO NOT read roadmap.yaml"
    - "DO NOT read execution-status.yaml"
    - "DO NOT modify WIP.yaml (orchestrator does this)"
    - "DO NOT implement other steps"
    - "DO NOT add external dependencies"
    - "DO NOT create files outside allowed paths"
    - "DO NOT modify forge_build.py (integration comes in future step)"

# ─────────────────────────────────────────────────────────────────────────────
# OUTPUT: What the agent must deliver (AGENT FILLS THIS SECTION)
# ─────────────────────────────────────────────────────────────────────────────
output:
  status: success
  artifacts_created:
    - src/crafter_ai/installer/services/auto_repair_service.py
    - src/crafter_ai/installer/services/__init__.py
    - tests/installer/services/test_auto_repair_service.py
  test_command: "python -m pytest tests/installer/services/test_auto_repair_service.py -v"
  test_result: "PASS: 16 tests"
  commit_hash: "1d10dc1976e9ffadb5a4aa24a8ab1644b962343c"
  commit_message: "feat(modern-cli-installer): add AutoRepairService for fixable check failures - step 02-09"
  notes: |
    Implementation complete. Created:
    - AutoRepairService class with can_repair() and repair() methods
    - RepairResult frozen dataclass with success, message, command_output
    - Interactive prompt 'Install it now? [Y/n]' using Rich Console
    - CI mode detection (CI=true env) for auto-accepting without prompt
    - Spinner feedback during command execution
    - Graceful subprocess error handling
    All tests pass, pre-commit hooks pass.
