# ═══════════════════════════════════════════════════════════════════════════════
# WIP.yaml - Work In Progress Contract
# Generated by: Vera (Orchestrator)
# Protocol Version: 0.1
# ═══════════════════════════════════════════════════════════════════════════════

meta:
  generated_at: "2026-02-03T06:00:00Z"
  project: "modern-cli-installer"
  phase: "05"
  phase_name: "Cross-Cutting Concerns"

# ─────────────────────────────────────────────────────────────────────────────
# STEP CONTRACT
# ─────────────────────────────────────────────────────────────────────────────
step:
  id: "05-04"
  name: "Integrate upgrade detection into install flows"
  agent: "software-crafter"
  estimated_hours: 3
  dependencies_satisfied: true
  user_stories: ["US-041"]

# ─────────────────────────────────────────────────────────────────────────────
# CRITICAL: OUTSIDE-IN TDD ENFORCEMENT
# ─────────────────────────────────────────────────────────────────────────────
tdd_approach:
  method: "OUTSIDE-IN"

  driving_test:
    file: "docs/features/modern-cli-installer/03-distill/e2e-scenarios/test_journey_3_pypi.py"
    function: "test_reinstall_same_version_prompts_confirmation"
    feature_file: "docs/features/modern-cli-installer/03-distill/features/journey_3_pypi.feature"
    scenario: "Reinstall same version prompts confirmation"

  execution_order:
    step_1:
      action: "Run the E2E test FIRST"
      command: "pytest docs/features/modern-cli-installer/03-distill/e2e-scenarios/test_journey_3_pypi.py -k 'upgrade or reinstall' -v --tb=short 2>&1 | head -100"
      expected: "FAIL (missing integration or NotImplementedError)"
      purpose: "See the failing test that will drive implementation"

    step_2:
      action: "Write unit tests for InstallService upgrade integration"
      file: "tests/installer/services/test_install_service_upgrade.py"
      purpose: "Define expected upgrade path behavior through tests"

    step_3:
      action: "Extend InstallService with upgrade detection"
      file: "src/crafter_ai/installer/services/install_service.py"
      purpose: "Make unit tests pass"

    step_4:
      action: "Run E2E test again"
      command: "pytest docs/features/modern-cli-installer/03-distill/e2e-scenarios/test_journey_3_pypi.py -k 'upgrade or reinstall' -v --tb=short 2>&1 | head -100"
      expected: "Test progresses further (may still fail on CLI prompts)"
      purpose: "Verify service integration"

# ─────────────────────────────────────────────────────────────────────────────
# INPUT: What the agent receives (READ-ONLY context)
# ─────────────────────────────────────────────────────────────────────────────
input:
  source_file: "src/crafter_ai/installer/services/install_service.py"
  test_file: "tests/installer/services/test_install_service_upgrade.py"

  existing_code:
    upgrade_detection: "src/crafter_ai/installer/services/upgrade_detection_service.py"
    install_service: "src/crafter_ai/installer/services/install_service.py"
    backup_port: "src/crafter_ai/installer/ports/backup_port.py"

  e2e_scenarios:
    - "journey_3_pypi.feature::Upgrade from older version"
    - "journey_3_pypi.feature::Fresh install on clean system"
    - "journey_3_pypi.feature::Reinstall same version prompts confirmation"
    - "journey_3_pypi.feature::Downgrade warning"
    - "journey_3_pypi.feature::CI mode auto-upgrades without prompts"

  requirements:
    upgrade_path_enum:
      - "Add UpgradePath enum to InstallService: FRESH_INSTALL, UPGRADE, REINSTALL, DOWNGRADE"

    install_service_integration:
      - "Add detect_upgrade_path(target_version: str) -> UpgradePath method"
      - "Add should_create_backup(upgrade_path: UpgradePath) -> bool method"
      - "Add get_upgrade_message(upgrade_path: UpgradePath, from_ver: str, to_ver: str) -> str"
      - "Modify install() to use upgrade path detection"

    upgrade_path_behaviors:
      - "FRESH_INSTALL: should_create_backup returns False, message shows '(fresh install)'"
      - "UPGRADE: should_create_backup returns True, message shows 'Upgrading from X to Y'"
      - "REINSTALL: should_create_backup returns True (after confirmation), message asks for confirmation"
      - "DOWNGRADE: should_create_backup returns True (after confirmation), message warns about downgrade"

    ci_mode_support:
      - "Add ci_mode parameter to install()"
      - "CI mode: auto-proceed for UPGRADE, skip prompts"
      - "CI mode: auto-proceed for REINSTALL without prompt"
      - "CI mode: still warn for DOWNGRADE but proceed"

  test_requirements:
    - "Test detect_upgrade_path returns FRESH_INSTALL when no existing version"
    - "Test detect_upgrade_path returns UPGRADE when target > installed"
    - "Test detect_upgrade_path returns REINSTALL when target == installed"
    - "Test detect_upgrade_path returns DOWNGRADE when target < installed"
    - "Test should_create_backup returns False for FRESH_INSTALL"
    - "Test should_create_backup returns True for UPGRADE"
    - "Test should_create_backup returns True for REINSTALL (after confirm)"
    - "Test get_upgrade_message formats correctly for each path"
    - "Test CI mode auto-proceeds for UPGRADE"
    - "Mock UpgradeDetectionService for isolated testing"

# ─────────────────────────────────────────────────────────────────────────────
# CONSTRAINTS: Rules the agent MUST follow
# ─────────────────────────────────────────────────────────────────────────────
constraints:
  max_tool_calls: 35
  must_run_tests: true
  fail_fast: true

  mandatory_sequence:
    - "1. Run E2E upgrade tests FIRST (see them fail)"
    - "2. Write unit tests for upgrade integration"
    - "3. Extend InstallService to make unit tests pass"
    - "4. Run E2E test again (verify progress)"
    - "5. Run all unit tests"
    - "6. Commit changes"

  allowed_actions:
    - "Read existing UpgradeDetectionService"
    - "Read existing InstallService"
    - "Read E2E test files"
    - "Extend InstallService with upgrade path detection"
    - "Create test_install_service_upgrade.py unit tests"
    - "Run pytest on unit tests"
    - "Run pytest on E2E tests"
    - "Commit changes"

  forbidden_actions:
    - "DO NOT skip running E2E test first"
    - "DO NOT modify UpgradeDetectionService"
    - "DO NOT read roadmap.yaml or execution-status.yaml"
    - "DO NOT implement CLI prompts (service layer only)"

# ─────────────────────────────────────────────────────────────────────────────
# OUTPUT: What the agent must deliver (AGENT FILLS THIS SECTION)
# ─────────────────────────────────────────────────────────────────────────────
output:
  status: complete

  e2e_test_before:
    command: "pytest docs/features/modern-cli-installer/03-distill/e2e-scenarios/test_journey_3_pypi.py -k 'upgrade or reinstall' -v --tb=short"
    result: "8 failed"
    failure_reason: "NotImplementedError in CLI layer (FrameworkInstaller.install, step definitions) - expected, outside scope of service layer step"

  artifacts_created:
    - "tests/installer/services/test_install_service_upgrade.py"
    - "src/crafter_ai/installer/services/install_service.py (modified)"

  unit_test_result:
    command: "pytest tests/installer/services/test_install_service_upgrade.py -v"
    tests_passed: 23
    tests_failed: 0

  e2e_test_after:
    command: "pytest docs/features/modern-cli-installer/03-distill/e2e-scenarios/test_journey_3_pypi.py -k 'upgrade or reinstall' -v --tb=short"
    result: "8 failed"
    failure_reason: "NotImplementedError in CLI layer - service layer integration complete, CLI layer implementation required in subsequent step"

  commit_hash: "pending"
  commit_message: "feat(installer): integrate upgrade detection into InstallService - step 05-04"
  notes: "Service layer integration complete. UpgradePath enum, detect_upgrade_path(), should_create_backup(), get_upgrade_message(), and ci_mode parameter all implemented and tested. E2E failures are in CLI layer which is outside scope of this step."

# ─────────────────────────────────────────────────────────────────────────────
# SUCCESS CRITERIA
# ─────────────────────────────────────────────────────────────────────────────
success_criteria:
  - criterion: "E2E test ran BEFORE implementation"
    validation: "output.e2e_test_before.result is not empty"

  - criterion: "UpgradePath enum added to InstallService"
    validation: "InstallService module contains UpgradePath enum"

  - criterion: "detect_upgrade_path method implemented"
    validation: "InstallService has detect_upgrade_path method"

  - criterion: "should_create_backup method implemented"
    validation: "InstallService has should_create_backup method"

  - criterion: "Unit tests pass"
    validation: "output.unit_test_result.tests_failed == 0"

  - criterion: "CI mode support added"
    validation: "install() method accepts ci_mode parameter"
