# ═══════════════════════════════════════════════════════════════════════════════
# WIP.yaml - Work In Progress Contract
# Generated by: Vera (Orchestrator)
# Protocol Version: 0.1
# ═══════════════════════════════════════════════════════════════════════════════

meta:
  generated_at: "2026-02-03T04:00:00Z"
  project: "modern-cli-installer"
  phase: "05"
  phase_name: "Cross-Cutting Concerns"

# ─────────────────────────────────────────────────────────────────────────────
# STEP CONTRACT
# ─────────────────────────────────────────────────────────────────────────────
step:
  id: "05-01"
  name: "Create RollbackService for automatic and manual rollback"
  agent: "software-crafter"
  estimated_hours: 4
  dependencies_satisfied: true
  user_stories: ["US-040"]

# ─────────────────────────────────────────────────────────────────────────────
# CRITICAL: OUTSIDE-IN TDD ENFORCEMENT
# ─────────────────────────────────────────────────────────────────────────────
tdd_approach:
  method: "OUTSIDE-IN"

  driving_test:
    file: "docs/features/modern-cli-installer/03-distill/e2e-scenarios/test_journey_3_pypi.py"
    function: "test_automatic_rollback_on_installation_failure"
    feature_file: "docs/features/modern-cli-installer/03-distill/features/journey_3_pypi.feature"
    scenario: "Automatic rollback on installation failure"

  execution_order:
    step_1:
      action: "Run the E2E test FIRST"
      command: "pytest docs/features/modern-cli-installer/03-distill/e2e-scenarios/test_journey_3_pypi.py::test_automatic_rollback_on_installation_failure -v"
      expected: "FAIL (missing RollbackService or assertion failure)"
      purpose: "See the failing test that will drive implementation"

    step_2:
      action: "Write unit tests for RollbackService"
      file: "tests/installer/services/test_rollback_service.py"
      purpose: "Define expected behavior through tests"

    step_3:
      action: "Implement RollbackService"
      file: "src/crafter_ai/installer/services/rollback_service.py"
      purpose: "Make unit tests pass"

    step_4:
      action: "Run E2E test again"
      command: "pytest docs/features/modern-cli-installer/03-distill/e2e-scenarios/test_journey_3_pypi.py::test_automatic_rollback_on_installation_failure -v"
      expected: "Test progresses further (may still fail on CLI wiring)"
      purpose: "Verify service integration"

# ─────────────────────────────────────────────────────────────────────────────
# INPUT: What the agent receives (READ-ONLY context)
# ─────────────────────────────────────────────────────────────────────────────
input:
  source_file: "src/crafter_ai/installer/services/rollback_service.py"
  test_file: "tests/installer/services/test_rollback_service.py"

  existing_code:
    backup_port: "src/crafter_ai/installer/ports/backup_port.py"
    backup_adapter: "src/crafter_ai/installer/adapters/backup_adapter.py"
    install_service: "src/crafter_ai/installer/services/install_service.py"
    health_checker: "src/crafter_ai/installer/domain/health_checker.py"

  e2e_scenarios:
    - "journey_3_pypi.feature::Automatic rollback on installation failure"
    - "journey_3_pypi.feature::Manual rollback command"
    - "journey_3_pypi.feature::Fresh install failure with no backup"
    - "journey_3_pypi.feature::Rollback with no available backups"

  requirements:
    rollback_service:
      - "RollbackService uses BackupPort via dependency injection"
      - "auto_rollback(error: Exception) -> RollbackResult"
      - "  - Triggered on install failure"
      - "  - Finds most recent backup via BackupPort.list_backups()"
      - "  - Cleans partial install files before restore"
      - "  - Restores from backup via BackupPort.restore_backup()"
      - "  - Returns RollbackResult with success/failure info"
      - "manual_rollback(backup_path: Path) -> RollbackResult"
      - "  - For nw rollback command (CLI layer will call this)"
      - "  - Restores specified backup"
      - "  - Runs health check after restore"
      - "list_available_backups() -> list[BackupInfo]"
      - "  - Returns available backups with timestamps"
      - "  - Sorted by date (newest first)"

    rollback_result:
      - "RollbackResult dataclass with:"
      - "  - success: bool"
      - "  - restored_version: str | None"
      - "  - backup_timestamp: datetime | None"
      - "  - error_message: str | None"
      - "  - health_status: HealthStatus | None (after restore)"

    error_handling:
      - "No backups available: return error with 'No backups available'"
      - "Backup restore fails: return error with details"
      - "Fresh install failure: return specific message 'No previous version to restore'"

  test_requirements:
    - "Test auto_rollback restores from most recent backup"
    - "Test auto_rollback cleans partial files before restore"
    - "Test auto_rollback returns success with restored version"
    - "Test auto_rollback returns error when no backups exist"
    - "Test manual_rollback restores specified backup"
    - "Test manual_rollback runs health check after restore"
    - "Test list_available_backups returns sorted list"
    - "Test list_available_backups returns empty list when none exist"
    - "Mock BackupPort for isolated testing"

# ─────────────────────────────────────────────────────────────────────────────
# CONSTRAINTS: Rules the agent MUST follow
# ─────────────────────────────────────────────────────────────────────────────
constraints:
  max_tool_calls: 30
  must_run_tests: true
  fail_fast: true

  mandatory_sequence:
    - "1. Run E2E test FIRST (see it fail)"
    - "2. Write unit tests for RollbackService"
    - "3. Implement RollbackService to make unit tests pass"
    - "4. Run E2E test again (verify progress)"
    - "5. Run all unit tests"
    - "6. Commit changes"

  allowed_actions:
    - "Read existing BackupPort and BackupAdapter"
    - "Read E2E test files"
    - "Create RollbackService source file"
    - "Create RollbackService test file"
    - "Run pytest on unit tests"
    - "Run pytest on E2E test"
    - "Commit changes"

  forbidden_actions:
    - "DO NOT skip running E2E test first"
    - "DO NOT modify BackupPort or BackupAdapter"
    - "DO NOT implement CLI command (that's step 05-02)"
    - "DO NOT read roadmap.yaml or execution-status.yaml"

# ─────────────────────────────────────────────────────────────────────────────
# OUTPUT: What the agent must deliver (AGENT FILLS THIS SECTION)
# ─────────────────────────────────────────────────────────────────────────────
output:
  status: complete

  e2e_test_before:
    command: "pytest docs/features/modern-cli-installer/03-distill/e2e-scenarios/test_journey_3_pypi.py::test_automatic_rollback_on_installation_failure -v"
    result: "FAIL"
    failure_reason: "E2E test infrastructure not fully wired - RollbackService not connected to CLI layer"

  artifacts_created:
    - "src/crafter_ai/installer/services/rollback_service.py"
    - "tests/installer/services/test_rollback_service.py"

  unit_test_result:
    command: "pytest tests/installer/services/test_rollback_service.py -v"
    tests_passed: 11
    tests_failed: 0

  e2e_test_after:
    command: "pytest docs/features/modern-cli-installer/03-distill/e2e-scenarios/test_journey_3_pypi.py::test_automatic_rollback_on_installation_failure -v"
    result: "FAIL"
    failure_reason: "E2E test expected - CLI layer integration pending (step 05-02)"

  commit_hash: "321b3ab72653e29efdfd83c8358b809347fc5935"
  commit_message: "feat(installer): add partial file cleanup to rollback service"
  notes: "RollbackService now cleans partial install files before restore as per WIP requirements"

# ─────────────────────────────────────────────────────────────────────────────
# SUCCESS CRITERIA
# ─────────────────────────────────────────────────────────────────────────────
success_criteria:
  - criterion: "E2E test ran BEFORE implementation"
    validation: "output.e2e_test_before.result is not empty"

  - criterion: "RollbackService created with required methods"
    validation: "src/crafter_ai/installer/services/rollback_service.py exists"

  - criterion: "Unit tests pass"
    validation: "output.unit_test_result.tests_failed == 0"

  - criterion: "Uses BackupPort via dependency injection"
    validation: "RollbackService.__init__ accepts BackupPort parameter"
