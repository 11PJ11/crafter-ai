# Gap Analysis: UX Journeys vs User Stories
# Epic: modern_CLI_installer
# Analyst: Riley (product-owner)
# Date: 2026-02-01
# Purpose: Quality gate before DESIGN phase

gap_analysis:
  epic: modern_CLI_installer
  analysis_date: "2026-02-01"
  stories_total: 35
  journeys_analyzed: 3

  # =============================================================================
  # COVERAGE MATRIX
  # =============================================================================

  coverage_matrix:
    infrastructure_stories:
      US-001_shared_pre_flight:
        journey_coverage:
          - journey: "forge:build-local-candidate"
            step: "Step 1: Pre-flight Checks"
            coverage: FULL
          - journey: "forge:install-local-candidate"
            step: "Step 1: Pre-flight & Wheel Validation"
            coverage: FULL
          - journey: "install-nwave"
            step: "Step 3: Pre-flight Checks"
            coverage: FULL
        feature_scenarios: 15+
        status: FULLY_COVERED

      US-002_doctor_framework:
        journey_coverage:
          - journey: "forge:install-local-candidate"
            step: "Step 4: Doctor Verification"
            coverage: FULL
          - journey: "install-nwave"
            step: "Step 5: Doctor Verification"
            coverage: FULL
        feature_scenarios: 12+
        status: FULLY_COVERED

      US-003_shared_artifacts:
        journey_coverage:
          - journey: "all"
            artifact: "shared-artifacts.yaml"
            coverage: FULL
          - journey: "all"
            artifact: "shared-artifacts-registry-installer.md"
            coverage: FULL
        feature_scenarios: "Implicit in integration checkpoints"
        status: FULLY_COVERED

      US-004_config_resolution:
        journey_coverage:
          - journey: "install-nwave"
            step: "Step 3: Pre-flight (path resolution)"
            coverage: FULL
          - journey: "forge:install-local-candidate"
            step: "Step 1: Pre-flight (install_path)"
            coverage: FULL
        feature_scenarios: 8+
        status: FULLY_COVERED

      US-005_pypi_urls:
        journey_coverage:
          - journey: "install-nwave"
            step: "Step 2: Download & Extract"
            coverage: PARTIAL
        feature_scenarios: 3
        status: PARTIAL_COVERAGE
        gap_notes: "URL configuration exists but mirror/proxy scenarios not fully elaborated"

    journey_1_build_stories:
      US-010_build_pre_flight:
        journey_coverage:
          - journey: "forge:build-local-candidate"
            step: "Step 1: Pre-flight Checks"
            coverage: FULL
        feature_scenarios: 10+
        status: FULLY_COVERED

      US-011_version_bumping:
        journey_coverage:
          - journey: "forge:build-local-candidate"
            step: "Step 2: Version Bumping"
            coverage: FULL
        feature_scenarios: 12+
        status: FULLY_COVERED

      US-012_build_process:
        journey_coverage:
          - journey: "forge:build-local-candidate"
            step: "Step 3: Build Process"
            coverage: FULL
        feature_scenarios: 8+
        status: FULLY_COVERED

      US-013_wheel_validation:
        journey_coverage:
          - journey: "forge:build-local-candidate"
            step: "Step 4: Wheel Validation"
            coverage: FULL
        feature_scenarios: 10+
        status: FULLY_COVERED

      US-014_success_summary:
        journey_coverage:
          - journey: "forge:build-local-candidate"
            step: "Step 5: Success Summary"
            coverage: FULL
        feature_scenarios: 5+
        status: FULLY_COVERED

      US-015_local_install_prompt:
        journey_coverage:
          - journey: "forge:build-local-candidate"
            step: "Step 6: Install Prompt"
            coverage: FULL
        feature_scenarios: 6+
        status: FULLY_COVERED

      US-016_force_version:
        journey_coverage:
          - journey: "forge:build-local-candidate"
            step: "Step 2: Version Bumping (--force-version)"
            coverage: FULL
        feature_scenarios: 4+
        status: FULLY_COVERED

      US-017_daily_sequence:
        journey_coverage:
          - journey: "forge:build-local-candidate"
            step: "Step 2: Version Bumping (seq calculation)"
            coverage: FULL
        feature_scenarios: 3+
        status: FULLY_COVERED

      US-018_ci_mode_build:
        journey_coverage:
          - journey: "forge:build-local-candidate"
            step: "CI Mode (--ci flag)"
            coverage: FULL
        feature_scenarios: 8+
        status: FULLY_COVERED

      US-019_auto_repair:
        journey_coverage:
          - journey: "forge:build-local-candidate"
            step: "Error Recovery (auto-repair)"
            coverage: PARTIAL
        feature_scenarios: 2
        status: PARTIAL_COVERAGE
        gap_notes: "Auto-repair mentioned in error paths but scenarios limited"

    journey_2_install_stories:
      US-020_install_pre_flight:
        journey_coverage:
          - journey: "forge:install-local-candidate"
            step: "Step 1: Pre-flight & Wheel Validation"
            coverage: FULL
        feature_scenarios: 8+
        status: FULLY_COVERED

      US-021_release_readiness:
        journey_coverage:
          - journey: "forge:install-local-candidate"
            step: "Step 2: Release Readiness Check"
            coverage: FULL
        feature_scenarios: 10+
        status: FULLY_COVERED

      US-022_pipx_install:
        journey_coverage:
          - journey: "forge:install-local-candidate"
            step: "Step 3: Install Candidate"
            coverage: FULL
        feature_scenarios: 8+
        status: FULLY_COVERED

      US-023_doctor_verification:
        journey_coverage:
          - journey: "forge:install-local-candidate"
            step: "Step 4: Doctor Verification"
            coverage: FULL
        feature_scenarios: 10+
        status: FULLY_COVERED

      US-024_release_report:
        journey_coverage:
          - journey: "forge:install-local-candidate"
            step: "Step 5: Release Report"
            coverage: FULL
        feature_scenarios: 6+
        status: FULLY_COVERED

      US-025_auto_chain:
        journey_coverage:
          - journey: "forge:build-local-candidate"
            step: "Step 6: Install Prompt (--install flag)"
            coverage: FULL
          - journey: "forge:install-local-candidate"
            step: "Auto-chained from build"
            coverage: FULL
        feature_scenarios: 4+
        status: FULLY_COVERED

      US-026_multiple_wheel:
        journey_coverage:
          - journey: "forge:install-local-candidate"
            step: "Step 1: Wheel Selection"
            coverage: FULL
        feature_scenarios: 5+
        status: FULLY_COVERED

      US-027_ci_mode_install:
        journey_coverage:
          - journey: "forge:install-local-candidate"
            step: "CI Mode (--ci flag)"
            coverage: FULL
        feature_scenarios: 6+
        status: FULLY_COVERED

      US-028_json_output:
        journey_coverage:
          - journey: "forge:install-local-candidate"
            step: "CI Mode (--json flag)"
            coverage: FULL
        feature_scenarios: 4+
        status: FULLY_COVERED

      US-029_strict_mode:
        journey_coverage:
          - journey: "forge:install-local-candidate"
            step: "Strict Mode (--strict flag)"
            coverage: FULL
        feature_scenarios: 4+
        status: FULLY_COVERED

    journey_3_pypi_stories:
      US-030_download:
        journey_coverage:
          - journey: "install-nwave"
            step: "Step 2: Download & Extract"
            coverage: FULL
        feature_scenarios: 6+
        status: FULLY_COVERED

      US-031_path_resolution:
        journey_coverage:
          - journey: "install-nwave"
            step: "Step 3: Pre-flight (path resolution)"
            coverage: FULL
        feature_scenarios: 5+
        status: FULLY_COVERED

      US-032_installation_progress:
        journey_coverage:
          - journey: "install-nwave"
            step: "Step 4: Framework Installation"
            coverage: FULL
        feature_scenarios: 4+
        status: FULLY_COVERED

      US-033_doctor_pypi:
        journey_coverage:
          - journey: "install-nwave"
            step: "Step 5: Doctor Verification"
            coverage: FULL
        feature_scenarios: 6+
        status: FULLY_COVERED

      US-034_welcome:
        journey_coverage:
          - journey: "install-nwave"
            step: "Step 6: Celebration & Welcome"
            coverage: FULL
        feature_scenarios: 3+
        status: FULLY_COVERED

      US-035_restart_notification:
        journey_coverage:
          - journey: "install-nwave"
            step: "Step 6: Celebration (restart instruction)"
            coverage: FULL
        feature_scenarios: 2+
        status: FULLY_COVERED

      US-036_verification:
        journey_coverage:
          - journey: "install-nwave"
            step: "Step 7: Verify Installation"
            coverage: FULL
        feature_scenarios: 4+
        status: FULLY_COVERED

      US-037_custom_path:
        journey_coverage:
          - journey: "install-nwave"
            step: "Step 3: Pre-flight (--path flag)"
            coverage: FULL
        feature_scenarios: 3+
        status: FULLY_COVERED

      US-038_ci_mode_pypi:
        journey_coverage:
          - journey: "install-nwave"
            step: "CI Mode (--ci flag)"
            coverage: PARTIAL
        feature_scenarios: 2
        status: PARTIAL_COVERAGE
        gap_notes: "CI mode mentioned but less elaborated than other journeys"

      US-039_backup:
        journey_coverage:
          - journey: "install-nwave"
            step: "Step 3: Pre-flight (backup creation)"
            coverage: FULL
        feature_scenarios: 4+
        status: FULLY_COVERED

  # =============================================================================
  # GAPS IDENTIFIED
  # =============================================================================

  gaps_identified:
    stories_without_journey_coverage: []
    # All 35 stories have journey coverage - no orphan stories

    stories_with_partial_coverage:
      - story_id: US-005
        story_title: "PyPI URL Configuration"
        gap: "Mirror/proxy scenarios not fully elaborated in journey"
        severity: LOW
        recommendation: "Add scenarios for corporate proxy, mirror fallback"

      - story_id: US-019
        story_title: "Auto-repair Pre-flight Failures"
        gap: "Auto-repair logic mentioned but limited feature scenarios"
        severity: MEDIUM
        recommendation: "Expand auto-repair scenarios in feature file"

      - story_id: US-038
        story_title: "CI Mode for PyPI Install"
        gap: "CI mode less detailed than build/install-local journeys"
        severity: LOW
        recommendation: "Align CI mode coverage with other journeys"

    journey_steps_without_story:
      - journey: "forge:build-local-candidate"
        step: "Build cleanup (remove old wheels)"
        gap: "No story covers cleaning up stale builds"
        severity: LOW
        recommendation: "Consider adding cleanup story or include in US-012"

      - journey: "forge:install-local-candidate"
        step: "Rollback on failure"
        gap: "Rollback mechanism exists in journey but no dedicated story"
        severity: MEDIUM
        recommendation: "Add US-02X for rollback functionality"

      - journey: "install-nwave"
        step: "Upgrade vs fresh install detection"
        gap: "Journey shows upgrade path but no dedicated story"
        severity: MEDIUM
        recommendation: "Add story for upgrade detection and handling"

      - journey: "all"
        step: "Telemetry/analytics opt-in"
        gap: "Discovery mentioned analytics but no journey/story coverage"
        severity: LOW
        recommendation: "Defer to future epic or add opt-in story"

    acceptance_criteria_mismatches:
      - story_id: US-017
        story_title: "Daily Sequence Number"
        issue: "Story says 'seq' format, journey shows 3-digit padding (001, 002)"
        resolution: "Aligned - journey uses correct format, story AC should specify 3-digit"
        severity: LOW

      - story_id: US-014
        story_title: "Success Summary"
        issue: "Story mentions 'wheel size' but journey visual shows 'package size'"
        resolution: "Terminology alignment needed - recommend 'wheel size'"
        severity: LOW

      - story_id: US-024
        story_title: "Release Report"
        issue: "Story has 5 AC items, journey visual shows 8 report sections"
        resolution: "Journey is more detailed - story AC could be expanded"
        severity: LOW

    consistency_issues:
      - type: "terminology"
        issue: "Mixed use of 'candidate_version' vs 'dev version'"
        locations:
          - "US-011 says 'development candidate version'"
          - "Journey YAML uses 'candidate_version'"
        resolution: "Standardize on 'candidate_version' per shared-artifacts-registry"

      - type: "example_values"
        issue: "Some story examples differ from standardized values"
        locations:
          - "Some stories use agent_count=30, standard is 47"
        resolution: "Align all stories to shared-artifacts-registry values"

  # =============================================================================
  # NEW STORIES RECOMMENDED
  # =============================================================================

  new_stories_recommended:
    - story_id: US-040
      title: "Rollback on Installation Failure"
      rationale: "Journey shows rollback mechanism but no story captures this"
      journey_reference: "forge:install-local-candidate error handling"
      priority: P1
      suggested_ac:
        - "Given installation fails, When rollback triggers, Then previous version restored"
        - "Given backup exists, When rollback completes, Then user notified of restoration"
        - "Given no backup exists, When rollback triggers, Then clean state message shown"

    - story_id: US-041
      title: "Upgrade Detection and Handling"
      rationale: "Journey shows upgrade vs fresh install but no story captures this"
      journey_reference: "install-nwave Step 3 pre-flight"
      priority: P1
      suggested_ac:
        - "Given nWave already installed, When running install, Then upgrade path triggered"
        - "Given upgrade detected, When pre-flight runs, Then backup created automatically"
        - "Given major version upgrade, When detected, Then migration warnings shown"

    - story_id: US-042
      title: "Build Cleanup of Stale Wheels"
      rationale: "Implicit in journey but not captured as explicit story"
      journey_reference: "forge:build-local-candidate Step 3"
      priority: P2
      suggested_ac:
        - "Given dist/ contains old wheels, When new build starts, Then old wheels cleaned"
        - "Given --keep-old flag, When build runs, Then old wheels preserved"
        - "Given cleanup fails, When build continues, Then warning shown"

    - story_id: US-043
      title: "Corporate Proxy Support"
      rationale: "Discovery mentions enterprise users, journey lacks proxy scenarios"
      journey_reference: "install-nwave Step 2 download"
      priority: P2
      suggested_ac:
        - "Given HTTPS_PROXY set, When downloading, Then proxy used"
        - "Given corporate firewall, When download fails, Then proxy hint shown"
        - "Given .netrc configured, When downloading, Then credentials used"

    - story_id: US-044
      title: "Offline Installation Mode"
      rationale: "Deployer persona needs air-gapped environments"
      journey_reference: "None - gap identified"
      priority: P3
      suggested_ac:
        - "Given --offline flag, When installing, Then only local wheel used"
        - "Given no network, When install runs, Then clear offline instructions"
        - "Given pre-downloaded wheel, When offline install, Then successful"

  # =============================================================================
  # SUMMARY
  # =============================================================================

  summary:
    coverage_percentage: 94
    coverage_breakdown:
      fully_covered: 32
      partially_covered: 3
      not_covered: 0

    critical_gaps:
      - gap: "No rollback story (US-040 recommended)"
        impact: "Users may lose previous installation on failure"
        severity: HIGH

      - gap: "No upgrade detection story (US-041 recommended)"
        impact: "Upgrade vs fresh install behavior undefined"
        severity: HIGH

    moderate_gaps:
      - gap: "Auto-repair scenarios limited"
        story: US-019
        recommendation: "Expand feature file scenarios"

      - gap: "CI mode for PyPI less detailed"
        story: US-038
        recommendation: "Align with other journey CI coverage"

    low_priority_gaps:
      - gap: "Build cleanup not explicit"
        recommendation: "Add US-042 or include in existing story"

      - gap: "Proxy support not covered"
        recommendation: "Add US-043 for enterprise users"

      - gap: "Terminology inconsistencies"
        recommendation: "Align all stories to shared-artifacts-registry"

    recommendations:
      immediate_actions:
        - action: "Create US-040 (Rollback on Failure)"
          priority: P0
          rationale: "Critical for production safety"

        - action: "Create US-041 (Upgrade Detection)"
          priority: P0
          rationale: "Fundamental install behavior"

        - action: "Align US-017 AC to specify 3-digit sequence padding"
          priority: P1
          rationale: "Journey shows correct format"

        - action: "Standardize example values across all stories"
          priority: P1
          rationale: "Use shared-artifacts-registry values"

      before_design_phase:
        - "Add recommended P0/P1 stories"
        - "Expand US-019 auto-repair scenarios"
        - "Align US-038 CI mode with other journeys"
        - "Resolve terminology inconsistencies"

      future_considerations:
        - "US-043 Proxy support for enterprise"
        - "US-044 Offline mode for air-gapped"
        - "Telemetry opt-in story (deferred)"

    quality_gate_status: CONDITIONAL_PASS
    quality_gate_notes: |
      The gap analysis reveals 94% coverage - a strong foundation.

      BLOCKING ISSUES (must resolve before DESIGN):
      1. Create US-040 (Rollback) - HIGH severity gap
      2. Create US-041 (Upgrade Detection) - HIGH severity gap

      NON-BLOCKING ISSUES (can resolve during DESIGN):
      - Terminology alignment
      - Example value standardization
      - Expanded scenarios for US-019, US-038

      RECOMMENDATION: Proceed to DESIGN after adding US-040 and US-041.

  # =============================================================================
  # TRACEABILITY MATRIX
  # =============================================================================

  traceability_matrix:
    journey_to_stories:
      forge_build_local_candidate:
        step_1_preflight: [US-001, US-010]
        step_2_version_bumping: [US-011, US-016, US-017]
        step_3_build_process: [US-012]
        step_4_wheel_validation: [US-013]
        step_5_success_summary: [US-014, US-003]
        step_6_install_prompt: [US-015, US-025]
        ci_mode: [US-018]
        error_handling: [US-019]

      forge_install_local_candidate:
        step_1_preflight_wheel: [US-001, US-020, US-026]
        step_2_release_readiness: [US-021]
        step_3_install_candidate: [US-022]
        step_4_doctor: [US-002, US-023]
        step_5_release_report: [US-024]
        ci_mode: [US-027, US-028, US-029]
        auto_chain: [US-025]

      install_nwave:
        step_1_run_command: []
        step_2_download: [US-030, US-005]
        step_3_preflight: [US-001, US-031, US-004, US-039]
        step_4_framework_install: [US-032]
        step_5_doctor: [US-002, US-033]
        step_6_celebration: [US-034, US-035]
        step_7_verify: [US-036]
        custom_path: [US-037]
        ci_mode: [US-038]

    shared_infrastructure:
      pre_flight_framework: [US-001]
      doctor_framework: [US-002]
      shared_artifacts: [US-003]
      config_resolution: [US-004]
      pypi_urls: [US-005]

  # =============================================================================
  # METADATA
  # =============================================================================

  metadata:
    files_analyzed:
      user_stories: "/docs/features/modern-cli-installer/01-discuss/user-stories.md"
      discovery: "/docs/features/modern-cli-installer/01-discuss/discovery.md"
      journey_1_yaml: "/docs/ux/modern-cli-installer/journey-forge-build-local.yaml"
      journey_1_visual: "/docs/ux/modern-cli-installer/journey-forge-build-local-visual.md"
      journey_1_feature: "/docs/ux/modern-cli-installer/journey-forge-build-local.feature"
      journey_2_yaml: "/docs/ux/modern-cli-installer/journey-forge-install-local-candidate.yaml"
      journey_2_visual: "/docs/ux/modern-cli-installer/journey-forge-install-local-candidate-visual.md"
      journey_2_feature: "/docs/ux/modern-cli-installer/journey-forge-install-local-candidate.feature"
      journey_3_yaml: "/docs/ux/modern-cli-installer/journey-install-nwave.yaml"
      journey_3_visual: "/docs/ux/modern-cli-installer/journey-install-nwave-visual.md"
      journey_3_feature: "/docs/ux/modern-cli-installer/journey-install-nwave.feature"
      shared_registry: "/docs/ux/modern-cli-installer/shared-artifacts-registry-installer.md"
      shared_preflight: "/docs/ux/modern-cli-installer/shared/pre-flight-checks.yaml"
      shared_doctor: "/docs/ux/modern-cli-installer/shared/doctor-health-check.yaml"
      shared_artifacts: "/docs/ux/modern-cli-installer/shared/shared-artifacts.yaml"

    analysis_method: "Cross-reference each user story against journey steps and feature scenarios"
    analyst: "Riley (product-owner agent)"
    review_status: "Pending peer review by product-owner-reviewer"
