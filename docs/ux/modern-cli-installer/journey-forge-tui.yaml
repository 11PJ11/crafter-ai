schema_version: "1.0"
journey_type: "tui-redesign"
owner: "leanux-designer"

journey:
  name: "forge-build-install-tui"
  goal: "Redesign the TUI for forge build + install as one continuous, frictionless, emotionally engaging flow"
  persona:
    name: "Mike"
    role: "Developer building and installing crafter-ai locally"

  emotional_arc:
    start: "Anticipation"
    middle: "Growing confidence through rapid green checkmarks, brief tension during compilation"
    end: "Joy and satisfaction at the celebration moment"

  trigger: "User runs 'crafter-ai forge build' or 'crafter-ai forge build --install'"
  success_criteria: "User sees a clean stream of progress culminating in a celebration line with version and health"

design_system:
  colors:
    green:
      semantic: "Success, pass, completion"
      rich_markup: "[green]"
      usage: "Passed checks, celebration (healthy)"
    red:
      semantic: "Error, failure, blocked"
      rich_markup: "[red]"
      usage: "Failed checks, blocking errors, error details"
    yellow:
      semantic: "Warning, non-blocking issue"
      rich_markup: "[yellow]"
      usage: "Warning checks, degraded celebration"
    dim:
      semantic: "Secondary information"
      rich_markup: "[dim]"
      usage: "Paths, sizes, durations, remediation text"
    bold:
      semantic: "Primary content emphasis"
      rich_markup: "[bold]"
      usage: "Phase headers, version numbers, package names"

  emoji_vocabulary:
    build_phase: "üî®"
    install_phase: "üì¶"
    check_passed: "‚úÖ"
    check_warning: "‚ö†Ô∏è"
    check_failed: "‚ùå"
    checking: "üîç"
    backup: "üíæ"
    active_operation: "‚öôÔ∏è"
    manifest: "üìã"
    health_check: "ü©∫"
    celebration: "üéâ"
    spinner_active: "‚è≥"
    version_arrow: "‚Üí"

  typography:
    phase_header:
      style: "bold + emoji"
      indent: 0
      example: "üî® Building crafter-ai"
    check_result:
      style: "emoji + plain text"
      indent: 2
      example: "  ‚úÖ pyproject.toml found"
    sub_phase_header:
      style: "emoji + plain text"
      indent: 2
      example: "  üîç Pre-flight checks"
    summary_value:
      style: "bold for value"
      indent: 2
      example: "  0.1.0 ‚Üí 0.2.0 (minor)"
    secondary_detail:
      style: "dim"
      indent: 3
      example: "   Ready to use in Claude Code."
    error_remediation:
      style: "dim"
      indent: 5
      example: "     Fix: Create pyproject.toml in project root"

  spacing:
    between_phases: 1_blank_line
    within_phase: 0_blank_lines
    before_error_detail_block: 1_blank_line
    after_final_celebration: 0_blank_lines

  forbidden_elements:
    - "Rich Panel (no borders or boxes)"
    - "Rich Table (no tabular layout for sequential data)"
    - "ASCII art borders (=== or ---)"
    - "Horizontal rules"
    - "FORGE: prefix (no shouting)"
    - "Multi-line summary blocks (no receipts)"
    - "Decorative colors (only semantic)"

steps:
  - id: 1
    phase: "build"
    name: "Build Phase Header"
    output: "üî® Building crafter-ai"
    emotional_state:
      entry: "Anticipation"
      exit: "Oriented, knows what's happening"

  - id: 2
    phase: "build"
    name: "Build Pre-flight Checks"
    sub_header: "üîç Pre-flight checks"
    checks:
      - id: "pyproject-exists"
        pass_message: "pyproject.toml found"
        fail_message: "pyproject.toml not found"
        severity: "BLOCKING"
      - id: "build-package"
        pass_message: "Build toolchain ready"
        fail_message: "Build package not installed"
        severity: "BLOCKING"
      - id: "src-directory"
        pass_message: "Source directory found"
        fail_message: "Source directory not found"
        severity: "BLOCKING"
      - id: "clean-git-status"
        pass_message: "Git status clean"
        warn_message: "Uncommitted changes detected"
        severity: "WARNING"
      - id: "version-not-released"
        pass_message: "Version available for release"
        warn_message: "Version may exist on PyPI"
        severity: "WARNING"
    summary_on_pass: "Pre-flight passed"
    emotional_state:
      entry: "Slight nervousness (will it pass?)"
      exit: "Confidence building (green checkmarks)"

  - id: 3
    phase: "build"
    name: "Version Display"
    sub_header: "üìê Version"
    output: "{current_version} ‚Üí {next_version} ({bump_type})"
    shared_artifacts:
      - name: "version"
        source: "pyproject.toml ‚Üí VersionBumpService ‚Üí wheel METADATA (canonical)"
        displayed_as: "{current_version} ‚Üí {next_version}"
        note: "At build time, version originates from pyproject.toml via VersionBumpService. After build, wheel METADATA becomes the canonical source."
    emotional_state:
      entry: "Curious"
      exit: "Clear on what's being built"

  - id: 4
    phase: "build"
    name: "Wheel Compilation"
    spinner_text: "‚è≥ Compiling wheel..."
    resolved_text: "‚úÖ Wheel built ({duration})"
    emotional_state:
      entry: "Tension (will it compile?)"
      exit: "Relief (it compiled, and fast)"

  - id: 5
    phase: "build"
    name: "Wheel Validation"
    sub_header: "üîç Validating wheel"
    checks:
      - pass_message: "PEP 427 format valid"
      - pass_message: "Metadata complete"
    summary_on_pass: "Wheel validated"
    emotional_state:
      entry: "Brief attention"
      exit: "Confidence"

  - id: 6
    phase: "build"
    name: "Build Complete"
    output: "üî® Build complete: {wheel_filename}"
    shared_artifacts:
      - name: "wheel_filename"
        source: "BuildResult.wheel_path.name"
        displayed_as: "{wheel_filename}"
    emotional_state:
      entry: "Anticipation of next phase"
      exit: "Satisfaction, ready for install"

  - id: 7
    phase: "transition"
    name: "Install Confirmation Prompt"
    output: "üì¶ Install crafter-ai {version}? [Y/n]: "
    interaction: "confirmation_prompt"
    default: "Y (yes)"
    on_yes: "proceed to step 8"
    on_no: "exit with code 0, message: Install skipped."
    shared_artifacts:
      - name: "version"
        source: "Wheel METADATA (via BuildResult)"
        displayed_as: "{version}"
    emotional_state:
      entry: "Build succeeded, anticipation of install"
      exit: "User feels in control, chose to proceed"
    design_notes: |
      The prompt appears after a blank line following build complete.
      It uses the üì¶ emoji to signal the transition to install phase.
      No box or panel. Just an inline prompt in the stream.
      The version shown here MUST match the version from wheel METADATA.

  - id: 8
    phase: "install"
    name: "Install Phase Header"
    output: "üì¶ Installing crafter-ai"
    emotional_state:
      entry: "Momentum continues, user just confirmed"
      exit: "Oriented in new phase"

  - id: 9
    phase: "install"
    name: "Install Pre-flight Checks"
    sub_header: "üîç Pre-flight checks"
    checks:
      - id: "wheel-exists"
        pass_message: "Wheel file found"
        fail_message: "No wheel file found in dist/"
        severity: "BLOCKING"
      - id: "wheel-format"
        pass_message: "Wheel format valid"
        fail_message: "Wheel format invalid"
        severity: "BLOCKING"
      - id: "pipx-isolation"
        pass_message: "pipx environment ready"
        fail_message: "pipx is not installed"
        severity: "BLOCKING"
      - id: "install-path-resolved"
        pass_message: "Install path writable"
        fail_message: "Install path not accessible"
        severity: "BLOCKING"
    summary_on_pass: "Pre-flight passed"
    emotional_state:
      entry: "Slight check-in"
      exit: "Green light, let's go"

  - id: 10
    phase: "install"
    name: "Backup"
    condition: "upgrade_path != FRESH_INSTALL"
    sub_header_upgrade: "üíæ Backing up configuration"
    spinner_text: "‚è≥ Creating backup..."
    resolved_text: "‚úÖ Backup saved ({duration})"
    detail_text_upgrade: "{backed_up_items} ‚Üí {backup_path}"
    skip_text_fresh: "üíæ Fresh install, no backup needed"
    shared_artifacts:
      - name: "backup_path"
        source: "BackupResult.backup_path"
        displayed_as: "{backup_path}"
        note: "Only shown for upgrade path. Format: ~/.claude/backups/nwave-YYYYMMDD-HHMMSS"
      - name: "backed_up_items"
        source: "FileSystemBackupAdapter.BACKUP_TARGETS (items that existed)"
        displayed_as: "{backed_up_items}"
        note: "Comma-separated list of backed-up item types, e.g. 'agents, commands, templates'"
    emotional_state:
      entry_upgrade: "Brief concern for existing data"
      exit_upgrade: "Trust (data is explicitly safe, I can see where it went)"
      entry_fresh: "No concern"
      exit_fresh: "Acknowledged, moving on"
    design_notes: |
      Upgrade path: sub-header ‚Üí spinner ‚Üí closure ‚Üí dim detail line showing
      what was backed up and where. The detail line builds trust by showing
      the user exactly where their data went.
      Fresh install: single informational line, no spinner (nothing to do).

  - id: 11
    phase: "install"
    name: "Installation Progress"
    sub_header: "‚öôÔ∏è Installing"
    spinner_text: "‚è≥ Installing via pipx..."
    resolved_text: "‚úÖ nWave installed via pipx ({duration})"
    emotional_state:
      entry: "Peak tension (the big operation, ~3 seconds)"
      exit: "Major relief (it worked, and I can see the timing)"
    design_notes: |
      The sub-header "‚öôÔ∏è Installing" creates a named container for the
      operation. The spinner runs during the ~3-second pipx install, filling
      the silence gap that previously caused anxiety. The closure line uses
      "nWave" (product brand) and includes duration for transparency.
      The ‚öôÔ∏è emoji means "active operation in progress".

  - id: 12
    phase: "install"
    name: "SBOM Manifest"
    sub_header: "üìã What was installed"
    manifest_items_always:
      - "{package_name} {version}"
      - "CLI: {cli_entry_points}"
      - "‚Üí {install_path}"
    manifest_items_upgrade_only:
      - "{agent_count} agents, {command_count} commands, {template_count} templates"
    shared_artifacts:
      - name: "package_name"
        source: "pyproject.toml [project].name"
        displayed_as: "crafter-ai"
      - name: "version"
        source: "Wheel METADATA (via InstallResult.version)"
        displayed_as: "{version}"
      - name: "cli_entry_points"
        source: "Wheel METADATA [console_scripts]"
        displayed_as: "crafter-ai, nw"
        note: "Parsed from wheel METADATA entry_points. Currently not available from pipx adapter; needs new method or wheel introspection."
      - name: "install_path"
        source: "pipx list_packages() ‚Üí InstalledPackage.path"
        displayed_as: "{install_path}"
      - name: "component_counts"
        source: "Post-install scan of ~/.claude/ (agents/, commands/, templates/)"
        displayed_as: "{agent_count} agents, {command_count} commands, {template_count} templates"
        note: "Only shown for upgrade path where components already exist. For fresh install, nw setup has not yet run."
    emotional_state:
      entry: "Curiosity (what just happened?)"
      exit: "Trust (I can see exactly what was installed and where)"
    design_notes: |
      The SBOM manifest answers: "what did this tool just do to my system?"
      Without it, a silent install that registers CLI commands and modifies
      paths looks like malware. All items are dim text at 4-space indent.
      No emojis on individual lines; they are informational, not status.
      The ‚Üí prefix on install_path mirrors the version transition arrow.

      DATA AVAILABILITY NOTE: cli_entry_points are not currently exposed
      by the pipx adapter. Two options:
      1. Parse from wheel METADATA (zipfile introspection before install)
      2. Hardcode known entry points ("crafter-ai, nw")
      Option 2 is pragmatic for now; option 1 is the clean long-term fix.

  - id: 13
    phase: "install"
    name: "Health Verification"
    sub_header: "ü©∫ Verifying installation"
    checks:
      - pass_message: "CLI responds to --version"
      - pass_message: "Core modules loadable"
    summary_healthy: "Health: HEALTHY"
    summary_degraded: "Health: DEGRADED"
    emotional_state:
      entry: "Final check"
      exit: "Confident or cautious depending on result"

  - id: 14
    phase: "celebration"
    name: "Celebration"
    healthy_output: |
      üéâ nWave {version} installed and healthy!
         Ready to use in Claude Code.
    degraded_output: |
      ‚ö†Ô∏è  nWave {version} installed with warnings
         Some features may be limited. Run 'crafter-ai doctor' for details.
    failed_output: |
      ‚ùå Installation failed
         {error_message}
    shared_artifacts:
      - name: "version"
        source: "Wheel METADATA (via InstallResult.version)"
      - name: "product_name"
        source: "Hardcoded: 'nWave'"
        note: "Product brand name used in user-facing celebration. Package name 'crafter-ai' used in SBOM manifest."
      - name: "health_status"
        source: "HealthChecker result"
    emotional_state:
      entry: "Anticipation of outcome"
      exit_healthy: "Joy, satisfaction, ready to go"
      exit_degraded: "Cautious optimism"
      exit_failed: "Clarity on what went wrong, path to fix"

error_states:
  blocking_preflight:
    pattern: |
      Show all checks (pass and fail mixed)
      Blank line
      Summary: "{Phase} blocked: {count} checks failed"
      Blank line
      Repeat ONLY failures with remediation:
        ‚ùå {failure.message}
           Fix: {failure.remediation}
    exit_code: 1

  build_failure:
    pattern: |
      ‚ùå Build failed
      Blank line
      Error: {error_message}
      Fix: {remediation if available}
    exit_code: 1

  install_failure:
    pattern: |
      ‚ùå Installation failed
      Blank line
      Error: {error_message}
      Fix: {remediation if available}
    exit_code: 1

interaction_patterns:
  spinner_to_persistent_line:
    description: "Spinner replaces itself, then a persistent line is printed"
    implementation: |
      status = console.status("‚è≥ {action}...")
      status.start()
      result = do_work()
      status.stop()
      console.print("{emoji} {result_message} ({duration})")

  confirmation_prompt:
    description: "Inline prompt with emoji matching current phase"
    format: "üì¶ Install crafter-ai {version}? [Y/n]: "
    default: "Y (yes)"

  check_list_streaming:
    description: "Each check prints as it completes, giving a streaming feel"
    note: "Even if checks run fast, the visual of lines appearing builds confidence"

  sub_phase_with_spinner:
    description: "Section header + spinner + closure + optional detail"
    implementation: |
      console.print("  {section_emoji} {Section Title}")
      status = console.status("  ‚è≥ {action}...")
      status.start()
      result = do_work()
      status.stop()
      console.print("  ‚úÖ {closure_message} ({duration})")
      if detail:
          console.print(f"[dim]    {detail_text}[/dim]")
    note: "Used by backup (upgrade) and install sections. The section header names the operation; the spinner provides feedback; the closure confirms completion."

  sbom_manifest:
    description: "Post-install transparency showing what was installed"
    implementation: |
      console.print("  üìã What was installed")
      console.print(f"[dim]    {package_name} {version}[/dim]")
      console.print(f"[dim]    CLI: {entry_points}[/dim]")
      if upgrade:
          console.print(f"[dim]    {agents} agents, {commands} commands, {templates} templates[/dim]")
      console.print(f"[dim]    ‚Üí {install_path}[/dim]")
    note: "No emojis on manifest items. All dim text at 4-space indent. Builds trust by showing exactly what changed."

shared_artifacts:
  version:
    source_of_truth: "Wheel METADATA file (METADATA inside the .whl archive)"
    data_flow: "pyproject.toml ‚Üí build process ‚Üí wheel METADATA ‚Üí all displays"
    canonical_runtime_path: "InstallResult.version (parsed from wheel METADATA)"
    consumers:
      - "Step 3: Version display line (via VersionBumpService during build)"
      - "Step 6: Build complete line (embedded in wheel filename)"
      - "Step 7: Install confirmation prompt"
      - "Step 12: SBOM manifest (package identity line)"
      - "Step 14: Celebration message"
    integration_risk: "HIGH"
    risk_explanation: "Version appears in 5 places. The wheel METADATA is the single source. All displays must trace back to it."
    validation: "All 5 displays must show identical version string originating from wheel METADATA"

  product_name:
    source_of_truth: "Hardcoded string: 'nWave'"
    consumers:
      - "Step 11: Install closure line ('nWave installed via pipx')"
      - "Step 14: Celebration message ('nWave {version} installed and healthy!')"
    integration_risk: "LOW"
    risk_explanation: "Brand name is intentionally different from package_name. If product renames, update these two locations."
    validation: "Both displays use identical product name string"

  wheel_filename:
    source_of_truth: "BuildResult.wheel_path.name"
    consumers:
      - "Step 6: Build complete line"
    integration_risk: "LOW"
    validation: "Filename matches built artifact"

  install_path:
    source_of_truth: "pipx list_packages() ‚Üí InstalledPackage.path"
    data_flow: "pipx install ‚Üí pipx list --json ‚Üí InstalledPackage.path"
    consumers:
      - "Step 12: SBOM manifest (install location line)"
    integration_risk: "MEDIUM"
    risk_explanation: "Install path displayed to user must match actual pipx venv location. If pipx changes its path scheme, the display breaks."
    validation: "Displayed path matches result from pipx list_packages() for crafter-ai"

  cli_entry_points:
    source_of_truth: "Wheel METADATA [console_scripts] section"
    consumers:
      - "Step 12: SBOM manifest (CLI commands line)"
    integration_risk: "MEDIUM"
    risk_explanation: "Entry points shown in SBOM must match what pipx actually registered. Currently not parsed from wheel; needs implementation."
    validation: "Displayed entry points match wheel METADATA console_scripts entries"
    implementation_note: |
      NOT YET AVAILABLE in current codebase. Options:
      1. Parse wheel METADATA (zipfile introspection) - clean, dynamic
      2. Hardcode known values ("crafter-ai, nw") - pragmatic, brittle
      3. Parse pipx install stdout which lists registered apps - depends on pipx output format
      Recommendation: Start with option 2, implement option 1 when refactoring pipx adapter.

  component_counts:
    source_of_truth: "Post-install scan of ~/.claude/ directory"
    data_flow: "~/.claude/{agents,commands,templates}/ ‚Üí glob count ‚Üí display"
    consumers:
      - "Step 12: SBOM manifest (component counts line; upgrade path only)"
    integration_risk: "LOW"
    risk_explanation: "Counts are informational, not functional. Mismatch is cosmetic."
    validation: "Counts match actual file counts in ~/.claude/ subdirectories"
    implementation_note: |
      Only shown for upgrade path. For fresh install, nw setup has not yet
      deployed components, so counts would be misleading (showing 0 or
      pre-existing counts from a different tool).

  backup_path:
    source_of_truth: "BackupResult.backup_path"
    consumers:
      - "Step 10: Backup detail line (upgrade path only)"
    integration_risk: "LOW"
    validation: "Displayed path matches BackupResult.backup_path and directory exists on disk"

  health_status:
    source_of_truth: "HealthChecker result"
    consumers:
      - "Step 13: Health verification summary"
      - "Step 14: Celebration message tone (üéâ vs ‚ö†Ô∏è)"
    integration_risk: "MEDIUM"
    risk_explanation: "Health status determines celebration variant"
    validation: "Same HealthStatus enum value drives both displays"

  package_name:
    source_of_truth: "pyproject.toml [project].name"
    consumers:
      - "Step 1: Build header"
      - "Step 8: Install header"
      - "Step 12: SBOM manifest (package identity line)"
    integration_risk: "LOW"
    validation: "Consistent package name across all three locations"
