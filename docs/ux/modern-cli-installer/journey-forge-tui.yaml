schema_version: "1.0"
journey_type: "tui-redesign"
owner: "leanux-designer"

journey:
  name: "forge-build-install-tui"
  goal: "Redesign the TUI for forge build + install as one continuous, frictionless, emotionally engaging flow"
  persona:
    name: "Mike"
    role: "Developer building and installing crafter-ai locally"

  emotional_arc:
    start: "Anticipation"
    middle: "Growing confidence through rapid green checkmarks, brief tension during compilation"
    end: "Joy and satisfaction at the celebration moment"

  trigger: "User runs 'crafter-ai forge build' or 'crafter-ai forge build --install'"
  success_criteria: "User sees a clean stream of progress culminating in a celebration line with version and health"

design_system:
  colors:
    green:
      semantic: "Success, pass, completion"
      rich_markup: "[green]"
      usage: "Passed checks, celebration (healthy)"
    red:
      semantic: "Error, failure, blocked"
      rich_markup: "[red]"
      usage: "Failed checks, blocking errors, error details"
    yellow:
      semantic: "Warning, non-blocking issue"
      rich_markup: "[yellow]"
      usage: "Warning checks, degraded celebration"
    dim:
      semantic: "Secondary information"
      rich_markup: "[dim]"
      usage: "Paths, sizes, durations, remediation text"
    bold:
      semantic: "Primary content emphasis"
      rich_markup: "[bold]"
      usage: "Phase headers, version numbers, package names"

  emoji_vocabulary:
    build_phase: "üî®"
    install_phase: "üì¶"
    check_passed: "‚úÖ"
    check_warning: "‚ö†Ô∏è"
    check_failed: "‚ùå"
    checking: "üîç"
    backup: "üíæ"
    active_operation: "‚öôÔ∏è"
    manifest: "üìã"
    health_check: "ü©∫"
    celebration: "üéâ"
    spinner_active: "‚è≥"
    version_arrow: "‚Üí"

  typography:
    phase_header:
      style: "bold + emoji"
      indent: 0
      example: "üî® Building crafter-ai"
    check_result:
      style: "emoji + plain text"
      indent: 2
      example: "  ‚úÖ pyproject.toml found"
    sub_phase_header:
      style: "emoji + plain text"
      indent: 2
      example: "  üîç Pre-flight checks"
    summary_value:
      style: "bold for value"
      indent: 2
      example: "  0.1.0 ‚Üí 0.2.0 (minor)"
    secondary_detail:
      style: "dim"
      indent: 3
      example: "   Ready to use in Claude Code."
    error_remediation:
      style: "dim"
      indent: 5
      example: "     Fix: Create pyproject.toml in project root"

  spacing:
    between_phases: 1_blank_line
    within_phase: 0_blank_lines
    before_error_detail_block: 1_blank_line
    after_final_celebration: 0_blank_lines

  forbidden_elements:
    - "Rich Panel (no borders or boxes)"
    - "Rich Table (no tabular layout for sequential data)"
    - "ASCII art borders (=== or ---)"
    - "Horizontal rules"
    - "FORGE: prefix (no shouting)"
    - "Multi-line summary blocks (no receipts)"
    - "Decorative colors (only semantic)"

steps:
  - id: 1
    phase: "build"
    name: "Build Phase Header"
    output: "üî® Building crafter-ai"
    emotional_state:
      entry: "Anticipation"
      exit: "Oriented, knows what's happening"

  - id: 2
    phase: "build"
    name: "Build Pre-flight Checks"
    sub_header: "üîç Pre-flight checks"
    checks:
      - id: "pyproject-exists"
        pass_message: "pyproject.toml found"
        fail_message: "pyproject.toml not found"
        severity: "BLOCKING"
      - id: "build-package"
        pass_message: "Build toolchain ready"
        fail_message: "Build package not installed"
        severity: "BLOCKING"
      - id: "src-directory"
        pass_message: "Source directory found"
        fail_message: "Source directory not found"
        severity: "BLOCKING"
      - id: "clean-git-status"
        pass_message: "Git status clean"
        warn_message: "Uncommitted changes detected"
        severity: "WARNING"
      - id: "version-not-released"
        pass_message: "Version available for release"
        warn_message: "Version may exist on PyPI"
        severity: "WARNING"
    summary_on_pass: "Pre-flight passed"
    emotional_state:
      entry: "Slight nervousness (will it pass?)"
      exit: "Confidence building (green checkmarks)"

  - id: 3
    phase: "build"
    name: "Version Display"
    sub_header: "üìê Version"
    output: "{current_version} ‚Üí {next_version} ({bump_type})"
    shared_artifacts:
      - name: "version"
        source: "pyproject.toml ‚Üí VersionBumpService ‚Üí wheel METADATA (canonical)"
        displayed_as: "{current_version} ‚Üí {next_version}"
        note: "At build time, version originates from pyproject.toml via VersionBumpService. After build, wheel METADATA becomes the canonical source."
    emotional_state:
      entry: "Curious"
      exit: "Clear on what's being built"

  - id: 4
    phase: "build"
    name: "Wheel Compilation"
    spinner_text: "‚è≥ Compiling wheel..."
    resolved_text: "‚úÖ Wheel built ({duration})"
    emotional_state:
      entry: "Tension (will it compile?)"
      exit: "Relief (it compiled, and fast)"

  - id: 5
    phase: "build"
    name: "Wheel Validation"
    sub_header: "üîç Validating wheel"
    checks:
      - pass_message: "PEP 427 format valid"
      - pass_message: "Metadata complete"
    summary_on_pass: "Wheel validated"
    emotional_state:
      entry: "Brief attention"
      exit: "Confidence"

  - id: 6
    phase: "build"
    name: "IDE Bundle Build"
    sub_header: "‚öôÔ∏è Building IDE bundle"
    spinner_text: "‚è≥ Processing nWave assets..."
    resolved_text: "‚úÖ IDE bundle built ({duration})"
    detail_lines:
      - "{agent_count} agents, {command_count} commands, {team_count} teams"
      - "{embed_count} embed injections applied"
      - "‚ö†Ô∏è  {yaml_warning_count} YAML warnings (non-blocking)"
      - "  {warning_file}: {warning_reason}"  # repeated for each warning, dim text at 6-space indent
    shared_artifacts:
      - name: "agent_count"
        source: "IDE bundle build output (dist/ide/agents/nw/ file count)"
        displayed_as: "30"
      - name: "command_count"
        source: "IDE bundle build output (dist/ide/commands/nw/ file count)"
        displayed_as: "23"
      - name: "team_count"
        source: "IDE bundle build output (agent-teams dir, 0 when missing)"
        displayed_as: "0"
      - name: "embed_count"
        source: "IDE bundle build log (DES embed injection count)"
        displayed_as: "3"
    emotional_state:
      entry: "Second tension (will the IDE bundle build?)"
      exit: "Relief (all components processed)"
    design_notes: |
      The IDE bundle build processes the nWave/ source directory into
      dist/ide/. It takes ~5.2s. Component counts, embed injection count,
      and YAML warnings are shown. Warnings are non-blocking;
      affected agents are still included in the bundle.

      YAML warnings include BOTH YAML parse errors AND missing YAML
      configuration blocks. Each warning shows the agent filename and
      the specific reason in dim text at 6-space indent. The warning
      count must come from the IDE bundle builder's internal log, NOT
      from its summary output (which currently undercounts to 0).

  - id: 7
    phase: "build"
    name: "Build Complete"
    output: "üî® Build complete"
    detail_lines:
      - "{wheel_filename}"
      - "IDE bundle: {agent_count} agents, {command_count} commands"
    shared_artifacts:
      - name: "wheel_filename"
        source: "BuildResult.wheel_path.name"
        displayed_as: "{wheel_filename}"
    emotional_state:
      entry: "Anticipation of next phase"
      exit: "Satisfaction, both artifacts confirmed"
    design_notes: |
      Build complete is now a sub-phase header with two dim detail lines.
      The build produces two artifacts: wheel + IDE bundle. Both must be
      visible so the user knows what was built before being asked to install.

  - id: 8
    phase: "transition"
    name: "Install Confirmation Prompt"
    output: "üì¶ Install crafter-ai {version}? [Y/n]: "
    interaction: "confirmation_prompt"
    default: "Y (yes)"
    on_yes: "proceed to step 9"
    on_no: "exit with code 0, message: Install skipped."
    shared_artifacts:
      - name: "version"
        source: "Wheel METADATA (via BuildResult)"
        displayed_as: "{version}"
    emotional_state:
      entry: "Build succeeded, anticipation of install"
      exit: "User feels in control, chose to proceed"
    design_notes: |
      The prompt appears after a blank line following build complete.
      It uses the üì¶ emoji to signal the transition to install phase.
      No box or panel. Just an inline prompt in the stream.
      The version shown here MUST match the version from wheel METADATA.

  - id: 9
    phase: "install"
    name: "Install Phase Header"
    output: "üì¶ Installing crafter-ai"
    emotional_state:
      entry: "Momentum continues, user just confirmed"
      exit: "Oriented in new phase"

  - id: 10
    phase: "install"
    name: "Install Pre-flight Checks"
    sub_header: "üîç Pre-flight checks"
    checks:
      - id: "wheel-exists"
        pass_message: "Wheel file found"
        fail_message: "No wheel file found in dist/"
        severity: "BLOCKING"
      - id: "wheel-format"
        pass_message: "Wheel format valid"
        fail_message: "Wheel format invalid"
        severity: "BLOCKING"
      - id: "pipx-isolation"
        pass_message: "pipx environment ready"
        fail_message: "pipx is not installed"
        severity: "BLOCKING"
      - id: "install-path-resolved"
        pass_message: "Install path writable"
        fail_message: "Install path not accessible"
        severity: "BLOCKING"
      - id: "ide-bundle-exists"
        pass_message: "IDE bundle found ({agent_count} agents, {command_count} commands)"
        fail_message: "IDE bundle not found in dist/ide/"
        severity: "BLOCKING"
        remediation: "Run 'crafter-ai forge build' to generate the IDE bundle"
    summary_on_pass: "Pre-flight passed"
    emotional_state:
      entry: "Slight check-in"
      exit: "Green light, let's go"

  - id: 11
    phase: "install"
    name: "Backup"
    condition: "upgrade_path != FRESH_INSTALL"
    sub_header_upgrade: "üíæ Backing up configuration"
    spinner_text: "‚è≥ Creating backup..."
    resolved_text: "‚úÖ Backup saved ({duration})"
    detail_text_upgrade: "{backed_up_items} ‚Üí {backup_path}"
    skip_text_fresh: "üíæ Fresh install, no backup needed"
    shared_artifacts:
      - name: "backup_path"
        source: "BackupResult.backup_path"
        displayed_as: "{backup_path}"
        note: "Only shown for upgrade path. Format: ~/.claude/backups/nwave-install-YYYYMMDD-HHMMSS"
      - name: "backed_up_items"
        source: "FileSystemBackupAdapter.BACKUP_TARGETS (items that existed)"
        displayed_as: "{backed_up_items}"
        note: "Full scope backup: 'agents, commands, templates, scripts, manifest, install log, DES, settings, CLAUDE.md'. Backs up everything nWave touches in ~/.claude/."
    emotional_state:
      entry_upgrade: "Brief concern for existing data"
      exit_upgrade: "Trust (data is explicitly safe, I can see where it went)"
      entry_fresh: "No concern"
      exit_fresh: "Acknowledged, moving on"
    design_notes: |
      Upgrade path: sub-header ‚Üí spinner ‚Üí closure ‚Üí dim detail line showing
      what was backed up and where. The detail line builds trust by showing
      the user exactly where their data went.
      Fresh install: single informational line, no spinner (nothing to do).

  - id: 12
    phase: "install"
    name: "CLI Installation"
    sub_header: "‚öôÔ∏è Installing CLI"
    spinner_text: "‚è≥ Installing via pipx..."
    resolved_text: "‚úÖ nWave CLI installed via pipx ({duration})"
    emotional_state:
      entry: "Peak tension (the big CLI operation, ~3 seconds)"
      exit: "Relief (CLI package installed, timing visible)"
    design_notes: |
      Renamed from "Installing" to "Installing CLI" to distinguish from
      asset deployment. The spinner runs during the ~3-second pipx install,
      filling the silence gap. The closure line uses "nWave CLI" to clarify
      this is the CLI package, not the full asset set.

  - id: 13
    phase: "install"
    name: "Asset Deployment"
    sub_header: "‚öôÔ∏è Deploying nWave assets"
    spinner_text: "‚è≥ Installing to ~/.claude/..."
    resolved_text: "‚úÖ Assets deployed ({duration})"
    detail_lines:
      - "{agent_count} agents ‚Üí ~/.claude/agents/nw/"
      - "{command_count} commands ‚Üí ~/.claude/commands/nw/"
      - "{template_count} templates ‚Üí ~/.claude/templates/"
      - "{script_count} scripts ‚Üí ~/.claude/scripts/"  # 4 scripts: install_nwave_target_hooks.py, validate_step_file.py, check_stale_phases.py, scope_boundary_check.py
    shared_artifacts:
      - name: "deploy_target"
        source: "Hardcoded: ~/.claude/"
        displayed_as: "~/.claude/"
        note: "Must be consistent across deploy detail lines and SBOM asset lines"
    emotional_state:
      entry: "Second peak tension (deploying to user's system)"
      exit: "Transparency (user sees what went where)"
    design_notes: |
      NEW section that copies IDE bundle contents to ~/.claude/.
      Shows four dim detail lines with arrow notation showing what went where.
      Replaces what install_nwave.py does with Rich panels and tables.
      The ‚öôÔ∏è emoji means "active operation in progress".

  - id: 14
    phase: "install"
    name: "Deployment Validation"
    sub_header: "üîç Validating deployment"
    checks:
      - pass_message: "Agents verified ({agent_count})"
      - pass_message: "Commands verified ({command_count})"
      - pass_message: "Templates verified ({template_count})"
      - pass_message: "Scripts verified ({script_count})"
      - pass_message: "Manifest created"
      - pass_message: "Schema validated ({schema_version}, {schema_phases} phases)"
    summary_on_pass: "Deployment validated"
    shared_artifacts:
      - name: "schema_version"
        source: "TDD cycle schema JSON (step-tdd-cycle-schema.json)"
        displayed_as: "v3.0"
      - name: "schema_phases"
        source: "TDD cycle schema JSON phase count"
        displayed_as: "7"
    emotional_state:
      entry: "Brief validation check"
      exit: "Growing trust (everything verified)"
    design_notes: |
      NEW section that replaces the Rich bordered table from install_nwave.py.
      Each component category gets a verification line with count as emoji stream.
      No table borders anywhere. The manifest and schema validation are also here.

  - id: 15
    phase: "install"
    name: "SBOM Manifest"
    sub_header: "üìã What was installed"
    manifest_items_cli_group:
      - "{package_name} {version}"
      - "CLI: {cli_entry_points}"
      - "‚Üí {install_path}"
    manifest_items_ide_group:
      - "{agent_count} agents ‚Üí ~/.claude/agents/nw/"
      - "{command_count} commands ‚Üí ~/.claude/commands/nw/"
      - "{template_count} templates ‚Üí ~/.claude/templates/"
      - "{script_count} scripts ‚Üí ~/.claude/scripts/"  # 4 scripts: install_nwave_target_hooks.py, validate_step_file.py, check_stale_phases.py, scope_boundary_check.py
      - "1 config ‚Üí ~/.claude/agents/nw/config.json"
      - "1 manifest ‚Üí ~/.claude/nwave-manifest.txt"
    shared_artifacts:
      - name: "package_name"
        source: "pyproject.toml [project].name"
        displayed_as: "crafter-ai"
      - name: "version"
        source: "Wheel METADATA (via InstallResult.version)"
        displayed_as: "{version}"
      - name: "cli_entry_points"
        source: "Wheel METADATA [console_scripts]"
        displayed_as: "crafter-ai, nw"
        note: "Parsed from wheel METADATA entry_points. Currently not available from pipx adapter; needs new method or wheel introspection."
      - name: "install_path"
        source: "pipx list_packages() ‚Üí InstalledPackage.path"
        displayed_as: "{install_path}"
    emotional_state:
      entry: "Curiosity (what just happened?)"
      exit: "Full trust (complete transparency on both CLI and IDE assets)"
    design_notes: |
      The SBOM is now split into two groups separated by a blank line:
      CLI package (what pipx installed) and IDE assets (what went to ~/.claude/).
      Every component category is listed with count and destination.
      Nothing is compressed or omitted. All items are dim text at 4-space indent.
      No emojis on individual lines; they are informational, not status.
      The SBOM always shows the full inventory for both fresh and upgrade installs.

  - id: 16
    phase: "install"
    name: "Health Verification"
    sub_header: "ü©∫ Verifying installation"
    checks:
      - pass_message: "CLI responds to --version"
      - pass_message: "Core modules loadable"
      - pass_message: "nWave assets accessible"
    summary_healthy: "Health: HEALTHY"
    summary_degraded: "Health: DEGRADED"
    emotional_state:
      entry: "Final check"
      exit: "Confident or cautious depending on result"
    design_notes: |
      Now includes "nWave assets accessible" check to verify that deployed
      assets in ~/.claude/ are readable by Claude Code.

  - id: 17
    phase: "celebration"
    name: "Celebration"
    healthy_output: |
      üéâ nWave {version} installed and healthy!
         Ready to use in Claude Code.
    degraded_output: |
      ‚ö†Ô∏è  nWave {version} installed with warnings
         Some features may be limited. Run 'crafter-ai doctor' for details.
    failed_output: |
      ‚ùå Installation failed
         {error_message}
    getting_started:
      sub_header: "üìñ Getting started"
      condition: "always (both fresh and upgrade installs)"
      items:
        - "/nw:discuss  - Requirements gathering and business analysis"
        - "/nw:design   - Architecture design with visual representation"
        - "/nw:distill  - Acceptance test creation and business validation"
        - "/nw:develop  - Outside-In TDD implementation with refactoring"
        - "/nw:deliver  - Production readiness validation"
    whats_new:
      sub_header: "üÜï What's new in {version}"
      condition: "only when a changelog entry exists for this version"
      items: "dynamic from changelog"
    shared_artifacts:
      - name: "version"
        source: "Wheel METADATA (via InstallResult.version)"
      - name: "product_name"
        source: "Hardcoded: 'nWave'"
        note: "Product brand name used in user-facing celebration. Package name 'crafter-ai' used in SBOM manifest."
      - name: "health_status"
        source: "HealthChecker result"
      - name: "available_commands"
        source: "Deployed commands in ~/.claude/commands/nw/ (parsed from manifest or file scan)"
        note: "Currently hardcoded to the 5 main wave commands. Could be dynamic from nwave-manifest.txt."
    emotional_state:
      entry: "Anticipation of outcome"
      exit_healthy: "Joy, satisfaction, clear on what to do next"
      exit_degraded: "Cautious optimism, still knows available commands"
      exit_failed: "Clarity on what went wrong, path to fix"
    design_notes: |
      The celebration is the emotional peak, followed by actionable guidance.
      The "Getting started" section ALWAYS shows available /nw: commands,
      because even upgrade users may discover new commands. The "What's new"
      section is conditional; it only appears when a changelog entry exists
      for this version. Both sections use dim text at 4-space indent.
      This replaces the old Rich panel that dumped all commands in a box.

error_states:
  blocking_preflight:
    pattern: |
      Show all checks (pass and fail mixed)
      Blank line
      Summary: "{Phase} blocked: {count} checks failed"
      Blank line
      Repeat ONLY failures with remediation:
        ‚ùå {failure.message}
           Fix: {failure.remediation}
    exit_code: 1

  build_failure:
    pattern: |
      ‚ùå Build failed
      Blank line
      Error: {error_message}
      Fix: {remediation if available}
    exit_code: 1

  ide_bundle_build_failure:
    pattern: |
      ‚ùå IDE bundle build failed
      Blank line
      Error: {error_message}
      Fix: {remediation if available}
    exit_code: 1

  install_failure:
    pattern: |
      ‚ùå Installation failed
      Blank line
      Error: {error_message}
      Fix: {remediation if available}
    exit_code: 1

  asset_deployment_failure:
    pattern: |
      ‚ùå Asset deployment failed
      Blank line
      Error: {error_message}
      Fix: {remediation if available}
    exit_code: 1

  deployment_validation_failure:
    pattern: |
      Show all validation checks (pass and fail mixed)
      Blank line
      Summary: "Deployment validation failed: {count} check(s) failed"
      Blank line
      Repeat ONLY failures with remediation:
        ‚ùå {failure.message}
           Fix: {failure.remediation}
    exit_code: 1

interaction_patterns:
  spinner_to_persistent_line:
    description: "Spinner replaces itself, then a persistent line is printed"
    implementation: |
      status = console.status("‚è≥ {action}...")
      status.start()
      result = do_work()
      status.stop()
      console.print("{emoji} {result_message} ({duration})")

  confirmation_prompt:
    description: "Inline prompt with emoji matching current phase"
    format: "üì¶ Install crafter-ai {version}? [Y/n]: "
    default: "Y (yes)"

  check_list_streaming:
    description: "Each check prints as it completes, giving a streaming feel"
    note: "Even if checks run fast, the visual of lines appearing builds confidence"

  sub_phase_with_spinner:
    description: "Section header + spinner + closure + optional detail"
    implementation: |
      console.print("  {section_emoji} {Section Title}")
      status = console.status("  ‚è≥ {action}...")
      status.start()
      result = do_work()
      status.stop()
      console.print("  ‚úÖ {closure_message} ({duration})")
      if detail:
          console.print(f"[dim]    {detail_text}[/dim]")
    note: "Used by backup, CLI install, and asset deployment sections. The section header names the operation; the spinner provides feedback; the closure confirms completion."

  sbom_manifest:
    description: "Post-install transparency showing what was installed (dual-group format)"
    implementation: |
      console.print("  üìã What was installed")
      # CLI package group
      console.print(f"[dim]    {package_name} {version}[/dim]")
      console.print(f"[dim]    CLI: {entry_points}[/dim]")
      console.print(f"[dim]    ‚Üí {install_path}[/dim]")
      console.print()  # blank line separates CLI from IDE assets
      # IDE assets group
      console.print(f"[dim]    {agents} agents ‚Üí ~/.claude/agents/nw/[/dim]")
      console.print(f"[dim]    {commands} commands ‚Üí ~/.claude/commands/nw/[/dim]")
      console.print(f"[dim]    {templates} templates ‚Üí ~/.claude/templates/[/dim]")
      console.print(f"[dim]    {script_count} scripts ‚Üí ~/.claude/scripts/[/dim]")
      console.print(f"[dim]    1 config ‚Üí ~/.claude/agents/nw/config.json[/dim]")
      console.print(f"[dim]    1 manifest ‚Üí ~/.claude/nwave-manifest.txt[/dim]")
    note: "No emojis on manifest items. All dim text at 4-space indent. Always shows full inventory for both fresh and upgrade installs."

shared_artifacts:
  version:
    source_of_truth: "Wheel METADATA file (METADATA inside the .whl archive)"
    data_flow: "pyproject.toml ‚Üí build process ‚Üí wheel METADATA ‚Üí all displays"
    canonical_runtime_path: "InstallResult.version (parsed from wheel METADATA)"
    consumers:
      - "Step 3: Version display line (via VersionBumpService during build)"
      - "Step 7: Build complete detail line (embedded in wheel filename)"
      - "Step 8: Install confirmation prompt"
      - "Step 15: SBOM manifest (package identity line)"
      - "Step 17: Celebration message"
    integration_risk: "HIGH"
    risk_explanation: "Version appears in 5 places. The wheel METADATA is the single source. All displays must trace back to it."
    validation: "All 5 displays must show identical version string originating from wheel METADATA"

  product_name:
    source_of_truth: "Hardcoded string: 'nWave'"
    consumers:
      - "Step 12: CLI install closure line ('nWave CLI installed via pipx')"
      - "Step 17: Celebration message ('nWave {version} installed and healthy!')"
    integration_risk: "LOW"
    risk_explanation: "Brand name is intentionally different from package_name. If product renames, update these two locations."
    validation: "Both displays use identical product name string"

  wheel_filename:
    source_of_truth: "BuildResult.wheel_path.name"
    consumers:
      - "Step 7: Build complete detail line"
    integration_risk: "LOW"
    validation: "Filename matches built artifact"

  agent_count:
    source_of_truth: "IDE bundle build output (dist/ide/agents/nw/ file count)"
    data_flow: "nWave/ source ‚Üí build.py ‚Üí dist/ide/ ‚Üí install pre-flight ‚Üí deploy ‚Üí validation ‚Üí SBOM"
    consumers:
      - "Step 6: IDE bundle detail line"
      - "Step 7: Build complete detail line"
      - "Step 10: Install pre-flight check"
      - "Step 13: Asset deployment detail line"
      - "Step 14: Deployment validation"
      - "Step 15: SBOM manifest"
    integration_risk: "MEDIUM"
    risk_explanation: "Count appears in 6 places across build and install. Must originate from same build output."
    validation: "All 6 displays show identical count from IDE bundle build"

  command_count:
    source_of_truth: "IDE bundle build output (dist/ide/commands/nw/ file count)"
    data_flow: "nWave/ source ‚Üí build.py ‚Üí dist/ide/ ‚Üí install pre-flight ‚Üí deploy ‚Üí validation ‚Üí SBOM"
    consumers:
      - "Step 6: IDE bundle detail line"
      - "Step 7: Build complete detail line"
      - "Step 10: Install pre-flight check"
      - "Step 13: Asset deployment detail line"
      - "Step 14: Deployment validation"
      - "Step 15: SBOM manifest"
    integration_risk: "MEDIUM"
    risk_explanation: "Count appears in 6 places across build and install. Must originate from same build output."
    validation: "All 6 displays show identical count from IDE bundle build"

  template_count:
    source_of_truth: "Post-deployment scan of ~/.claude/templates/"
    consumers:
      - "Step 13: Asset deployment detail line"
      - "Step 14: Deployment validation"
      - "Step 15: SBOM manifest"
    integration_risk: "LOW"
    validation: "Count matches actual file count in ~/.claude/templates/"

  script_count:
    source_of_truth: "Post-deployment scan of ~/.claude/scripts/"
    consumers:
      - "Step 13: Asset deployment detail line"
      - "Step 14: Deployment validation"
      - "Step 15: SBOM manifest"
    integration_risk: "LOW"
    validation: "Count matches actual file count in ~/.claude/scripts/"

  deploy_target:
    source_of_truth: "Hardcoded: ~/.claude/"
    consumers:
      - "Step 13: Asset deployment detail lines"
      - "Step 15: SBOM manifest asset lines"
    integration_risk: "HIGH"
    risk_explanation: "Deploy target path must be consistent across deployment and SBOM. If hardcoded differently in two places, assets go to wrong location."
    validation: "All deployment and SBOM paths use identical deploy_target constant"

  schema_version:
    source_of_truth: "TDD cycle schema JSON (step-tdd-cycle-schema.json)"
    consumers:
      - "Step 14: Deployment validation line"
    integration_risk: "LOW"
    validation: "Version matches actual deployed schema file"

  install_path:
    source_of_truth: "pipx list_packages() ‚Üí InstalledPackage.path"
    data_flow: "pipx install ‚Üí pipx list --json ‚Üí InstalledPackage.path"
    consumers:
      - "Step 15: SBOM manifest (CLI install location line)"
    integration_risk: "MEDIUM"
    risk_explanation: "Install path displayed to user must match actual pipx venv location. If pipx changes its path scheme, the display breaks."
    validation: "Displayed path matches result from pipx list_packages() for crafter-ai"

  cli_entry_points:
    source_of_truth: "Wheel METADATA [console_scripts] section"
    consumers:
      - "Step 15: SBOM manifest (CLI commands line)"
    integration_risk: "MEDIUM"
    risk_explanation: "Entry points shown in SBOM must match what pipx actually registered. Currently not parsed from wheel; needs implementation."
    validation: "Displayed entry points match wheel METADATA console_scripts entries"
    implementation_note: |
      NOT YET AVAILABLE in current codebase. Options:
      1. Parse wheel METADATA (zipfile introspection) - clean, dynamic
      2. Hardcode known values ("crafter-ai, nw") - pragmatic, brittle
      3. Parse pipx install stdout which lists registered apps - depends on pipx output format
      Recommendation: Start with option 2, implement option 1 when refactoring pipx adapter.

  backup_path:
    source_of_truth: "BackupResult.backup_path"
    consumers:
      - "Step 11: Backup detail line (upgrade path only)"
    integration_risk: "LOW"
    validation: "Displayed path matches BackupResult.backup_path and directory exists on disk"

  health_status:
    source_of_truth: "HealthChecker result"
    consumers:
      - "Step 16: Health verification summary"
      - "Step 17: Celebration message tone (üéâ vs ‚ö†Ô∏è)"
    integration_risk: "MEDIUM"
    risk_explanation: "Health status determines celebration variant"
    validation: "Same HealthStatus enum value drives both displays"

  package_name:
    source_of_truth: "pyproject.toml [project].name"
    consumers:
      - "Step 1: Build header"
      - "Step 9: Install header"
      - "Step 15: SBOM manifest (package identity line)"
    integration_risk: "LOW"
    validation: "Consistent package name across all three locations"
