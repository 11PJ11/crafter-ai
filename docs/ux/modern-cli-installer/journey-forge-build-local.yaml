# Journey Schema: Build nWave Local Candidate (forge:build-local-candidate)
# Designer: Luna (leanux-designer)
# Date: 2026-02-01
# Epic: modern_CLI_installer

schema_version: "1.0"
journey_type: "build"

journey:
  name: "forge-build-local-candidate"
  goal: "Build a pipx-compatible candidate wheel with semantic versioning"

  version_strategy:
    description: "Candidate versioning for local development iteration"
    format: "M.m.p-dev-YYYYMMDD-sequence"
    example_flow:
      - "pyproject.toml: 1.2.0 (current)"
      - "Conventional commits analyzed → MINOR bump"
      - "New version: 1.3.0"
      - "Candidate: 1.3.0-dev-20260201-001"
      - "Iterate: 1.3.0-dev-20260201-002, ..., 1.3.0-dev-20260201-005"
      - "PR merged to main → CI/CD releases 1.3.0 (final)"
    bump_sources:
      - "conventional_commits: Analyze git history for feat/fix/breaking"
      - "force_version: User-specified version (must be > current)"

  persona:
    name: "The Contributor"
    role: "Developer modifying or extending nWave"
    triggers:
      - "After modifying core nWave code - verify package still builds"
      - "Before PR/release - pre-flight check everything is packaged properly"
      - "Testing custom agents - test them in installed context, not dev mode"

  emotional_arc:
    start: "Focused"
    middle: "Confident"
    end: "Accomplished"
    pattern: "trust_building"

  success_criteria:
    - "Pre-flight checks all pass"
    - "Wheel built successfully in dist/"
    - "Wheel validated for pipx compatibility"
    - "User prompted for local install"
    - "Clear next steps provided"

  use_cases:
    - id: "uc-1"
      name: "Verify build after code changes"
      description: "Developer modifies nWave code and wants to verify package still builds correctly"

    - id: "uc-2"
      name: "Pre-release validation"
      description: "Developer preparing PR or release, needs pre-flight check that everything packages properly"

    - id: "uc-3"
      name: "Test custom agents in installed context"
      description: "Developer added custom agents and wants to test them as if installed, not dev mode"

    - id: "uc-4"
      name: "Validate pyproject.toml dependencies"
      description: "Developer updated dependencies and wants to verify they resolve correctly in built wheel"

steps:
  - id: 1
    name: "Pre-flight Checks"
    command: "forge:build-local-candidate"

    tui_mockup: |
      Validating build environment...

      +--------------------------------------------------+
      |  Check              Status    Details            |
      |  ------------------------------------------------|
      |  Python version     [check]   3.12.1 (3.10+ OK)  |
      |  build package      [check]   v1.2.1 installed   |
      |  pyproject.toml     [check]   Valid, v${version} |
      |  Source directory   [check]   nWave/ found       |
      |  dist/ directory    [check]   Writable           |
      +--------------------------------------------------+

      [check] All pre-flight checks passed!

    pre_flight_checks:
      - check: "python_version"
        requirement: "3.10+"
        display: "Python version"
        fixable: false

      - check: "build_package"
        requirement: "build package installed"
        display: "build package"
        fixable: true
        fix_prompt: "Install it now? [Y/n]"
        fix_command: "pip install build"

      - check: "pyproject_toml"
        requirement: "Valid pyproject.toml with version"
        display: "pyproject.toml"
        fixable: false

      - check: "source_directory"
        requirement: "nWave/ directory exists"
        display: "Source directory"
        fixable: false

      - check: "dist_directory"
        requirement: "dist/ directory writable"
        display: "dist/ directory"
        fixable: true
        fix_prompt: "Create dist/ directory? [Y/n]"
        fix_command: "mkdir -p dist"

    shared_artifacts:
      - name: "version"
        source: "pyproject.toml [project.version]"
        displayed_as: "${version}"
        validation: "Must be valid semver"

    emotional_state:
      entry: "Focused - let's make sure everything is ready"
      exit: "Confident - environment validated"

    error_paths:
      - condition: "python_version < 3.10"
        severity: "blocking"
        message: |
          [x] Python version too old

          Required: Python 3.10+
          Found:    Python ${python_version}
        recovery: "Upgrade Python using pyenv, brew, or python.org"

      - condition: "build_package_missing"
        severity: "fixable"
        message: |
          [x] Pre-flight check failed: build package missing

          The 'build' package is required to create Python wheels.

          Install it now? [Y/n]
        recovery: "Auto-install via pip install build"

      - condition: "pyproject_toml_invalid"
        severity: "blocking"
        message: |
          [x] Pre-flight check failed: pyproject.toml invalid

          Error at line ${line_number}: ${error_message}
        recovery: "Fix pyproject.toml and re-run forge:build-local-candidate"

      - condition: "pyproject_toml_missing"
        severity: "blocking"
        message: |
          [x] pyproject.toml not found

          forge:build-local-candidate must be run from the nWave project root directory.
        recovery: "cd to project root and re-run"

  - id: 2
    name: "Version Bumping"
    command: null  # Automatic after pre-flight

    tui_mockup: |
      [tag] Resolving candidate version...

      +--------------------------------------------------+
      |  Current version   ${base_version} (pyproject.toml)|
      |  Branch            ${branch_name}                 |
      |  Last tag          v${last_tag_version}           |
      +--------------------------------------------------+

      [magnifier] Analyzing conventional commits...

      +--------------------------------------------------+
      |  Bump type: ${bump_type} (from commit analysis)  |
      +--------------------------------------------------+

      [check] Version bump: ${base_version} → ${new_version}
      [check] Candidate:    ${candidate_version}

    version_resolution:
      sources:
        - source: "conventional_commits"
          description: "Analyze git log for feat/fix/BREAKING CHANGE"
          priority: 1
        - source: "force_version"
          description: "User override via --force-version flag"
          priority: 0
          constraint: "Must be > current version"

      bump_rules:
        - pattern: "BREAKING CHANGE|!:"
          bump: "major"
        - pattern: "^feat"
          bump: "minor"
        - pattern: "^fix"
          bump: "patch"

      candidate_format:
        pattern: "M.m.p-dev-YYYYMMDD-seq"
        date_format: "YYYYMMDD"
        sequence: "Daily counter starting at 001"
        example: "1.3.0-dev-20260201-001"

    shared_artifacts:
      - name: "base_version"
        source: "pyproject.toml [project.version]"
        displayed_as: "${base_version}"
        example_value: "1.2.0"

      - name: "new_version"
        source: "Calculated from conventional commits or --force-version"
        displayed_as: "${new_version}"
        example_value: "1.3.0"

      - name: "candidate_version"
        source: "Generated: M.m.p-dev-YYYYMMDD-seq"
        displayed_as: "${candidate_version}"
        example_value: "1.3.0-dev-20260201-001"
        consumers:
          - "Step 3: Build wheel filename"
          - "Step 4: Validation display"
          - "Step 5: Summary display"
          - "Step 6: Install prompt"
          - "Handoff to forge:install-local-candidate"
        integration_risk: "HIGH"
        risk_explanation: "Candidate version flows through all subsequent steps"

      - name: "branch_name"
        source: "git rev-parse --abbrev-ref HEAD"
        displayed_as: "${branch_name}"
        example_value: "feature/add-luna-agent"

      - name: "daily_sequence"
        source: "Counter for builds on same day"
        displayed_as: "${sequence}"
        example_value: "001"

    emotional_state:
      entry: "Focused - environment validated"
      exit: "Anticipation - version resolved, ready to build"

    error_paths:
      - condition: "force_version_too_low"
        severity: "blocking"
        message: |
          [x] Force version rejected

          Current version: ${base_version}
          Forced version:  ${force_version}

          Force version must be higher than current.
        recovery: "Use --force-version with a higher version number"

      - condition: "no_commits_since_tag"
        severity: "warning"
        message: |
          [warn] No commits since last tag v${last_tag_version}

          Building with same version as candidate.
        recovery: "Proceed with current version or specify --force-version"

  - id: 3
    name: "Build Process"
    command: null  # Automatic after version resolution

    tui_mockup: |
      [hammer] Building nWave wheel...

      +--------------------------------------------------+
      |  Phase                    Status                 |
      |  ------------------------------------------------|
      |  Cleaning dist/           [check] Removed old    |
      |  Processing source        [check] ${file_count}  |
      |  Running build backend    [check] Complete       |
      +--------------------------------------------------+

      Duration: ${build_duration}

    phases:
      - phase: "clean"
        display: "Cleaning dist/"
        description: "Remove old wheel files to avoid conflicts"

      - phase: "process"
        display: "Processing source"
        description: "Process nWave source files for bundling"

      - phase: "build"
        display: "Running build backend"
        description: "Execute python -m build to create wheel"

    shared_artifacts:
      - name: "file_count"
        source: "Runtime count of processed source files"
        displayed_as: "${file_count} files"

      - name: "build_duration"
        source: "Runtime duration calculation"
        displayed_as: "${build_duration}"
        example_value: "2.3 seconds"

    emotional_state:
      entry: "Confident"
      exit: "Satisfaction - it worked!"

    error_paths:
      - condition: "build_backend_failure"
        severity: "blocking"
        message: |
          [x] Build failed

          Error from build backend (setuptools):
          ${error_message}

          Suggested fix: ${suggested_fix}
        recovery: "Fix the error and re-run forge:build-local-candidate"

      - condition: "existing_wheel_conflict"
        severity: "warning"
        message: |
          [warn] Existing wheel found with same version

          Found: dist/nwave-${candidate_version}-py3-none-any.whl
          Built: ${existing_wheel_timestamp}

          Overwrite existing wheel? [Y/n]
        recovery: "Prompt user to overwrite or abort"

  - id: 4
    name: "Wheel Validation"
    command: null  # Automatic after build

    tui_mockup: |
      [magnifier] Validating wheel contents...

      +--------------------------------------------------+
      |  Wheel: nwave-${candidate_version}-py3-none-any.whl        |
      +--------------------------------------------------+

      +--------------------------------------------------+
      |  Validation               Status                 |
      |  ------------------------------------------------|
      |  Wheel format             [check] Valid          |
      |  Metadata present         [check] pyproject.toml |
      |  Entry points             [check] nw CLI defined |
      |  Agents bundled           [check] ${agent_count} |
      |  Commands bundled         [check] ${command_count}|
      |  Templates bundled        [check] ${template_count}|
      |  pipx compatible          [check] Verified       |
      +--------------------------------------------------+

      [check] Wheel validation passed!

    validations:
      - validation: "wheel_format"
        display: "Wheel format"
        description: "Verify wheel file structure is valid"

      - validation: "metadata_present"
        display: "Metadata present"
        description: "Verify pyproject.toml metadata is bundled"

      - validation: "entry_points"
        display: "Entry points"
        description: "Verify nw CLI entry point is defined"

      - validation: "agents_bundled"
        display: "Agents bundled"
        description: "Verify agent files are included"

      - validation: "commands_bundled"
        display: "Commands bundled"
        description: "Verify command files are included"

      - validation: "templates_bundled"
        display: "Templates bundled"
        description: "Verify template files are included"

      - validation: "pipx_compatible"
        display: "pipx compatible"
        description: "Verify wheel can be installed via pipx"

    shared_artifacts:
      - name: "agent_count"
        source: "Runtime count of bundled agents in wheel"
        displayed_as: "${agent_count}"
        validation: "Must match source count"
        consumers:
          - "Step 3: Validation table"
          - "Step 4: Summary table"

      - name: "command_count"
        source: "Runtime count of bundled commands in wheel"
        displayed_as: "${command_count}"
        validation: "Must match source count"
        consumers:
          - "Step 3: Validation table"
          - "Step 4: Summary table"

      - name: "template_count"
        source: "Runtime count of bundled templates in wheel"
        displayed_as: "${template_count}"
        validation: "Must match source count"
        consumers:
          - "Step 3: Validation table"
          - "Step 4: Summary table"

    emotional_state:
      entry: "Satisfaction"
      exit: "Trust - verified working"

    integration_checkpoint:
      - "${version} in wheel filename matches pyproject.toml"
      - "All source files are bundled in wheel"
      - "Wheel structure is valid for pipx"

  - id: 5
    name: "Success Summary"
    command: null  # Automatic display

    tui_mockup: |
      +--------------------------------------------------+
      |  [hammer] FORGE: BUILD COMPLETE                  |
      +--------------------------------------------------+

      [sparkles] nWave v${version} wheel built successfully!

      +--------------------------------------------------+
      |  Artifact          Location                      |
      |  ------------------------------------------------|
      |  [package] Wheel   ${wheel_path}                 |
      |  [ruler] Size      ${wheel_size}                 |
      |  [clock] Built     ${build_timestamp}            |
      +--------------------------------------------------+

      +--------------------------------------------------+
      |  Contents                     Count              |
      |  ------------------------------------------------|
      |  [robot] Agents               ${agent_count}     |
      |  [zap] Commands               ${command_count}   |
      |  [clipboard] Templates        ${template_count}  |
      +--------------------------------------------------+

    shared_artifacts:
      - name: "wheel_path"
        source: "Generated from version: dist/nwave-${candidate_version}-py3-none-any.whl"
        displayed_as: "${wheel_path}"
        consumers:
          - "Step 4: Artifact table"
          - "Step 5: Install command"
        integration_risk: "LOW"
        risk_explanation: "Derived deterministically from version"

      - name: "wheel_size"
        source: "Runtime file size calculation"
        displayed_as: "${wheel_size}"
        example_value: "2.3 MB"

      - name: "build_timestamp"
        source: "Runtime timestamp"
        displayed_as: "${build_timestamp}"
        example_value: "2026-02-01 14:23:45"

      - name: "version"
        source: "pyproject.toml [project.version]"
        displayed_as: "v${version}"
        consumers:
          - "Step 1: Pre-flight validation"
          - "Step 3: Wheel filename"
          - "Step 4: Summary header"
          - "Step 5: Install prompt"
        integration_risk: "HIGH"
        risk_explanation: "Version mismatch would break install flow"

    emotional_state:
      entry: "Trust"
      exit: "Accomplished - done, ready to test!"

  - id: 6
    name: "Install Prompt"
    command: null  # Prompted action

    tui_mockup: |
      Your wheel is ready for testing!

      +--------------------------------------------------+
      |  [info] Test this wheel locally?                 |
      |                                                  |
      |  This will install nwave-${version} to a local   |
      |  pipx environment for testing.                   |
      |                                                  |
      |  Install locally now? [Y/n]                      |
      +--------------------------------------------------+

    prompted_flow:
      prompt: "Install locally now? [Y/n]"
      default: "Y"

      on_yes:
        action: "handoff_to_install_local"
        command: "pipx install ${wheel_path} --force"
        tui_mockup: |
          Installing wheel locally...

          [spinner] pipx install ${wheel_path} --force

          ... (install-nwave journey continues) ...

      on_no:
        action: "display_manual_instructions"
        tui_mockup: |
          Your wheel is ready for testing!

          Install locally now? [Y/n] n

          +--------------------------------------------------+
          |  To install manually, run:                       |
          |                                                  |
          |  pipx install ${wheel_path} --force              |
          |                                                  |
          |  Or to test in development mode:                 |
          |                                                  |
          |  pip install -e .                                |
          +--------------------------------------------------+

          [book] Docs: https://nwave.dev/contributing/local-dev

    shared_artifacts:
      - name: "wheel_path"
        source: "Propagated from Step 4"
        displayed_as: "${wheel_path}"
        validation: "Must match Step 4"

      - name: "docs_url"
        source: "nWave/data/config/urls.yaml [docs.contributing.local_dev]"
        displayed_as: "https://nwave.dev/contributing/local-dev"

    emotional_state:
      entry: "Accomplished"
      exit: "Guided - I know what to do next"

    integration_checkpoint:
      - "${wheel_path} is valid and exists"
      - "pipx install command will use correct wheel"
      - "Handoff to install-local journey is seamless"

shared_artifacts:
  version:
    source_of_truth: "pyproject.toml [project.version]"
    displayed_as: "${version}"
    example_value: "1.3.0"
    consumers:
      - "Step 1: Pre-flight check"
      - "Step 3: Wheel filename validation"
      - "Step 4: Summary header"
      - "Step 5: Install prompt"
    owner: "build system"
    integration_risk: "HIGH"
    risk_explanation: "Version mismatch between steps would confuse users and break install"
    validation: "All displays must show same version"

  wheel_path:
    source_of_truth: "Generated from version: dist/nwave-${candidate_version}-py3-none-any.whl"
    displayed_as: "${wheel_path}"
    example_value: "dist/nwave-1.3.0-dev-20260201-001-py3-none-any.whl"
    consumers:
      - "Step 4: Artifact location"
      - "Step 5: Install command"
      - "Handoff to install-local journey"
    owner: "build system"
    integration_risk: "LOW"
    risk_explanation: "Derived deterministically from version"
    validation: "File must exist after build"

  agent_count:
    source_of_truth: "Runtime count of bundled agents in wheel"
    displayed_as: "${agent_count}"
    example_value: "47"
    cross_journey_note: "Must match install-nwave and forge:install-local-candidate"
    consumers:
      - "Step 3: Validation table"
      - "Step 4: Contents table"
    owner: "build system"
    integration_risk: "LOW"
    risk_explanation: "Count is cosmetic but should match source"
    validation: "Must match source nWave/agents/ count"

  command_count:
    source_of_truth: "Runtime count of bundled commands in wheel"
    displayed_as: "${command_count}"
    example_value: "23"
    cross_journey_note: "Must match install-nwave and forge:install-local-candidate"
    consumers:
      - "Step 3: Validation table"
      - "Step 4: Contents table"
    owner: "build system"
    integration_risk: "LOW"
    risk_explanation: "Count is cosmetic but should match source"
    validation: "Must match source count"

  template_count:
    source_of_truth: "Runtime count of bundled templates in wheel"
    displayed_as: "${template_count}"
    example_value: "12"
    cross_journey_note: "Must match install-nwave and forge:install-local-candidate"
    consumers:
      - "Step 3: Validation table"
      - "Step 4: Contents table"
    owner: "build system"
    integration_risk: "LOW"
    risk_explanation: "Count is cosmetic but should match source"
    validation: "Must match source count"

  wheel_size:
    source_of_truth: "Runtime file size calculation"
    displayed_as: "${wheel_size}"
    example_value: "2.3 MB"
    consumers:
      - "Step 4: Artifact table"
    owner: "build system"
    integration_risk: "LOW"
    risk_explanation: "Informational only"

  build_timestamp:
    source_of_truth: "Runtime timestamp at build completion"
    displayed_as: "${build_timestamp}"
    example_value: "2026-02-01 14:23:45"
    consumers:
      - "Step 4: Artifact table"
    owner: "build system"
    integration_risk: "LOW"
    risk_explanation: "Informational only"

  build_duration:
    source_of_truth: "Runtime duration from start to finish"
    displayed_as: "${build_duration}"
    example_value: "2.3 seconds"
    consumers:
      - "Step 2: Build completion"
    owner: "build system"
    integration_risk: "LOW"
    risk_explanation: "Informational only"

integration_validation:
  shared_artifact_consistency:
    - artifact: "version"
      must_match_across: [1, 3, 4, 5]
      failure_message: "Version mismatch detected - check pyproject.toml propagation"

    - artifact: "agent_count"
      must_match_across: [3, 4]
      failure_message: "Agent count mismatch - verify wheel bundling"

    - artifact: "command_count"
      must_match_across: [3, 4]
      failure_message: "Command count mismatch - verify wheel bundling"

    - artifact: "template_count"
      must_match_across: [3, 4]
      failure_message: "Template count mismatch - verify wheel bundling"

    - artifact: "wheel_path"
      must_match_across: [4, 5]
      failure_message: "Wheel path mismatch - verify path propagation"

  cross_journey_integration:
    - journey: "install-nwave"
      integration_point: "Step 5 handoff"
      shared_artifacts:
        - "wheel_path (local wheel replaces PyPI download)"
        - "version (must match wheel)"
      validation: "install-nwave journey accepts local wheel path"

error_paths:
  - id: "err-1"
    name: "pyproject.toml Not Found"
    detection: "pyproject.toml file does not exist in current directory"
    severity: "blocking"
    recovery_path: "cd to project root and re-run"

  - id: "err-2"
    name: "pyproject.toml Invalid"
    detection: "pyproject.toml cannot be parsed or has invalid structure"
    severity: "blocking"
    recovery_path: "Fix syntax error and re-run"

  - id: "err-3"
    name: "build Package Missing"
    detection: "python -m build not available"
    severity: "fixable"
    recovery_path: "Auto-install via pip install build"
    interactive_repair: true

  - id: "err-4"
    name: "Python Version Too Old"
    detection: "python --version < 3.10"
    severity: "blocking"
    recovery_path: "Upgrade Python"

  - id: "err-5"
    name: "Build Backend Failure"
    detection: "python -m build returns non-zero exit code"
    severity: "blocking"
    recovery_path: "Fix reported error and re-run"

  - id: "err-6"
    name: "Existing Wheel Conflict"
    detection: "Wheel with same version already exists in dist/"
    severity: "warning"
    recovery_path: "Prompt to overwrite or abort"
    interactive_repair: true

  - id: "err-7"
    name: "Permission Denied"
    detection: "Cannot write to dist/ directory"
    severity: "blocking"
    recovery_path: "Fix permissions on dist/ directory"

  - id: "err-8"
    name: "Source Directory Missing"
    detection: "nWave/ directory does not exist"
    severity: "blocking"
    recovery_path: "Ensure nWave/ source directory exists"

error_handling_strategy:
  approach: "layered"
  layers:
    - layer: "pre-flight"
      description: "Validate environment before attempting build"
      catches: ["err-1", "err-2", "err-3", "err-4", "err-7", "err-8"]

    - layer: "interactive_repair"
      description: "Offer to fix issues automatically"
      catches: ["err-3", "err-6"]

    - layer: "clear_failure"
      description: "Provide clear error message with suggested fix"
      catches: ["err-1", "err-2", "err-4", "err-5", "err-7", "err-8"]

quality_gates:
  discovery_complete: true
  journey_complete: true
  emotional_coherence: true
  shared_artifacts_tracked: true
  integration_checkpoints_defined: true
  error_paths_comprehensive: true
  interactive_repair_implemented: true
  cross_journey_integration_defined: true

metadata:
  created_by: "Luna (leanux-designer)"
  created_at: "2026-02-01"
  epic: "modern_CLI_installer"
  design_reference: "Astro/Vite - warm, celebratory, guided"
  predecessor_journey: null
  successor_journey: "forge-install-local-candidate"
  related_journeys:
    - "install-nwave (shares install flow)"
  ready_for_review: true
