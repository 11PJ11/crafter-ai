# Shared Pre-flight Checks Schema
# Used by: forge:build-local-candidate, forge:install-local-candidate, install-nwave
# Designer: Luna (leanux-designer)
# Date: 2026-02-01

schema_version: "1.0"
description: "Common pre-flight validation checks shared across installation journeys"

# =============================================================================
# CORE CHECKS (Required by ALL journeys)
# =============================================================================

core_checks:
  - id: "python_version"
    name: "Python Version"
    requirement: "3.10+"
    display: "Python version [check] ${python_version} (3.10+ OK)"
    detection: "python --version"
    fixable: false
    severity: "blocking"
    error_message: |
      [x] Python version too old

      Required: Python 3.10+
      Found:    Python ${python_version}

      Upgrade options:
      - pyenv install 3.12 && pyenv local 3.12
      - brew install python@3.12
      - Download from python.org

  - id: "pipx_available"
    name: "pipx Available"
    requirement: "pipx command accessible"
    display: "pipx [check] Available"
    detection: "which pipx || pipx --version"
    fixable: true
    fix_prompt: "Install pipx now? [Y/n]"
    fix_command: "pip install pipx && pipx ensurepath"
    severity: "blocking"
    error_message: |
      [x] pipx not found

      Install it first:
        pip install pipx
        pipx ensurepath

  - id: "claude_dir_writable"
    name: "Claude Directory Writable"
    requirement: "~/.claude/ directory is writable"
    display: "Write permissions [check] ~/.claude/ writable"
    detection: "test -w ~/.claude/ || mkdir -p ~/.claude/"
    fixable: true
    fix_prompt: "Create ~/.claude/ directory? [Y/n]"
    fix_command: "mkdir -p ~/.claude/"
    severity: "blocking"
    error_message: |
      [x] Cannot write to ~/.claude/

      Check permissions or create manually:
        mkdir -p ~/.claude/
        chmod u+w ~/.claude/

# =============================================================================
# BUILD-SPECIFIC CHECKS (forge:build-local-candidate only)
# =============================================================================

build_checks:
  - id: "build_package"
    name: "Build Package"
    requirement: "build package installed"
    display: "build package [check] v${build_version} installed"
    detection: "python -m build --version"
    fixable: true
    fix_prompt: "Install it now? [Y/n]"
    fix_command: "pip install build"
    severity: "blocking"
    used_by: ["forge:build-local-candidate"]

  - id: "pyproject_toml_exists"
    name: "pyproject.toml Exists"
    requirement: "pyproject.toml file present"
    display: "pyproject.toml [check] Found"
    detection: "test -f pyproject.toml"
    fixable: false
    severity: "blocking"
    used_by: ["forge:build-local-candidate"]

  - id: "pyproject_toml_valid"
    name: "pyproject.toml Valid"
    requirement: "pyproject.toml is parseable TOML with valid structure"
    display: "pyproject.toml [check] Valid, v${version}"
    detection: "python -c 'import tomllib; tomllib.load(open(\"pyproject.toml\", \"rb\"))'"
    fixable: false
    severity: "blocking"
    used_by: ["forge:build-local-candidate"]

  - id: "source_directory"
    name: "Source Directory"
    requirement: "nWave/ source directory exists"
    display: "Source directory [check] nWave/ found"
    detection: "test -d nWave/"
    fixable: false
    severity: "blocking"
    used_by: ["forge:build-local-candidate"]

  - id: "dist_directory"
    name: "dist/ Directory"
    requirement: "dist/ directory writable"
    display: "dist/ directory [check] Writable"
    detection: "test -w dist/ || mkdir -p dist/"
    fixable: true
    fix_prompt: "Create dist/ directory? [Y/n]"
    fix_command: "mkdir -p dist/"
    severity: "blocking"
    used_by: ["forge:build-local-candidate"]

# =============================================================================
# INSTALL-SPECIFIC CHECKS (forge:install-local-candidate, install-nwave)
# =============================================================================

install_checks:
  - id: "wheel_exists"
    name: "Wheel Exists"
    requirement: "Wheel file present in dist/"
    display: "Wheel [check] ${wheel_path} found"
    detection: "test -f ${wheel_path}"
    fixable: false
    severity: "blocking"
    recovery: "Run forge:build-local-candidate first"
    used_by: ["forge:install-local-candidate"]

  - id: "pipx_isolation"
    name: "pipx Isolation"
    requirement: "pipx provides isolated environment"
    display: "pipx isolation [check] Isolated environment ready"
    detection: "pipx list"
    fixable: false
    severity: "blocking"
    used_by: ["forge:install-local-candidate", "install-nwave"]

  - id: "install_path_resolved"
    name: "Install Path"
    requirement: "Install path resolved and accessible"
    display: "Install path [check] ${install_path}"
    detection: "Resolve from env var → config → default"
    fixable: true
    severity: "blocking"
    used_by: ["forge:install-local-candidate", "install-nwave"]

  - id: "claude_code_installed"
    name: "Claude Code Installed"
    requirement: "Claude Code is installed (optional warning)"
    display: "Claude Code [check] Found at ${claude_code_path}"
    detection: "which claude || test -d ~/.claude/"
    fixable: false
    severity: "warning"  # Not blocking - just a heads up
    used_by: ["install-nwave"]
    note: "Optional for forge:install-local-candidate since developer may be testing without Claude Code"

# =============================================================================
# CHECK GROUPS (Which checks apply to which journey)
# =============================================================================

journey_check_groups:
  forge-build-local-candidate:
    core: ["python_version"]
    build: ["build_package", "pyproject_toml_exists", "pyproject_toml_valid", "source_directory", "dist_directory"]
    install: []

  forge-install-local-candidate:
    core: ["python_version", "pipx_available", "claude_dir_writable"]
    build: []
    install: ["wheel_exists", "pipx_isolation", "install_path_resolved"]

  install-nwave:
    core: ["python_version", "pipx_available", "claude_dir_writable"]
    build: []
    install: ["pipx_isolation", "install_path_resolved", "claude_code_installed"]

# =============================================================================
# ERROR HANDLING STRATEGY
# =============================================================================

error_handling:
  approach: "layered"
  layers:
    - layer: "pre-flight"
      description: "Validate environment before attempting action"
      behavior: "Run all checks, collect all failures, display summary"

    - layer: "interactive_repair"
      description: "Offer to fix fixable issues automatically"
      behavior: "For each fixable issue, prompt user and attempt repair"

    - layer: "clear_failure"
      description: "Provide actionable error message with recovery steps"
      behavior: "Show error, suggested fix, and next command to try"

# =============================================================================
# DISPLAY CONVENTIONS
# =============================================================================

display:
  success_icon: "[check]"  # ✓ in TUI
  failure_icon: "[x]"      # ✗ in TUI
  warning_icon: "[warn]"   # ⚠ in TUI
  spinner_icon: "[spinner]"

  table_format: |
    +--------------------------------------------------+
    |  Check              Status    Details            |
    |  ------------------------------------------------|
    |  {check_name}       {status}  {details}          |
    +--------------------------------------------------+
