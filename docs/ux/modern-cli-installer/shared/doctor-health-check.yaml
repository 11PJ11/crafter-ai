# Shared Doctor Health Check Schema
# Used by: forge:install-local-candidate, install-nwave
# Designer: Luna (leanux-designer)
# Date: 2026-02-01

schema_version: "1.0"
description: "Common doctor/verification checks shared across installation journeys"

# =============================================================================
# DOCTOR CHECKS (Post-installation verification)
# =============================================================================

doctor_checks:
  - id: "core_installation"
    name: "Core Installation"
    description: "Verify nWave core is installed correctly"
    display: "Core [check] Installed"
    detection: "Verify nwave package in pipx list"
    severity: "critical"

  - id: "agent_files"
    name: "Agent Files"
    description: "Verify agent files are present in install path"
    display: "Agents [check] ${agent_count} agents"
    detection: "Count files in ${install_path}/agents/"
    severity: "critical"
    artifact: "${agent_count}"

  - id: "command_files"
    name: "Command Files"
    description: "Verify command files are present in install path"
    display: "Commands [check] ${command_count} commands"
    detection: "Count files in ${install_path}/commands/"
    severity: "critical"
    artifact: "${command_count}"

  - id: "template_files"
    name: "Template Files"
    description: "Verify template files are present in install path"
    display: "Templates [check] ${template_count} templates"
    detection: "Count files in ${install_path}/templates/"
    severity: "warning"  # Templates are optional
    artifact: "${template_count}"

  - id: "config_valid"
    name: "Configuration Valid"
    description: "Verify configuration files are valid"
    display: "Config [check] Valid"
    detection: "Parse and validate config files"
    severity: "critical"

  - id: "permissions"
    name: "Permissions"
    description: "Verify file permissions are correct"
    display: "Permissions [check] OK"
    detection: "Check read/execute permissions on installed files"
    severity: "warning"

  - id: "version_match"
    name: "Version Match"
    description: "Verify installed version matches expected"
    display: "Version [check] ${installed_version}"
    detection: "Compare installed version with expected"
    severity: "critical"
    artifact: "${installed_version}"

# =============================================================================
# HEALTH STATUS LEVELS
# =============================================================================

health_status:
  healthy:
    display: "HEALTHY"
    emoji: "stethoscope"
    color: "green"
    condition: "All critical checks pass"

  degraded:
    display: "DEGRADED"
    emoji: "warning"
    color: "yellow"
    condition: "All critical pass, some warnings"

  unhealthy:
    display: "UNHEALTHY"
    emoji: "x"
    color: "red"
    condition: "One or more critical checks fail"

# =============================================================================
# DOCTOR OUTPUT FORMAT
# =============================================================================

output_format:
  tui_mockup: |
    [stethoscope] Doctor verification running...

    +--------------------------------------------------+
    |  Check              Status    Details            |
    |  ------------------------------------------------|
    |  Core               [check]   Installed          |
    |  Agents             [check]   ${agent_count}     |
    |  Commands           [check]   ${command_count}   |
    |  Templates          [check]   ${template_count}  |
    |  Config             [check]   Valid              |
    |  Permissions        [check]   OK                 |
    |  Version            [check]   ${version}         |
    +--------------------------------------------------+

    [stethoscope] Status: HEALTHY

  json_format:
    schema:
      status: "HEALTHY | DEGRADED | UNHEALTHY"
      version: "${version}"
      install_path: "${install_path}"
      checks:
        - name: "check_name"
          status: "pass | fail | warning"
          details: "string"
      counts:
        agents: "${agent_count}"
        commands: "${command_count}"
        templates: "${template_count}"

# =============================================================================
# JOURNEY-SPECIFIC NOTES
# =============================================================================

journey_notes:
  forge-install-local-candidate:
    version_check: "Compare against ${candidate_version} from build"
    additional_checks:
      - "Verify wheel contents match installed files"
      - "Validate release-readiness metadata"

  install-nwave:
    version_check: "Compare against ${version} from PyPI metadata"
    additional_checks:
      - "Verify Claude Code integration (if present)"

# =============================================================================
# INTEGRATION WITH INSTALL JOURNEYS
# =============================================================================

integration:
  triggers:
    - "Automatically after successful pipx install"
    - "Manually via /nw:doctor command"
    - "On Claude Code restart (health check)"

  shared_artifacts:
    - name: "agent_count"
      must_match: "Step 4/5 validation count"
      source: "Runtime count of installed agents"

    - name: "command_count"
      must_match: "Step 4/5 validation count"
      source: "Runtime count of installed commands"

    - name: "template_count"
      must_match: "Step 4/5 validation count"
      source: "Runtime count of installed templates"

    - name: "installed_version"
      must_match: "Expected version from install"
      source: "Installed package metadata"
