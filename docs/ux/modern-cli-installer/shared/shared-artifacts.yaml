# Shared Artifacts Schema
# Central registry of artifacts that flow across journeys
# Designer: Luna (leanux-designer)
# Date: 2026-02-01

schema_version: "1.0"
description: "Artifacts that flow between forge:build-local-candidate, forge:install-local-candidate, and install-nwave"

# =============================================================================
# VERSION ARTIFACTS
# =============================================================================

version_artifacts:
  base_version:
    source_of_truth: "pyproject.toml [project.version]"
    format: "M.m.p (semantic versioning)"
    example: "1.2.0"
    description: "Current version in pyproject.toml before bump"
    used_by: ["forge:build-local-candidate"]
    risk: "LOW"

  new_version:
    source_of_truth: "Calculated from conventional commits or --force-version"
    format: "M.m.p (semantic versioning)"
    example: "1.3.0"
    description: "Bumped version after analyzing commits"
    used_by: ["forge:build-local-candidate"]
    risk: "MEDIUM"

  candidate_version:
    source_of_truth: "Generated: M.m.p-dev-YYYYMMDD-seq"
    format: "M.m.p-dev-YYYYMMDD-seq"
    example: "1.3.0-dev-20260201-001"
    description: "Full candidate version for local development"
    used_by: ["forge:build-local-candidate", "forge:install-local-candidate"]
    consumers:
      - "forge:build-local-candidate Step 2: Version display"
      - "forge:build-local-candidate Step 3: Wheel filename"
      - "forge:build-local-candidate Step 5: Summary display"
      - "forge:build-local-candidate Step 6: Install prompt"
      - "forge:install-local-candidate Step 2: Release readiness"
      - "forge:install-local-candidate Step 4: Doctor verification"
    risk: "HIGH"
    risk_explanation: "Flows through entire local development cycle"

  final_version:
    source_of_truth: "CI/CD pipeline strips -dev suffix"
    format: "M.m.p"
    example: "1.3.0"
    description: "Released version (candidate without -dev suffix)"
    used_by: ["CI/CD", "install-nwave"]
    risk: "HIGH"

# =============================================================================
# PATH ARTIFACTS
# =============================================================================

path_artifacts:
  wheel_path:
    source_of_truth: "Generated: dist/nwave-${candidate_version}-py3-none-any.whl"
    format: "Relative path to wheel file"
    example: "dist/nwave-1.3.0.dev20260131.1-py3-none-any.whl"
    description: "Path to built wheel file"
    used_by: ["forge:build-local-candidate", "forge:install-local-candidate"]
    consumers:
      - "forge:build-local-candidate Step 5: Artifact display"
      - "forge:build-local-candidate Step 6: Install command"
      - "forge:install-local-candidate Step 1: Wheel validation"
      - "forge:install-local-candidate Step 3: Install command"
    risk: "LOW"
    risk_explanation: "Derived deterministically from candidate_version"

  install_path:
    source_of_truth: "Resolution order: NWAVE_INSTALL_PATH env var → config/installer.yaml → default"
    format: "Absolute path"
    default: "~/.claude/agents/nw/"
    example: "~/.claude/agents/nw/"
    description: "Where nWave is installed"
    used_by: ["forge:install-local-candidate", "install-nwave"]
    consumers:
      - "forge:install-local-candidate Step 1: Pre-flight"
      - "forge:install-local-candidate Step 4: Doctor verification"
      - "install-nwave Step 3: Pre-flight"
      - "install-nwave Step 5: Doctor verification"
      - "install-nwave Step 7: /nw:version display"
    risk: "MEDIUM"
    risk_explanation: "Must be consistent across install and verify"

  backup_path:
    source_of_truth: "Generated: ${install_path}.backup-YYYYMMDD-HHMMSS"
    format: "Absolute path with timestamp"
    example: "~/.claude/agents/nw.backup-20260131-143025"
    description: "Backup location for rollback"
    used_by: ["forge:install-local-candidate", "install-nwave"]
    risk: "LOW"

# =============================================================================
# COUNT ARTIFACTS
# =============================================================================

count_artifacts:
  agent_count:
    source_of_truth: "Runtime count of agent files"
    format: "Integer"
    example: "47"
    description: "Number of agent files"
    used_by: ["forge:build-local-candidate", "forge:install-local-candidate", "install-nwave"]
    consumers:
      - "forge:build-local-candidate Step 4: Validation"
      - "forge:build-local-candidate Step 5: Summary"
      - "forge:install-local-candidate Step 4: Doctor"
      - "install-nwave Step 4: Validation"
      - "install-nwave Step 5: Doctor"
      - "install-nwave Step 7: /nw:version"
    validation: "Must match across build, install, and verify"
    risk: "LOW"

  command_count:
    source_of_truth: "Runtime count of command files"
    format: "Integer"
    example: "23"
    description: "Number of command files"
    used_by: ["forge:build-local-candidate", "forge:install-local-candidate", "install-nwave"]
    validation: "Must match across build, install, and verify"
    risk: "LOW"

  template_count:
    source_of_truth: "Runtime count of template files"
    format: "Integer"
    example: "12"
    description: "Number of template files"
    used_by: ["forge:build-local-candidate", "forge:install-local-candidate", "install-nwave"]
    validation: "Must match across build, install, and verify"
    risk: "LOW"

# =============================================================================
# METADATA ARTIFACTS
# =============================================================================

metadata_artifacts:
  branch_name:
    source_of_truth: "git rev-parse --abbrev-ref HEAD"
    format: "String"
    example: "feature/add-luna-agent"
    description: "Current git branch"
    used_by: ["forge:build-local-candidate"]
    risk: "LOW"

  build_timestamp:
    source_of_truth: "Runtime timestamp"
    format: "ISO 8601 or human-readable"
    example: "2026-02-01 14:23:45"
    description: "When the build completed"
    used_by: ["forge:build-local-candidate"]
    risk: "LOW"

  wheel_size:
    source_of_truth: "Runtime file size"
    format: "Human-readable size"
    example: "2.3 MB"
    description: "Size of built wheel"
    used_by: ["forge:build-local-candidate"]
    risk: "LOW"

# =============================================================================
# CROSS-JOURNEY HANDOFF CONTRACTS
# =============================================================================

handoff_contracts:
  build_to_install:
    from_journey: "forge:build-local-candidate"
    to_journey: "forge:install-local-candidate"
    artifacts_passed:
      - "${wheel_path}"
      - "${candidate_version}"
      - "${agent_count}"
      - "${command_count}"
      - "${template_count}"
    validation: "install-local-candidate must verify wheel exists and is valid"

  install_to_verify:
    from_journey: "forge:install-local-candidate"
    to_journey: "Doctor verification"
    artifacts_passed:
      - "${install_path}"
      - "${candidate_version}"
      - "${agent_count}"
      - "${command_count}"
      - "${template_count}"
    validation: "Doctor must verify installed counts match build counts"

  cicd_to_pypi:
    from_journey: "CI/CD pipeline"
    to_journey: "install-nwave (PyPI)"
    artifacts_passed:
      - "${final_version} (candidate_version with -dev stripped)"
      - "${agent_count}"
      - "${command_count}"
      - "${template_count}"
    validation: "PyPI package metadata must match release"

# =============================================================================
# CONSISTENCY VALIDATION RULES
# =============================================================================

consistency_rules:
  - rule: "candidate_version_consistent"
    description: "Candidate version must be same across build and install"
    artifacts: ["candidate_version"]
    journeys: ["forge:build-local-candidate", "forge:install-local-candidate"]
    failure_message: "Candidate version mismatch - wheel may be stale"

  - rule: "counts_consistent"
    description: "Agent/command/template counts must match across all steps"
    artifacts: ["agent_count", "command_count", "template_count"]
    journeys: ["forge:build-local-candidate", "forge:install-local-candidate", "install-nwave"]
    failure_message: "Component count mismatch - verify bundling"

  - rule: "install_path_consistent"
    description: "Install path must be same for install and verify"
    artifacts: ["install_path"]
    journeys: ["forge:install-local-candidate", "install-nwave"]
    failure_message: "Install path mismatch - check config resolution"
