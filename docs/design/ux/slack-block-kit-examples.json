{
  "description": "Slack Block Kit message templates for CI/CD notifications",
  "owner": "leanux-designer (Luna)",
  "last_updated": "2026-01-31",
  "usage": "Dakota can use these as templates in notification service",

  "templates": {
    "red_notification": {
      "description": "Pipeline failure notification (RED)",
      "emotional_tone": "Urgent concern - actionable",
      "blocks": [
        {
          "type": "header",
          "text": {
            "type": "plain_text",
            "text": "üî¥ Pipeline Failed: CI Pipeline",
            "emoji": true
          }
        },
        {
          "type": "section",
          "fields": [
            {
              "type": "mrkdwn",
              "text": "*Branch:*\ninstaller"
            },
            {
              "type": "mrkdwn",
              "text": "*Author:*\n<@U01234ABCD>"
            }
          ]
        },
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "üìù *Fix authentication bug*\nCommit: `a1b2c3d`"
          }
        },
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*‚ùå Failed Jobs:*\n‚Ä¢ test (exit code 1)\n‚Ä¢ lint (ruff formatting)"
          }
        },
        {
          "type": "actions",
          "elements": [
            {
              "type": "button",
              "text": {
                "type": "plain_text",
                "text": "View Run"
              },
              "url": "https://github.com/Undeadgrishnackh/crafter-ai/actions/runs/123",
              "style": "danger"
            },
            {
              "type": "button",
              "text": {
                "type": "plain_text",
                "text": "View Commit"
              },
              "url": "https://github.com/Undeadgrishnackh/crafter-ai/commit/a1b2c3d"
            }
          ]
        },
        {
          "type": "context",
          "elements": [
            {
              "type": "mrkdwn",
              "text": "‚è±Ô∏è Failed at: 2:34 PM"
            }
          ]
        }
      ]
    },

    "green_notification": {
      "description": "Pipeline recovery notification (GREEN)",
      "emotional_tone": "Relief + Celebration",
      "blocks": [
        {
          "type": "header",
          "text": {
            "type": "plain_text",
            "text": "‚úÖ Pipeline Recovered: CI Pipeline",
            "emoji": true
          }
        },
        {
          "type": "section",
          "fields": [
            {
              "type": "mrkdwn",
              "text": "*Branch:*\ninstaller"
            },
            {
              "type": "mrkdwn",
              "text": "*Fixed by:*\n<@U01234ABCD>"
            }
          ]
        },
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "üìù *Fix auth mock in tests*\nCommit: `b2c3d4e`"
          }
        },
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "üéâ *Back to green* after 18 minutes\nRecovery commits: 1"
          }
        },
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*Previously failed:*\n‚Ä¢ test ‚úÖ now passing\n‚Ä¢ lint ‚úÖ now passing"
          }
        },
        {
          "type": "actions",
          "elements": [
            {
              "type": "button",
              "text": {
                "type": "plain_text",
                "text": "View Run"
              },
              "url": "https://github.com/Undeadgrishnackh/crafter-ai/actions/runs/124",
              "style": "primary"
            },
            {
              "type": "button",
              "text": {
                "type": "plain_text",
                "text": "View Commit"
              },
              "url": "https://github.com/Undeadgrishnackh/crafter-ai/commit/b2c3d4e"
            }
          ]
        },
        {
          "type": "context",
          "elements": [
            {
              "type": "mrkdwn",
              "text": "üü¢ All systems healthy"
            }
          ]
        }
      ]
    },

    "green_notification_teammate_fix": {
      "description": "Pipeline recovery by teammate (different author)",
      "emotional_tone": "Gratitude + Team reassurance",
      "blocks": [
        {
          "type": "header",
          "text": {
            "type": "plain_text",
            "text": "‚úÖ Pipeline Recovered: CI Pipeline",
            "emoji": true
          }
        },
        {
          "type": "section",
          "fields": [
            {
              "type": "mrkdwn",
              "text": "*Branch:*\ninstaller"
            },
            {
              "type": "mrkdwn",
              "text": "*Fixed by:*\n<@U56789EFGH>"
            }
          ]
        },
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "üìù *Fix Mike's auth issue*\nCommit: `c3d4e5f`"
          }
        },
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "üéâ *Back to green* after 2h 34m\nRecovery commits: 3"
          }
        },
        {
          "type": "section",
          "text": {
            "type": "mrkdwn",
            "text": "*Previously failed:*\n‚Ä¢ test ‚úÖ now passing"
          }
        },
        {
          "type": "actions",
          "elements": [
            {
              "type": "button",
              "text": {
                "type": "plain_text",
                "text": "View Run"
              },
              "url": "https://github.com/Undeadgrishnackh/crafter-ai/actions/runs/127",
              "style": "primary"
            },
            {
              "type": "button",
              "text": {
                "type": "plain_text",
                "text": "View Commit"
              },
              "url": "https://github.com/Undeadgrishnackh/crafter-ai/commit/c3d4e5f"
            }
          ]
        },
        {
          "type": "context",
          "elements": [
            {
              "type": "mrkdwn",
              "text": "üü¢ All systems healthy"
            }
          ]
        }
      ]
    }
  },

  "implementation_notes": {
    "variable_substitution": {
      "workflow_name": {
        "example": "CI Pipeline",
        "source": "workflow_run.name from GitHub webhook"
      },
      "branch": {
        "example": "installer",
        "source": "workflow_run.head_branch from GitHub webhook"
      },
      "author_slack_id": {
        "example": "<@U01234ABCD>",
        "source": "Map git author to Slack user ID via config",
        "mapping": {
          "undeadgrishnackh": "U01234ABCD",
          "11PJ11": "U56789EFGH"
        }
      },
      "commit_message": {
        "example": "Fix authentication bug",
        "source": "workflow_run.head_commit.message (first line only)",
        "truncation": "Max 100 chars, add '...' if truncated"
      },
      "commit_sha_short": {
        "example": "a1b2c3d",
        "source": "workflow_run.head_sha (first 7 chars)"
      },
      "failed_jobs": {
        "example": "‚Ä¢ test (exit code 1)\\n‚Ä¢ lint (ruff formatting)",
        "source": "Parse workflow_run.jobs array, filter conclusion=failure",
        "format": "‚Ä¢ {job_name} ({error_summary})"
      },
      "run_url": {
        "example": "https://github.com/Undeadgrishnackh/crafter-ai/actions/runs/123",
        "source": "workflow_run.html_url from GitHub webhook"
      },
      "commit_url": {
        "example": "https://github.com/Undeadgrishnackh/crafter-ai/commit/a1b2c3d",
        "source": "workflow_run.head_commit.url from GitHub webhook"
      },
      "failure_timestamp": {
        "example": "2:34 PM",
        "source": "workflow_run.updated_at converted to team timezone",
        "format": "h:mm AM/PM"
      },
      "time_since_failure": {
        "example": "18 minutes",
        "source": "Calculate: recovery_timestamp - failure_timestamp",
        "format": "Smart: '5 min', '18 minutes', '2h 34m', '1d 3h'"
      },
      "recovery_commit_count": {
        "example": "1",
        "source": "GitHub API: /repos/{owner}/{repo}/compare/{failure_sha}...{recovery_sha}",
        "fallback": "If API fails, omit this field"
      },
      "previously_failed_jobs": {
        "example": "‚Ä¢ test ‚úÖ now passing\\n‚Ä¢ lint ‚úÖ now passing",
        "source": "Retrieve failed_jobs from RED notification state storage",
        "format": "‚Ä¢ {job_name} ‚úÖ now passing"
      }
    },

    "state_storage_requirements": {
      "description": "Data that must persist between RED and GREEN notifications",
      "required_fields": [
        {
          "field": "previous_run_id",
          "type": "integer",
          "purpose": "Detect state transitions (GREEN‚ÜíRED, RED‚ÜíGREEN)",
          "example": 122
        },
        {
          "field": "previous_status",
          "type": "string",
          "purpose": "Determine if transition is RED‚ÜíGREEN",
          "example": "failure"
        },
        {
          "field": "failure_timestamp",
          "type": "ISO8601",
          "purpose": "Calculate time_since_failure for GREEN notification",
          "example": "2026-01-31T14:34:00Z"
        },
        {
          "field": "failed_jobs",
          "type": "array",
          "purpose": "Show 'Previously failed' in GREEN notification",
          "example": ["test", "lint"]
        },
        {
          "field": "failure_commit_sha",
          "type": "string",
          "purpose": "Calculate recovery_commit_count",
          "example": "a1b2c3d4e5f6789abcdef0123456789abcdef012"
        }
      ],
      "storage_recommendation": "Redis, PostgreSQL, or file-based (JSON) with atomic writes"
    },

    "notification_logic": {
      "state_transitions": [
        {
          "from": "success",
          "to": "failure",
          "action": "Post RED notification",
          "example": "Run 122 (success) ‚Üí Run 123 (failure)"
        },
        {
          "from": "failure",
          "to": "success",
          "action": "Post GREEN notification",
          "example": "Run 123 (failure) ‚Üí Run 124 (success)"
        },
        {
          "from": "success",
          "to": "success",
          "action": "Silent (no notification)",
          "example": "Run 124 (success) ‚Üí Run 125 (success)"
        },
        {
          "from": "failure",
          "to": "failure",
          "action": "Silent OR thread subsequent failure (future enhancement)",
          "example": "Run 123 (failure) ‚Üí Run 124 (failure again)"
        }
      ]
    },

    "error_handling": {
      "unknown_author": {
        "scenario": "Git username not in Slack mapping",
        "fallback": "Use plaintext git username instead of <@USER_ID>",
        "example": "*Author:*\\nunknown_contributor",
        "log": "WARN: Author mapping missing for 'unknown_contributor'"
      },
      "missing_commit_message": {
        "scenario": "workflow_run.head_commit.message is empty",
        "fallback": "Use '(no commit message)' placeholder",
        "example": "üìù *(no commit message)*\\nCommit: `a1b2c3d`"
      },
      "job_parsing_failure": {
        "scenario": "Cannot parse failed jobs from workflow_run.jobs",
        "fallback": "Show generic 'Multiple jobs failed'",
        "example": "*‚ùå Failed Jobs:*\\nMultiple jobs failed (see run details)",
        "log": "ERROR: Failed to parse job status for run 123"
      },
      "time_calculation_failure": {
        "scenario": "failure_timestamp not found in state storage",
        "fallback": "Omit time_since_failure from GREEN notification",
        "example": "üéâ *Back to green*\\nRecovery commits: 1",
        "log": "WARN: Cannot calculate time_since_failure for run 124"
      }
    },

    "slack_api_constraints": {
      "max_blocks": 50,
      "max_text_length": 3000,
      "current_usage": {
        "red_notification": {
          "blocks": 6,
          "approximate_chars": 350
        },
        "green_notification": {
          "blocks": 7,
          "approximate_chars": 420
        }
      },
      "safety_margin": "Well within limits, can add more fields if needed"
    },

    "testing_checklist": [
      "‚úì Test RED notification with real failure (verify @mention pings user)",
      "‚úì Test GREEN notification with real recovery (verify time calculation)",
      "‚úì Test author mapping for both known users (undeadgrishnackh, 11PJ11)",
      "‚úì Test unknown author fallback (external contributor)",
      "‚úì Test long commit message truncation (>100 chars)",
      "‚úì Test multiple failed jobs (>2 jobs)",
      "‚úì Test state persistence across Dakota service restart",
      "‚úì Test timezone handling (failure and recovery in different hours)",
      "‚úì Test branch filter (feature branch should NOT notify)",
      "‚úì Test GREEN‚ÜíGREEN silence (no spam when already green)"
    ]
  },

  "python_template_example": {
    "description": "Example Python code for Dakota to generate RED notification",
    "code": "def build_red_notification(workflow_run, author_mapping):\n    \"\"\"\n    Build Slack Block Kit message for pipeline failure.\n    \n    Args:\n        workflow_run: GitHub webhook payload (workflow_run event)\n        author_mapping: Dict mapping git username to Slack user ID\n    \n    Returns:\n        Dict: Slack Block Kit message blocks\n    \"\"\"\n    git_author = workflow_run['head_commit']['author']['name']\n    slack_user_id = author_mapping.get(git_author, git_author)  # Fallback to plaintext\n    \n    # Format Slack mention if mapped\n    author_display = f\"<@{slack_user_id}>\" if slack_user_id.startswith('U') else slack_user_id\n    \n    # Parse failed jobs\n    failed_jobs = []\n    for job in workflow_run.get('jobs', []):\n        if job['conclusion'] == 'failure':\n            job_name = job['name']\n            error_summary = extract_error_summary(job)  # Custom function\n            failed_jobs.append(f\"‚Ä¢ {job_name} ({error_summary})\")\n    \n    failed_jobs_text = \"\\n\".join(failed_jobs) if failed_jobs else \"Multiple jobs failed\"\n    \n    # Truncate commit message\n    commit_msg = workflow_run['head_commit']['message'].split('\\n')[0]  # First line\n    if len(commit_msg) > 100:\n        commit_msg = commit_msg[:97] + \"...\"\n    \n    # Format timestamp\n    failure_time = parse_timestamp(workflow_run['updated_at'])  # Convert to team timezone\n    \n    return {\n        \"channel\": \"#cicd\",\n        \"blocks\": [\n            {\n                \"type\": \"header\",\n                \"text\": {\n                    \"type\": \"plain_text\",\n                    \"text\": f\"üî¥ Pipeline Failed: {workflow_run['name']}\",\n                    \"emoji\": True\n                }\n            },\n            {\n                \"type\": \"section\",\n                \"fields\": [\n                    {\"type\": \"mrkdwn\", \"text\": f\"*Branch:*\\n{workflow_run['head_branch']}\"},\n                    {\"type\": \"mrkdwn\", \"text\": f\"*Author:*\\n{author_display}\"}\n                ]\n            },\n            {\n                \"type\": \"section\",\n                \"text\": {\n                    \"type\": \"mrkdwn\",\n                    \"text\": f\"üìù *{commit_msg}*\\nCommit: `{workflow_run['head_sha'][:7]}`\"\n                }\n            },\n            {\n                \"type\": \"section\",\n                \"text\": {\n                    \"type\": \"mrkdwn\",\n                    \"text\": f\"*‚ùå Failed Jobs:*\\n{failed_jobs_text}\"\n                }\n            },\n            {\n                \"type\": \"actions\",\n                \"elements\": [\n                    {\n                        \"type\": \"button\",\n                        \"text\": {\"type\": \"plain_text\", \"text\": \"View Run\"},\n                        \"url\": workflow_run['html_url'],\n                        \"style\": \"danger\"\n                    },\n                    {\n                        \"type\": \"button\",\n                        \"text\": {\"type\": \"plain_text\", \"text\": \"View Commit\"},\n                        \"url\": workflow_run['head_commit']['url']\n                    }\n                ]\n            },\n            {\n                \"type\": \"context\",\n                \"elements\": [\n                    {\"type\": \"mrkdwn\", \"text\": f\"‚è±Ô∏è Failed at: {failure_time}\"}\n                ]\n            }\n        ]\n    }"
  }
}
