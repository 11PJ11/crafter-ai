{
  "project_id": "plugin-marketplace-migration",
  "step_id": "06-01",
  "phase": {
    "number": 6,
    "name": "Template Migration",
    "purpose": "Convert reference templates to TOON for consistency"
  },
  "step": {
    "number": "6.1",
    "name": "Convert AGENT_TEMPLATE",
    "description": "Convert AGENT_TEMPLATE.yaml to AGENT_TEMPLATE.toon",
    "motivation": "Template consistency with new source format",
    "estimated_hours": "1-3 OR 20-30 if TOON toolchain prerequisite needed",
    "prerequisite_verification_required": true
  },
  "context": {
    "constraints": [
      "DO NOT CREATE NEW REPORT FILES",
      "DO NOT COMMIT BEFORE USER APPROVAL",
      "FOCUS ON DELIVERABLES ONLY",
      "Tests use business language and domain concepts",
      "Type system makes wrong state non-representable",
      "CRITICAL: Verify TOON toolchain prerequisite OR use fallback approach"
    ],
    "success_criteria_mapping": {
      "SC1": "All source files in TOON v3.0 format OR Markdown format (if toolchain unavailable)"
    },
    "dependencies": ["2.4", "PHASE_1_TOOLCHAIN_OR_FALLBACK"],
    "critical_blocker_status": {
      "blocker_id": "BLOCKER_001",
      "title": "Phase 1 TOON Toolchain Missing",
      "severity": "CRITICAL",
      "evidence": "tools/toon/ directory does not exist (verified 2026-01-05)",
      "impact": "Cannot execute TOON conversion workflow without parser/compiler",
      "affects_steps": ["06-01", "06-02", "06-03", "07-01", "07-02", "07-03"],
      "resolution_options": [
        {
          "option": "A",
          "name": "Implement Phase 1 TOON Toolchain First",
          "description": "Complete Phase 1.1-1.3 to create tools/toon/ directory with parser.py and compiler.py",
          "effort_estimate": "20-30 hours",
          "prerequisites": [
            "TOON v3.0 format specification documented",
            "Parser output schema defined",
            "Compiler validation mechanism designed",
            "Test infrastructure for toolchain created"
          ],
          "timeline": "3-4 days before Phase 6 can start"
        },
        {
          "option": "B",
          "name": "Pivot to Markdown Optimization (Skip TOON Format)",
          "description": "Optimize existing .md files instead of converting to .toon format",
          "effort_estimate": "1-2 hours per template",
          "prerequisites": [
            "Update success criteria from 'TOON v3.0 format' to 'Optimized Markdown format'",
            "Define Markdown optimization criteria (readability, consistency, embedding)",
            "Create validation tests for Markdown output"
          ],
          "timeline": "Can start immediately"
        },
        {
          "option": "C",
          "name": "Block Phase 6 Until Toolchain Available",
          "description": "Mark steps as BLOCKED, wait for Phase 1 completion",
          "effort_estimate": "0 hours (waiting)",
          "prerequisites": [
            "Phase 1 team commits to delivery timeline",
            "Dependencies updated in all Phase 6-8 steps",
            "Project timeline adjusted for Phase 1 completion"
          ],
          "timeline": "Unknown - depends on Phase 1 completion"
        }
      ]
    }
  },
  "deliverables": {
    "files_to_create": [
      "5d-wave/templates/AGENT_TEMPLATE.toon (Option A) OR 5d-wave/templates/AGENT_TEMPLATE.md (Option B)"
    ],
    "acceptance_criteria": [
      "PREREQUISITE CHECK PASSED: TOON toolchain exists OR fallback approach approved",
      "Template compiles to valid reference MD (Option A) OR Template is valid optimized MD (Option B)",
      "Includes all agent structure elements",
      "Conversion methodology documented in execution notes"
    ]
  },
  "tdd_approach": {
    "outer_test": "GIVEN AGENT_TEMPLATE source\nWHEN processed\nTHEN produces valid agent template reference",
    "inner_tests": [
      "test_prerequisite_toolchain_available (Option A)",
      "test_template_structure_complete",
      "test_fallback_markdown_valid (Option B)"
    ]
  },
  "refactoring": {
    "targets": []
  },
  "execution_guidance": {
    "approach": "Prerequisite-driven template conversion with fallback",
    "mandatory_prerequisite_check": {
      "step_0": "MANDATORY FIRST STEP - Verify Prerequisites",
      "checks": [
        {
          "check_id": "PRE-01",
          "description": "Verify TOON toolchain exists",
          "validation_command": "ls -la /path/to/tools/toon/ && python -c 'from tools.toon import compile; print(compile.__doc__)'",
          "success_criteria": "Directory exists AND compile function importable",
          "failure_action": "STOP - Choose Option B (Markdown) or Option C (Block)"
        },
        {
          "check_id": "PRE-02",
          "description": "Verify TOON format specification available",
          "validation_command": "ls -la /path/to/docs/toon-v3.0-spec.md OR grep -r 'TOON v3.0' /path/to/docs/",
          "success_criteria": "Specification document exists with syntax examples",
          "failure_action": "STOP - Cannot convert without format specification"
        },
        {
          "check_id": "PRE-03",
          "description": "Get user approval for approach",
          "validation_method": "Interactive - ask user to choose Option A, B, or C",
          "success_criteria": "User explicitly approves approach",
          "failure_action": "STOP - Cannot proceed without user decision"
        }
      ]
    },
    "workflow_option_a": [
      "0. RUN PREREQUISITE CHECKS (PRE-01, PRE-02, PRE-03)",
      "1. Convert AGENT_TEMPLATE.yaml to AGENT_TEMPLATE.toon using TOON format spec",
      "2. Compile to validate structure using tools/toon/compiler.py",
      "3. Write test to verify template completeness",
      "4. Validate all agent structure elements present",
      "5. Document conversion methodology in commit message",
      "6. DO NOT COMMIT - wait for user approval"
    ],
    "workflow_option_b": [
      "0. RUN PREREQUISITE CHECKS (PRE-03 only - get fallback approval)",
      "1. Optimize AGENT_TEMPLATE.yaml as Markdown (readability, consistency)",
      "2. Validate Markdown syntax and structure",
      "3. Write test to verify template completeness",
      "4. Validate all agent structure elements present",
      "5. Document optimization approach in commit message",
      "6. DO NOT COMMIT - wait for user approval"
    ],
    "workflow_option_c": [
      "0. RUN PREREQUISITE CHECKS (PRE-01 fails)",
      "1. Mark step as BLOCKED in status",
      "2. Document blocking reason and Phase 1 dependency",
      "3. Notify user of block and estimated wait time",
      "4. Wait for Phase 1 completion notification"
    ],
    "quality_gates": [
      "MANDATORY: Prerequisite checks completed and passed OR fallback approved",
      "All tests passing (100% required)",
      "Template validates successfully (compile OR Markdown lint)",
      "All structure elements present",
      "No report files created",
      "Approach documented in execution notes"
    ]
  },
  "adversarial_review": {
    "review_date": "2026-01-05",
    "reviewer": "adversarial-software-crafter-reviewer",
    "mission": "Find what WILL go wrong, not what MIGHT work",
    "UPDATED_AFTER_CORRECTION": {
      "correction_date": "2026-01-06",
      "correction_summary": "Added explicit prerequisite verification, fallback options, and blocking status tracking",
      "remaining_risks": [
        "User may skip prerequisite checks (mitigated by MANDATORY step 0)",
        "Option A chosen without understanding 20-30h Phase 1 effort (mitigated by effort estimates)",
        "Option B chosen without updating success criteria SC1 (mitigated by acceptance criteria update)"
      ]
    },
    "contradictions_found": [
      {
        "id": "CONTRA-1",
        "title": "Phase 1 Status Unknown - Task Assumes Completion",
        "contradiction": "Task states: 'Requires Phase 1.1 (TOON Parser)' implicit in acceptance criteria (compile validation). Yet Phase 1.1 review (01-01.json) shows CRITICAL issues: python-toon library availability unverified, parser output schema undefined, TOON symbol list incomplete. Task assumes Phase 1 is complete, but it has CRITICAL blockers.",
        "severity": "CRITICAL",
        "impact": "Task cannot execute if Phase 1.1 is still blocked. Executor starts work, discovers Phase 1 missing, wasted time.",
        "failure_mode": "Phase 6.1 begins, attempts to test TOON compiler, discovers tools/toon/compiler.py doesn't exist (Phase 1 incomplete). Blocker. Executor waits for Phase 1.",
        "MITIGATION_ADDED": "Mandatory prerequisite check (step 0) with ls command verification. Three fallback options documented."
      },
      {
        "id": "CONTRA-2",
        "title": "Compiler Component Existence Ambiguous",
        "contradiction": "Acceptance criteria requires: 'Template compiles to valid reference MD'. But Phase 1 description (01-01.json) only mentions 'Create TOON Parser', not compiler. Is compiler part of Phase 1.1 or Phase 1.2 or Phase 1.3? Unknown.",
        "severity": "CRITICAL",
        "impact": "Executor cannot validate acceptance criteria without knowing which tool to invoke.",
        "failure_mode": "Executor searches for 'compile' command, finds only parser in Phase 1.1. Compiler doesn't exist. Blocker.",
        "MITIGATION_ADDED": "PRE-01 check validates both directory existence AND compile function importability. Option B provides non-compiler fallback."
      }
    ],
    "dangerous_assumptions": [
      {
        "id": "ASSUME-1",
        "assumption": "Phase 1 TOON toolchain is complete and functional",
        "why_dangerous": "Phase 1.1 review shows CRITICAL blockers: parser library not validated, output schema undefined. Compiler component not mentioned in Phase 1 deliverables. Assumption is optimistic.",
        "likelihood": "VERY HIGH",
        "consequence": "Task blocked waiting for Phase 1. Compiler doesn't exist. Executor cannot proceed.",
        "MITIGATION_ADDED": "Explicit verification in PRE-01 check. Three resolution paths (A, B, C) provide alternatives."
      },
      {
        "id": "ASSUME-2",
        "assumption": "Manual YAML→TOON conversion is feasible in 1 hour",
        "why_dangerous": "98KB complex nested YAML structure cannot be manually transcribed accurately in 1 hour. Error rate likely >30%.",
        "likelihood": "HIGH",
        "consequence": "Output contains errors. Compiler fails or produces invalid MD. Rework required.",
        "MITIGATION_ADDED": "Updated estimated_hours to '1-3 OR 20-30 if prerequisite needed'. Option B avoids conversion entirely."
      }
    ],
    "overall_risk_assessment": {
      "risk_score": 8.5,
      "severity": "CRITICAL",
      "confidence_in_success": "15% (Option A without prerequisite) → 75% (Option B with fallback)",
      "root_causes": [
        "Phase 1 toolchain not verified complete",
        "TOON format specification missing",
        "Conversion methodology undefined",
        "Acceptance criteria subjectively defined",
        "1-hour estimate wildly optimistic",
        "No integration test with Phase 3-7"
      ],
      "blocking_items": [
        "CRITICAL: Verify Phase 1 TOON parser/compiler functional before Phase 6 start",
        "CRITICAL: Document TOON v3.0 format specification with examples",
        "CRITICAL: Define YAML→TOON conversion methodology (auto-tool or manual guide)",
        "HIGH: Create explicit structure elements checklist",
        "HIGH: Expand test suite beyond single 'compile success' test",
        "HIGH: Verify TOON v3.0 compatibility with existing v1.0 agents"
      ],
      "RISK_MITIGATION_EFFECTIVENESS": "Prerequisite checks reduce risk from 8.5/10 to 4.0/10 by preventing execution with missing dependencies"
    },
    "blast_radius": "CRITICAL - Phase 6 is pilot for Phase 7 batch migration (28 agents). Failure cascades to Phase 7, potentially invalidating entire 6-7 phase sequence. If Phase 6 template incompatible with agents, Phase 7 fails. Recovery: rework Phase 6 template (2h) + reconvert all 28 agents (4-6h) = 6-8 hour setback.",
    "execution_readiness": "NOT READY without prerequisite verification → READY after prerequisite checks pass → BLOCKED if checks fail and Option C chosen"
  },
  "review_metadata": {
    "reviewed_by": "Lyra",
    "review_date": "2026-01-05",
    "corrected_date": "2026-01-06",
    "review_status": "CORRECTED - Prerequisite checks and fallback options added",
    "severity_summary": {
      "critical": 1,
      "high": 3,
      "medium": 2
    },
    "clarity_assessment": "NOW CLEAR - Prerequisite verification mandatory, three resolution paths documented",
    "completeness_assessment": "NOW COMPLETE - Blocking scenario addressed with concrete options",
    "achievability_assessment": "NOW ACHIEVABLE - With prerequisite checks and fallback strategies"
  }
}
