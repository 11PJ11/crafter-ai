{
  "project_id": "plugin-marketplace-migration",
  "step_id": "04-04",
  "phase": {
    "number": 4,
    "name": "Command Migration",
    "purpose": "Convert all 20 commands to TOON format"
  },
  "step": {
    "number": "4.4",
    "name": "Convert DEVELOP Wave Commands",
    "description": "Convert 8 DEVELOP wave commands: baseline.md, roadmap.md, split.md, execute.md, review.md, develop.md, refactor.md, mikado.md",
    "motivation": "DEVELOP wave is the core implementation phase",
    "estimated_hours": "8-12"
  },
  "context": {
    "constraints": [
      "DO NOT CREATE NEW REPORT FILES",
      "DO NOT COMMIT BEFORE USER APPROVAL",
      "FOCUS ON DELIVERABLES ONLY",
      "Tests use business language and domain concepts",
      "Type system makes wrong state non-representable",
      "TOON v3.0 format specification MUST be available before execution",
      "Agent binding rules MUST be documented explicitly",
      "Refactoring rules MUST be defined before application"
    ],
    "success_criteria_mapping": {
      "SC1": "All source files in TOON v3.0 format",
      "SC7": "Token savings measured and documented (target ~60%, actual to be measured)"
    },
    "dependencies": [
      "2.4"
    ],
    "toon_format_specification": {
      "reference": "tools/toon/TOON-v3.0-SPEC.md or agents/novel-editor-chatgpt-toon.txt",
      "required_fields": [
        "wave",
        "agent",
        "description",
        "parameters"
      ],
      "metadata_format": "YAML key: value style",
      "header_format": "@agent [agent-name] for activation headers",
      "wave_format": "wave: [WAVE_NAME] (uppercase, e.g., DEVELOP)"
    }
  },
  "deliverables": {
    "files_to_create": [
      "nWave/tasks/dw/baseline.toon",
      "nWave/tasks/dw/roadmap.toon",
      "nWave/tasks/dw/split.toon",
      "nWave/tasks/dw/execute.toon",
      "nWave/tasks/dw/review.toon",
      "nWave/tasks/dw/develop.toon",
      "nWave/tasks/dw/refactor.toon",
      "nWave/tasks/dw/mikado.toon"
    ],
    "acceptance_criteria": [
      "All 8 commands compile with agent-activation headers",
      "Wave metadata correct (DEVELOP) - uppercase, format: wave: DEVELOP",
      "Agent bindings correct for each command (validated against agent_bindings table)",
      "Compilation validation passes all criteria (exit code 0, no stderr, size > 1000 bytes, schema valid)",
      "All required metadata fields present (wave, agent, description, parameters)",
      "Refactoring level 1 consistency rules applied if refactoring included",
      "Token savings measured and documented (before/after counts with tokenizer specified)"
    ]
  },
  "tdd_approach": {
    "outer_test": "GIVEN all DEVELOP wave command .toon files\nWHEN compiled\nTHEN all 8 have wave: DEVELOP and correct agent binding",
    "inner_tests": [
      "test_each_develop_command_compiles",
      "test_develop_command_binds_software_crafter",
      "test_review_command_binds_reviewer"
    ]
  },
  "refactoring": {
    "targets": [],
    "note": "Refactoring removed to match 04-01/02/03 pattern - conversion only, no structural changes",
    "rationale": "Adversarial review identified contradiction: 04-01/02/03 have empty refactoring targets. Consistency achieved through TOON format specification compliance, not post-conversion refactoring."
  },
  "execution_guidance": {
    "approach": "Batch command conversion with pre-work validation and comprehensive testing",
    "workflow": [
      "PRE-WORK: Run all prerequisite checks (see prerequisite_checks section)",
      "PRE-WORK: Verify TOON format specification available",
      "PRE-WORK: Verify no existing .toon files in target directory (nWave/tasks/dw/)",
      "PRE-WORK: Validate all 8 source .md files parse without errors",
      "1. Convert all 8 DEVELOP wave .md files to .toon using compiler",
      "2. Compile each TOON file with python tools/toon/compiler.py <input.toon> --validate",
      "3. Validate compilation meets all criteria (exit 0, no stderr, size > 1000 bytes, schema valid)",
      "4. Write tests to validate wave metadata and agent bindings (using test framework from prerequisite_checks)",
      "5. Verify all agent-activation headers present and correct format",
      "6. Measure token savings (before/after with specified tokenizer)",
      "7. Run all tests (100% pass rate required)",
      "8. DO NOT COMMIT - wait for user approval"
    ],
    "quality_gates": [
      "All prerequisite checks passed",
      "All tests passing (100% required)",
      "All 8 commands compile successfully (exit 0, no stderr, size > 1000 bytes)",
      "Wave metadata correct (wave: DEVELOP, uppercase)",
      "Agent bindings validated against agent_bindings table",
      "All required metadata fields present",
      "Schema validation passes for all 8 files",
      "Token savings measured and documented",
      "No report files created"
    ]
  },
  "review_metadata": {
    "reviewed_at": "2026-01-05T00:00:00Z",
    "reviewer": "Lyra (code-review-mode)",
    "review_status": "APPROVED_WITH_RECOMMENDATIONS",
    "clarity_score": 8.5,
    "completeness_score": 8.0,
    "achievability_score": 8.5,
    "issues_found": 5,
    "critical_issues": 2,
    "medium_issues": 1,
    "low_issues": 2,
    "findings": {
      "critical_1": {
        "category": "Specification Clarity",
        "title": "Refactoring Target Justification Missing",
        "severity": "medium",
        "description": "Refactoring targets level 1 'Consistent command structure' but no clear definition of what consistency rule applies. Previous DEVELOP wave tasks (04-01 through 04-03) have empty refactoring targets.",
        "impact": "Ambiguity about post-conversion refactoring scope",
        "recommendation": "Either remove refactoring target to match pattern, or explicitly define the consistency rule being applied (e.g., 'Ensure all agent-activation headers follow identical structure')"
      },
      "critical_2": {
        "category": "Acceptance Criteria",
        "title": "Agent Binding Specification Incomplete",
        "severity": "medium",
        "description": "Inner test 'test_review_command_binds_reviewer' assumes specific agent binding but acceptance criteria lacks explicit mapping (which agent should 'review' bind to?)",
        "impact": "Test may fail if agent binding rules differ from assumption",
        "recommendation": "Document agent binding rule: specify if review→software-crafter or review→software-crafter-reviewer, apply consistently across all 8 commands"
      },
      "medium_3": {
        "category": "Implicit Dependencies",
        "title": "TOON v3.0 Format Specification Not Linked",
        "severity": "low",
        "description": "Task references 'TOON v3.0 format' but provides no specification link or format definition. Converter needs to know exact syntax requirements.",
        "impact": "Converter may guess at format; test validation may be incomplete",
        "recommendation": "Add specification link or embed TOON v3.0 schema in task context (format: headers, field names, data types expected)"
      },
      "low_4": {
        "category": "Ambiguity",
        "title": "Compilation Tool Not Specified",
        "severity": "low",
        "description": "Step 2 'Compile each TOON file' lacks specifics: compiler name, command syntax, output location, success criteria",
        "impact": "Minor - but executor needs to know which tool to run",
        "recommendation": "Specify: 'Run [compiler-name] on each .toon file. Expected: no errors. Output: [location or stdout validation].'"
      },
      "low_5": {
        "category": "Test Framework",
        "title": "Test Framework Not Specified",
        "severity": "low",
        "description": "Inner tests reference validation logic but no test framework specified (NUnit? pytest? Jest? Custom?)",
        "impact": "Executor must infer test framework from codebase context",
        "recommendation": "Specify test framework: 'Use [NUnit/pytest/Jest] to write inner tests for metadata validation'"
      }
    },
    "hidden_dependencies": [
      "All 8 source .md files must exist at nWave/tasks/dw/ (VERIFIED: all present)",
      "Sequential dependency on steps 04-01, 04-02, 04-03 completion",
      "TOON compiler availability (not verified in review)",
      "Test framework must be configured and available"
    ],
    "missing_context": [
      "TOON v3.0 format specification (link or embedded schema needed)",
      "Agent binding mapping rules (which command binds to which agent)",
      "Wave metadata field name/format specification (e.g., 'wave: DEVELOP' vs 'wave_name: DEVELOP')",
      "Test framework specification (which framework to use for inner tests)"
    ],
    "strengths": [
      "Clear wave focus with proper motivation (DEVELOP = 'core implementation phase')",
      "Consistent structure following established pattern from 04-01/02/03",
      "Explicit TDD approach with separated outer/inner tests",
      "Well-defined quality gates with measurable criteria (100% pass rate requirement)",
      "Realistic time estimate (4 hours for 8 commands = ~30 min per command)"
    ],
    "overall_assessment": {
      "status": "APPROVED_WITH_RECOMMENDATIONS",
      "achievable": true,
      "risks": [
        "Agent binding assumptions may not match actual binding rules",
        "Refactoring scope ambiguity could lead to incomplete refactoring",
        "TOON format misinterpretation possible without specification"
      ],
      "mitigations": [
        "Review and document agent binding rules before execution",
        "Clarify refactoring targets (add to acceptance criteria if applied)",
        "Embed or link TOON v3.0 format specification in task context",
        "Validate TOON compiler is available before starting conversion"
      ],
      "confidence": 0.85
    }
  },
  "prerequisite_checks": {
    "phase_1_toon_infrastructure": {
      "requirement": "TOON parser and compiler from Phase 1 must be complete",
      "verification": "Confirm tools/toon/compiler.py exists and test_toon_parser passes",
      "blocking": true,
      "escalation": "If Phase 1 incomplete, STOP - escalate to project manager for decision on Option B (Markdown) or Option C (Block)"
    },
    "toon_format_specification": {
      "requirement": "TOON v3.0 format specification must be available",
      "verification": "Obtain from tools/toon/TOON-v3.0-SPEC.md or reference implementation",
      "blocking": true,
      "escalation": "If spec unavailable, create from reverse-engineering agents/novel-editor-chatgpt-toon.txt",
      "validation_requirements": [
        "Required fields documented (wave, agent, description, parameters)",
        "Metadata format specified (YAML key: value style)",
        "Header format specified (@agent [agent-name])",
        "Wave format specified (wave: [WAVE_NAME] uppercase)",
        "Valid and invalid examples provided"
      ]
    },
    "baseline_measurements": {
      "requirement": "Baseline measurements from Phase 0 must be complete",
      "verification": "Confirm docs/workflow/plugin-marketplace-migration/baseline.yaml exists with command metrics",
      "blocking": true,
      "escalation": "If baseline missing, execute Phase 0 baseline measurement first"
    },
    "no_existing_toon_files": {
      "requirement": "No .toon files exist in target directory to avoid collision",
      "verification": "Check nWave/tasks/dw/*.toon files do not exist",
      "blocking": true,
      "escalation": "If .toon files exist, abort and request user to remove or archive them first"
    },
    "source_md_files_valid": {
      "requirement": "All 8 source .md files must parse without errors",
      "verification": "Parse each .md file and confirm valid YAML/markdown structure",
      "blocking": true,
      "escalation": "If any .md file malformed, fix source file syntax before conversion"
    },
    "test_framework_available": {
      "requirement": "Test framework configured and available",
      "verification": "pytest or NUnit or xUnit available and runnable",
      "blocking": true,
      "escalation": "Install and configure test framework before execution",
      "framework_specification": "Use pytest for Python projects, NUnit/xUnit for .NET projects"
    },
    "agent_registry_accessible": {
      "requirement": "Agent registry accessible for binding validation",
      "verification": "Can query agent registry to verify agent existence",
      "blocking": false,
      "note": "Optional for compilation, required for runtime. Tests validate syntax, integration tests validate existence."
    }
  },
  "toon_compiler": {
    "tool_location": "tools/toon/compiler.py (from Phase 1)",
    "purpose": "Transforms TOON source to Claude Code compliant output",
    "input": "nWave/tasks/dw/*.toon (TOON format)",
    "output": "dist/commands/dw/*.md (Markdown format)",
    "invocation": "python tools/toon/compiler.py <input.toon> --validate --output <output.md>",
    "success_criteria": [
      "Exit code = 0 (no errors)",
      "No errors in stderr",
      "Output file size > 1000 bytes (non-trivial content)",
      "Metadata validates against TOON v3.0 schema",
      "Output markdown is Claude Code compliant"
    ],
    "validation": "pytest tests/tools/toon/test_compiler.py",
    "compilation_validation_details": {
      "exit_code_check": "Must be 0 for success",
      "stderr_check": "Must be empty (no error messages)",
      "output_size_check": "Must be > 1000 bytes to indicate non-trivial content",
      "schema_validation": "All required fields present (wave, agent, description, parameters)",
      "metadata_validation": "Wave format correct (wave: DEVELOP), agent binding valid"
    }
  },
  "error_handling": {
    "scenario_1_compiler_not_found": {
      "error": "TOON compiler not found at tools/toon/compiler.py",
      "handling": "Log error with clear message: 'Phase 1 TOON infrastructure required. Run Phase 1.1-1.5 first or choose Option B (Markdown).'",
      "recovery": "STOP execution, escalate to user for decision",
      "test": "test_error_compiler_not_found"
    },
    "scenario_2_compilation_failure": {
      "error": "TOON compiler exits with non-zero code",
      "handling": "Log compilation error with file path and stderr output. ROLLBACK all converted files. DO NOT continue with partial conversion.",
      "recovery": "Review TOON syntax, fix errors, retry full batch conversion from clean state",
      "test": "test_error_compilation_failure_graceful",
      "rollback_policy": "Atomic batch conversion - all 8 succeed or rollback all"
    },
    "scenario_3_metadata_validation_failure": {
      "error": "Compiled output fails metadata validation (missing required fields)",
      "handling": "Log validation errors with specific missing fields. ROLLBACK all converted files.",
      "recovery": "Add missing metadata to source TOON file, retry full batch conversion",
      "test": "test_error_metadata_validation_failure",
      "rollback_policy": "Atomic batch conversion - validation failure rolls back entire batch"
    },
    "scenario_4_partial_batch_failure": {
      "error": "Some files in batch succeed, others fail",
      "handling": "ROLLBACK all successful conversions. Report which conversion failed and why. Maintain clean state.",
      "recovery": "Fix failed files, retry entire batch from clean state",
      "test": "test_error_partial_batch_failure_reporting",
      "rollback_policy": "All-or-nothing: Either all 8 succeed or none persist"
    },
    "scenario_5_file_collision": {
      "error": "Target .toon file already exists",
      "handling": "STOP immediately. Log error: 'Target .toon files exist. Remove or archive existing files first.'",
      "recovery": "User removes or archives existing .toon files before retry",
      "test": "test_error_file_collision_detection",
      "prevention": "Pre-work check validates no existing .toon files"
    },
    "scenario_6_source_file_malformed": {
      "error": "Source .md file has invalid YAML/markdown structure",
      "handling": "STOP immediately. Log error with file path and parse error details.",
      "recovery": "Fix source .md file syntax, retry",
      "test": "test_error_source_file_validation",
      "prevention": "Pre-work check validates all source .md files parse correctly"
    }
  },
  "test_specifications": {
    "test_framework": "pytest (Python projects) or NUnit/xUnit (.NET projects)",
    "unit_tests": [
      {
        "name": "test_toon_parser_valid_command_input",
        "purpose": "Verify parser handles valid TOON command syntax correctly",
        "input": "Sample TOON command file with all required fields (wave, agent, description, parameters)",
        "expected": "Parsed dict with command metadata: {wave, agent, description, parameters, dependencies}"
      },
      {
        "name": "test_template_rendering_with_parsed_command",
        "purpose": "Verify Jinja2 template renders command.md from parsed data",
        "input": "Parsed command dict from parser output",
        "expected": "Valid Markdown output with command syntax section, parameters table, usage examples"
      },
      {
        "name": "test_output_validation_against_claude_code_spec",
        "purpose": "Verify compiled output meets Claude Code command specification",
        "input": "Generated command.md file",
        "expected": "Validation passes: Has frontmatter, execution context, success criteria sections"
      },
      {
        "name": "test_wave_metadata_validation",
        "purpose": "Verify wave metadata format is correct",
        "input": "Compiled .toon file",
        "expected": "Wave field present, uppercase (wave: DEVELOP), not lowercase or wrong field name"
      },
      {
        "name": "test_agent_binding_validation",
        "purpose": "Verify agent bindings match agent_bindings table",
        "input": "Compiled .toon file and agent_bindings table",
        "expected": "Agent binding matches expected binding from table, correct field format (agent: [agent-name])"
      }
    ],
    "integration_tests": [
      {
        "name": "test_e2e_command_migration_pipeline",
        "purpose": "Verify complete migration: TOON → Parse → Template → Validate → Output",
        "input": "Real TOON command file from nWave/tasks/dw/",
        "steps": "Parse TOON → Apply command template → Validate output → Write to dist/",
        "expected": "Valid command.md in dist/commands/dw/ matching Claude Code spec"
      },
      {
        "name": "test_batch_migration_all_commands",
        "purpose": "Verify batch processing of all command files",
        "input": "All TOON command files (8 dw: commands)",
        "expected": "All 8 commands migrated successfully with validation report"
      }
    ],
    "error_scenario_tests": [
      {
        "name": "test_compiler_not_found_error_handling",
        "purpose": "Verify graceful failure when compiler missing",
        "setup": "Remove or rename tools/toon/compiler.py",
        "expected": "Clear error message, execution stops, no partial output"
      },
      {
        "name": "test_malformed_toon_syntax_error_handling",
        "purpose": "Verify parser reports syntax errors clearly",
        "input": "TOON file with missing ## section header",
        "expected": "Parser error with line number, specific syntax issue description"
      },
      {
        "name": "test_validation_failure_error_handling",
        "purpose": "Verify validation errors reported clearly",
        "input": "TOON file missing required 'description' field",
        "expected": "Validation error: 'Missing required field: description' with file path"
      },
      {
        "name": "test_file_collision_handling",
        "purpose": "Verify detection of existing .toon files",
        "setup": "Create dummy .toon file in target directory",
        "expected": "Pre-work check fails, clear error message, execution does not proceed"
      },
      {
        "name": "test_source_file_malformed_handling",
        "purpose": "Verify detection of malformed source .md files",
        "setup": "Create .md file with unclosed YAML fence",
        "expected": "Pre-work check fails, parse error reported with file and line number"
      },
      {
        "name": "test_partial_batch_failure_rollback",
        "purpose": "Verify atomic batch conversion rollback policy",
        "setup": "Create 7 valid .md files and 1 malformed .md file",
        "expected": "All conversions rolled back, no .toon files persist, error report shows which file failed"
      }
    ],
    "token_savings_measurement": {
      "requirement": "Measure and document token savings before/after conversion",
      "tokenizer": "Specify tokenizer used (e.g., tiktoken for OpenAI, transformers for Huggingface)",
      "baseline": "Count tokens in all 8 source .md files",
      "post_conversion": "Count tokens in all 8 compiled .toon files",
      "calculation": "savings_percentage = ((baseline - post_conversion) / baseline) * 100",
      "target": "~60% (aspirational based on SC7)",
      "documentation": "Document actual savings achieved with tokenizer specification",
      "acceptance": "Any savings documented is acceptable; 60% is target not requirement"
    }
  },
  "agent_bindings": {
    "description": "Maps each DEVELOP wave command to its primary agent - EXPLICIT SPECIFICATION",
    "field_format": "agent: [agent-name]",
    "bindings": {
      "dw:baseline": "software-crafter",
      "dw:roadmap": "software-crafter",
      "dw:split": "software-crafter",
      "dw:execute": "software-crafter",
      "dw:review": "software-crafter-reviewer",
      "dw:develop": "software-crafter",
      "dw:refactor": "software-crafter",
      "dw:mikado": "software-crafter"
    },
    "validation": "Each binding MUST have test validating command invokes correct agent",
    "format_examples": {
      "valid": [
        "agent: software-crafter",
        "agent: software-crafter-reviewer"
      ],
      "invalid": [
        "agent_binding: software-crafter (wrong field name)",
        "activation: software-crafter (wrong field name)",
        "agent: Software-Crafter (case mismatch)",
        "(no agent field) (missing required field)"
      ]
    },
    "integration_validation": {
      "requirement": "Validate bindings against actual agent registry",
      "test": "Query agent registry to confirm each agent exists",
      "blocking": false,
      "note": "Syntax validated during compilation, existence validated at runtime/integration"
    }
  },
  "adversarial_review_integration": {
    "review_date": "2026-01-05",
    "review_status": "APPROVED WITH CRITICAL GAPS",
    "risk_score": "6.5/10 (HIGH)",
    "blast_radius": "VERY HIGH - 8 core DEVELOP commands",
    "critical_gaps_resolved": [
      "Gap 1: TOON v3.0 format specification - Added to context.toon_format_specification",
      "Gap 2: Agent binding rules - Added explicit agent_bindings table with format examples",
      "Gap 3: Refactoring definition - Removed to match 04-01/02/03 pattern",
      "Gap 4: Compiler specification - Enhanced toon_compiler section with validation details",
      "Gap 5: Test framework - Added test_specifications.test_framework field"
    ],
    "contradictions_resolved": [
      "Contradiction 1: Refactoring scope mismatch - Removed refactoring targets to match pattern",
      "Contradiction 2: Agent binding specification - Added explicit bindings table",
      "Contradiction 3: Implicit format assumption - Added TOON v3.0 spec reference"
    ],
    "edge_cases_addressed": [
      "Edge Case 1: File collision - Added prerequisite check and error handling",
      "Edge Case 2: Partial conversion failure - Added atomic rollback policy",
      "Edge Case 3: Compiler validation - Added detailed validation criteria",
      "Edge Case 4: Wave metadata inconsistency - Added format examples",
      "Edge Case 5: Agent binding inconsistency - Added format specification and examples"
    ],
    "pre_work_validation_added": [
      "TOON format specification availability",
      "No existing .toon files in target directory",
      "All source .md files parse without errors",
      "Test framework configured and available",
      "TOON compiler available and accessible"
    ],
    "execution_risk_mitigation": {
      "original_risk": "6.5/10 (HIGH)",
      "expected_risk_after_corrections": "3-4/10 (MEDIUM-LOW)",
      "confidence_improvement": "From 0.65 to 0.90 (estimated)",
      "recommended_next_steps": [
        "Verify TOON v3.0 specification exists before execution",
        "Run all prerequisite checks as first step",
        "Use atomic batch conversion with rollback on any failure",
        "Measure token savings with specified tokenizer",
        "Validate against agent registry during integration testing"
      ]
    }
  },
  "validation": {
    "status": "approved",
    "quality_score": 8.3,
    "reviewer_notes": "Step 04-04 demonstrates high quality with comprehensive scope definition, explicit agent bindings, atomic batch conversion policy, and strong error handling. Adversarial review integration shows thoughtful refinement. Recommended improvements: (1) Require Phase 0 baseline metrics in pre-work, (2) Mention test framework in main task description, (3) Add compiler availability verification to prerequisites. Non-blocking - execute as written.",
    "approval_rationale": "All 6 review criteria meet or exceed standards. Critical gaps from adversarial review have been resolved. Scope is appropriately bounded (8 commands, conversion only, no structural changes). Testability comprehensive with unit, integration, and error scenarios. Dependencies clearly mapped with blocking prerequisites.",
    "risk_assessment": "LOW - Comprehensive prerequisite validation and atomic rollback policy mitigate execution risks. Agent bindings explicitly documented. TOON format specification required before execution.",
    "ready_for_execution": true,
    "last_reviewed_at": "2026-01-13T22:15:00Z",
    "reviewer": "Lyra (code-review-mode)",
    "migrated_at": "2026-01-13T22:11:27.228638"
  }
}