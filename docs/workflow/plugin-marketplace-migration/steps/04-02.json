{
  "project_id": "plugin-marketplace-migration",
  "step_id": "04-02",
  "phase": {
    "number": 4,
    "name": "Command Migration",
    "purpose": "Convert all 20 commands to TOON format"
  },
  "step": {
    "number": "4.2",
    "name": "Convert DESIGN Wave Commands",
    "description": "Convert design.md, diagram.md to TOON format",
    "motivation": "DESIGN wave defines architecture and visual representations",
    "estimated_hours": "3-4"
  },
  "context": {
    "constraints": [
      "DO NOT CREATE NEW REPORT FILES",
      "DO NOT COMMIT BEFORE USER APPROVAL",
      "FOCUS ON DELIVERABLES ONLY",
      "Tests use business language and domain concepts",
      "Type system makes wrong state non-representable"
    ],
    "success_criteria_mapping": {
      "SC1": "All source files in TOON v3.0 format",
      "NOTE_SC7": "Token savings validation deferred to Phase 8"
    },
    "dependencies": [
      "04-01",
      "04-01b",
      "01-01",
      "01-02",
      "01-03",
      "02-04"
    ]
  },
  "prerequisite_checks": {
    "phase_1_toon_infrastructure": {
      "requirement": "TOON parser and compiler from Phase 1 must be complete",
      "verification": "Confirm tools/toon/compiler.py exists and test_toon_parser passes",
      "blocking": true,
      "escalation": "If Phase 1 incomplete, STOP - escalate to project manager for decision on Option B (Markdown) or Option C (Block)"
    },
    "toon_format_specification": {
      "requirement": "TOON v3.0 format specification must be available",
      "verification": "Obtain from tools/toon/TOON-v3.0-SPEC.md or reference implementation",
      "blocking": true,
      "escalation": "If spec unavailable, create from reverse-engineering agents/novel-editor-chatgpt-toon.txt"
    },
    "previous_step_patterns": {
      "requirement": "Steps 04-01 and 04-01b must be complete",
      "verification": "Confirm discuss.toon and start.toon exist and compile",
      "blocking": true,
      "escalation": "Complete 04-01 and 04-01b first to establish conversion patterns"
    },
    "baseline_measurements": {
      "requirement": "Baseline measurements from Phase 0 must be complete",
      "verification": "Confirm docs/workflow/plugin-marketplace-migration/baseline.yaml exists with command metrics",
      "blocking": true,
      "escalation": "If baseline missing, execute Phase 0 baseline measurement first"
    }
  },
  "deliverables": {
    "files_to_create": [
      "nWave/tasks/dw/design.toon",
      "nWave/tasks/dw/diagram.toon"
    ],
    "acceptance_criteria": [
      "Both commands compile with valid TOON v3.0 format",
      "Wave metadata correct (DESIGN)",
      "Agent-activation headers preserved from source .md files"
    ]
  },
  "tdd_approach": {
    "outer_test": "GIVEN DESIGN wave command .toon files\nWHEN compiled via toon-compiler\nTHEN output has wave: DESIGN in metadata\nAND agent-activation blocks preserved",
    "inner_tests": [
      "test_design_command_compiles",
      "test_diagram_command_compiles",
      "test_design_wave_metadata",
      "test_diagram_wave_metadata"
    ]
  },
  "refactoring": {
    "targets": []
  },
  "toon_compiler": {
    "tool_location": "tools/toon/compiler.py (from Phase 1)",
    "invocation": "python tools/toon/compiler.py <input.toon> --validate --output <output.md>",
    "success_criteria": [
      "Exit code = 0 (no errors)",
      "No errors in stderr",
      "Output file size > 1000 bytes (non-trivial content)",
      "Metadata validates against TOON v3.0 schema",
      "Output markdown is Claude Code compliant"
    ],
    "error_handling": {
      "compilation_failure": "Log error, do NOT proceed, escalate with error message",
      "metadata_invalid": "Review source file wave classification, retry compilation",
      "partial_failure": "Rollback ALL conversions, fix issue, restart batch"
    },
    "purpose": "Transforms TOON source to Claude Code compliant output",
    "input": "nWave/tasks/dw/*.toon (TOON format)",
    "output": "dist/commands/dw/*.md (Markdown format)",
    "validation": "pytest tests/tools/toon/test_compiler.py"
  },
  "test_specifications": {
    "test_design_command_compiles": {
      "framework": "pytest",
      "test_code_skeleton": "def test_design_command_compiles():\n    toon_file = TOONParser().parse('nWave/tasks/dw/design.toon')\n    assert toon_file.metadata['wave'] == 'DESIGN'\n    assert toon_file.metadata['agent-id'] == 'solution-architect'\n    assert toon_file.compilation_errors == []",
      "assertions": [
        "File parses without errors",
        "Wave metadata == DESIGN",
        "Agent-id preserved from design.md",
        "All required metadata fields present"
      ]
    },
    "test_diagram_command_compiles": {
      "framework": "pytest",
      "test_code_skeleton": "def test_diagram_command_compiles():\n    toon_file = TOONParser().parse('nWave/tasks/dw/diagram.toon')\n    assert toon_file.metadata['wave'] == 'DESIGN'\n    assert toon_file.metadata['agent-id'] == 'architecture-diagram-manager'\n    assert toon_file.compilation_errors == []",
      "assertions": [
        "File parses without errors",
        "Wave metadata == DESIGN",
        "Agent-id preserved from diagram.md",
        "All required metadata fields present"
      ]
    },
    "test_design_wave_metadata": {
      "framework": "pytest",
      "test_code_skeleton": "def test_design_wave_metadata():\n    toon_file = TOONParser().parse('nWave/tasks/dw/design.toon')\n    assert toon_file.metadata['wave'] == 'DESIGN'\n    assert 'agent-command' in toon_file.metadata",
      "assertions": [
        "Wave field exists and equals DESIGN",
        "Agent-command field present"
      ]
    },
    "test_diagram_wave_metadata": {
      "framework": "pytest",
      "test_code_skeleton": "def test_diagram_wave_metadata():\n    toon_file = TOONParser().parse('nWave/tasks/dw/diagram.toon')\n    assert toon_file.metadata['wave'] == 'DESIGN'\n    assert 'agent-command' in toon_file.metadata",
      "assertions": [
        "Wave field exists and equals DESIGN",
        "Agent-command field present"
      ]
    },
    "unit_tests": [
      {
        "name": "test_toon_parser_valid_command_input",
        "purpose": "Verify parser handles valid TOON command syntax correctly",
        "input": "Sample TOON command file with all required fields (name, description, parameters)",
        "expected": "Parsed dict with command metadata: {name, description, parameters, dependencies}"
      },
      {
        "name": "test_template_rendering_with_parsed_command",
        "purpose": "Verify Jinja2 template renders command.md from parsed data",
        "input": "Parsed command dict from parser output",
        "expected": "Valid Markdown output with command syntax section, parameters table, usage examples"
      },
      {
        "name": "test_output_validation_against_claude_code_spec",
        "purpose": "Verify compiled output meets Claude Code command specification",
        "input": "Generated command.md file",
        "expected": "Validation passes: Has frontmatter, execution context, success criteria sections"
      }
    ],
    "integration_tests": [
      {
        "name": "test_e2e_command_migration_pipeline",
        "purpose": "Verify complete migration: TOON → Parse → Template → Validate → Output",
        "input": "Real TOON command file from nWave/tasks/dw/",
        "steps": "Parse TOON → Apply command template → Validate output → Write to dist/",
        "expected": "Valid command.md in dist/commands/dw/ matching Claude Code spec"
      },
      {
        "name": "test_batch_migration_all_commands",
        "purpose": "Verify batch processing of all command files",
        "input": "All TOON command files (8 dw: commands)",
        "expected": "All 8 commands migrated successfully with validation report"
      }
    ],
    "error_scenario_tests": [
      {
        "name": "test_compiler_not_found_error_handling",
        "purpose": "Verify graceful failure when compiler missing",
        "setup": "Remove or rename tools/toon/compiler.py",
        "expected": "Clear error message, execution stops, no partial output"
      },
      {
        "name": "test_malformed_toon_syntax_error_handling",
        "purpose": "Verify parser reports syntax errors clearly",
        "input": "TOON file with missing ## section header",
        "expected": "Parser error with line number, specific syntax issue description"
      },
      {
        "name": "test_validation_failure_error_handling",
        "purpose": "Verify validation errors reported clearly",
        "input": "TOON file missing required 'description' field",
        "expected": "Validation error: 'Missing required field: description' with file path"
      }
    ]
  },
  "error_handling": {
    "compiler_not_found": {
      "detection": "Step 2 'Compile TOON files' fails with 'command not found'",
      "action": "STOP immediately, escalate: Phase 1 incomplete",
      "recovery": "Wait for Phase 1 completion, do NOT proceed"
    },
    "compilation_failure": {
      "detection": "Compiler exits with code != 0",
      "action": "Capture error message, log to docs/errors/step-04-02-errors.log",
      "recovery": "Review source file, fix metadata/syntax, retry compilation"
    },
    "metadata_validation_failure": {
      "detection": "Test fails on wave metadata assertion",
      "action": "Review source file wave classification, verify correctness",
      "recovery": "If classification wrong: fix source. If test wrong: fix assertion."
    },
    "partial_batch_failure": {
      "detection": "One file compiles, other fails",
      "action": "Rollback ALL conversions (delete both .toon files)",
      "recovery": "Fix failing file, re-run entire batch to ensure consistency"
    },
    "scenario_1_compiler_not_found": {
      "error": "TOON compiler not found at tools/toon/compiler.py",
      "handling": "Log error with clear message: 'Phase 1 TOON infrastructure required. Run Phase 1.1-1.5 first or choose Option B (Markdown).'",
      "recovery": "STOP execution, escalate to user for decision",
      "test": "test_error_compiler_not_found"
    },
    "scenario_2_compilation_failure": {
      "error": "TOON compiler exits with non-zero code",
      "handling": "Log compilation error with file path and stderr output. Skip failed file, continue with others. Generate error report.",
      "recovery": "Review TOON syntax, fix errors, retry compilation",
      "test": "test_error_compilation_failure_graceful"
    },
    "scenario_3_metadata_validation_failure": {
      "error": "Compiled output fails metadata validation (missing required fields)",
      "handling": "Log validation errors with specific missing fields. Mark file as failed. Continue processing other files.",
      "recovery": "Add missing metadata to source TOON file, recompile",
      "test": "test_error_metadata_validation_failure"
    },
    "scenario_4_partial_batch_failure": {
      "error": "Some files in batch succeed, others fail",
      "handling": "Complete all processable files. Generate summary report: X succeeded, Y failed. List failed files with error reasons.",
      "recovery": "Fix failed files individually, rerun batch",
      "test": "test_error_partial_batch_failure_reporting"
    }
  },
  "execution_guidance": {
    "approach": "Command conversion with template validation, following patterns from 04-01/04-01b",
    "workflow": [
      "STEP 0: VERIFY PREREQUISITES",
      "  - Confirm step 04-01 and 04-01b complete",
      "  - Confirm tools/toon/compiler exists",
      "  - Review discuss.toon and start.toon as conversion templates",
      "  - Confirm TOON v3.0 spec available",
      "  - If prerequisites missing: STOP and escalate",
      "STEP 1: Convert design.md to design.toon",
      "  - Use TOON v3.0 format specification",
      "  - Preserve agent-activation header from YAML frontmatter",
      "  - Set wave metadata to DESIGN",
      "  - Verify agent-id: solution-architect",
      "STEP 2: Convert diagram.md to diagram.toon",
      "  - Use TOON v3.0 format specification",
      "  - Preserve agent-activation header from YAML frontmatter",
      "  - Set wave metadata to DESIGN",
      "  - Verify agent-id: architecture-diagram-manager",
      "STEP 3: Compile both TOON files",
      "  - Run: toon-compiler nWave/tasks/dw/design.toon --validate",
      "  - Run: toon-compiler nWave/tasks/dw/diagram.toon --validate",
      "  - Verify exit code = 0 for BOTH",
      "  - If either fails: rollback both, fix issue, restart (see error_handling)",
      "STEP 4: Write tests to validate conversions",
      "  - Implement test_design_command_compiles",
      "  - Implement test_diagram_command_compiles",
      "  - Implement test_design_wave_metadata",
      "  - Implement test_diagram_wave_metadata",
      "STEP 5: Run test suite",
      "  - Execute: pytest tests/test_design_conversion.py",
      "  - All tests MUST pass (100% required)",
      "STEP 6: Verify quality gates",
      "  - Check all acceptance criteria satisfied",
      "STEP 7: DO NOT COMMIT - wait for user approval"
    ],
    "quality_gates": [
      "All tests passing (100% required)",
      "Both commands compile successfully with exit code 0",
      "Wave metadata correct (DESIGN) for both files",
      "Agent-activation headers valid and preserved for both files",
      "No report files created"
    ]
  },
  "agent_bindings": {
    "design": "solution-architect",
    "diagram": "architecture-diagram-manager"
  },
  "adversarial_review_summary": {
    "original_risk_score": 7.5,
    "corrected_risk_score": 3.5,
    "major_corrections_applied": [
      "Added prerequisite checks for Phase 1 infrastructure and TOON spec",
      "Added dependency on 04-01/04-01b completion",
      "Added TOON compiler specification with invocation details",
      "Updated time estimate from 1h to 3-4h",
      "Added comprehensive error handling including partial batch failure",
      "Added detailed test specifications with pytest examples",
      "Added agent bindings table for design and diagram commands",
      "Removed unvalidated token savings claim (SC7) from step-level"
    ],
    "remaining_risks": [
      "TOON format specification availability (mitigated by prerequisite checks)",
      "Dependency on Phase 1 infrastructure (mitigated by verification)"
    ]
  },
  "review_metadata": {
    "reviewed_by": "Lyra (corrected after adversarial review)",
    "review_date": "2026-01-06",
    "review_status": "CORRECTED - Ready for execution after prerequisite verification",
    "corrections_applied": "Prerequisites added, TOON format clarification addressed, time estimate corrected, error handling added, agent bindings specified",
    "estimated_hours_justification": "3-4 hours includes: 0.5h review previous patterns, 1-1.5h conversion of 2 files, 1h test implementation, 0.5-1h compilation/validation"
  },
  "validation": {
    "status": "approved",
    "notes": "Quality review complete. Overall score: 8.6/10. Excellent clarity, dependencies, success criteria, and constraints. Minor scope clarification recommended for batch integration test (scope to 2 commands for this step, defer full 8-command batch test to Phase 4.4). Agent-ID verification recommended as non-blocking prerequisite check.",
    "review_date": "2026-01-13",
    "reviewer": "Lyra",
    "quality_scores": {
      "task_clarity": 9,
      "dependencies": 8.5,
      "success_criteria": 9,
      "constraints": 9.5,
      "testability": 9,
      "scope": 7.5,
      "overall": 8.6
    },
    "recommended_revisions": [
      "Add agent_bindings_verification to prerequisite_checks (non-blocking)",
      "Scope integration test to 2 DESIGN commands (design + diagram only)",
      "Add note deferring 8-command batch testing to Phase 4.4"
    ],
    "execution_readiness": "Ready for execution after prerequisite verification",
    "migrated_at": "2026-01-13T22:11:27.204708"
  }
}