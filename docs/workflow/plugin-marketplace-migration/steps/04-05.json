{
  "project_id": "plugin-marketplace-migration",
  "step_id": "04-05",
  "phase": {
    "number": 4,
    "name": "Command Migration",
    "purpose": "Convert all 20 commands to TOON format"
  },
  "step": {
    "number": "4.5",
    "name": "Convert DEMO Wave Commands",
    "description": "Convert deliver.md (2.4K) and finalize.md (17K) to TOON format with comprehensive validation",
    "motivation": "DEMO wave handles deployment and closure. Finalize has complex parameter dispatch protocol requiring careful conversion",
    "estimated_hours": "2-3"
  },
  "context": {
    "constraints": [
      "DO NOT CREATE NEW REPORT FILES",
      "DO NOT COMMIT BEFORE USER APPROVAL",
      "FOCUS ON DELIVERABLES ONLY",
      "Tests use business language and domain concepts",
      "Type system makes wrong state non-representable",
      "MANDATORY: Verify TOON format supports agent-parameter metadata before conversion",
      "MANDATORY: Preserve all finalize parameter parsing and validation logic",
      "MANDATORY: Test runtime behavior, not just compilation"
    ],
    "success_criteria_mapping": {
      "SC1": "All source files in TOON v3.0 format",
      "SC7": "~60% token savings in source files"
    },
    "dependencies": [
      "02-04"
    ],
    "progress_tracking": "2 of 20 commands (deliver, finalize). After completion: 16 of 20 TOON files exist. See task 04-06 for final validation of all 20"
  },
  "agent_bindings": {
    "deliver": {
      "agent_id": "devop",
      "source": "deliver.md frontmatter",
      "binding_type": "single_agent",
      "notes": "Straightforward binding to devop agent for deployment operations"
    },
    "finalize": {
      "agent_parameter": true,
      "source": "finalize.md frontmatter",
      "binding_type": "parameterized",
      "parameter_format": "@{agent-name} {project-id}",
      "notes": "Special case: accepts agent as runtime parameter. TOON conversion MUST preserve agent-parameter: true metadata",
      "validation_required": [
        "Parameter extraction (@-prefix, quote stripping, whitespace handling)",
        "Agent registry lookup (valid agents list)",
        "Project-id extraction (second parameter)",
        "Error handling (unknown agent, missing project-id, invalid format)"
      ]
    }
  },
  "file_complexity_notes": {
    "deliver": {
      "size": "2.4K",
      "complexity": "LOW",
      "structure": "Linear control flow, straightforward error handling",
      "estimated_conversion_time": "20-30 minutes",
      "risk": "LOW"
    },
    "finalize": {
      "size": "17K",
      "complexity": "HIGH",
      "structure": "Multi-step parameter dispatch protocol with conditional branching",
      "logic_steps": [
        "Step 1: Extract agent parameter (@-prefix handling)",
        "Step 2: Verify agent exists in registry",
        "Step 3: Extract project-id (second parameter)",
        "Step 4: Validate against business rules",
        "Step 5: Execute with dispatch error handling"
      ],
      "estimated_conversion_time": "70-90 minutes",
      "risk": "MEDIUM-HIGH - Complex logic may not translate perfectly to TOON format",
      "critical_requirements": [
        "Preserve all conditional logic blocks",
        "Preserve all error handling paths",
        "Preserve agent-parameter metadata flag",
        "Preserve parameter parsing rules (quotes, whitespace, validation)"
      ]
    }
  },
  "deliverables": {
    "files_to_create": [
      "nWave/tasks/dw/deliver.toon",
      "nWave/tasks/dw/finalize.toon"
    ],
    "acceptance_criteria": [
      "Commands compile with agent-activation headers",
      "Wave metadata correct (DEMO)",
      "deliver.toon has agent-id: devop in metadata",
      "finalize.toon has agent-parameter: true in metadata",
      "finalize.toon preserves all parameter parsing logic",
      "finalize.toon preserves all error handling paths",
      "All tests passing (100% required) including runtime validation tests"
    ]
  },
  "tdd_approach": {
    "outer_test": "GIVEN DEMO wave command .toon files (deliver, finalize)\nWHEN compiled\nTHEN output has wave: DEMO in metadata\nAND deliver has agent-id: devop\nAND finalize has agent-parameter: true\nAND all parameter parsing logic preserved",
    "inner_tests": [
      "test_deliver_command_compiles",
      "test_deliver_agent_binding_correct",
      "test_finalize_command_compiles",
      "test_finalize_agent_parameter_flag_preserved",
      "test_finalize_parameter_parsing_rules",
      "test_finalize_agent_validation_logic",
      "test_finalize_project_id_extraction",
      "test_finalize_error_handling_paths",
      "test_finalize_edge_cases_parameter_input"
    ],
    "test_coverage_notes": {
      "deliver_tests": "Generic compilation + agent binding validation (2 tests sufficient)",
      "finalize_tests": "Comprehensive: compilation + metadata + parameter parsing + agent validation + error handling + edge cases (7 tests minimum)",
      "rationale": "Finalize is 7x larger with complex dispatch protocol requiring thorough validation beyond compilation"
    }
  },
  "refactoring": {
    "targets": [
      {
        "level": 1,
        "description": "Consistent command structure between deliver and finalize",
        "considerations": [
          "Normalize parameter parsing style if possible",
          "Consistent error handling patterns",
          "Aligned section ordering in TOON output"
        ],
        "intentional_differences": [
          "finalize has parameterized agent binding (deliver does not)",
          "finalize has multi-step validation (deliver is linear)",
          "These differences are functional, not organizational - preserve them"
        ]
      }
    ],
    "notes": "Structural differences between deliver (simple) and finalize (complex) are intentional based on functional requirements. Refactoring should focus on consistent patterns within each command's complexity level, not forcing uniformity across different complexity classes"
  },
  "execution_guidance": {
    "approach": "Careful command conversion with comprehensive runtime validation",
    "workflow": [
      "1. VERIFY PREREQUISITES: Confirm TOON compiler supports agent-parameter metadata (BLOCKING)",
      "2. VERIFY PREREQUISITES: Confirm TOON compiler tested with 17K file complexity (BLOCKING)",
      "3. Convert deliver.md to deliver.toon (20-30 min)",
      "4. Compile deliver.toon and verify agent-id: devop binding",
      "5. Write deliver tests (compilation + agent binding)",
      "6. Convert finalize.md to finalize.toon (70-90 min)",
      "7. CRITICAL: Verify agent-parameter: true metadata preserved in finalize.toon",
      "8. CRITICAL: Verify all parameter parsing logic preserved (Step 1-5)",
      "9. Compile finalize.toon with verbose output to catch any logic translation issues",
      "10. Write finalize tests (compilation + metadata + parameter parsing + validation + error handling + edge cases)",
      "11. Run all tests with 100% pass requirement",
      "12. Apply Level 1 refactoring if time permits (consistent patterns)",
      "13. DO NOT COMMIT - wait for user approval"
    ],
    "quality_gates": [
      "All tests passing (100% required)",
      "Both commands compile successfully",
      "Wave metadata correct (DEMO)",
      "Agent-activation headers valid",
      "deliver: agent-id = devop verified",
      "finalize: agent-parameter = true verified",
      "finalize parameter parsing logic preserved (manual code review)",
      "finalize error handling paths preserved (manual code review)",
      "Runtime validation tests pass (not just compilation)",
      "No report files created"
    ],
    "time_allocation": {
      "deliver_conversion": "20-30 minutes",
      "deliver_testing": "10-15 minutes",
      "finalize_conversion": "70-90 minutes",
      "finalize_testing": "30-40 minutes",
      "refactoring": "10-15 minutes",
      "total_estimated": "140-190 minutes (2.3-3.2 hours)"
    }
  },
  "prerequisite_checks": {
    "phase_1_toon_infrastructure": {
      "requirement": "TOON parser and compiler from Phase 1 must be complete",
      "verification": "Confirm tools/toon/compiler.py exists and test_toon_parser passes",
      "blocking": true,
      "escalation": "If Phase 1 incomplete, STOP - escalate to project manager for decision on Option B (Markdown) or Option C (Block)"
    },
    "toon_format_specification": {
      "requirement": "TOON v3.0 format specification must be available",
      "verification": "Obtain from tools/toon/TOON-v3.0-SPEC.md or reference implementation",
      "blocking": true,
      "escalation": "If spec unavailable, create from reverse-engineering agents/novel-editor-chatgpt-toon.txt"
    },
    "baseline_measurements": {
      "requirement": "Baseline measurements from Phase 0 must be complete",
      "verification": "Confirm docs/workflow/plugin-marketplace-migration/baseline.yaml exists with command metrics",
      "blocking": true,
      "escalation": "If baseline missing, execute Phase 0 baseline measurement first"
    },
    "toon_compiler_finalize_support": {
      "requirement": "TOON compiler must support finalize.md complexity (17K with conditional logic)",
      "verification": "Test TOON compiler with sample file containing conditional blocks, parameter parsing, multi-step logic",
      "blocking": true,
      "escalation": "If compiler doesn't support finalize complexity, escalate for TOON spec extension or alternative approach"
    },
    "agent_parameter_metadata_support": {
      "requirement": "TOON format must support agent-parameter: true metadata flag",
      "verification": "Check TOON v3.0 spec for agent-parameter field definition OR test with sample file",
      "blocking": true,
      "escalation": "If agent-parameter not supported, define translation strategy OR escalate as blocker"
    }
  },
  "toon_compiler": {
    "tool_location": "tools/toon/compiler.py (from Phase 1)",
    "purpose": "Transforms TOON source to Claude Code compliant output",
    "input": "nWave/tasks/dw/*.toon (TOON format)",
    "output": "dist/commands/dw/*.md (Markdown format)",
    "invocation": "python tools/toon/compiler.py <input.toon> --validate --output <output.md>",
    "success_criteria": [
      "Exit code = 0 (no errors)",
      "No errors in stderr",
      "Output file size > 1000 bytes (non-trivial content)",
      "Metadata validates against TOON v3.0 schema",
      "Output markdown is Claude Code compliant",
      "agent-parameter metadata preserved in finalize output",
      "Complex conditional logic preserved in finalize output"
    ],
    "validation": "pytest tests/tools/toon/test_compiler.py",
    "finalize_specific_validation": [
      "Compile finalize.toon with --verbose flag to see logic translation",
      "Manually review compiled output for parameter parsing preservation",
      "Manually review compiled output for error handling path preservation",
      "Test compiled finalize.md with sample parameter inputs to verify runtime behavior"
    ]
  },
  "error_handling": {
    "scenario_1_compiler_not_found": {
      "error": "TOON compiler not found at tools/toon/compiler.py",
      "handling": "Log error with clear message: 'Phase 1 TOON infrastructure required. Run Phase 1.1-1.5 first or choose Option B (Markdown).'",
      "recovery": "STOP execution, escalate to user for decision",
      "test": "test_error_compiler_not_found"
    },
    "scenario_2_compilation_failure": {
      "error": "TOON compiler exits with non-zero code",
      "handling": "Log compilation error with file path and stderr output. Skip failed file, continue with others. Generate error report.",
      "recovery": "Review TOON syntax, fix errors, retry compilation",
      "test": "test_error_compilation_failure_graceful"
    },
    "scenario_3_metadata_validation_failure": {
      "error": "Compiled output fails metadata validation (missing required fields)",
      "handling": "Log validation errors with specific missing fields. Mark file as failed. Continue processing other files.",
      "recovery": "Add missing metadata to source TOON file, recompile",
      "test": "test_error_metadata_validation_failure"
    },
    "scenario_4_partial_batch_failure": {
      "error": "Some files in batch succeed, others fail",
      "handling": "Complete all processable files. Generate summary report: X succeeded, Y failed. List failed files with error reasons.",
      "recovery": "Fix failed files individually, rerun batch",
      "test": "test_error_partial_batch_failure_reporting"
    },
    "scenario_5_agent_parameter_metadata_loss": {
      "error": "finalize.toon compiled successfully but agent-parameter: true metadata missing from output",
      "handling": "CRITICAL ERROR: Log with severity HIGH. STOP processing. This is a blocking issue.",
      "recovery": "Verify TOON spec supports agent-parameter OR define translation strategy",
      "test": "test_error_finalize_agent_parameter_preservation"
    },
    "scenario_6_finalize_logic_translation_failure": {
      "error": "finalize.toon compiles but parameter parsing logic incorrect or missing",
      "handling": "CRITICAL ERROR: Log with severity HIGH. Compare source finalize.md logic blocks with compiled output. STOP if logic lost.",
      "recovery": "Manual review + correction of TOON conversion OR escalate to TOON spec extension",
      "test": "test_error_finalize_logic_preservation"
    }
  },
  "test_specifications": {
    "deliver_tests": [
      {
        "name": "test_deliver_command_compiles",
        "purpose": "Verify deliver.toon compiles without errors",
        "input": "nWave/tasks/dw/deliver.toon",
        "expected": "Exit code 0, no compilation errors, output file created"
      },
      {
        "name": "test_deliver_agent_binding_correct",
        "purpose": "Verify deliver.toon has correct agent binding",
        "input": "Compiled deliver.md output",
        "expected": "Metadata contains agent-id: devop"
      },
      {
        "name": "test_deliver_wave_metadata",
        "purpose": "Verify deliver.toon has DEMO wave metadata",
        "input": "Compiled deliver.md output",
        "expected": "Metadata contains wave: DEMO"
      }
    ],
    "finalize_tests": [
      {
        "name": "test_finalize_command_compiles",
        "purpose": "Verify finalize.toon compiles without errors",
        "input": "nWave/tasks/dw/finalize.toon",
        "expected": "Exit code 0, no compilation errors, output file created"
      },
      {
        "name": "test_finalize_agent_parameter_flag_preserved",
        "purpose": "CRITICAL: Verify finalize.toon preserves agent-parameter metadata",
        "input": "Compiled finalize.md output",
        "expected": "Metadata contains agent-parameter: true",
        "blocking": true,
        "notes": "If this fails, conversion is fundamentally broken - finalize loses parameterization capability"
      },
      {
        "name": "test_finalize_wave_metadata",
        "purpose": "Verify finalize.toon has DEMO wave metadata",
        "input": "Compiled finalize.md output",
        "expected": "Metadata contains wave: DEMO"
      },
      {
        "name": "test_finalize_parameter_parsing_rules",
        "purpose": "Verify finalize parameter parsing logic preserved",
        "input": "Compiled finalize.md, test parameters: ['@agent projectid', '@\"quoted agent\" projectid', '@agent   projectid', '@agent \"quoted-project\"']",
        "expected": "All parameter formats parsed correctly: @ prefix stripped, quotes handled, whitespace trimmed",
        "test_type": "runtime_validation",
        "notes": "Tests actual execution, not just compilation"
      },
      {
        "name": "test_finalize_agent_validation_logic",
        "purpose": "Verify finalize validates agent against registry",
        "input": "Compiled finalize.md, test agent: valid agent from registry, invalid agent not in registry",
        "expected": "Valid agent: proceeds. Invalid agent: error with message 'Agent not found in registry'",
        "test_type": "runtime_validation"
      },
      {
        "name": "test_finalize_project_id_extraction",
        "purpose": "Verify finalize extracts project-id (second parameter) correctly",
        "input": "Compiled finalize.md, test inputs: '@agent simple-project', '@agent complex-project-123', '@agent \"project with spaces\"'",
        "expected": "Project IDs extracted: 'simple-project', 'complex-project-123', 'project with spaces'",
        "test_type": "runtime_validation"
      },
      {
        "name": "test_finalize_error_handling_paths",
        "purpose": "Verify finalize error handling preserved",
        "input": "Compiled finalize.md, error scenarios: missing agent parameter, missing project-id, unknown agent, invalid format",
        "expected": "All error paths trigger appropriate error messages without crashes",
        "test_type": "runtime_validation"
      },
      {
        "name": "test_finalize_edge_cases_parameter_input",
        "purpose": "Verify finalize handles parameter edge cases",
        "input": "Edge cases: '@InvalidAgent projectid', '@agent \"\"', '@agent   projectid', '@\"quoted agent\" projectid', '@UnknownAgent projectid'",
        "expected": "Graceful handling: invalid agent rejected, empty project-id rejected, whitespace normalized, quotes handled, unknown agent error",
        "test_type": "runtime_validation",
        "notes": "Critical for production robustness"
      }
    ],
    "integration_tests": [
      {
        "name": "test_e2e_demo_wave_commands",
        "purpose": "Verify both DEMO wave commands work end-to-end",
        "input": "deliver.toon and finalize.toon",
        "steps": "Compile both → validate metadata → test deliver invocation → test finalize invocation with parameters",
        "expected": "Both commands compile, both have correct metadata, both execute successfully"
      }
    ],
    "metadata_preservation_tests": [
      {
        "name": "test_all_frontmatter_metadata_preserved",
        "purpose": "Verify TOON conversion preserves all metadata fields from source markdown",
        "input": "deliver.md and finalize.md frontmatter, compiled deliver.toon and finalize.toon output",
        "expected": "All frontmatter fields present in compiled output: wave, agent-id (deliver), agent-parameter (finalize), description, etc.",
        "notes": "Regression test to catch any metadata loss during conversion"
      }
    ]
  },
  "security_validation": {
    "finalize_parameter_injection_tests": [
      {
        "name": "test_finalize_parameter_sanitization",
        "purpose": "Verify finalize rejects malicious parameter inputs",
        "malicious_inputs": [
          "@agent-id-with-special-chars projectid",
          "@../../../some-path projectid",
          "@$(command-injection) projectid",
          "@agent ../../../private-data",
          "@agent 999999999999999"
        ],
        "expected": "All malicious inputs rejected with appropriate error messages. No path traversal, no command injection, no resource exhaustion",
        "test_type": "security_validation"
      }
    ]
  },
  "toon_format_verification": {
    "requirement": "Before conversion, verify TOON format capabilities",
    "verification_steps": [
      "1. Read TOON v3.0 specification for agent-parameter field support",
      "2. Test TOON compiler with sample file containing agent-parameter: true",
      "3. Test TOON compiler with sample file containing conditional logic (if/else blocks)",
      "4. Test TOON compiler with sample file containing multi-step parameter parsing",
      "5. Verify compiled output preserves all logic from source"
    ],
    "escalation_triggers": [
      "If agent-parameter not supported: Define translation strategy OR escalate as blocker",
      "If conditional logic not preserved: TOON spec extension required OR escalate",
      "If parameter parsing lost: Manual conversion required OR escalate"
    ]
  },
  "review_metadata": {
    "adversarial_review_date": "2026-01-05",
    "adversarial_reviewer": "Lyra (adversarial-review-mode)",
    "adversarial_review_file": "docs/workflow/plugin-marketplace-migration/adversarial-reviews/adversarial-review-04-05.md",
    "risk_score": "6/10 (MEDIUM-HIGH)",
    "blast_radius": "Phase 4 completion + Task 04-06 validation",
    "approval_status": "APPROVED with mandatory clarifications",
    "mandatory_clarifications_implemented": [
      "TOON format capabilities verification added to prerequisite checks",
      "Agent bindings documented explicitly (deliver: devop, finalize: agent-parameter)",
      "Time estimate extended from 1 hour to 2-3 hours",
      "Finalize-specific test suite added (7 additional tests)",
      "Refactoring targets defined with intentional differences documented",
      "Test framework patterns referenced from 04-04",
      "File complexity notes added (deliver: 2.4K/LOW, finalize: 17K/HIGH)",
      "Security validation tests added for parameter injection",
      "Metadata preservation tests added",
      "Error handling scenarios expanded for finalize-specific failures"
    ],
    "corrections_applied": {
      "contradiction_1_time_estimate": "Extended from 1 hour to 2-3 hours with detailed time allocation breakdown",
      "contradiction_2_test_coverage": "Added 7 finalize-specific tests (parameter parsing, agent validation, error handling, edge cases, security)",
      "contradiction_3_agent_bindings": "Documented explicitly: deliver → devop, finalize → agent-parameter: true",
      "contradiction_4_refactoring_empty": "Added Level 1 refactoring targets with intentional differences documented",
      "dangerous_assumption_1_toon_preserves_logic": "Added prerequisite checks to verify TOON compiler capabilities before conversion",
      "dangerous_assumption_2_agent_parameter_maps": "Added blocking prerequisite check for agent-parameter metadata support",
      "dangerous_assumption_3_tests_sufficient": "Expanded test suite from 2 to 10 tests with runtime validation",
      "dangerous_assumption_4_time_includes_testing": "Time allocation explicitly breaks down conversion + testing + refactoring",
      "dangerous_assumption_5_dependencies": "Added context.progress_tracking and documented 04-05 → 04-06 coupling",
      "edge_case_1_parameter_parsing": "Added test_finalize_edge_cases_parameter_input with comprehensive edge cases",
      "edge_case_2_agent_registry": "Added test_finalize_agent_validation_logic for runtime agent availability",
      "edge_case_5_agent_parameter_loss": "Added error_handling scenario_5 and test_finalize_agent_parameter_flag_preserved",
      "security_hole_1_parameter_injection": "Added security_validation section with parameter sanitization tests",
      "security_hole_2_project_id_manipulation": "Included in parameter sanitization tests (path traversal, resource exhaustion)",
      "test_coverage_gap_1_parameter_parsing": "Added 3 tests: parsing rules, agent validation, project-id extraction",
      "test_coverage_gap_2_runtime_behavior": "All finalize tests marked as runtime_validation type",
      "test_coverage_gap_4_metadata_preservation": "Added test_all_frontmatter_metadata_preserved",
      "integration_point_risk_1_toon_compiler": "Added toon_format_verification section with explicit verification steps",
      "integration_point_risk_4_artifact_location": "Documented in deliverables.files_to_create with exact paths"
    },
    "unverified_assumptions_addressed": {
      "toon_compiler_supports_finalize_complexity": "Added as blocking prerequisite check",
      "agent_parameter_flag_maps_to_toon": "Added as blocking prerequisite check",
      "one_hour_estimate_includes_all_work": "Time allocation explicitly detailed",
      "compilation_equals_correctness": "Runtime validation tests added",
      "agent_bindings_documented_elsewhere": "Explicitly documented in agent_bindings section",
      "test_framework_from_04_04_available": "Referenced in test specifications",
      "finalize_parameter_parsing_robust": "Security validation tests added"
    }
  },
  "validation": {
    "status": "pending",
    "notes": "Step validation",
    "migrated_at": "2026-01-13T22:11:27.242722"
  }
}