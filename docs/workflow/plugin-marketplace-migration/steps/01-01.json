{
  "project_id": "plugin-marketplace-migration",
  "step_id": "01-01",
  "phase": {
    "number": 1,
    "name": "TOON Infrastructure",
    "purpose": "Create parser and compiler toolchain that transforms TOON source into Claude Code compliant output"
  },
  "step": {
    "number": "1.1",
    "name": "Create TOON Parser Core",
    "description": "Implement TOON parser that reads .toon files and produces structured data.\n\nCRITICAL PREREQUISITE: Resolve TOON version strategy BEFORE implementation.\n- Test fixture (agents/novel-editor-chatgpt-toon.txt) uses TOON v1.0 (CONFIRMED)\n- Original spec references TOON v3.0\n- VERSION MISMATCH IDENTIFIED: Must resolve which version is actual target\n- DECISION REQUIRED: Support v1.0 only, v3.0 only, or version detection + both (recommended)\n- Recommended: Option C (version detection) - Most flexible, supports existing content and future v3.0 adoption (+3 hours)\n\nLIBRARY EVALUATION: Validate python-toon availability via working command\n- USE: 'pip index versions python-toon' OR 'pip install python-toon && python -c \"import toon\"'\n- NOTE: 'pip search' is deprecated (2021) - DO NOT USE\n- If available with API docs: Use library (4-6 hours)\n- If unavailable: Custom parser (12-16 hours including lexer, parser, semantic validation, error handling)\n- CONTINGENCY REVISED: Custom parser estimate increased from 8 to 12-16 hours based on complexity analysis\n\nParser must handle: sections (##), key-value pairs, nested structures, TOON symbols (→, ⟷, ≠, ✓, ✗, ⚠️), multiline content, comments, UTF-8 encoding.\n\nSCHEMA COORDINATION: Parser output schema must be coordinated with step 1.2 (Jinja2 template) owner BEFORE finalization to prevent rework.\n\nERROR HANDLING: Parser must raise ToonParseError with clear messages on malformed input (line number, syntax issue, suggested fix).",
    "motivation": "Parser is foundation for all migration - nothing works without it. Version mismatch and schema design are critical blockers that cascade through steps 1.2-1.6.",
    "estimated_hours": "16-20 (library path) OR 16-22 (custom parser with version detection)"
  },
  "context": {
    "constraints": [
      "DO NOT CREATE NEW REPORT FILES",
      "DO NOT COMMIT BEFORE USER APPROVAL",
      "FOCUS ON DELIVERABLES ONLY",
      "Tests use business language and domain concepts",
      "Type system makes wrong state non-representable",
      "Minimum Python 3.9 (for dict | union syntax in type hints)",
      "UTF-8 encoding assumed - parser must validate and raise clear error on encoding mismatch",
      "Test isolation REQUIRED - run with pytest -n (parallel mode) to validate no shared state"
    ],
    "success_criteria_mapping": {
      "SC2": "Build produces Claude Code compliant output"
    },
    "dependencies": [],
    "toon_symbols_enumerated": [
      "→ (implies/arrow)",
      "⟷ (alternates/bidirectional)",
      "≠ (not equal)",
      "✓ (correct/checkmark)",
      "✗ (wrong/cross)",
      "⚠️ (warning)"
    ],
    "test_data_reference": "agents/novel-editor-chatgpt-toon.txt (TOON v1.0 example - 259 lines)",
    "test_framework": "pytest with conftest.py in tests/ root, parallel execution validated via pytest -n",
    "dependency_management": "Update tools/requirements.txt with 'python-toon>=X.Y' if library chosen, document decision in commit message"
  },
  "deliverables": {
    "files_to_create": [
      "tools/toon/__init__.py",
      "tools/toon/parser.py",
      "tools/toon/schema/parser_output.json",
      "tests/tools/toon/test_parser.py",
      "tools/toon/parser_schema.py",
      "tools/toon/exceptions.py (for ToonParseError)"
    ],
    "acceptance_criteria": [
      "Parser detects TOON version (v1.0 or v3.0) and handles appropriately",
      "Parser reads TOON syntax without errors for target version",
      "Parser produces structured TypedDict/dataclass output (schema coordinated with step 1.2)",
      "Parser handles all TOON symbols explicitly: → ⟷ ≠ ✓ ✗ ⚠️",
      "Parser extracts metadata section correctly",
      "Parser handles nested hierarchies",
      "Parser output schema documented (TypedDict or dataclass) with example in schema/parser_output.json",
      "Parser raises ToonParseError on malformed input with line number and syntax issue details",
      "Parser validates UTF-8 encoding and raises clear error on encoding mismatch",
      "Unit tests achieve ≥85% code coverage (measured via pytest-cov)",
      "Critical parsing logic (symbol handling, nested structures) achieves ≥95% coverage",
      "Tests pass in parallel execution mode (pytest -n) - no shared mutable state",
      "Parser output schema approved by step 1.2 owner before commit"
    ]
  },
  "tdd_approach": {
    "outer_test": "GIVEN a valid .toon file with agent definition\nWHEN I call parser.parse(toon_content)\nTHEN I get a structured dict/object with id, role, commands, dependencies, metadata, sections",
    "inner_tests": [
      "test_parse_empty_file_returns_empty_dict",
      "test_parse_section_headers_extracted",
      "test_parse_key_value_pairs",
      "test_parse_nested_lists",
      "test_parse_toon_symbols_converted",
      "test_parse_multiline_content",
      "test_parse_inline_comments_stripped",
      "test_parse_detects_version_v1_0",
      "test_parse_detects_version_v3_0",
      "test_parse_detects_version_mismatch_raises_error",
      "test_parse_detects_malformed_toon_raises_error",
      "test_parse_detects_encoding_mismatch_raises_error",
      "test_parse_error_includes_line_number_and_details",
      "test_parse_handles_utf8_symbols_correctly"
    ]
  },
  "refactoring": {
    "targets": [
      {
        "level": 1,
        "focus": "Clear naming for parse methods"
      },
      {
        "level": 2,
        "focus": "Extract section parsers from monolithic parse function"
      },
      {
        "level": 3,
        "focus": "Separate lexer from parser responsibility"
      }
    ]
  },
  "execution_guidance": {
    "approach": "Outside-In TDD with double-loop",
    "workflow": [
      "0. PREREQUISITE: Complete blocking_prerequisite_check items (TOON version, library validation, schema coordination)",
      "1. Write failing E2E test (outer_test) with coordinated schema",
      "2. Implement via inner TDD loop (inner_tests including version detection and error handling)",
      "3. Apply refactoring levels 1-3 progressively",
      "4. Validate all acceptance criteria met including coverage thresholds",
      "5. Run tests in parallel mode (pytest -n) to validate isolation",
      "6. Schema review and approval by step 1.2 owner",
      "7. DO NOT COMMIT - wait for user approval"
    ],
    "quality_gates": [
      "All tests passing (100% required)",
      "Tests pass in parallel execution (pytest -n)",
      "Coverage ≥85% general, ≥95% critical paths",
      "All acceptance criteria validated",
      "Refactoring applied (levels 1-3)",
      "No report files created",
      "Schema approved by step 1.2 owner"
    ],
    "rollback_plan": "If parser output schema incompatible with step 1.2 after completion: halt step 1.2, redesign parser schema (4-6 hours), update tests, re-validate with 1.2 owner before proceeding"
  },
  "review_metadata": {
    "review_date": "2026-01-05",
    "reviewer": "Lyra (software-crafter review mode + adversarial review mode)",
    "review_type": "task_clarity_completeness_achievability + adversarial_verification",
    "status": "adversarial_corrections_applied",
    "adversarial_review_file": "docs/workflow/plugin-marketplace-migration/adversarial-reviews/ADVERSARIAL_REVIEW_01-01.md",
    "severity_distribution": {
      "critical": 9,
      "high": 6,
      "medium": 5,
      "low": 3
    },
    "corrections_applied": {
      "toon_version_mismatch": "Added version detection requirement and clarified v1.0 vs v3.0 conflict",
      "library_validation_command": "Updated from deprecated 'pip search' to 'pip index versions' or direct install test",
      "custom_parser_estimate": "Revised from 8 to 12-16 hours based on complexity analysis",
      "schema_coordination": "Added requirement for step 1.2 owner approval before finalization",
      "error_handling": "Added ToonParseError with line numbers and details",
      "test_isolation": "Added pytest -n parallel execution requirement",
      "coverage_requirements": "Added ≥85% general, ≥95% critical coverage thresholds",
      "utf8_encoding": "Added UTF-8 validation and encoding mismatch error handling",
      "rollback_plan": "Added schema incompatibility rollback procedure",
      "additional_tests": "Added version detection, malformed input, encoding tests"
    }
  },
  "blocking_prerequisite_check": {
    "required_before_execution": [
      {
        "name": "Resolve TOON version strategy (v1.0 vs v3.0)",
        "description": "CRITICAL: Test data is v1.0, spec references v3.0 - must resolve before implementation",
        "estimated_time_minutes": 60,
        "steps": [
          "Check agents/novel-editor-chatgpt-toon.txt header (confirmed: TOON v1.0)",
          "Verify if TOON v3.0 spec exists at github.com/toon-format/spec OR in baseline.yaml",
          "DECISION OPTIONS:",
          "  A) Implement v1.0 parser only (simpler, supports existing fixture, 16-20 hours)",
          "  B) Implement v3.0 parser + convert fixture to v3.0 (future-proof, requires fixture update, 18-22 hours)",
          "  C) Implement version detection + support both (most flexible, +3 hours, 19-23 hours total)",
          "Document chosen strategy and rationale in task file"
        ],
        "recommended_decision": "Option C (version detection) - Most flexible, supports existing content and future v3.0 adoption",
        "go_no_go_criteria": "Version strategy documented and approved by tech lead → GO. No decision → NO-GO, cannot proceed.",
        "blocking": true,
        "status": "UNRESOLVED - BLOCKER"
      },
      {
        "name": "Validate python-toon library availability",
        "description": "Check if python-toon library exists on PyPI and has usable API",
        "command": "pip index versions python-toon 2>&1 || pip install python-toon && python -c 'import toon; print(toon.__version__)' 2>&1 || echo 'LIBRARY NOT FOUND'",
        "estimated_time_minutes": 15,
        "steps": [
          "Run: pip index versions python-toon (NOTE: pip search is deprecated, do NOT use)",
          "If found: Review documentation at https://pypi.org/project/python-toon/",
          "Check: Last update date, download count, API documentation quality",
          "If not found via pip index: Try direct install: pip install python-toon && python -c 'import toon'",
          "DECISION: Library with clear API → GO (use library, 4-6 hours). No library or unclear API → GO (custom parser, 12-16 hours)"
        ],
        "go_no_go_criteria": "Library available with API documentation → LIBRARY PATH (4-6 hrs). Library unavailable → CUSTOM PARSER PATH (12-16 hrs)",
        "blocking": true,
        "status": "UNRESOLVED - BLOCKER"
      },
      {
        "name": "Coordinate parser output schema with step 1.2 owner",
        "description": "Prevent circular dependency - get template requirements from 1.2 before finalizing parser schema",
        "estimated_time_minutes": 90,
        "deliverable": "tools/toon/schema/parser_output.json with TypedDict definition",
        "steps": [
          "Contact step 1.2 (Jinja2 template) owner",
          "Request template requirements sketch: what fields does template need from parser?",
          "Design parser schema to satisfy template requirements",
          "Document schema in parser_output.json with example",
          "Get approval from 1.2 owner before finalizing"
        ],
        "example_schema": {
          "type": "TypedDict",
          "required_fields": {
            "id": "str - Unique identifier",
            "type": "Literal['agent', 'command', 'skill'] - Content type for template selection",
            "version": "str - TOON version detected (v1.0 or v3.0)",
            "metadata": "dict[str, Any] - Frontmatter/header information",
            "sections": "dict[str, Any] - Parsed content sections"
          },
          "example_output": {
            "id": "software-crafter",
            "type": "agent",
            "version": "v1.0",
            "metadata": {
              "name": "Crafty",
              "model": "claude-sonnet-4.5"
            },
            "sections": {
              "commands": [
                "develop",
                "refactor",
                "mikado"
              ],
              "dependencies": [
                "tools/toon/parser"
              ],
              "persona": {
                "role": "Master Software Crafter"
              }
            }
          }
        },
        "rationale": "Templates (01-02, 01-03, 01-04) cannot be designed without knowing parser output structure. Coordinating prevents rework cycle.",
        "go_no_go_criteria": "Schema coordinated and approved by 1.2 owner → GO. No coordination → NO-GO, risk of 4-6 hour rework.",
        "blocking": true,
        "status": "UNRESOLVED - BLOCKER"
      },
      {
        "name": "Create tools/toon/ directory infrastructure",
        "description": "Directory must exist before creating parser files",
        "command": "mkdir -p /mnt/c/Repositories/Projects/ai-craft/tools/toon && touch /mnt/c/Repositories/Projects/ai-craft/tools/toon/__init__.py",
        "estimated_time_minutes": 5,
        "go_no_go_criteria": "Directory exists and writable → GO. Cannot create → NO-GO, resolve permissions.",
        "blocking": false,
        "status": "UNRESOLVED"
      }
    ],
    "total_prerequisite_time": "2.5-3 hours",
    "all_prerequisites_must_pass": true
  },
  "recommended_actions": [
    {
      "action": "CRITICAL BLOCKER: Resolve TOON v1.0 vs v3.0 version mismatch",
      "priority": "critical",
      "assigned_to": "tech lead",
      "estimated_time": "60 minutes",
      "rationale": "Test data is v1.0, spec says v3.0 - implementation will fail without resolution"
    },
    {
      "action": "CRITICAL BLOCKER: Coordinate parser schema with step 1.2 owner",
      "priority": "critical",
      "blocks": [
        "01-02 (Jinja2 template design)"
      ],
      "assigned_to": "developer + 1.2 owner",
      "estimated_time": "90 minutes"
    },
    {
      "action": "CRITICAL BLOCKER: Validate python-toon library with correct command",
      "priority": "critical",
      "assigned_to": "developer",
      "estimated_time": "15 minutes",
      "note": "Use 'pip index versions python-toon' NOT 'pip search' (deprecated)"
    },
    {
      "action": "HIGH: Revise custom parser contingency estimate to 12-16 hours",
      "priority": "high",
      "affects": "Project timeline if library path not available",
      "estimated_time": "5 minutes (documentation only)"
    },
    {
      "action": "HIGH: Add ToonParseError exception class with line number details",
      "priority": "high",
      "affects": "Error handling acceptance criteria",
      "estimated_time": "Included in implementation"
    },
    {
      "action": "HIGH: Add coverage requirement (≥85% general, ≥95% critical)",
      "priority": "high",
      "affects": "Quality gates",
      "estimated_time": "Included in implementation"
    },
    {
      "action": "MEDIUM: Add test isolation validation (pytest -n)",
      "priority": "medium",
      "affects": "Test suite reliability in CI",
      "estimated_time": "Included in testing phase"
    },
    {
      "action": "MEDIUM: Add UTF-8 encoding validation",
      "priority": "medium",
      "affects": "Cross-platform compatibility",
      "estimated_time": "Included in implementation"
    },
    {
      "action": "MEDIUM: Document dependency management strategy",
      "priority": "medium",
      "affects": "requirements.txt updates",
      "estimated_time": "5 minutes"
    }
  ],
  "critical_blocker_status": {
    "BLOCKER_001": {
      "title": "TOON Toolchain Missing",
      "status": "PARTIALLY_RESOLVED",
      "evidence": "tools/toon/ directory creation added to prerequisites",
      "remaining_blockers": [
        "TOON version mismatch (v1.0 vs v3.0)",
        "Parser schema not coordinated with step 1.2",
        "Library availability not validated"
      ],
      "impact": "Cannot parse TOON files until blockers resolved",
      "resolution_path": "Complete blocking_prerequisite_check items before implementation"
    },
    "BLOCKER_002": {
      "title": "TOON Version Mismatch (v1.0 vs v3.0)",
      "status": "UNRESOLVED",
      "evidence": "agents/novel-editor-chatgpt-toon.txt is TOON v1.0, spec references v3.0",
      "impact": "CATASTROPHIC - Parser will fail against real test data",
      "blast_radius": "Steps 1.1-1.6 all blocked",
      "resolution_options": [
        "A: Use v1.0 only (simplest, 16-20 hours)",
        "B: Convert to v3.0 (future-proof, 18-22 hours)",
        "C: Support both versions (recommended, 19-23 hours)"
      ],
      "estimated_resolution_time": "60 minutes (decision) + implementation time"
    },
    "BLOCKER_003": {
      "title": "Parser Schema Undefined - Blocks Step 1.2",
      "status": "UNRESOLVED",
      "evidence": "Step 1.2 (Jinja2 template) cannot be designed without knowing parser output structure",
      "impact": "HIGH - Risk of 4-6 hour rework if schema incompatible",
      "resolution_path": "Coordinate with step 1.2 owner to get template requirements before finalizing schema",
      "estimated_resolution_time": "90 minutes"
    }
  },
  "prerequisites": {
    "blocking": [
      "TOON version strategy resolved (v1.0, v3.0, or both)",
      "tools/toon/ directory exists with __init__.py",
      "TOON format specification accessible (local or verified URL)",
      "Parser output schema coordinated and approved by step 1.2 owner",
      "python-toon library availability validated OR custom parser path confirmed"
    ],
    "validation": "All items in blocking_prerequisite_check must pass before starting implementation"
  },
  "adversarial_review_corrections": {
    "description": "All corrections from ADVERSARIAL_REVIEW_01-01.md have been applied",
    "corrections_summary": [
      "TOON version mismatch (v1.0 vs v3.0) identified and resolution options documented",
      "Library validation command updated from deprecated 'pip search' to working alternatives",
      "Custom parser contingency estimate revised from 8 to 12-16 hours",
      "Schema coordination with step 1.2 owner added as blocking prerequisite",
      "Error handling specification added (ToonParseError with line numbers)",
      "Test isolation requirement added (pytest -n parallel execution)",
      "Coverage thresholds added (≥85% general, ≥95% critical)",
      "UTF-8 encoding validation added",
      "Rollback plan added for schema incompatibility",
      "Version detection tests added",
      "Malformed input tests added",
      "Encoding mismatch tests added",
      "Python version constraint added (≥3.9)",
      "Test framework clarified (pytest with conftest.py)",
      "Dependency management strategy documented"
    ],
    "review_quality_improvement": "Original embedded review identified 4 critical issues. Adversarial review found 10 additional failure modes. All 14 issues now addressed in updated task definition.",
    "risk_score_reduction": "From 8/10 (CRITICAL) to 3/10 (MEDIUM-LOW) after corrections applied - remaining risk is execution risk, not planning risk"
  },
  "validation": {
    "status": "approved",
    "notes": "Step validation",
    "migrated_at": "2026-01-13T22:11:27.022470",
    "approved_by": "software-crafter-reviewer",
    "approved_at": "2026-01-13T22:11:27.022482"
  },
  "tdd_cycle": {
    "tdd_phase_tracking": {
      "phase_execution_log": [
        {
          "phase_name": "COMMIT",
          "outcome": "PASS",
          "timestamp": "2026-01-13T22:11:27.022483",
          "notes": {
            "commit_hash": "migrated",
            "message": "Step 01-01 completed (tracking added during migration)"
          }
        }
      ]
    }
  }
}