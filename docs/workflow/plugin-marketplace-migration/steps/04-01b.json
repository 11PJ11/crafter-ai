{
  "project_id": "plugin-marketplace-migration",
  "step_id": "04-01b",
  "phase": {
    "number": 4,
    "name": "Command Migration",
    "purpose": "Convert all 20 commands to TOON format"
  },
  "step": {
    "number": "4.1b",
    "name": "Convert CROSS_WAVE Entry Command",
    "description": "Convert start.md to TOON format (CROSS_WAVE initialization)",
    "motivation": "start command initializes the 5D-Wave workflow - CROSS_WAVE classification",
    "estimated_hours": "2-3"
  },
  "context": {
    "constraints": [
      "DO NOT CREATE NEW REPORT FILES",
      "DO NOT COMMIT BEFORE USER APPROVAL",
      "FOCUS ON DELIVERABLES ONLY",
      "Tests use business language and domain concepts",
      "Type system makes wrong state non-representable"
    ],
    "success_criteria_mapping": {
      "SC1": "All source files in TOON v3.0 format",
      "NOTE_SC7": "Token savings validation deferred to Phase 8"
    },
    "dependencies": [
      "04-01",
      "01-01",
      "01-02",
      "01-03",
      "02-04"
    ],
    "note": "This step split from original 04-01 to correct wave classification contradiction"
  },
  "prerequisite_checks": {
    "phase_1_toon_infrastructure": {
      "requirement": "TOON parser and compiler from Phase 1 must be complete",
      "verification": "Confirm tools/toon/compiler.py exists and test_toon_parser passes",
      "blocking": true,
      "escalation": "If Phase 1 incomplete, STOP - escalate to project manager for decision on Option B (Markdown) or Option C (Block)"
    },
    "toon_format_specification": {
      "requirement": "TOON v3.0 format specification must be available",
      "verification": "Obtain from tools/toon/TOON-v3.0-SPEC.md or reference implementation",
      "blocking": true,
      "escalation": "If spec unavailable, create from reverse-engineering agents/novel-editor-chatgpt-toon.txt"
    },
    "step_04_01_complete": {
      "requirement": "Step 04-01 (discuss.md conversion) must be complete",
      "verification": "Confirm discuss.toon exists and compiles successfully",
      "blocking": true,
      "escalation": "Complete step 04-01 first to establish TOON conversion patterns"
    },
    "baseline_measurements": {
      "requirement": "Baseline measurements from Phase 0 must be complete",
      "verification": "Confirm docs/workflow/plugin-marketplace-migration/baseline.yaml exists with command metrics",
      "blocking": true,
      "escalation": "If baseline missing, execute Phase 0 baseline measurement first"
    }
  },
  "deliverables": {
    "files_to_create": [
      "5d-wave/tasks/dw/start.toon"
    ],
    "acceptance_criteria": [
      "start.toon compiles with valid TOON v3.0 format",
      "Wave metadata correct (CROSS_WAVE)",
      "Agent-activation header preserved from start.md"
    ]
  },
  "tdd_approach": {
    "outer_test": "GIVEN start.md converted to start.toon\nWHEN compiled via toon-compiler\nTHEN output has wave: CROSS_WAVE in metadata\nAND agent-activation block preserved",
    "inner_tests": [
      "test_start_command_compiles",
      "test_start_wave_metadata_cross_wave",
      "test_start_agent_activation_preserved"
    ]
  },
  "refactoring": {
    "targets": []
  },
  "toon_compiler": {
    "tool_location": "tools/toon/compiler.py (from Phase 1)",
    "invocation": "python tools/toon/compiler.py <input.toon> --validate --output <output.md>",
    "success_criteria": [
      "Exit code = 0 (no errors)",
      "No errors in stderr",
      "Output file size > 1000 bytes (non-trivial content)",
      "Metadata validates against TOON v3.0 schema",
      "Output markdown is Claude Code compliant"
    ],
    "error_handling": {
      "compilation_failure": "Log error, do NOT proceed, escalate with error message",
      "metadata_invalid": "Review source file wave classification - should be CROSS_WAVE",
      "partial_failure": "Rollback all conversions, fix issue, restart batch"
    },
    "purpose": "Transforms TOON source to Claude Code compliant output",
    "input": "5d-wave/tasks/dw/*.toon (TOON format)",
    "output": "dist/commands/dw/*.md (Markdown format)",
    "validation": "pytest tests/tools/toon/test_compiler.py"
  },
  "test_specifications": {
    "test_start_command_compiles": {
      "framework": "pytest",
      "test_code_skeleton": "def test_start_command_compiles():\n    toon_file = TOONParser().parse('5d-wave/tasks/dw/start.toon')\n    assert toon_file.metadata['wave'] == 'CROSS_WAVE'\n    assert toon_file.compilation_errors == []",
      "assertions": [
        "File parses without errors",
        "Wave metadata == CROSS_WAVE (NOT DISCUSS)",
        "All required metadata fields present"
      ]
    },
    "test_start_wave_metadata_cross_wave": {
      "framework": "pytest",
      "test_code_skeleton": "def test_start_wave_metadata_cross_wave():\n    toon_file = TOONParser().parse('5d-wave/tasks/dw/start.toon')\n    assert toon_file.metadata['wave'] == 'CROSS_WAVE'\n    assert 'agent-id' in toon_file.metadata\n    assert toon_file.metadata['agent-id'] == 'project-initializer'",
      "assertions": [
        "Wave field exists and equals CROSS_WAVE",
        "Agent-id field present and correct",
        "start.md is architecturally CROSS_WAVE for project initialization"
      ]
    },
    "test_start_agent_activation_preserved": {
      "framework": "pytest",
      "test_code_skeleton": "def test_start_agent_activation_preserved():\n    toon_file = TOONParser().parse('5d-wave/tasks/dw/start.toon')\n    assert toon_file.metadata['agent-id'] == 'project-initializer'\n    assert toon_file.metadata['agent-command'] == 'start'",
      "assertions": [
        "Agent-id preserved from start.md",
        "Agent-command preserved"
      ]
    },
    "unit_tests": [
      {
        "name": "test_toon_parser_valid_command_input",
        "purpose": "Verify parser handles valid TOON command syntax correctly",
        "input": "Sample TOON command file with all required fields (name, description, parameters)",
        "expected": "Parsed dict with command metadata: {name, description, parameters, dependencies}"
      },
      {
        "name": "test_template_rendering_with_parsed_command",
        "purpose": "Verify Jinja2 template renders command.md from parsed data",
        "input": "Parsed command dict from parser output",
        "expected": "Valid Markdown output with command syntax section, parameters table, usage examples"
      },
      {
        "name": "test_output_validation_against_claude_code_spec",
        "purpose": "Verify compiled output meets Claude Code command specification",
        "input": "Generated command.md file",
        "expected": "Validation passes: Has frontmatter, execution context, success criteria sections"
      }
    ],
    "integration_tests": [
      {
        "name": "test_e2e_command_migration_pipeline",
        "purpose": "Verify complete migration: TOON → Parse → Template → Validate → Output",
        "input": "Real TOON command file from 5d-wave/tasks/dw/",
        "steps": "Parse TOON → Apply command template → Validate output → Write to dist/",
        "expected": "Valid command.md in dist/commands/dw/ matching Claude Code spec"
      },
      {
        "name": "test_batch_migration_all_commands",
        "purpose": "Verify batch processing of all command files",
        "input": "All TOON command files (8 dw: commands)",
        "expected": "All 8 commands migrated successfully with validation report"
      }
    ],
    "error_scenario_tests": [
      {
        "name": "test_compiler_not_found_error_handling",
        "purpose": "Verify graceful failure when compiler missing",
        "setup": "Remove or rename tools/toon/compiler.py",
        "expected": "Clear error message, execution stops, no partial output"
      },
      {
        "name": "test_malformed_toon_syntax_error_handling",
        "purpose": "Verify parser reports syntax errors clearly",
        "input": "TOON file with missing ## section header",
        "expected": "Parser error with line number, specific syntax issue description"
      },
      {
        "name": "test_validation_failure_error_handling",
        "purpose": "Verify validation errors reported clearly",
        "input": "TOON file missing required 'description' field",
        "expected": "Validation error: 'Missing required field: description' with file path"
      }
    ]
  },
  "error_handling": {
    "compiler_not_found": {
      "detection": "Step 2 'Compile TOON file' fails with 'command not found'",
      "action": "STOP immediately, escalate: Phase 1 incomplete",
      "recovery": "Wait for Phase 1 completion, do NOT proceed"
    },
    "compilation_failure": {
      "detection": "Compiler exits with code != 0",
      "action": "Capture error message, log to docs/errors/step-04-01b-errors.log",
      "recovery": "Review source file, fix metadata/syntax, retry compilation"
    },
    "wave_classification_error": {
      "detection": "Test expects CROSS_WAVE but metadata shows different wave",
      "action": "Verify start.md source file has wave: CROSS_WAVE",
      "recovery": "If source is CROSS_WAVE: fix conversion. If source different: escalate architectural review"
    },
    "scenario_1_compiler_not_found": {
      "error": "TOON compiler not found at tools/toon/compiler.py",
      "handling": "Log error with clear message: 'Phase 1 TOON infrastructure required. Run Phase 1.1-1.5 first or choose Option B (Markdown).'",
      "recovery": "STOP execution, escalate to user for decision",
      "test": "test_error_compiler_not_found"
    },
    "scenario_2_compilation_failure": {
      "error": "TOON compiler exits with non-zero code",
      "handling": "Log compilation error with file path and stderr output. Skip failed file, continue with others. Generate error report.",
      "recovery": "Review TOON syntax, fix errors, retry compilation",
      "test": "test_error_compilation_failure_graceful"
    },
    "scenario_3_metadata_validation_failure": {
      "error": "Compiled output fails metadata validation (missing required fields)",
      "handling": "Log validation errors with specific missing fields. Mark file as failed. Continue processing other files.",
      "recovery": "Add missing metadata to source TOON file, recompile",
      "test": "test_error_metadata_validation_failure"
    },
    "scenario_4_partial_batch_failure": {
      "error": "Some files in batch succeed, others fail",
      "handling": "Complete all processable files. Generate summary report: X succeeded, Y failed. List failed files with error reasons.",
      "recovery": "Fix failed files individually, rerun batch",
      "test": "test_error_partial_batch_failure_reporting"
    }
  },
  "execution_guidance": {
    "approach": "Command conversion following established pattern from 04-01",
    "workflow": [
      "STEP 0: VERIFY PREREQUISITES",
      "  - Confirm step 04-01 complete (discuss.toon exists)",
      "  - Confirm tools/toon/compiler exists",
      "  - Review discuss.toon as conversion template",
      "  - If prerequisites missing: STOP and escalate",
      "STEP 1: Convert start.md to start.toon",
      "  - Use TOON v3.0 format specification",
      "  - Preserve agent-activation header from YAML frontmatter",
      "  - Set wave metadata to CROSS_WAVE (NOT DISCUSS)",
      "  - Note: start.md is project initialization, thus CROSS_WAVE",
      "STEP 2: Compile TOON file",
      "  - Run: toon-compiler 5d-wave/tasks/dw/start.toon --validate",
      "  - Verify exit code = 0",
      "  - If compilation fails: capture error, escalate (see error_handling)",
      "STEP 3: Write tests to validate conversion",
      "  - Implement test_start_command_compiles",
      "  - Implement test_start_wave_metadata_cross_wave (verify CROSS_WAVE)",
      "  - Implement test_start_agent_activation_preserved",
      "STEP 4: Run test suite",
      "  - Execute: pytest tests/test_start_conversion.py",
      "  - All tests MUST pass (100% required)",
      "STEP 5: Verify quality gates",
      "  - Check all acceptance criteria satisfied",
      "  - Specifically verify wave == CROSS_WAVE",
      "STEP 6: DO NOT COMMIT - wait for user approval"
    ],
    "quality_gates": [
      "All tests passing (100% required)",
      "start.toon compiles successfully with exit code 0",
      "Wave metadata correct (CROSS_WAVE - critical distinction)",
      "Agent-activation headers valid and preserved",
      "No report files created"
    ]
  },
  "wave_classification_rationale": {
    "why_cross_wave": "start.md initializes 5D-Wave workflow, which spans ALL waves (DISCUSS, DESIGN, DISTILL, DEVELOP, DEMO). It is not confined to DISCUSS phase, thus classified as CROSS_WAVE.",
    "original_contradiction": "Original step 04-01 claimed 'Convert DISCUSS Wave Commands' but included start.md which is architecturally CROSS_WAVE. This created impossible acceptance criteria.",
    "resolution": "Split into two steps: 04-01 for DISCUSS (discuss.md), 04-01b for CROSS_WAVE (start.md)"
  },
  "adversarial_review_summary": {
    "original_issue": "Wave classification contradiction in original step 04-01",
    "resolution": "New step 04-01b created to handle CROSS_WAVE command separately",
    "risk_score": 3.0,
    "major_corrections_applied": [
      "Created separate step for CROSS_WAVE command",
      "Correct wave metadata validation (CROSS_WAVE not DISCUSS)",
      "Added dependency on 04-01 to leverage learning from first conversion",
      "Reduced time estimate to 2-3h (learning curve from 04-01 reduces effort)",
      "Added wave classification rationale section"
    ],
    "remaining_risks": [
      "Dependency on step 04-01 completion",
      "Architectural validation that start.md is indeed CROSS_WAVE"
    ]
  },
  "review_metadata": {
    "reviewed_by": "Lyra (corrected after adversarial review)",
    "review_date": "2026-01-06",
    "review_status": "CORRECTED - Ready for execution after step 04-01 complete",
    "corrections_applied": "Wave classification corrected to CROSS_WAVE, separated from DISCUSS, prerequisites include 04-01 dependency",
    "estimated_hours_justification": "2-3 hours includes: 0.5h review 04-01 pattern, 1h conversion following template, 0.5-1h test implementation, 0.5h validation. Reduced from 04-01 due to established pattern."
  }
}