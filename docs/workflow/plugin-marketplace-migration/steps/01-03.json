{
  "project_id": "plugin-marketplace-migration",
  "step_id": "01-03",
  "phase": {
    "number": 1,
    "name": "TOON Infrastructure",
    "purpose": "Create parser and compiler toolchain that transforms TOON source into Claude Code compliant output"
  },
  "step": {
    "number": "1.3",
    "name": "Create Command Jinja2 Template",
    "description": "Create Jinja2 template for command.md files with command-specific metadata and invocation context.\n\nCRITICAL: Commands are invocable operations within agent context, NOT agents themselves.\n\nTemplate Structure Requirements:\n- Command invocation header (name, purpose, parameters, returns)\n- Parent agent reference (which agent owns this command)\n- Prerequisites (commands that must run first)\n- Input/output specifications\n- Success criteria as markdown checklist\n\nBLOCKING DEPENDENCIES (MUST be resolved before starting):\n1. Step 01-01 MUST define parser output schema with examples\n2. Step 01-02 MUST resolve C1-C4 issues for pattern reference\n3. Command vs Agent structural differences MUST be documented\n4. Example parsed command data MUST be provided\n\nWARNING: Starting without these will guarantee rework.",
    "motivation": "Command template defines output for 20 command files. Commands have different metadata structure than agents (parameters/returns vs persona/capabilities).",
    "estimated_hours": "11.5"
  },
  "context": {
    "constraints": [
      "DO NOT CREATE NEW REPORT FILES",
      "DO NOT COMMIT BEFORE USER APPROVAL",
      "FOCUS ON DELIVERABLES ONLY",
      "Tests use business language and domain concepts",
      "Type system makes wrong state non-representable",
      "MANDATORY: Validate input schema exists before implementation",
      "MANDATORY: Test YAML escaping and special character handling",
      "MANDATORY: Test null/missing field handling",
      "MANDATORY: Validate output against Claude Code spec, not just template logic"
    ],
    "success_criteria_mapping": {
      "SC2": "Build produces Claude Code compliant output",
      "validation_requirement": "Generated command.md files MUST match Claude Code specification. Template logic tests are insufficient - output validation required."
    },
    "dependencies": [
      "1.1 (BLOCKING - Parser output schema MUST be defined with examples)",
      "1.2 (BLOCKING - Agent template C1-C4 issues MUST be resolved for pattern reference)"
    ],
    "blocking_prerequisites": {
      "01-01_schema_definition": {
        "status": "UNRESOLVED",
        "requirement": "Parser MUST document output schema with field definitions and examples",
        "impact_if_missing": "Cannot write accurate tests or template - will guess wrong structure"
      },
      "01-02_pattern_reference": {
        "status": "UNRESOLVED",
        "requirement": "Agent template MUST resolve C1-C4 to provide stable patterns",
        "impact_if_missing": "Will copy wrong patterns, require complete redesign"
      },
      "command_vs_agent_specification": {
        "status": "UNRESOLVED",
        "requirement": "Document how command structure differs from agent structure",
        "impact_if_missing": "Tests will validate wrong acceptance criteria"
      }
    }
  },
  "deliverables": {
    "files_to_create": [
      "tools/toon/templates/command.md.j2",
      "tests/tools/toon/test_command_template.py",
      "tests/tools/toon/test_command_template_edge_cases.py",
      "docs/workflow/plugin-marketplace-migration/command-data-schema.md"
    ],
    "acceptance_criteria": [
      "AC1: Template produces command invocation header with name, purpose, parameters, returns (NOT agent-activation header)",
      "AC2: Template includes parent agent reference (which agent owns this command)",
      "AC3: Template includes command prerequisites (commands that must run first, NOT 'context files')",
      "AC4: Template renders success criteria as markdown checklist (- [ ] format)",
      "AC5: Template handles null/missing fields gracefully (provides defaults or clear errors)",
      "AC6: Template properly escapes YAML special characters (colons, dashes, quotes)",
      "AC7: Template handles multi-line command documentation without YAML formatting errors",
      "AC8: Template namespaces commands to prevent name collisions",
      "AC9: Generated command.md files validate against Claude Code specification (not just template logic)",
      "AC10: Template preserves embedded knowledge injection markers if present"
    ],
    "validation_requirements": {
      "input_validation": "Template MUST validate parser provides required fields (name, purpose, parent_agent)",
      "output_validation": "Generated command.md MUST parse as valid YAML and match Claude Code spec",
      "edge_case_testing": "MUST test null fields, special characters, multi-line strings, name collisions",
      "schema_compliance": "Output structure MUST match documented command schema"
    }
  },
  "tdd_approach": {
    "prerequisite_validation": "BEFORE writing tests, MUST have: parser output schema, example command data, command vs agent differences documented",
    "outer_test": "GIVEN parsed command data {\n  'name': 'implement-feature',\n  'purpose': 'Implement features via Outside-In TDD',\n  'parent_agent': 'software-crafter',\n  'parameters': [{'name': 'feature_name', 'type': 'str'}],\n  'returns': 'Implementation with passing tests',\n  'prerequisites': ['accept-criteria', 'design-architecture']\n}\nWHEN I render command.md.j2 template\nTHEN output:\n- Has command invocation header (NOT agent-activation header)\n- Includes parent_agent reference to software-crafter\n- Lists prerequisites as ordered checklist\n- Validates as proper YAML\n- Matches Claude Code command specification",
    "inner_tests": [
      "test_command_invocation_header_structure",
      "test_parent_agent_reference",
      "test_command_prerequisites_section",
      "test_parameter_specification_rendering",
      "test_success_criteria_markdown_checklist",
      "test_null_field_handling",
      "test_yaml_special_character_escaping",
      "test_multiline_description_formatting",
      "test_command_namespace_collision_prevention",
      "test_embedded_knowledge_marker_preservation"
    ],
    "edge_case_tests": {
      "null_handling": "Command with missing description, missing prerequisites, missing parameters",
      "special_characters": "Command description with colons, dashes, quotes, special chars",
      "name_collision": "Multiple commands named 'validate' in different agent contexts",
      "yaml_formatting": "Multi-line strings, nested lists, complex data structures",
      "marker_preservation": "Existing command.md with embedded knowledge markers"
    }
  },
  "refactoring": {
    "targets": [
      {
        "level": 1,
        "focus": "Section naming consistency"
      }
    ]
  },
  "execution_guidance": {
    "approach": "Outside-In TDD with double-loop",
    "CRITICAL_BLOCKERS_MUST_RESOLVE_FIRST": {
      "blocker_1": "Step 01-01 parser MUST define output schema with field definitions and examples",
      "blocker_2": "Step 01-02 agent template MUST resolve C1-C4 critical issues",
      "blocker_3": "Command vs agent structural differences MUST be documented with examples",
      "blocker_4": "Example parsed command data MUST be provided for test implementation",
      "enforcement": "DO NOT START implementation until all blockers resolved. Starting now guarantees 4-6 hours of rework."
    },
    "workflow": [
      "0. BLOCKER VALIDATION: Verify ALL critical blockers resolved. If ANY unresolved: HALT",
      "0.1. PREREQUISITE CHECK: Verify tools/toon/ exists. If not: HALT - refer to BLOCKER_001 resolution",
      "0.2. SCHEMA VALIDATION: Verify parser output schema documented with examples. If not: HALT",
      "0.3. PATTERN VALIDATION: Verify step 01-02 C1-C4 resolved. If not: HALT",
      "0.4. EXAMPLE DATA VALIDATION: Verify example parsed command data available. If not: HALT",
      "1. Document command data schema (command-data-schema.md) based on parser output",
      "2. Write failing E2E test using ACTUAL command data structure (not assumptions)",
      "3. Implement template with YAML escaping and null handling",
      "4. Implement inner tests including ALL edge cases",
      "5. Validate output against Claude Code spec (not just template logic)",
      "6. Apply refactoring level 1",
      "7. Run edge case test suite (special chars, nulls, collisions)",
      "8. Validate all 10 acceptance criteria met",
      "9. DO NOT COMMIT - wait for user approval"
    ],
    "quality_gates": [
      "All blockers resolved BEFORE starting",
      "Parser schema documented with examples",
      "All tests passing (100% required)",
      "All 10 acceptance criteria validated",
      "Edge case tests passing (null, special chars, collisions)",
      "Generated output validates as proper YAML",
      "Generated output matches Claude Code command spec",
      "Refactoring applied (level 1)",
      "No report files created"
    ],
    "failure_prevention": {
      "schema_mismatch": "Use ACTUAL parser output, not assumptions. Test with real data from 01-01.",
      "yaml_errors": "Test special character escaping BEFORE batch generation in step 1.4",
      "output_validation": "Validate generated command.md matches spec, not just template renders",
      "pattern_consistency": "Reference 01-02 patterns after C1-C4 resolved, not before"
    }
  },
  "review_metadata": {
    "review_date": "2026-01-05",
    "reviewer": "lyra",
    "post_adversarial_update": "2026-01-08",
    "clarity_score": 9,
    "completeness_score": 9,
    "achievability_score": 8,
    "overall_score": 8.7,
    "improvements_applied": [
      "FIXED: Rewritten all ACs with command-specific terminology (invocation header, parent agent, prerequisites)",
      "FIXED: Added blocking prerequisites validation section with 4 critical blockers",
      "FIXED: Expanded from 4 to 10 acceptance criteria covering edge cases",
      "FIXED: Updated outer_test with realistic command data structure (name, purpose, parent_agent, parameters, returns, prerequisites)",
      "FIXED: Added 10 inner tests including edge case coverage",
      "FIXED: Increased time estimate from 2h to 11.5h (realistic)",
      "FIXED: Added edge_case_tests section (null handling, special chars, name collision, YAML formatting, markers)",
      "FIXED: Added validation_requirements for input/output validation",
      "FIXED: Added CRITICAL_BLOCKERS_MUST_RESOLVE_FIRST with enforcement",
      "FIXED: Updated dependencies to explicitly state BLOCKING status",
      "FIXED: Added command-data-schema.md deliverable",
      "FIXED: Added test_command_template_edge_cases.py deliverable",
      "FIXED: Added failure_prevention section with concrete guidance"
    ],
    "critical_issues": [
      {
        "type": "blocking_dependencies",
        "severity": "BLOCKING",
        "status": "DOCUMENTED - Requires resolution before execution",
        "description": "Step 01-01 parser output schema undefined. Step 01-02 C1-C4 unresolved. Command vs agent structure differences undocumented.",
        "impact": "Cannot implement without these - will guess wrong structure",
        "remediation": "All 4 blocking prerequisites now documented in blocking_prerequisites section. Must resolve before starting.",
        "current_state": "Step file updated with blockers - awaiting resolution"
      }
    ],
    "medium_issues": [],
    "low_issues": [],
    "resolved_issues": [
      "Agent-specific terminology in ACs - NOW FIXED with command-specific language",
      "Missing edge case tests - NOW ADDED (10 inner tests)",
      "Vague acceptance criteria - NOW SPECIFIC (10 ACs with clear validation)",
      "Unrealistic time estimate - NOW ADJUSTED (11.5h)",
      "Missing validation requirements - NOW ADDED",
      "Incomplete outer test - NOW FIXED with realistic command data"
    ],
    "missing_context": [
      "STILL MISSING: Parser output schema (awaiting 01-01)",
      "STILL MISSING: Agent template patterns (awaiting 01-02 C1-C4 resolution)",
      "STILL MISSING: Example parsed command data (awaiting 01-01)",
      "ADDED: Command data structure specification documented in step requirements"
    ],
    "recommendations": [
      "DO NOT START until all 4 blocking prerequisites resolved",
      "WHEN STARTING: Follow validation steps 0.1-0.4 before implementation",
      "USE: Actual parser output from 01-01, not assumptions",
      "TEST: All edge cases before batch generation in step 1.4",
      "VALIDATE: Generated output against Claude Code spec, not just template logic"
    ]
  },
  "adversarial_review": {
    "review_date": "2026-01-05",
    "reviewer": "lyra (adversarial mode)",
    "mission": "Find what WILL go wrong, not what might work",
    "status": "BLOCKED - CRITICAL DEPENDENCIES UNRESOLVED",
    "risk_score": 9,
    "risk_score_scale": "1-10 (catastrophic)",
    "blast_radius": "Blocks steps 1.4-1.6 (all command file generation)",
    "contradictions_found": [
      {
        "contradiction": "Template input schema undefined",
        "severity": "BLOCKING",
        "evidence": "Parser (01-01) produces 'structured dict/object' with no schema specification. This step assumes parser output has fields like agent_id, wave, command_name - all unvalidated assumptions.",
        "failure_scenario": "Template tries to render {{ command.wave }} but parsed data doesn't have wave field. Renders blank.",
        "probability_of_correct_guess": "20-30%"
      },
      {
        "contradiction": "Commands treated as agents in acceptance criteria",
        "severity": "HIGH",
        "evidence": "AC#1 says 'agent-activation YAML header' - agents have activation headers. Commands don't. AC#2 says 'wave, agent, command metadata' - wave applies to agents, not commands. AC#3 assumes 'context files' same as agents - wrong domain model.",
        "failure_scenario": "Developer realizes mid-implementation that commands have different metadata structure. Complete template redesign needed.",
        "discovery_timing": "Step 1.4 when first 20 commands generated - too late"
      },
      {
        "contradiction": "Agent template (01-02) not yet specified but assumed to work",
        "severity": "BLOCKING",
        "evidence": "Step 01-02 is flagged 'ready_for_execution: false' with critical issues C1-C4 unresolved. This step assumes 01-02 completed and patterns available.",
        "failure_scenario": "Developer starts this step, discovers 01-02 blocked, cannot proceed. Or proceeds with guessed patterns that don't match final 01-02.",
        "probability_of_sequential_execution": "<10%"
      },
      {
        "contradiction": "Success criteria don't map to system success criteria",
        "severity": "MEDIUM",
        "evidence": "AC#1-4 describe what template does (produces header, includes metadata, renders sections, includes checklist). But SC2 is 'Build produces Claude Code compliant output'. No test validates actual compliance.",
        "failure_scenario": "Tests pass (ACs satisfied), but generated command.md files don't match Claude Code spec. Discovered in step 1.4+, cascades failure."
      }
    ],
    "dangerous_assumptions": [
      {
        "assumption": "Commands and agents have similar structure",
        "confidence_correct": "5%",
        "when_breaks": "When generated command.md doesn't match Claude Code spec",
        "impact": "Requires template redesign"
      },
      {
        "assumption": "Single parser can produce schema suitable for both agent and command templates",
        "confidence_correct": "40%",
        "when_breaks": "When template receives nested data that doesn't unpack into expected fields",
        "example": "Parser produces {agent: {}, commands: {}}, template expects flat fields"
      },
      {
        "assumption": "Context files section works same for commands as agents",
        "confidence_correct": "30%",
        "when_breaks": "Template renders empty context_files for all commands because structure doesn't exist",
        "impact": "Command documentation incomplete"
      },
      {
        "assumption": "Jinja2 templates sufficient for task",
        "confidence_correct": "60%",
        "when_breaks": "First batch of commands fail on YAML escaping, special character handling, multi-line strings",
        "example": "Description with colon: 'Validate: configuration' becomes invalid YAML"
      }
    ],
    "unhandled_edge_cases": [
      {
        "edge_case": "Null/missing fields in command data",
        "test_status": "NOT TESTED",
        "failure": "Template produces malformed YAML or blank sections"
      },
      {
        "edge_case": "Special characters in command description",
        "test_status": "NOT TESTED",
        "failure": "YAML parsing fails on colons, dashes, quotes"
      },
      {
        "edge_case": "Commands with same name in different waves",
        "test_status": "NOT TESTED",
        "failure": "Namespace collision, files overwrite each other"
      },
      {
        "edge_case": "Embedded knowledge injection markers",
        "test_status": "NOT TESTED",
        "failure": "Markers corrupted or content lost"
      },
      {
        "edge_case": "Multi-line command documentation",
        "test_status": "NOT TESTED",
        "failure": "YAML indentation or formatting errors"
      }
    ],
    "failure_scenarios": [
      {
        "scenario_id": "F1",
        "title": "Parser schema definition slips",
        "probability": "90%",
        "timeline": "Dev starts step -> realizes schema undefined -> waits for 01-01 -> implements based on assumptions -> 01-01 produces different schema -> template breaks -> rework 4-6 hours"
      },
      {
        "scenario_id": "F2",
        "title": "Command structure doesn't match agent assumptions",
        "probability": "85%",
        "timeline": "Template assumes {{ command.wave }} -> parser doesn't include wave in command -> template renders blank -> discovered step 1.4 -> redesign required"
      },
      {
        "scenario_id": "F3",
        "title": "YAML formatting breaks on first batch",
        "probability": "70%",
        "timeline": "First 5 commands work -> command #6 has special characters -> YAML malformed -> debugging YAML escaping -> +2-3 hours"
      },
      {
        "scenario_id": "F4",
        "title": "Acceptance criteria don't validate real output",
        "probability": "60%",
        "timeline": "Tests pass (AC#1-4 satisfied) -> step 1.4 generates commands -> output doesn't match spec -> feature-completion-coordinator rejects -> rework"
      }
    ],
    "data_loss_risks": [
      {
        "risk": "Command metadata corruption",
        "scenario": "Parser includes nested data, template flattens incorrectly. Prerequisites lost in output.",
        "impact": "Command documentation incomplete"
      },
      {
        "risk": "Embedded knowledge markers corrupted",
        "scenario": "Existing markers not preserved in re-render. Content between markers replaced.",
        "impact": "Embedded knowledge lost or inaccessible"
      }
    ],
    "test_coverage_gaps": [
      "NULL field handling",
      "YAML escaping (colons, dashes, quotes)",
      "Special character handling",
      "Multiple commands with same name",
      "Missing prerequisite structure",
      "Embedded marker preservation",
      "Command vs agent field differences",
      "Parser schema validation"
    ],
    "critical_dependencies": [
      {
        "dependency": "Step 01-01 (Parser)",
        "status": "BLOCKED",
        "blocking_reason": "Schema undefined, output structure unspecified",
        "impact_if_wrong": "All downstream work invalid"
      },
      {
        "dependency": "Step 01-02 (Agent Template)",
        "status": "BLOCKED",
        "blocking_reason": "Critical issues C1-C4 unresolved",
        "impact_if_wrong": "This step will copy wrong patterns"
      }
    ],
    "realistic_time_estimate": {
      "stated_hours": 2,
      "adjusted_hours": 11.5,
      "multiplier": "5.75x",
      "breakdown": {
        "clarify_input_schema": 1,
        "review_agent_patterns": 1,
        "design_command_structure": 1,
        "write_e2e_test": 1,
        "implement_template": 2.5,
        "write_inner_tests": 2,
        "refactoring": 1,
        "validation_and_fixes": 2
      },
      "note": "2 hours is 18% of likely actual time"
    },
    "blockers_before_starting": [
      {
        "blocker": "Define parser output schema with examples",
        "priority": "CRITICAL",
        "blocks": [
          "Template design",
          "Test writing",
          "Acceptance criteria clarity"
        ]
      },
      {
        "blocker": "Define command vs agent structural differences",
        "priority": "CRITICAL",
        "blocks": [
          "Acceptance criteria accuracy",
          "Test correctness"
        ]
      },
      {
        "blocker": "Resolve step 01-02 critical issues C1-C4",
        "priority": "CRITICAL",
        "blocks": [
          "Pattern reference availability"
        ]
      },
      {
        "blocker": "Provide example parsed command data",
        "priority": "HIGH",
        "blocks": [
          "E2E test implementation"
        ]
      },
      {
        "blocker": "Specify YAML edge case handling",
        "priority": "HIGH",
        "blocks": [
          "Test completeness"
        ]
      }
    ],
    "conclusion": "This task WILL FAIL if started now. Not might fail - WILL fail. Root cause: attempting to create template without knowing input schema or how commands differ from agents. Cannot proceed until 01-01 and 01-02 both unblocked with clear specifications."
  },
  "critical_blocker_status": {
    "BLOCKER_001": {
      "title": "TOON Toolchain Missing",
      "status": "UNRESOLVED",
      "evidence": "tools/toon/ directory does not exist",
      "impact": "Cannot parse TOON files, blocks all Phase 1 steps",
      "resolution_options": [
        "A: Implement TOON toolchain (16-20h estimated)",
        "B: Pivot to Markdown templates (8-10h, loses TOON benefits)",
        "C: Block until external TOON library available"
      ]
    }
  },
  "prerequisites": {
    "blocking": [
      "tools/toon/ directory MUST exist with README.md",
      "TOON format specification v3.0 must be accessible",
      "Parser output schema must be defined with field definitions and examples",
      "Step 01-02 C1-C4 critical issues MUST be resolved",
      "Command vs agent structural differences MUST be documented",
      "Example parsed command data MUST be provided"
    ],
    "validation": [
      "Run: ls tools/toon/README.md - Must exist. If not: BLOCKER_001",
      "Check: Step 01-01 has parser_output_schema section with examples",
      "Check: Step 01-02 ready_for_execution = true (C1-C4 resolved)",
      "Check: command-vs-agent-differences.md exists with examples",
      "Check: Example command data available from parser test fixtures"
    ]
  },
  "execution_readiness": {
    "status": "BLOCKED",
    "ready_for_execution": false,
    "blocker_resolution_status": {
      "blocker_1_parser_schema": {
        "description": "Step 01-01 MUST define parser output schema with examples",
        "status": "UNRESOLVED",
        "required_artifact": "Parser output schema documentation with field definitions",
        "validation": "Step 01-01 contains parser_output_schema section"
      },
      "blocker_2_agent_template_patterns": {
        "description": "Step 01-02 MUST resolve C1-C4 critical issues",
        "status": "UNRESOLVED",
        "required_artifact": "Agent template with resolved critical issues",
        "validation": "Step 01-02 ready_for_execution = true"
      },
      "blocker_3_command_structure": {
        "description": "Command vs agent structural differences MUST be documented",
        "status": "UNRESOLVED",
        "required_artifact": "Documentation of command-specific fields vs agent fields",
        "validation": "command-vs-agent-differences.md exists with concrete examples"
      },
      "blocker_4_example_data": {
        "description": "Example parsed command data MUST be provided",
        "status": "UNRESOLVED",
        "required_artifact": "Test fixture with example command data from parser",
        "validation": "Parser test suite contains example command data"
      }
    },
    "improvements_vs_original": {
      "acceptance_criteria": "Expanded from 4 to 10 with command-specific terminology",
      "time_estimate": "Increased from 2h to 11.5h (realistic)",
      "test_coverage": "Added edge case tests (null, special chars, collisions, YAML)",
      "validation": "Added output validation against Claude Code spec",
      "blockers": "Explicitly documented 4 critical blocking prerequisites",
      "workflow": "Added pre-execution validation steps (0.1-0.4)",
      "deliverables": "Added schema documentation and edge case tests"
    },
    "risk_mitigation_applied": {
      "schema_mismatch_prevention": "Workflow requires parser schema validation before starting",
      "yaml_error_prevention": "Added dedicated edge case tests for special characters",
      "output_validation": "AC9 requires validation against Claude Code spec",
      "pattern_consistency": "Dependencies explicitly require 01-02 C1-C4 resolution",
      "null_handling": "AC5 and dedicated tests for null/missing fields",
      "name_collision_prevention": "AC8 and tests for namespace collision"
    },
    "next_steps": {
      "immediate": "Resolve 4 blocking prerequisites (01-01 schema, 01-02 C1-C4, command structure doc, example data)",
      "after_unblocked": "Execute workflow steps 0.1-0.4 to validate all prerequisites met",
      "implementation": "Follow updated workflow with Outside-In TDD and edge case testing",
      "validation": "Validate all 10 acceptance criteria and edge cases before approval"
    }
  },
  "validation": {
    "status": "pending",
    "notes": "Step validation",
    "migrated_at": "2026-01-13T22:11:27.045354"
  }
}