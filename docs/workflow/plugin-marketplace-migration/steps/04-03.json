{
  "project_id": "plugin-marketplace-migration",
  "step_id": "04-03",
  "phase": {
    "number": 4,
    "name": "Command Migration",
    "purpose": "Convert all 20 commands to TOON format"
  },
  "step": {
    "number": "4.3",
    "name": "Convert DISTILL Wave Commands",
    "description": "Convert distill.md, skeleton.md to TOON format with verified Phase 1 infrastructure",
    "motivation": "DISTILL wave creates acceptance tests - requires complete TOON toolchain and specifications",
    "estimated_hours": "3-4"
  },
  "context": {
    "constraints": [
      "DO NOT CREATE NEW REPORT FILES",
      "DO NOT COMMIT BEFORE USER APPROVAL",
      "FOCUS ON DELIVERABLES ONLY",
      "Tests use business language and domain concepts",
      "Type system makes wrong state non-representable",
      "BLOCKING: Phase 1 TOON infrastructure must be verified complete before proceeding",
      "BLOCKING: TOON v3.0 format specification must be accessible and stable",
      "BLOCKING: Compiler usage must be documented with examples"
    ],
    "success_criteria_mapping": {
      "SC1": "All source files in TOON v3.0 format",
      "SC7": "~60% token savings validated post-conversion (deferred to Phase 4.6 batch validation)"
    },
    "dependencies": [
      "1.1",
      "1.2",
      "1.3",
      "1.4",
      "1.5",
      "2.4"
    ],
    "dependency_verification_required": {
      "phase_1_completion": {
        "steps": [
          "1.1",
          "1.2",
          "1.3",
          "1.4",
          "1.5"
        ],
        "deliverables": [
          "tools/toon/compiler.py executable",
          "tools/toon/TOON-v3.0-SPEC.md specification",
          "pytest tests/tools/toon/test_compiler.py (100% pass rate)",
          "Example conversions in tests/tools/toon/fixtures/"
        ],
        "verification": "Confirm compiler exists, test suite passes, documentation accessible",
        "blocking": true,
        "fallback_if_incomplete": "STOP execution. Escalate to project manager for decision: Option B (Markdown) or Option C (Block until complete)"
      },
      "step_2_4_completion": {
        "deliverable": "Agent framework integration patterns",
        "verification": "Confirm deliverable describes agent-activation header format",
        "blocking": false,
        "impact_if_missing": "Medium - may affect header conversion approach"
      }
    }
  },
  "deliverables": {
    "files_to_create": [
      "nWave/tasks/dw/distill.toon",
      "nWave/tasks/dw/skeleton.toon"
    ],
    "acceptance_criteria": [
      "Commands compile successfully with tools/toon/compiler.py (exit code 0)",
      "Wave metadata validates: wave='DISTILL', wave_number=3",
      "Agent-activation headers preserved: agent-id, agent-name, agent-command, auto-activate fields present in compiled output",
      "Content preservation verified: All sections from source Markdown present in compiled output",
      "Field preservation verified: YAML frontmatter fields map correctly to TOON metadata",
      "Semantic correctness validated: Compiled commands functionally equivalent to source",
      "Round-trip conversion passes: Source → TOON → Markdown produces semantically equivalent output"
    ],
    "validation_requirements": {
      "compiler_success": {
        "criteria": [
          "Exit code = 0 (no errors)",
          "No errors in stderr",
          "Output file size > 1000 bytes (non-trivial content)",
          "Metadata validates against TOON v3.0 schema"
        ]
      },
      "metadata_schema": {
        "required_fields": [
          "wave: 'DISTILL'",
          "wave_number: 3",
          "agent-id: 'acceptance-designer|walking-skeleton-automator'",
          "agent-name: 'Distiller|Walking Skeleton Automator'",
          "agent-command: 'distill|skeleton'",
          "auto-activate: true"
        ],
        "validation_method": "pytest test_wave_metadata_schema_validation"
      },
      "content_preservation": {
        "required_sections": [
          "Command description",
          "Parameters/arguments",
          "Usage examples",
          "Success criteria"
        ],
        "validation_method": "pytest test_content_preservation_after_compilation"
      }
    }
  },
  "tdd_approach": {
    "outer_test": "GIVEN DISTILL wave source files (distill.md, skeleton.md)\nWHEN compiled with tools/toon/compiler.py\nTHEN output validates: wave metadata correct, agent-activation headers preserved, content complete",
    "inner_tests": [
      "test_toon_compiler_executable_exists",
      "test_distill_command_compiles_successfully",
      "test_skeleton_command_compiles_successfully",
      "test_wave_metadata_schema_validation",
      "test_agent_activation_headers_preserved",
      "test_content_preservation_after_compilation",
      "test_field_preservation_yaml_to_toon",
      "test_compiler_error_handling_graceful",
      "test_malformed_toon_syntax_error_reporting",
      "test_validation_failure_error_reporting",
      "test_round_trip_conversion_semantic_equivalence"
    ],
    "test_framework": {
      "framework": "pytest",
      "version": ">=7.0.0",
      "rationale": "pytest provides clear assertion failures, fixture support, and parameterization for testing multiple command files",
      "test_file_locations": [
        "tests/workflow/plugin-marketplace-migration/phase-4/test_04_03_distill_conversion.py"
      ],
      "assertion_patterns": {
        "compilation_success": "assert subprocess.run(['python', 'tools/toon/compiler.py', input_file]).returncode == 0",
        "metadata_validation": "assert compiled_output['wave'] == 'DISTILL'",
        "field_preservation": "assert all(field in compiled_output for field in required_fields)"
      },
      "setup_requirements": [
        "pytest installed (pip install pytest>=7.0.0)",
        "tools/toon/compiler.py accessible in PATH or via absolute path",
        "Source files available: nWave/tasks/dw/distill.md, skeleton.md"
      ]
    },
    "tdd_workflow": {
      "step_1": "Write FAILING outer test: test_distill_skeleton_commands_compile_and_validate",
      "step_2": "Write FAILING inner tests for each validation criterion",
      "step_3": "Convert distill.md to distill.toon (minimal implementation)",
      "step_4": "Run tests - expect failures on metadata/content validation",
      "step_5": "Refine conversion to pass metadata validation tests",
      "step_6": "Refine conversion to pass content preservation tests",
      "step_7": "Repeat steps 3-6 for skeleton.md",
      "step_8": "Verify ALL tests passing (100% required)",
      "step_9": "Refactor .toon files for clarity while keeping tests green"
    }
  },
  "refactoring": {
    "targets": []
  },
  "prerequisite_checks": {
    "phase_1_toon_infrastructure": {
      "requirement": "TOON parser and compiler from Phase 1 must be complete",
      "verification_steps": [
        "Confirm tools/toon/compiler.py exists and is executable",
        "Run pytest tests/tools/toon/test_compiler.py and verify 100% pass rate",
        "Verify tools/toon/TOON-v3.0-SPEC.md exists and is readable",
        "Test compiler with example input: python tools/toon/compiler.py tests/tools/toon/fixtures/example.toon",
        "Confirm example compilation succeeds (exit code 0)"
      ],
      "blocking": true,
      "escalation": "If Phase 1 incomplete, STOP - escalate to project manager for decision on Option B (Markdown) or Option C (Block)"
    },
    "toon_format_specification": {
      "requirement": "TOON v3.0 format specification must be available and stable",
      "verification_steps": [
        "Locate specification: tools/toon/TOON-v3.0-SPEC.md (local) OR github.com/toon-format/spec (external with version tag)",
        "If external: Verify GitHub repository is accessible (not deleted/private)",
        "If external: Confirm version is pinned (git tag or commit hash, not just 'v3.0')",
        "Read specification and confirm sections: syntax definition, metadata schema, compilation rules"
      ],
      "blocking": true,
      "escalation": "If spec unavailable, create from reverse-engineering tools/toon/compiler.py or escalate"
    },
    "baseline_measurements": {
      "requirement": "Baseline measurements from Phase 0 must be complete",
      "verification_steps": [
        "Confirm docs/workflow/plugin-marketplace-migration/baseline.yaml exists",
        "Verify baseline includes token counts for distill.md and skeleton.md",
        "Extract pre-conversion metrics for comparison"
      ],
      "blocking": true,
      "escalation": "If baseline missing, execute Phase 0 baseline measurement first"
    },
    "source_files_available": {
      "requirement": "Source files (distill.md, skeleton.md) must be accessible",
      "verification_steps": [
        "Confirm nWave/tasks/dw/distill.md exists and is readable",
        "Confirm nWave/tasks/dw/skeleton.md exists and is readable",
        "Verify both files contain YAML frontmatter with agent-activation headers"
      ],
      "blocking": true,
      "escalation": "If source files missing, locate original files or escalate"
    }
  },
  "toon_compiler": {
    "tool_location": "tools/toon/compiler.py (from Phase 1)",
    "purpose": "Transforms TOON source to Claude Code compliant output",
    "input": "nWave/tasks/dw/*.toon (TOON format)",
    "output": "dist/commands/dw/*.md (Markdown format)",
    "invocation": "python tools/toon/compiler.py <input.toon> --validate --output <output.md>",
    "invocation_examples": [
      "python tools/toon/compiler.py nWave/tasks/dw/distill.toon --validate --output dist/commands/dw/distill.md",
      "python tools/toon/compiler.py nWave/tasks/dw/skeleton.toon --validate --output dist/commands/dw/skeleton.md"
    ],
    "success_criteria": [
      "Exit code = 0 (no errors)",
      "No errors in stderr",
      "Output file size > 1000 bytes (non-trivial content)",
      "Metadata validates against TOON v3.0 schema",
      "Output markdown is Claude Code compliant"
    ],
    "error_codes": {
      "0": "Success - compilation completed without errors",
      "1": "Syntax error - malformed TOON syntax (see stderr for line number)",
      "2": "Validation error - missing required metadata fields",
      "3": "IO error - input file not found or output directory not writable",
      "4": "Schema error - metadata doesn't match TOON v3.0 schema"
    },
    "validation": "pytest tests/tools/toon/test_compiler.py",
    "documentation_reference": "tools/toon/TOON-v3.0-SPEC.md for format specification"
  },
  "error_handling": {
    "scenario_1_compiler_not_found": {
      "error": "TOON compiler not found at tools/toon/compiler.py",
      "detection": "FileNotFoundError or subprocess 'command not found'",
      "handling": "Log error with clear message: 'Phase 1 TOON infrastructure required. Run Phase 1.1-1.5 first or choose Option B (Markdown).'",
      "recovery": "STOP execution immediately. Do not attempt partial conversion. Escalate to user for decision.",
      "test": "test_error_compiler_not_found_stops_execution"
    },
    "scenario_2_compilation_failure": {
      "error": "TOON compiler exits with non-zero code (syntax/validation error)",
      "detection": "subprocess.returncode != 0",
      "handling": "Log compilation error with: file path, exit code, stderr output. Mark file as FAILED. Continue with other files if batch processing.",
      "recovery": "Review TOON syntax against tools/toon/TOON-v3.0-SPEC.md. Fix errors in source .toon file. Retry compilation. If persistent, consult Phase 1 team for compiler bug.",
      "test": "test_error_compilation_failure_logs_stderr"
    },
    "scenario_3_metadata_validation_failure": {
      "error": "Compiled output fails metadata validation (missing required fields: wave, agent-id, etc.)",
      "detection": "Assertion failure in test_wave_metadata_schema_validation",
      "handling": "Log validation errors with specific missing fields: 'Missing required field: wave'. Mark file as FAILED. Generate validation report.",
      "recovery": "Add missing metadata to source .toon file. Verify against metadata schema in tools/toon/TOON-v3.0-SPEC.md. Recompile.",
      "test": "test_error_metadata_validation_failure_reports_missing_fields"
    },
    "scenario_4_partial_batch_failure": {
      "error": "Batch processing: distill.toon compiles successfully, skeleton.toon fails",
      "detection": "Mixed success/failure in batch test run",
      "handling": "Complete all processable files. Generate summary report: 'Batch: 1 succeeded (distill.toon), 1 failed (skeleton.toon). Error: [details]'",
      "recovery": "Fix failed files individually. Rerun ONLY failed files (not entire batch). Verify all files compile before proceeding.",
      "test": "test_error_partial_batch_failure_reporting"
    },
    "scenario_5_content_preservation_failure": {
      "error": "Compiled output missing sections from source Markdown (data loss)",
      "detection": "Assertion failure in test_content_preservation_after_compilation",
      "handling": "Log missing sections: 'Content loss detected: Missing sections [Parameters, Usage Examples]'",
      "recovery": "Review TOON conversion logic. Verify all Markdown sections map to TOON equivalents. Manually inspect compiled output. If compiler bug, escalate to Phase 1 team.",
      "test": "test_error_content_preservation_failure_detects_missing_sections"
    },
    "scenario_6_round_trip_conversion_failure": {
      "error": "Round-trip (source → TOON → Markdown) produces semantically different output",
      "detection": "Assertion failure in test_round_trip_conversion_semantic_equivalence",
      "handling": "Log semantic differences with diff output. Mark conversion as LOSSY.",
      "recovery": "Acceptable if differences are formatting only (whitespace, line breaks). UNACCEPTABLE if content or metadata differs. Review TOON format specification for lossy conversion patterns.",
      "test": "test_error_round_trip_semantic_differences_logged"
    },
    "scenario_7_external_spec_unavailable": {
      "error": "External TOON v3.0 specification (GitHub) is inaccessible (deleted, archived, private)",
      "detection": "HTTP 404, 403, or timeout when accessing github.com/toon-format/spec",
      "handling": "Log error: 'External TOON spec unavailable. Falling back to local specification.'",
      "recovery": "Use local specification at tools/toon/TOON-v3.0-SPEC.md. If local spec also missing, STOP and escalate.",
      "test": "test_error_external_spec_unavailable_uses_local_fallback"
    },
    "scenario_8_test_framework_mismatch": {
      "error": "Tests written in pytest but project CI/CD uses unittest",
      "detection": "Tests run locally but fail in CI/CD pipeline with framework errors",
      "handling": "Early detection: Verify test framework in CI/CD config before writing tests. Log error if mismatch detected.",
      "recovery": "Rewrite tests in correct framework OR update CI/CD config to support pytest (1-2 hour effort).",
      "test": "test_error_test_framework_verified_before_implementation"
    }
  },
  "edge_cases": {
    "edge_case_1_toon_format_breaking_changes": {
      "scenario": "TOON format has breaking changes between Phase 1 spec and Phase 4 usage",
      "probability": "Medium",
      "handler": "Version pinning in prerequisite_checks.toon_format_specification ensures stable spec. If breaking changes detected, validate against pinned version, not latest.",
      "test": "test_edge_case_toon_version_pinning_prevents_breaking_changes"
    },
    "edge_case_2_compiler_semantic_incorrectness": {
      "scenario": "Compilation succeeds but output is semantically incorrect (compiler bug)",
      "probability": "Medium",
      "handler": "test_round_trip_conversion_semantic_equivalence and test_content_preservation_after_compilation detect semantic bugs. Manual inspection required if tests fail.",
      "test": "test_edge_case_semantic_correctness_validated"
    },
    "edge_case_3_yaml_frontmatter_conversion_ambiguity": {
      "scenario": "Source YAML frontmatter has nested structures that don't map cleanly to TOON metadata",
      "probability": "High",
      "handler": "TOON v3.0 spec should define metadata mapping rules. If ambiguous, flatten nested structures or use JSON encoding for complex fields.",
      "test": "test_edge_case_yaml_nested_structures_flattened"
    },
    "edge_case_4_agent_activation_headers_format_mismatch": {
      "scenario": "Agent-activation headers exist in source but cannot be extracted from compiled .toon",
      "probability": "High",
      "handler": "test_agent_activation_headers_preserved explicitly validates header preservation. If headers lost, review TOON format spec for header embedding rules.",
      "test": "test_edge_case_headers_preserved_in_compiled_output"
    },
    "edge_case_5_compilation_timeout": {
      "scenario": "Compilation takes >5 minutes per file (slow computer or large files)",
      "probability": "Low",
      "handler": "Implement timeout in subprocess.run(timeout=300). If timeout exceeded, log warning and retry once. If persistent, escalate.",
      "test": "test_edge_case_compilation_timeout_handled"
    },
    "edge_case_6_test_environment_dependencies_missing": {
      "scenario": "pytest requires dependencies not installed (specific Python version, packages)",
      "probability": "High",
      "handler": "Document environment setup in tdd_approach.test_framework.setup_requirements. Verify environment before test execution: pytest --version, python --version.",
      "test": "test_edge_case_environment_setup_verified"
    },
    "edge_case_7_markdown_comments_lost": {
      "scenario": "Markdown comments or annotations lost in .toon conversion",
      "probability": "Medium",
      "handler": "test_content_preservation_after_compilation should include comment preservation check. If comments critical, embed as TOON metadata.",
      "test": "test_edge_case_comments_preserved_or_documented"
    },
    "edge_case_8_wave_metadata_malformed_but_present": {
      "scenario": "Wave metadata validation test passes (field exists) but data is invalid (e.g., wave='DISTIL' typo)",
      "probability": "High",
      "handler": "test_wave_metadata_schema_validation validates exact values, not just field presence: assert compiled_output['wave'] == 'DISTILL' (not just assert 'wave' in compiled_output).",
      "test": "test_edge_case_metadata_values_exact_not_just_presence"
    }
  },
  "test_specifications": {
    "unit_tests": [
      {
        "name": "test_toon_compiler_executable_exists",
        "purpose": "Verify TOON compiler is accessible before attempting conversion",
        "input": "Path: tools/toon/compiler.py",
        "expected": "File exists, is executable (or Python script), returns --help without error"
      },
      {
        "name": "test_toon_parser_valid_command_input",
        "purpose": "Verify parser handles valid TOON command syntax correctly",
        "input": "Sample TOON command file with all required fields (name, description, parameters)",
        "expected": "Parsed dict with command metadata: {name, description, parameters, dependencies}"
      },
      {
        "name": "test_template_rendering_with_parsed_command",
        "purpose": "Verify Jinja2 template renders command.md from parsed data",
        "input": "Parsed command dict from parser output",
        "expected": "Valid Markdown output with command syntax section, parameters table, usage examples"
      },
      {
        "name": "test_output_validation_against_claude_code_spec",
        "purpose": "Verify compiled output meets Claude Code command specification",
        "input": "Generated command.md file",
        "expected": "Validation passes: Has frontmatter, execution context, success criteria sections"
      },
      {
        "name": "test_wave_metadata_schema_validation",
        "purpose": "Verify wave metadata has exact required values",
        "input": "Compiled distill.toon output",
        "expected": "Metadata: wave='DISTILL', wave_number=3, agent-id present, agent-name present"
      },
      {
        "name": "test_agent_activation_headers_preserved",
        "purpose": "Verify YAML frontmatter fields preserved in TOON metadata",
        "input": "Source distill.md with YAML frontmatter",
        "expected": "Compiled output contains: agent-id, agent-name, agent-command, auto-activate fields with correct values"
      },
      {
        "name": "test_content_preservation_after_compilation",
        "purpose": "Verify all source Markdown sections present in compiled output",
        "input": "Source distill.md with sections: Description, Parameters, Examples, Success Criteria",
        "expected": "Compiled output contains ALL sections with content intact"
      },
      {
        "name": "test_field_preservation_yaml_to_toon",
        "purpose": "Verify no data loss in YAML → TOON metadata conversion",
        "input": "YAML frontmatter with 6 fields",
        "expected": "TOON metadata contains all 6 fields with identical values"
      },
      {
        "name": "test_round_trip_conversion_semantic_equivalence",
        "purpose": "Verify Source → TOON → Markdown produces equivalent output",
        "input": "Original distill.md",
        "expected": "Round-trip output semantically equivalent (content identical, formatting differences acceptable)"
      }
    ],
    "integration_tests": [
      {
        "name": "test_e2e_command_migration_pipeline",
        "purpose": "Verify complete migration: TOON → Parse → Template → Validate → Output",
        "input": "Real TOON command file from nWave/tasks/dw/",
        "steps": "Parse TOON → Apply command template → Validate output → Write to dist/",
        "expected": "Valid command.md in dist/commands/dw/ matching Claude Code spec"
      },
      {
        "name": "test_batch_migration_distill_skeleton",
        "purpose": "Verify batch processing of DISTILL wave commands",
        "input": "Both distill.toon and skeleton.toon",
        "expected": "Both commands migrated successfully with validation report: 2/2 succeeded"
      }
    ],
    "error_scenario_tests": [
      {
        "name": "test_compiler_not_found_error_handling",
        "purpose": "Verify graceful failure when compiler missing",
        "setup": "Remove or rename tools/toon/compiler.py",
        "expected": "Clear error message, execution stops, no partial output"
      },
      {
        "name": "test_malformed_toon_syntax_error_handling",
        "purpose": "Verify parser reports syntax errors clearly",
        "input": "TOON file with missing ## section header",
        "expected": "Parser error with line number, specific syntax issue description"
      },
      {
        "name": "test_validation_failure_error_handling",
        "purpose": "Verify validation errors reported clearly",
        "input": "TOON file missing required 'description' field",
        "expected": "Validation error: 'Missing required field: description' with file path"
      },
      {
        "name": "test_metadata_validation_failure_reports_missing_fields",
        "purpose": "Verify metadata errors identify specific missing fields",
        "input": "Compiled output with wave field missing",
        "expected": "Error: 'Missing required metadata field: wave'"
      },
      {
        "name": "test_content_preservation_failure_detects_missing_sections",
        "purpose": "Verify content loss detection",
        "input": "Compiled output missing 'Parameters' section",
        "expected": "Error: 'Content loss detected: Missing sections [Parameters]'"
      },
      {
        "name": "test_partial_batch_failure_reporting",
        "purpose": "Verify batch processing reports partial failures correctly",
        "input": "distill.toon (valid), skeleton.toon (invalid syntax)",
        "expected": "Report: '1 succeeded (distill), 1 failed (skeleton). Error: [syntax error details]'"
      }
    ]
  },
  "execution_guidance": {
    "approach": "Test-first command conversion with comprehensive validation",
    "workflow": [
      "0. PREREQUISITE VERIFICATION (BLOCKING - DO NOT PROCEED WITHOUT)",
      "   a. Verify Phase 1 TOON infrastructure complete (run prerequisite_checks.phase_1_toon_infrastructure)",
      "   b. Verify TOON v3.0 spec accessible (run prerequisite_checks.toon_format_specification)",
      "   c. Verify baseline measurements available (run prerequisite_checks.baseline_measurements)",
      "   d. Verify source files accessible (run prerequisite_checks.source_files_available)",
      "   e. If ANY prerequisite fails: STOP, escalate, DO NOT PROCEED",
      "1. SETUP TEST ENVIRONMENT",
      "   a. Install pytest>=7.0.0: pip install pytest",
      "   b. Verify Python version matches project requirements",
      "   c. Create test file: tests/workflow/plugin-marketplace-migration/phase-4/test_04_03_distill_conversion.py",
      "2. WRITE FAILING TESTS (TDD RED PHASE)",
      "   a. Write outer test: test_distill_skeleton_commands_compile_and_validate (EXPECT FAIL)",
      "   b. Write inner tests from test_specifications.unit_tests (ALL EXPECT FAIL)",
      "   c. Run pytest - verify ALL tests fail as expected",
      "3. CONVERT FIRST COMMAND (distill.md → distill.toon)",
      "   a. Read tools/toon/TOON-v3.0-SPEC.md for format reference",
      "   b. Convert distill.md to distill.toon following spec",
      "   c. Compile: python tools/toon/compiler.py nWave/tasks/dw/distill.toon --validate --output dist/commands/dw/distill.md",
      "   d. Run tests - expect SOME failures (metadata, content validation)",
      "4. REFINE CONVERSION (TDD GREEN PHASE)",
      "   a. Fix metadata validation failures (add missing wave, agent-id fields)",
      "   b. Fix content preservation failures (ensure all sections included)",
      "   c. Fix field preservation failures (map all YAML fields to TOON metadata)",
      "   d. Recompile and retest after each fix",
      "   e. Continue until ALL tests pass for distill.toon",
      "5. CONVERT SECOND COMMAND (skeleton.md → skeleton.toon)",
      "   a. Repeat steps 3-4 for skeleton.md",
      "   b. Leverage learning from distill.md conversion",
      "   c. Verify ALL tests pass for skeleton.toon",
      "6. BATCH VALIDATION",
      "   a. Run test_batch_migration_distill_skeleton",
      "   b. Verify 2/2 commands compile successfully",
      "   c. Run ALL tests again - confirm 100% pass rate",
      "7. REFACTOR (TDD REFACTOR PHASE)",
      "   a. Review .toon files for clarity and consistency",
      "   b. Apply any refactoring to improve readability",
      "   c. Keep tests GREEN during all refactoring",
      "8. FINAL VALIDATION",
      "   a. Run complete test suite: pytest tests/workflow/plugin-marketplace-migration/phase-4/test_04_03_distill_conversion.py -v",
      "   b. Verify 100% test pass rate (NO FAILURES, NO SKIPS)",
      "   c. Generate validation report (optional, if user requests)",
      "9. USER APPROVAL",
      "   a. DO NOT COMMIT automatically",
      "   b. Present results to user with test report",
      "   c. Wait for explicit approval before committing"
    ],
    "quality_gates": [
      "BLOCKING: All prerequisite checks pass (Phase 1 complete, spec accessible, baseline available)",
      "BLOCKING: All tests passing (100% required - no failures, no skips)",
      "BLOCKING: Both commands compile successfully (exit code 0, no stderr errors)",
      "BLOCKING: Wave metadata validates against schema (exact values: wave='DISTILL', wave_number=3)",
      "BLOCKING: Agent-activation headers preserved (all YAML frontmatter fields present in compiled output)",
      "BLOCKING: Content preservation verified (all source sections present in compiled output)",
      "BLOCKING: Field preservation verified (no data loss in YAML → TOON conversion)",
      "BLOCKING: Semantic correctness validated (round-trip conversion produces equivalent output)",
      "BLOCKING: No report files created (constraint enforcement)",
      "RECOMMENDED: Compilation completes within 5 minutes per file (performance check)"
    ],
    "time_breakdown": {
      "total_estimate": "3-4 hours",
      "prerequisite_verification": "15-30 min (one-time, may be longer if Phase 1 incomplete)",
      "test_environment_setup": "15-20 min (install pytest, create test file)",
      "test_implementation": "45-60 min (write 11 unit tests + 2 integration tests + 6 error tests)",
      "first_conversion": "45-60 min (distill.md → distill.toon, including refinement to pass tests)",
      "second_conversion": "30-45 min (skeleton.md → skeleton.toon, faster due to learning)",
      "batch_validation": "10-15 min (run full test suite, verify 100% pass rate)",
      "refactoring": "15-20 min (improve .toon readability while keeping tests green)",
      "final_validation": "10-15 min (comprehensive test run, generate report if needed)",
      "contingency": "30-45 min (buffer for unexpected issues, compiler bugs, format ambiguities)"
    }
  },
  "risk_mitigation": {
    "phase_1_incomplete": {
      "risk": "Phase 1 TOON infrastructure not ready (9/10 severity)",
      "mitigation": "Prerequisite verification BLOCKING before any conversion work",
      "fallback": "STOP execution. Escalate to project manager for decision: Option B (Markdown) or Option C (Block until Phase 1 complete)"
    },
    "format_conversion_ambiguity": {
      "risk": "TOON format unclear, developer guesses incorrectly (8/10 severity)",
      "mitigation": "Explicit reference to tools/toon/TOON-v3.0-SPEC.md in workflow step 3a",
      "fallback": "Reverse-engineer format from tools/toon/compiler.py source or consult Phase 1 team"
    },
    "metadata_validation_misinterpretation": {
      "risk": "Tests validate field presence but not exact values (7/10 severity)",
      "mitigation": "deliverables.validation_requirements.metadata_schema defines exact required values",
      "fallback": "Manual inspection of compiled output against schema definition"
    },
    "test_framework_mismatch": {
      "risk": "Tests don't execute in CI/CD pipeline (6/10 severity)",
      "mitigation": "tdd_approach.test_framework explicitly specifies pytest with version and setup requirements",
      "fallback": "Verify CI/CD config before test implementation. If mismatch, update config or rewrite tests (1-2 hours)"
    },
    "cascading_phase_4_failures": {
      "risk": "Step 4.1 fails but 4.2-4.6 continue, compounding errors (9/10 severity)",
      "mitigation": "Each step independently verifies prerequisites. If compilation fails in ANY step, STOP and fix before proceeding.",
      "fallback": "Identify root cause, fix format/compiler issue, replay failed conversions"
    },
    "schedule_slip": {
      "risk": "1-hour estimate leads to 2-3 hour overrun (7/10 severity)",
      "mitigation": "Revised estimate to 3-4 hours with detailed time breakdown",
      "fallback": "Negotiate schedule extension or reduce scope (defer one command to later step)"
    }
  },
  "review_metadata": {
    "review_date": "2026-01-05",
    "reviewer": "Lyra (Quality Review + Adversarial Review)",
    "completeness_score": "9/10 (all critical gaps addressed)",
    "achievability_score": "8/10 (achievable with prerequisite verification)",
    "clarity_score": "9/10 (comprehensive specifications and examples)",
    "critical_issues_count": 0,
    "high_issues_count": 0,
    "medium_issues_count": 0,
    "adversarial_review_applied": true,
    "adversarial_review_reference": "docs/workflow/plugin-marketplace-migration/adversarial-reviews/ADVERSARIAL_REVIEW_04-03.md"
  },
  "adversarial_review_corrections_applied": {
    "corrected_contradictions": [
      "CONT-1: Added explicit dependencies on Phase 1 steps (1.1-1.5) with verification requirements",
      "CONT-2: Added prerequisite check for TOON v3.0 spec with local and external fallback options",
      "CONT-3: Restructured TDD workflow to write FAILING tests FIRST, then drive implementation",
      "CONT-4: Revised time estimate from 1 hour to 3-4 hours with detailed breakdown"
    ],
    "addressed_dangerous_assumptions": [
      "Phase 1 complete: Added prerequisite_checks.phase_1_toon_infrastructure with verification steps",
      "TOON spec accessible: Added prerequisite_checks.toon_format_specification with version pinning",
      "Headers preserved: Added explicit test_agent_activation_headers_preserved with field validation",
      "Time realistic: Added execution_guidance.time_breakdown with learning curve consideration",
      "Test framework: Added tdd_approach.test_framework with pytest specification, version, setup",
      "Compilation defined: Added toon_compiler section with invocation examples and error codes"
    ],
    "handled_edge_cases": [
      "Format breaking changes: Added version pinning in prerequisite checks",
      "Compiler semantic bugs: Added test_round_trip_conversion_semantic_equivalence",
      "Source conversion issues: Added test_content_preservation_after_compilation",
      "Metadata validation: Added deliverables.validation_requirements.metadata_schema with exact values",
      "Header preservation: Added test_agent_activation_headers_preserved",
      "Compilation timeout: Added edge_cases.edge_case_5_compilation_timeout with handler",
      "Environment dependencies: Added tdd_approach.test_framework.setup_requirements",
      "Malformed metadata: Added test_wave_metadata_schema_validation with exact value assertions"
    ],
    "mitigated_failure_scenarios": [
      "FS-1 Compiler not ready: Added prerequisite verification BLOCKING step with escalation",
      "FS-2 Format ambiguity: Added explicit reference to tools/toon/TOON-v3.0-SPEC.md in workflow",
      "FS-3 Metadata misinterpretation: Added metadata schema with exact required values",
      "FS-4 Test framework mismatch: Added explicit pytest specification with verification step",
      "FS-5 Cascading failures: Added prerequisite verification to each step, STOP on failure",
      "FS-6 Schedule slip: Added realistic time estimate (3-4 hours) with detailed breakdown"
    ],
    "addressed_test_coverage_gaps": [
      "Content preservation: Added test_content_preservation_after_compilation",
      "Field preservation: Added test_field_preservation_yaml_to_toon",
      "Compiler error handling: Added test_compiler_not_found_error_handling",
      "TOON readability: Added round-trip conversion test",
      "Metadata semantic correctness: Added test_wave_metadata_schema_validation with exact values",
      "Round-trip conversion: Added test_round_trip_conversion_semantic_equivalence"
    ],
    "clarified_integration_points": [
      "Phase 1 → Phase 4: Added explicit dependencies with deliverables verification",
      "Phase 4 → Phase 5: Added semantic correctness validation to prevent malformed output",
      "Test framework → CI/CD: Added pytest specification with version and verification step"
    ],
    "documented_security_mitigations": [
      "External GitHub spec: Added version pinning (git tag or commit hash) in prerequisite checks",
      "Compiler input validation: Referenced Phase 1 compiler security features in error_handling",
      "Test dependencies: Added version specification in tdd_approach.test_framework"
    ],
    "improved_clarity": [
      "Terminology: Standardized 'compile' vs 'convert' usage throughout document",
      "Agent invocation: Clarified task is about converting task files, not invoking agents",
      "AC vs tests: Separated acceptance_criteria (requirements) from tdd_approach (implementation)"
    ]
  },
  "validation": {
    "status": "approved",
    "notes": "Step validation completed. Quality score: 9.5/10 (all 6 criteria met with excellence). No critical, high, or medium issues found. Exceptional adversarial review evidence with 34 documented corrections. Realistic time estimates with detailed breakdown. Comprehensive error handling and edge case coverage.",
    "validated_at": "2026-01-13T22:15:00Z",
    "reviewer": "Lyra",
    "review_criteria": {
      "task_clarity": "9/10 - Crystal clear objective, comprehensive guidance, well-structured workflow",
      "dependencies": "10/10 - Explicit blocking/non-blocking deps, verification steps, fallback escalation",
      "success_criteria": "10/10 - 7 acceptance criteria, 8 quality gates, exact validation values specified",
      "constraints": "10/10 - 3 explicit constraints enforced throughout document",
      "testability": "10/10 - 19 tests specified with input/expected output, pytest configured, edge cases covered",
      "scope": "10/10 - Precisely 2 files, clear delineation of in/out of scope items"
    },
    "quality_assessment": {
      "overall_score": "9.5/10",
      "strengths": [
        "Adversarial review evidence with 34 documented corrections",
        "Realistic time estimates with detailed breakdown (3-4 hours total)",
        "Comprehensive error handling: 8 scenarios with detection/recovery",
        "Edge case specification: 8 cases with probability and handlers",
        "Test specification excellence: 19 tests with clear input/output",
        "Risk mitigation: 6 scenarios with severity scores and fallbacks",
        "Blocking dependency enforcement with escalation procedures",
        "Compiler tool specification with error codes and examples"
      ],
      "minor_opportunities": [
        "Agent-activation headers terminology could be clarified on first read (adequately explained in validation_requirements)"
      ],
      "critical_issues": 0,
      "high_issues": 0,
      "medium_issues": 0,
      "low_issues": 0
    },
    "execution_readiness": "READY - All prerequisites, workflows, tests, and error handling fully specified. Author ready to execute.",
    "handoff_confidence": "HIGH - Step file is comprehensive, well-vetted, and ready for implementation.",
    "migrated_at": "2026-01-13T22:11:27.216991",
    "approved_at": "2026-01-13T22:15:00Z"
  }
}